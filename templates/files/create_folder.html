{% extends 'base.html' %}
{% load static %}

{% block title %}Criar Pasta - Arquivos - Rede Confiança{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center space-x-4">
            <a href="{% url 'files:files_list' %}{% if parent_folder %}?folder={{ parent_folder.id }}{% endif %}" class="text-gray-600 hover:text-primary">
                <i class="fas fa-arrow-left text-lg"></i>
            </a>
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Criar Nova Pasta</h1>
                <p class="text-gray-600 mt-2">
                    {% if parent_folder %}
                        Criar pasta dentro de: <strong>{{ parent_folder.name }}</strong>
                    {% else %}
                        Criar pasta na raiz
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    
    <!-- Form -->
    <div class="bg-white rounded-lg shadow-sm p-6">
        <form method="post" class="space-y-6">
            {% csrf_token %}
            
            {% if parent_folder %}
                <input type="hidden" name="parent" value="{{ parent_folder.id }}">
            {% endif %}
            
            <!-- Nome da pasta -->
            <div>
                <label for="name" class="block text-sm font-medium text-gray-700 mb-2">Nome da Pasta *</label>
                <input type="text" name="name" id="name" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                       placeholder="Ex: Documentos Administrativos">
            </div>
            
            <!-- Descrição -->
            <div>
                <label for="description" class="block text-sm font-medium text-gray-700 mb-2">Descrição</label>
                <textarea name="description" id="description" rows="3"
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                          placeholder="Descrição opcional da pasta..."></textarea>
            </div>
            
            <!-- Visibilidade -->
            <div>
                <label for="visibility" class="block text-sm font-medium text-gray-700 mb-2">Visibilidade</label>
                <select name="visibility" id="visibility" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    <option value="ALL">Todos os usuários</option>
                    <option value="SECTOR">Usuários do setor específico</option>
                    <option value="ADMIN">Apenas administradores</option>
                </select>
            </div>
            
            <!-- Setor (condicional) -->
            <div id="sector-field" style="display: none;">
                <label for="target_sector" class="block text-sm font-medium text-gray-700 mb-2">Setor</label>
                <select name="target_sector" id="target_sector"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    <option value="">Carregando setores...</option>
                </select>
            </div>
            
            <!-- Botões -->
            <div class="flex justify-between items-center pt-6">
                <a href="{% url 'files:files_list' %}{% if parent_folder %}?folder={{ parent_folder.id }}{% endif %}" 
                   class="bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400 transition-colors">
                    <i class="fas fa-times mr-2"></i>Cancelar
                </a>
                
                <button type="submit" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-orange-600 transition-colors">
                    <i class="fas fa-folder-plus mr-2"></i>Criar Pasta
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.getElementById('visibility').addEventListener('change', function() {
    const sectorField = document.getElementById('sector-field');
    const sectorSelect = document.getElementById('target_sector');
    
    if (this.value === 'SECTOR') {
        sectorField.style.display = 'block';
        loadSectors();
    } else {
        sectorField.style.display = 'none';
        sectorSelect.innerHTML = '<option value="">Carregando setores...</option>';
    }
});

function loadSectors() {
    const sectorSelect = document.getElementById('target_sector');
    
    // Mostrar loading
    sectorSelect.innerHTML = '<option value="">Carregando setores...</option>';
    sectorSelect.disabled = true;
    
    console.log('Carregando setores...');
    
    fetch('{% url "files:get_sectors" %}', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        console.log('Setores recebidos:', data);
        sectorSelect.innerHTML = '<option value="">Selecione um setor</option>';
        
        if (data.sectors && data.sectors.length > 0) {
            data.sectors.forEach(sector => {
                const option = document.createElement('option');
                option.value = sector.id;
                option.textContent = sector.name;
                sectorSelect.appendChild(option);
            });
        } else {
            sectorSelect.innerHTML = '<option value="">Nenhum setor disponível</option>';
        }
        
        sectorSelect.disabled = false;
    })
    .catch(error => {
        console.error('Erro ao carregar setores:', error);
        sectorSelect.innerHTML = '<option value="">Erro ao carregar setores</option>';
        sectorSelect.disabled = false;
    });
}
</script>
{% endblock %}