{% extends 'base.html' %}
{% load static %}

{% block title %}Histórico de Resgates - Rede Confiança{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
        <h1 class="text-3xl font-bold text-gray-900">
            <i class="fas fa-history mr-3 text-blue-600"></i>
            Meus Resgates
        </h1>
        <a href="{% url 'marketplace' %}" class="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg hover:bg-blue-200 transition-colors">
            <i class="fas fa-store mr-2"></i>
            Voltar ao Mercadinho
        </a>
    </div>

    <!-- Estatísticas -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center">
                <div class="p-3 bg-blue-100 rounded-full">
                    <i class="fas fa-shopping-cart text-blue-600 text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-600">Total de Resgates</p>
                    <p class="text-2xl font-bold">{{ redemptions.paginator.count }}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center">
                <div class="p-3 bg-yellow-100 rounded-full">
                    <i class="fas fa-clock text-yellow-600 text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-600">Pendentes</p>
                    <p class="text-2xl font-bold">{{ redemptions.object_list|length }}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center">
                <div class="p-3 bg-green-100 rounded-full">
                    <i class="fas fa-check-circle text-green-600 text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-600">Entregues</p>
                    <p class="text-2xl font-bold">0</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center">
                <div class="p-3 bg-purple-100 rounded-full">
                    <i class="fas fa-coins text-purple-600 text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-600">C$ Gastos</p>
                    <p class="text-2xl font-bold">0</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de resgates -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold">Histórico de Resgates</h3>
        </div>
        
        {% if redemptions %}
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prêmio</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for redemption in redemptions %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                {% if redemption.prize.image %}
                                <img src="{{ redemption.prize.image.url }}" alt="{{ redemption.prize.name }}" class="w-12 h-12 rounded-lg object-cover mr-4">
                                {% else %}
                                <div class="w-12 h-12 bg-gray-200 rounded-lg flex items-center justify-center mr-4">
                                    <i class="fas fa-gift text-gray-400"></i>
                                </div>
                                {% endif %}
                                <div>
                                    <div class="text-sm font-medium text-gray-900">{{ redemption.prize.name }}</div>
                                    <div class="text-sm text-gray-500">{{ redemption.prize.description|truncatechars:50 }}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-bold text-blue-600">
                                <i class="fas fa-coins mr-1"></i>
                                {{ redemption.prize.value_cs|floatformat:0 }} C$
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">{{ redemption.redeemed_at|date:"d/m/Y" }}</div>
                            <div class="text-sm text-gray-500">{{ redemption.redeemed_at|time:"H:i" }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if redemption.status == 'PENDENTE' %}
                                <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs font-bold">
                                    <i class="fas fa-clock"></i> Pendente
                                </span>
                            {% elif redemption.status == 'APROVADO' %}
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-bold">
                                    <i class="fas fa-check"></i> Aprovado
                                </span>
                            {% elif redemption.status == 'ENTREGUE' %}
                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-bold">
                                    <i class="fas fa-check-circle"></i> Entregue
                                </span>
                            {% elif redemption.status == 'CANCELADO' %}
                                <span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-bold">
                                    <i class="fas fa-times"></i> Cancelado
                                </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="viewDetails({{ redemption.id }})" class="text-blue-600 hover:text-blue-900 mr-3">
                                <i class="fas fa-eye"></i>
                            </button>
                            {% if redemption.status == 'PENDENTE' %}
                            <button onclick="cancelRedemption({{ redemption.id }})" class="text-red-600 hover:text-red-900">
                                <i class="fas fa-times"></i>
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="p-12 text-center">
            <div class="text-gray-400 mb-4">
                <i class="fas fa-shopping-cart text-6xl"></i>
            </div>
            <h3 class="text-xl font-semibold text-gray-600 mb-2">Nenhum resgate realizado</h3>
            <p class="text-gray-500 mb-4">Você ainda não resgatou nenhum prêmio.</p>
            <a href="{% url 'marketplace' %}" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                <i class="fas fa-store mr-2"></i>
                Explorar Mercadinho
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Paginação -->
    {% if redemptions.has_other_pages %}
    <div class="flex justify-center mt-8">
        <nav class="flex space-x-2">
            {% if redemptions.has_previous %}
                <a href="?page={{ redemptions.previous_page_number }}" 
                   class="px-3 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                    <i class="fas fa-chevron-left"></i>
                </a>
            {% endif %}
            
            {% for page_num in redemptions.paginator.page_range %}
                {% if page_num == redemptions.number %}
                    <span class="px-3 py-2 bg-blue-600 text-white rounded-lg">{{ page_num }}</span>
                {% else %}
                    <a href="?page={{ page_num }}" 
                       class="px-3 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">{{ page_num }}</a>
                {% endif %}
            {% endfor %}
            
            {% if redemptions.has_next %}
                <a href="?page={{ redemptions.next_page_number }}" 
                   class="px-3 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                    <i class="fas fa-chevron-right"></i>
                </a>
            {% endif %}
        </nav>
    </div>
    {% endif %}
</div>

<!-- Modal de detalhes -->
<div id="detailsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg p-6 max-w-md w-full">
            <h3 class="text-lg font-bold mb-4">Detalhes do Resgate</h3>
            <div id="modalContent">
                <!-- Conteúdo será carregado via JavaScript -->
            </div>
            <div class="flex gap-3 mt-4">
                <button onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                    Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function viewDetails(redemptionId) {
    // Implementar visualização de detalhes
    document.getElementById('detailsModal').classList.remove('hidden');
    document.getElementById('modalContent').innerHTML = '<p>Carregando detalhes...</p>';
}

function closeModal() {
    document.getElementById('detailsModal').classList.add('hidden');
}

function cancelRedemption(redemptionId) {
    if (confirm('Tem certeza que deseja cancelar este resgate? O C$ será devolvido ao seu saldo.')) {
        // Verificar se o token CSRF existe
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfToken) {
            alert('Erro: Token CSRF não encontrado. Recarregue a página e tente novamente.');
            return;
        }
        
        console.log('Cancelando resgate ID:', redemptionId);
        
        fetch(`/prizes/redemptions/${redemptionId}/cancel/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken.value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            console.log('Resposta recebida:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Dados recebidos:', data);
            if (data.success) {
                alert(data.message || 'Resgate cancelado com sucesso!');
                location.reload();
            } else {
                alert('Erro ao cancelar resgate: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erro na requisição:', error);
            alert('Erro ao cancelar resgate: ' + error.message);
        });
    }
}

// Fechar modal ao clicar fora
document.getElementById('detailsModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});
</script>
{% endblock %}
