{% extends 'base.html' %}
{% load static %}

{% block title %}OneSignal - Push Notifications{% endblock %}

{% block extra_css %}
<style>
    @keyframes ring {
        0%, 100% { transform: rotate(0deg); }
        10%, 30% { transform: rotate(15deg); }
        20%, 40% { transform: rotate(-15deg); }
        50% { transform: rotate(0deg); }
    }
    .animate-ring { animation: ring 2s ease-in-out infinite; }
    
    .stat-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .stat-card:hover {
        transform: translateY(-4px);
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-900 py-6">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Header -->
        <div class="relative overflow-hidden bg-gradient-to-r from-red-600 to-red-700 rounded-2xl shadow-2xl mb-8">
            <div class="absolute inset-0 overflow-hidden">
                <div class="absolute -top-1/2 -right-1/4 w-96 h-96 bg-white/10 rounded-full"></div>
            </div>
            
            <div class="relative px-8 py-10">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
                    <div class="flex items-center gap-5">
                        <div class="w-16 h-16 bg-white rounded-2xl shadow-lg flex items-center justify-center">
                            <i class="fas fa-bell text-3xl text-red-600 animate-ring"></i>
                        </div>
                        <div>
                            <h1 class="text-3xl font-bold text-white">OneSignal</h1>
                            <p class="text-red-100 mt-1">Gerenciamento de Push Notifications</p>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap gap-3">
                        <button onclick="openSyncModal()" class="inline-flex items-center px-5 py-2.5 bg-white/20 hover:bg-white/30 text-white font-medium rounded-xl transition-all border border-white/30">
                            <i class="fas fa-sync-alt mr-2"></i>
                            Sincronizar Todos
                        </button>
                        <button onclick="refreshStats()" class="inline-flex items-center px-5 py-2.5 bg-white hover:bg-gray-100 text-red-600 font-medium rounded-xl transition-all shadow-lg">
                            <i class="fas fa-chart-line mr-2"></i>
                            Atualizar Stats
                        </button>
                    </div>
                </div>
                
                <!-- Status Badge -->
                <div class="mt-6">
                    {% if is_configured %}
                    <span class="inline-flex items-center px-4 py-2 bg-green-500/30 text-green-100 rounded-full text-sm font-medium border border-green-400/50">
                        <span class="w-2 h-2 bg-green-400 rounded-full mr-2 animate-pulse"></span>
                        API Configurada e Ativa
                    </span>
                    {% else %}
                    <span class="inline-flex items-center px-4 py-2 bg-yellow-500/30 text-yellow-100 rounded-full text-sm font-medium border border-yellow-400/50">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Configura√ß√£o Pendente
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Banner para Aceitar Notifica√ß√µes -->
        <div id="subscriptionBanner" class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-2xl p-6 mb-8 hidden">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                        <i class="fas fa-bell text-2xl text-white"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-white">Ativar Notifica√ß√µes Push</h3>
                        <p class="text-blue-100 text-sm">Voc√™ ainda n√£o est√° inscrito para receber notifica√ß√µes neste navegador.</p>
                    </div>
                </div>
                <button onclick="requestPushPermissionLocal()" class="px-6 py-3 bg-white text-blue-600 font-semibold rounded-xl hover:bg-blue-50 transition-all shadow-lg">
                    <i class="fas fa-bell mr-2"></i>
                    Aceitar Notifica√ß√µes
                </button>
            </div>
        </div>
        
        <!-- Stats Grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Usu√°rios -->
            <div class="stat-card bg-gray-800 rounded-2xl p-6 border border-gray-700">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-400 uppercase tracking-wider">Total Usu√°rios</p>
                        <p class="text-3xl font-bold text-white mt-2">{{ total_active_users }}</p>
                        <p class="text-xs text-gray-500 mt-1">usu√°rios ativos</p>
                    </div>
                    <div class="w-14 h-14 bg-blue-600 rounded-2xl flex items-center justify-center">
                        <i class="fas fa-users text-white text-xl"></i>
                    </div>
                </div>
            </div>
            
            <!-- Sincronizados -->
            <div class="stat-card bg-gray-800 rounded-2xl p-6 border border-gray-700">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-400 uppercase tracking-wider">Sincronizados</p>
                        <p class="text-3xl font-bold text-white mt-2">{{ total_synced|default:0 }}</p>
                        <p class="text-xs text-gray-500 mt-1">registros criados</p>
                    </div>
                    <div class="w-14 h-14 bg-purple-600 rounded-2xl flex items-center justify-center">
                        <i class="fas fa-database text-white text-xl"></i>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-700">
                    {% if total_active_users > 0 %}
                    <div class="w-full bg-gray-700 rounded-full h-2">
                        <div class="bg-purple-500 h-2 rounded-full" style="width: {% widthratio total_synced total_active_users 100 %}%"></div>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">{% widthratio total_synced total_active_users 100 %}% sincronizado</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Com Push Ativo -->
            <div class="stat-card bg-gray-800 rounded-2xl p-6 border border-gray-700">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-400 uppercase tracking-wider">Push Ativo</p>
                        <p class="text-3xl font-bold text-white mt-2">{{ registered_users }}</p>
                        <p class="text-xs text-gray-500 mt-1">dispositivos ativos</p>
                    </div>
                    <div class="w-14 h-14 bg-green-600 rounded-2xl flex items-center justify-center">
                        <i class="fas fa-check-circle text-white text-xl"></i>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-700">
                    <div class="flex items-center text-sm text-gray-400">
                        <i class="fas fa-clock mr-2 text-yellow-500"></i>
                        {{ pending_users }} pendentes
                    </div>
                </div>
            </div>
            
            <!-- Players API -->
            <div class="stat-card bg-gray-800 rounded-2xl p-6 border border-gray-700">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-400 uppercase tracking-wider">Players API</p>
                        <p class="text-3xl font-bold text-white mt-2" id="playerCount">{{ player_count }}</p>
                        <p class="text-xs text-gray-500 mt-1">na API OneSignal</p>
                    </div>
                    <div class="w-14 h-14 bg-red-600 rounded-2xl flex items-center justify-center">
                        <i class="fas fa-mobile-alt text-white text-xl"></i>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-700">
                    <div class="flex items-center text-sm text-gray-400">
                        <i class="fas fa-chart-pie mr-2 text-red-500"></i>
                        {{ success_rate }}% sucesso ({{ total_notifications }} envios)
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Enviar Notifica√ß√£o -->
            <div class="lg:col-span-2">
                <div class="bg-gray-800 rounded-2xl border border-gray-700 overflow-hidden">
                    <div class="px-6 py-5 border-b border-gray-700 bg-gray-800/50">
                        <h2 class="text-lg font-semibold text-white flex items-center">
                            <i class="fas fa-paper-plane text-red-500 mr-3"></i>
                            Enviar Notifica√ß√£o
                        </h2>
                    </div>
                    <div class="p-6">
                        <form id="sendNotificationForm" class="space-y-5">
                            {% csrf_token %}
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">T√≠tulo *</label>
                                <input type="text" name="title" required maxlength="100"
                                    class="w-full px-4 py-3 bg-gray-700 border border-gray-600 text-white rounded-xl focus:ring-2 focus:ring-red-500/50 focus:border-red-500 transition-all placeholder-gray-400"
                                    placeholder="T√≠tulo da notifica√ß√£o">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Mensagem *</label>
                                <textarea name="message" required rows="3" maxlength="500"
                                    class="w-full px-4 py-3 bg-gray-700 border border-gray-600 text-white rounded-xl focus:ring-2 focus:ring-red-500/50 focus:border-red-500 transition-all resize-none placeholder-gray-400"
                                    placeholder="Mensagem da notifica√ß√£o"></textarea>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">URL de Destino</label>
                                    <input type="url" name="url" 
                                        class="w-full px-4 py-3 bg-gray-700 border border-gray-600 text-white rounded-xl focus:ring-2 focus:ring-red-500/50 focus:border-red-500 transition-all placeholder-gray-400"
                                        placeholder="https://exemplo.com/pagina">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Segmento</label>
                                    <select name="segment" 
                                        class="w-full px-4 py-3 bg-gray-700 border border-gray-600 text-white rounded-xl focus:ring-2 focus:ring-red-500/50 focus:border-red-500 transition-all">
                                        <option value="Subscribed Users">Todos Inscritos</option>
                                        <option value="Active Users">Usu√°rios Ativos</option>
                                        <option value="Inactive Users">Usu√°rios Inativos</option>
                                        {% for segment in segments %}
                                        <option value="{{ segment.name }}">{{ segment.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="pt-4">
                                <button type="submit" 
                                    class="w-full inline-flex items-center justify-center px-6 py-3.5 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-xl transition-all shadow-lg">
                                    <i class="fas fa-paper-plane mr-2"></i>
                                    Enviar Notifica√ß√£o
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Notifica√ß√µes Recentes -->
                <div class="bg-gray-800 rounded-2xl border border-gray-700 overflow-hidden mt-8">
                    <div class="px-6 py-5 border-b border-gray-700 bg-gray-800/50">
                        <h2 class="text-lg font-semibold text-white flex items-center">
                            <i class="fas fa-history text-purple-500 mr-3"></i>
                            Notifica√ß√µes Recentes
                        </h2>
                    </div>
                    <div class="divide-y divide-gray-700">
                        {% if recent_notifications %}
                            {% for notif in recent_notifications %}
                            <div class="px-6 py-4 hover:bg-gray-700/50 transition-colors">
                                <div class="flex items-start justify-between gap-4">
                                    <div class="flex-1 min-w-0">
                                        <h4 class="font-medium text-white truncate">{{ notif.headings.en|default:"Sem t√≠tulo" }}</h4>
                                        <p class="text-sm text-gray-400 mt-1 line-clamp-2">{{ notif.contents.en|default:"" }}</p>
                                    </div>
                                    <div class="flex-shrink-0">
                                        <span class="inline-flex items-center px-2.5 py-1 bg-green-600/20 text-green-400 text-xs font-medium rounded-full border border-green-500/30">
                                            {{ notif.successful|default:0 }} entregues
                                        </span>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="px-6 py-12 text-center">
                                <div class="w-16 h-16 bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-inbox text-2xl text-gray-500"></i>
                                </div>
                                <p class="text-gray-400">Nenhuma notifica√ß√£o enviada ainda</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="space-y-6">
                
                <!-- Usu√°rios Sincronizados -->
                <div class="bg-gray-800 rounded-2xl border border-gray-700 overflow-hidden">
                    <div class="px-6 py-5 border-b border-gray-700 bg-gray-800/50">
                        <div class="flex items-center justify-between">
                            <h2 class="text-lg font-semibold text-white flex items-center">
                                <i class="fas fa-user-check text-green-500 mr-3"></i>
                                Usu√°rios
                            </h2>
                            <span class="text-xs bg-gray-700 text-gray-300 px-2.5 py-1 rounded-full font-medium">
                                {{ total_synced|default:0 }} total
                            </span>
                        </div>
                    </div>
                    <div class="max-h-80 overflow-y-auto">
                        {% if onesignal_players %}
                            <div class="divide-y divide-gray-700">
                                {% for player in onesignal_players %}
                                <div class="px-4 py-3 hover:bg-gray-700/50 transition-colors">
                                    <div class="flex items-center gap-3">
                                        <div class="w-9 h-9 bg-gray-700 rounded-full flex items-center justify-center flex-shrink-0 overflow-hidden">
                                            {% if player.user.profile_picture %}
                                            <img src="{{ player.user.profile_picture.url }}" alt="" class="w-9 h-9 rounded-full object-cover">
                                            {% else %}
                                            <i class="fas fa-user text-gray-500 text-sm"></i>
                                            {% endif %}
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm font-medium text-white truncate">{{ player.user.get_full_name|default:player.user.username }}</p>
                                            <p class="text-xs text-gray-500 truncate">{{ player.user.sector.name|default:"Sem setor" }}</p>
                                        </div>
                                        <div class="flex-shrink-0">
                                            {% if player.player_id|slice:":7" == "pending" %}
                                            <span class="px-2 py-0.5 bg-yellow-600/20 text-yellow-400 text-xs rounded-full border border-yellow-500/30">Pendente</span>
                                            {% else %}
                                            <span class="px-2 py-0.5 bg-green-600/20 text-green-400 text-xs rounded-full border border-green-500/30">Ativo</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% if total_synced > 100 %}
                            <div class="px-4 py-3 bg-gray-700/50 text-center">
                                <p class="text-xs text-gray-400">Mostrando 100 de {{ total_synced }} usu√°rios</p>
                            </div>
                            {% endif %}
                        {% else %}
                            <div class="px-6 py-12 text-center">
                                <div class="w-16 h-16 bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-users text-2xl text-gray-500"></i>
                                </div>
                                <p class="text-gray-400 text-sm">Nenhum usu√°rio sincronizado</p>
                                <button onclick="openSyncModal()" class="mt-3 text-red-400 hover:text-red-300 text-sm font-medium">
                                    <i class="fas fa-sync-alt mr-1"></i> Sincronizar agora
                                </button>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- A√ß√µes R√°pidas -->
                <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl p-6 border border-gray-700">
                    <h3 class="font-semibold text-lg text-white mb-4">A√ß√µes R√°pidas</h3>
                    <div class="space-y-3">
                        <button onclick="openSyncModal()" class="w-full flex items-center gap-3 px-4 py-3 bg-blue-600/20 hover:bg-blue-600/30 rounded-xl transition-all border border-blue-500/30 text-blue-400">
                            <i class="fas fa-sync-alt"></i>
                            <span class="text-sm">Sincronizar Todos Usu√°rios</span>
                        </button>
                        <button onclick="testNotification()" class="w-full flex items-center gap-3 px-4 py-3 bg-green-600/20 hover:bg-green-600/30 rounded-xl transition-all border border-green-500/30 text-green-400">
                            <i class="fas fa-vial"></i>
                            <span class="text-sm">Enviar Notifica√ß√£o Teste</span>
                        </button>
                        <a href="https://onesignal.com/login" target="_blank" class="w-full flex items-center gap-3 px-4 py-3 bg-purple-600/20 hover:bg-purple-600/30 rounded-xl transition-all border border-purple-500/30 text-purple-400">
                            <i class="fas fa-external-link-alt"></i>
                            <span class="text-sm">Abrir Painel OneSignal</span>
                        </a>
                    </div>
                </div>
                
                <!-- Info Box -->
                <div class="bg-yellow-600/10 border border-yellow-500/30 rounded-2xl p-5">
                    <div class="flex gap-3">
                        <i class="fas fa-info-circle text-yellow-400 mt-0.5"></i>
                        <div>
                            <h4 class="text-sm font-medium text-yellow-400">Como funciona?</h4>
                            <p class="text-xs text-yellow-200/70 mt-1">
                                1. Sincronize os usu√°rios para criar registros<br>
                                2. Usu√°rios precisam aceitar notifica√ß√µes no navegador<br>
                                3. Status muda de "Pendente" para "Ativo"
                            </p>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
</div>

<!-- Modal de Sincroniza√ß√£o -->
<div id="syncModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeSyncModal()"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
        <div class="relative bg-gray-800 rounded-2xl shadow-2xl max-w-md w-full overflow-hidden border border-gray-700">
            <div class="px-6 py-5 border-b border-gray-700">
                <h3 class="text-xl font-semibold text-white">Sincronizar Todos Usu√°rios</h3>
                <p class="text-sm text-gray-400 mt-1">Criar registros para todos os usu√°rios ativos</p>
            </div>
            <div class="p-6">
                <div id="syncContent">
                    <div class="text-center py-6">
                        <div class="w-20 h-20 bg-blue-600/20 rounded-full flex items-center justify-center mx-auto mb-4 border border-blue-500/30">
                            <i class="fas fa-users text-3xl text-blue-400"></i>
                        </div>
                        <p class="text-gray-300 mb-2">
                            Esta a√ß√£o ir√° criar registros para <strong class="text-white">{{ total_active_users }}</strong> usu√°rios ativos.
                        </p>
                        <p class="text-gray-500 text-sm mb-6">
                            {% if total_synced > 0 %}
                            J√° existem {{ total_synced }} registros sincronizados.
                            {% else %}
                            Nenhum usu√°rio foi sincronizado ainda.
                            {% endif %}
                        </p>
                        <div class="flex gap-3">
                            <button onclick="closeSyncModal()" class="flex-1 px-4 py-2.5 bg-gray-700 text-gray-300 font-medium rounded-xl hover:bg-gray-600 transition-colors border border-gray-600">
                                Cancelar
                            </button>
                            <button onclick="syncUsers()" class="flex-1 px-4 py-2.5 bg-red-600 text-white font-medium rounded-xl hover:bg-red-700 transition-colors">
                                <i class="fas fa-sync-alt mr-2"></i>
                                Sincronizar
                            </button>
                        </div>
                    </div>
                </div>
                <div id="syncLoading" class="hidden text-center py-12">
                    <div class="w-16 h-16 border-4 border-red-600/30 border-t-red-600 rounded-full animate-spin mx-auto mb-4"></div>
                    <p class="text-gray-300">Sincronizando usu√°rios...</p>
                    <p class="text-gray-500 text-sm mt-1">Isso pode levar alguns segundos</p>
                </div>
                <div id="syncResult" class="hidden text-center py-6">
                    <div class="w-20 h-20 bg-green-600/20 rounded-full flex items-center justify-center mx-auto mb-4 border border-green-500/30">
                        <i class="fas fa-check text-3xl text-green-400"></i>
                    </div>
                    <h4 class="text-lg font-semibold text-white mb-2">Sincroniza√ß√£o Conclu√≠da!</h4>
                    <p id="syncResultText" class="text-gray-300 mb-6"></p>
                    <button onclick="closeSyncModal(); location.reload();" class="px-6 py-2.5 bg-green-600 text-white font-medium rounded-xl hover:bg-green-700 transition-colors">
                        <i class="fas fa-check mr-2"></i>Fechar e Atualizar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Modal functions
    function openSyncModal() {
        document.getElementById('syncModal').classList.remove('hidden');
        document.getElementById('syncContent').classList.remove('hidden');
        document.getElementById('syncLoading').classList.add('hidden');
        document.getElementById('syncResult').classList.add('hidden');
    }
    
    function closeSyncModal() {
        document.getElementById('syncModal').classList.add('hidden');
    }
    
    // Sync users
    async function syncUsers() {
        document.getElementById('syncContent').classList.add('hidden');
        document.getElementById('syncLoading').classList.remove('hidden');
        
        try {
            const response = await fetch('{% url "notifications:onesignal_sync_users" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });
            
            const data = await response.json();
            
            document.getElementById('syncLoading').classList.add('hidden');
            document.getElementById('syncResult').classList.remove('hidden');
            
            if (data.success) {
                document.getElementById('syncResultText').innerHTML = `
                    <span class="block text-green-400 text-2xl font-bold">${data.created}</span>
                    <span class="block text-gray-400">novos registros criados</span>
                    <span class="block text-sm text-gray-500 mt-2">${data.existing} j√° existiam ‚Ä¢ ${data.total_users} total</span>
                `;
            } else {
                document.getElementById('syncResultText').textContent = data.error || 'Erro ao sincronizar';
            }
        } catch (error) {
            document.getElementById('syncLoading').classList.add('hidden');
            document.getElementById('syncResult').classList.remove('hidden');
            document.getElementById('syncResultText').textContent = 'Erro de conex√£o';
        }
    }
    
    // Send notification
    document.getElementById('sendNotificationForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const form = e.target;
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Enviando...';
        
        try {
            const formData = new FormData(form);
            const data = {
                title: formData.get('title'),
                message: formData.get('message'),
                url: formData.get('url') || '/',
                segment: formData.get('segment')
            };
            
            const response = await fetch('{% url "notifications:onesignal_send" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('Notifica√ß√£o enviada com sucesso!', 'success');
                form.reset();
            } else {
                showToast(result.error || 'Erro ao enviar notifica√ß√£o', 'error');
            }
        } catch (error) {
            showToast('Erro de conex√£o', 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    });
    
    // Refresh stats
    async function refreshStats() {
        try {
            const response = await fetch('{% url "notifications:onesignal_players" %}');
            const data = await response.json();
            
            if (data.success) {
                document.getElementById('playerCount').textContent = data.count;
                showToast('Estat√≠sticas atualizadas', 'success');
            }
        } catch (error) {
            showToast('Erro ao atualizar estat√≠sticas', 'error');
        }
    }
    
    // Test notification
    async function testNotification() {
        try {
            const response = await fetch('{% url "notifications:onesignal_send" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    title: 'üîî Teste de Notifica√ß√£o',
                    message: 'Esta √© uma notifica√ß√£o de teste do sistema OneSignal.',
                    url: '/',
                    segment: 'Subscribed Users'
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('Notifica√ß√£o de teste enviada!', 'success');
            } else {
                showToast(result.error || 'Erro ao enviar teste', 'error');
            }
        } catch (error) {
            showToast('Erro de conex√£o', 'error');
        }
    }
    
    // Toast notification
    function showToast(message, type = 'info') {
        const colors = {
            success: 'bg-green-600',
            error: 'bg-red-600',
            info: 'bg-blue-600'
        };
        
        const toast = document.createElement('div');
        toast.className = `fixed bottom-4 right-4 px-6 py-3 ${colors[type]} text-white rounded-xl shadow-lg z-50 transform transition-all duration-300 translate-y-full opacity-0`;
        toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} mr-2"></i>${message}`;
        
        document.body.appendChild(toast);
        
        requestAnimationFrame(() => {
            toast.classList.remove('translate-y-full', 'opacity-0');
        });
        
        setTimeout(() => {
            toast.classList.add('translate-y-full', 'opacity-0');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
    
    // Close modal on Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeSyncModal();
        }
    });
    
    // Verificar status de inscri√ß√£o do OneSignal
    let checkAttempts = 0;
    const maxAttempts = 10;
    
    function checkSubscriptionStatus() {
        checkAttempts++;
        console.log('Verificando status de inscri√ß√£o... Tentativa:', checkAttempts);
        
        const banner = document.getElementById('subscriptionBanner');
        
        // Verificar se OneSignal est√° dispon√≠vel
        if (typeof OneSignal !== 'undefined' && OneSignal.User && OneSignal.User.PushSubscription) {
            try {
                // optedIn √© uma propriedade booleana, n√£o uma Promise
                const isSubscribed = OneSignal.User.PushSubscription.optedIn;
                console.log('OneSignal optedIn:', isSubscribed);
                
                if (!isSubscribed && banner) {
                    banner.classList.remove('hidden');
                    console.log('Banner exibido - usu√°rio n√£o inscrito');
                } else if (isSubscribed && banner) {
                    banner.classList.add('hidden');
                    console.log('Banner oculto - usu√°rio j√° inscrito');
                }
            } catch(err) {
                console.log('Erro ao verificar optedIn:', err);
                // Mostrar banner em caso de erro
                if (banner) banner.classList.remove('hidden');
            }
        } else if (checkAttempts < maxAttempts) {
            // Tentar novamente ap√≥s 1 segundo se OneSignal ainda n√£o carregou
            console.log('OneSignal ainda n√£o carregou, tentando novamente...');
            setTimeout(checkSubscriptionStatus, 1000);
        } else {
            // Ap√≥s m√°ximo de tentativas, mostrar banner por padr√£o
            console.log('M√°ximo de tentativas atingido, mostrando banner');
            if (banner) banner.classList.remove('hidden');
        }
    }
    
    // Verificar ap√≥s carregar a p√°gina (iniciar ap√≥s 2 segundos)
    setTimeout(checkSubscriptionStatus, 2000);
    
    // Fun√ß√£o para solicitar permiss√£o
    function requestPushPermissionLocal() {
        console.log('Solicitando permiss√£o de notifica√ß√£o...');
        
        if (typeof OneSignal !== 'undefined' && OneSignal.Slidedown) {
            OneSignal.Slidedown.promptPush()
                .then(function() {
                    console.log('Permiss√£o solicitada via OneSignal');
                    showToast('Permiss√£o solicitada! Verifique o popup do navegador.', 'info');
                    // Esconder banner ap√≥s alguns segundos
                    setTimeout(function() {
                        document.getElementById('subscriptionBanner').classList.add('hidden');
                    }, 3000);
                })
                .catch(function(err) {
                    console.error('Erro ao solicitar permiss√£o:', err);
                    showToast('Erro ao solicitar permiss√£o. Tente novamente.', 'error');
                });
        } else if (typeof window.requestPushPermission === 'function') {
            window.requestPushPermission();
            setTimeout(function() {
                document.getElementById('subscriptionBanner').classList.add('hidden');
            }, 5000);
        } else {
            // Fallback para API nativa do navegador
            if ('Notification' in window) {
                Notification.requestPermission().then(function(permission) {
                    console.log('Permiss√£o nativa:', permission);
                    if (permission === 'granted') {
                        showToast('Notifica√ß√µes ativadas!', 'success');
                        document.getElementById('subscriptionBanner').classList.add('hidden');
                    }
                });
            } else {
                showToast('OneSignal ainda n√£o carregou. Aguarde e tente novamente.', 'info');
            }
        }
    }
</script>
{% endblock %}