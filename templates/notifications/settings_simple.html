{% extends 'base.html' %}

{% block title %}Configurações de Notificações{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Hidden form for CSRF token -->
    <form style="display: none;">
        {% csrf_token %}
    </form>
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-2xl font-bold text-gray-900 mb-6">
                <i class="fas fa-bell mr-2"></i>
                Configurações de Notificações
            </h1>

            <!-- Preferências de Notificação -->
            <form method="POST" class="mb-8">
                {% csrf_token %}
                
                <!-- Canais de Notificação -->
                <div class="bg-gray-50 rounded-lg p-6 mb-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-broadcast-tower mr-2"></i>
                        Canais de Notificação
                    </h2>
                    <p class="text-sm text-gray-600 mb-4">Escolha como deseja receber suas notificações:</p>
                    
                    <div class="space-y-3">
                        <label class="flex items-center justify-between p-3 bg-white rounded border hover:bg-blue-50 cursor-pointer">
                            <div class="flex items-center">
                                <i class="fas fa-desktop text-blue-500 mr-3"></i>
                                <div>
                                    <span class="font-medium">Notificações In-App</span>
                                    <p class="text-sm text-gray-500">Notificações dentro do sistema (sino)</p>
                                </div>
                            </div>
                            <input type="checkbox" name="in_app_enabled" class="h-5 w-5 text-blue-600 rounded"
                                   {% if preferences.in_app_enabled %}checked{% endif %}>
                        </label>
                        
                        <label class="flex items-center justify-between p-3 bg-white rounded border hover:bg-blue-50 cursor-pointer">
                            <div class="flex items-center">
                                <i class="fas fa-mobile-alt text-green-500 mr-3"></i>
                                <div>
                                    <span class="font-medium">Push Notifications</span>
                                    <p class="text-sm text-gray-500">Notificações no celular e navegador</p>
                                </div>
                            </div>
                            <input type="checkbox" name="push_enabled" class="h-5 w-5 text-blue-600 rounded"
                                   {% if preferences.push_enabled %}checked{% endif %}>
                        </label>
                        
                        <label class="flex items-center justify-between p-3 bg-white rounded border hover:bg-blue-50 cursor-pointer">
                            <div class="flex items-center">
                                <i class="fas fa-envelope text-red-500 mr-3"></i>
                                <div>
                                    <span class="font-medium">Email</span>
                                    <p class="text-sm text-gray-500">Notificações importantes por email</p>
                                </div>
                            </div>
                            <input type="checkbox" name="email_enabled" class="h-5 w-5 text-blue-600 rounded"
                                   {% if preferences.email_enabled %}checked{% endif %}>
                        </label>
                    </div>
                </div>
                
                <!-- Tipos de Notificação -->
                <div class="bg-gray-50 rounded-lg p-6 mb-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-list-check mr-2"></i>
                        Tipos de Notificação
                    </h2>
                    <p class="text-sm text-gray-600 mb-4">Selecione quais tipos de eventos você deseja receber:</p>
                    
                    <div class="space-y-3">
                        <label class="flex items-center justify-between p-3 bg-white rounded border hover:bg-blue-50 cursor-pointer">
                            <div class="flex items-center">
                                <i class="fas fa-ticket-alt text-blue-500 mr-3"></i>
                                <div>
                                    <span class="font-medium">Novos Chamados</span>
                                    <p class="text-sm text-gray-500">Quando um chamado é criado no seu setor</p>
                                </div>
                            </div>
                            <input type="checkbox" name="ticket_created" class="h-5 w-5 text-blue-600 rounded"
                                   {% if preferences.ticket_created %}checked{% endif %}>
                        </label>
                        
                        <label class="flex items-center justify-between p-3 bg-white rounded border hover:bg-blue-50 cursor-pointer">
                            <div class="flex items-center">
                                <i class="fas fa-user-tag text-purple-500 mr-3"></i>
                                <div>
                                    <span class="font-medium">Atribuição de Chamados</span>
                                    <p class="text-sm text-gray-500">Quando você é atribuído a um chamado</p>
                                </div>
                            </div>
                            <input type="checkbox" name="ticket_assigned" class="h-5 w-5 text-blue-600 rounded"
                                   {% if preferences.ticket_assigned %}checked{% endif %}>
                        </label>
                        
                        <label class="flex items-center justify-between p-3 bg-white rounded border hover:bg-blue-50 cursor-pointer">
                            <div class="flex items-center">
                                <i class="fas fa-exchange-alt text-orange-500 mr-3"></i>
                                <div>
                                    <span class="font-medium">Mudança de Status</span>
                                    <p class="text-sm text-gray-500">Quando o status do seu chamado muda</p>
                                </div>
                            </div>
                            <input type="checkbox" name="ticket_status_changed" class="h-5 w-5 text-blue-600 rounded"
                                   {% if preferences.ticket_status_changed %}checked{% endif %}>
                        </label>
                        
                        <label class="flex items-center justify-between p-3 bg-white rounded border hover:bg-blue-50 cursor-pointer">
                            <div class="flex items-center">
                                <i class="fas fa-comment text-teal-500 mr-3"></i>
                                <div>
                                    <span class="font-medium">Novos Comentários</span>
                                    <p class="text-sm text-gray-500">Quando há novos comentários nos seus chamados</p>
                                </div>
                            </div>
                            <input type="checkbox" name="ticket_comment" class="h-5 w-5 text-blue-600 rounded"
                                   {% if preferences.ticket_comment %}checked{% endif %}>
                        </label>
                        
                        <label class="flex items-center justify-between p-3 bg-white rounded border hover:bg-blue-50 cursor-pointer">
                            <div class="flex items-center">
                                <i class="fas fa-bullhorn text-yellow-500 mr-3"></i>
                                <div>
                                    <span class="font-medium">Novos Comunicados</span>
                                    <p class="text-sm text-gray-500">Comunicados enviados para você</p>
                                </div>
                            </div>
                            <input type="checkbox" name="communication_new" class="h-5 w-5 text-blue-600 rounded"
                                   {% if preferences.communication_new %}checked{% endif %}>
                        </label>
                    </div>
                </div>
                
                <!-- Horário Silencioso -->
                <div class="bg-gray-50 rounded-lg p-6 mb-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-moon mr-2"></i>
                        Horário Silencioso
                    </h2>
                    <p class="text-sm text-gray-600 mb-4">Pause as notificações durante um período específico:</p>
                    
                    <label class="flex items-center mb-4">
                        <input type="checkbox" name="quiet_hours_enabled" class="h-5 w-5 text-blue-600 rounded mr-3"
                               {% if preferences.quiet_hours_enabled %}checked{% endif %}
                               onchange="toggleQuietHours(this.checked)">
                        <span class="font-medium">Ativar horário silencioso</span>
                    </label>
                    
                    <div id="quietHoursInputs" class="flex space-x-4 {% if not preferences.quiet_hours_enabled %}opacity-50{% endif %}">
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">Início</label>
                            <input type="time" name="quiet_hours_start" 
                                   value="{{ preferences.quiet_hours_start|time:'H:i'|default:'22:00' }}"
                                   class="border rounded px-3 py-2"
                                   {% if not preferences.quiet_hours_enabled %}disabled{% endif %}>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">Fim</label>
                            <input type="time" name="quiet_hours_end"
                                   value="{{ preferences.quiet_hours_end|time:'H:i'|default:'07:00' }}"
                                   class="border rounded px-3 py-2"
                                   {% if not preferences.quiet_hours_enabled %}disabled{% endif %}>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="w-full bg-primary hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                    <i class="fas fa-save mr-2"></i>Salvar Preferências
                </button>
            </form>

            <!-- Push Notifications Section -->
            <div class="bg-gray-50 rounded-lg p-6 mb-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fas fa-mobile-alt mr-2"></i>
                    Notificações Push no Navegador
                </h2>
                
                <div id="pushNotificationStatus">
                    <div class="flex items-center justify-between p-4 bg-yellow-100 rounded-lg">
                        <div>
                            <h3 class="font-medium text-yellow-800">Status: Desabilitado</h3>
                            <p class="text-sm text-yellow-700">Ative as notificações push para receber alertas em tempo real</p>
                        </div>
                        <button id="enablePushBtn" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-bell mr-2"></i>Ativar Notificações
                        </button>
                    </div>
                </div>
            </div>

            <!-- Device Tokens Section -->
            <div class="bg-gray-50 rounded-lg p-6 mb-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fas fa-devices mr-2"></i>
                    Dispositivos Registrados
                </h2>
                
                <div id="deviceTokensList">
                    {% if user_tokens %}
                        {% for token in user_tokens %}
                        <div class="flex items-center justify-between p-3 bg-white rounded border mb-2">
                            <div>
                                <div class="font-medium">{{ token.get_device_type_display }}</div>
                                <div class="text-sm text-gray-500">
                                    Último uso: {{ token.last_used|date:"d/m/Y H:i" }}
                                </div>
                            </div>
                            <div class="flex items-center">
                                <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full mr-2">
                                    Ativo
                                </span>
                                <button onclick="deleteDevice({{ token.id }})" 
                                        class="text-red-600 hover:text-red-800 p-1 rounded transition-colors"
                                        title="Remover dispositivo">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-mobile-alt text-4xl mb-4"></i>
                            <p>Nenhum dispositivo registrado</p>
                            <p class="text-sm">Ative as notificações push para registrar este dispositivo</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Test Section -->
            <div class="bg-gray-50 rounded-lg p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fas fa-vial mr-2"></i>
                    Teste de Notificações
                </h2>
                
                <p class="text-gray-600 mb-4">
                    Teste se as notificações push estão funcionando corretamente neste dispositivo.
                </p>
                
                <button id="testNotificationBtn" 
                        class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-paper-plane mr-2"></i>Enviar Notificação de Teste
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function toggleQuietHours(enabled) {
    const inputs = document.getElementById('quietHoursInputs');
    inputs.classList.toggle('opacity-50', !enabled);
    inputs.querySelectorAll('input').forEach(input => input.disabled = !enabled);
}

document.addEventListener('DOMContentLoaded', function() {
    const enablePushBtn = document.getElementById('enablePushBtn');
    const testNotificationBtn = document.getElementById('testNotificationBtn');
    const pushStatusDiv = document.getElementById('pushNotificationStatus');
    
    // Verificar status atual das notificações apenas uma vez
    if (!sessionStorage.getItem('notification_status_checked')) {
        checkNotificationStatus();
        sessionStorage.setItem('notification_status_checked', 'true');
    } else {
        // Se já foi verificado, apenas atualizar o status sem mensagens
        checkNotificationStatusSilent();
    }
    
    // Ativar notificações push
    enablePushBtn.addEventListener('click', enablePushNotifications);
    
    // Testar notificação
    testNotificationBtn.addEventListener('click', testNotification);
    
    async function checkNotificationStatus() {
        if (!('Notification' in window)) {
            updateStatus('unsupported');
            return;
        }
        
        if (Notification.permission === 'denied') {
            updateStatus('denied');
            return;
        }
        
        if (Notification.permission !== 'granted') {
            updateStatus('default');
            return;
        }
        
        // Se a permissão está concedida, verificar se temos Service Worker e subscription
        try {
            if (!('serviceWorker' in navigator)) {
                updateStatus('error');
                return;
            }
            
            const registration = await navigator.serviceWorker.getRegistration('/');
            if (!registration) {
                updateStatus('error');
                return;
            }
            
            const subscription = await registration.pushManager.getSubscription();
            if (!subscription) {
                updateStatus('error');
                return;
            }
            
            // Tudo OK - notificações estão funcionando
            updateStatus('granted');
            
        } catch (error) {
            console.error('Erro ao verificar status:', error);
            updateStatus('error');
        }
    }
    
    async function checkNotificationStatusSilent() {
        if (!('Notification' in window)) {
            updateStatusSilent('unsupported');
            return;
        }
        
        if (Notification.permission === 'denied') {
            updateStatusSilent('denied');
            return;
        }
        
        if (Notification.permission !== 'granted') {
            updateStatusSilent('default');
            return;
        }
        
        // Se a permissão está concedida, verificar se temos Service Worker e subscription
        try {
            if (!('serviceWorker' in navigator)) {
                updateStatusSilent('error');
                return;
            }
            
            const registration = await navigator.serviceWorker.getRegistration('/');
            if (!registration) {
                updateStatusSilent('error');
                return;
            }
            
            const subscription = await registration.pushManager.getSubscription();
            if (!subscription) {
                updateStatusSilent('error');
                return;
            }
            
            // Tudo OK - notificações estão funcionando
            updateStatusSilent('granted');
            
        } catch (error) {
            console.log('Status das notificações verificado silenciosamente');
            updateStatusSilent('error');
        }
    }
    
    function updateStatus(status) {
        const statusMap = {
            'granted': {
                title: 'Status: Ativado',
                description: 'Notificações push estão ativadas neste dispositivo',
                color: 'green',
                showButton: false
            },
            'denied': {
                title: 'Status: Bloqueado',
                description: 'Notificações foram bloqueadas. Ative nas configurações do navegador.',
                color: 'red',
                showButton: false
            },
            'default': {
                title: 'Status: Desabilitado',
                description: 'Ative as notificações push para receber alertas em tempo real',
                color: 'yellow',
                showButton: true
            },
            'error': {
                title: 'Status: Erro de Configuração',
                description: 'Service Worker não registrado corretamente. Clique para reativar.',
                color: 'orange',
                showButton: true
            },
            'unsupported': {
                title: 'Status: Não Suportado',
                description: 'Seu navegador não suporta notificações push',
                color: 'gray',
                showButton: false
            }
        };
        
        const config = statusMap[status];
        const colorClasses = {
            'green': 'bg-green-100 text-green-800',
            'red': 'bg-red-100 text-red-800',
            'yellow': 'bg-yellow-100 text-yellow-800',
            'orange': 'bg-orange-100 text-orange-800',
            'gray': 'bg-gray-100 text-gray-800'
        };
        
        pushStatusDiv.innerHTML = `
            <div class="flex items-center justify-between p-4 ${colorClasses[config.color]} rounded-lg">
                <div>
                    <h3 class="font-medium">${config.title}</h3>
                    <p class="text-sm">${config.description}</p>
                </div>
                ${config.showButton ? `
                    <button id="enablePushBtn" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-bell mr-2"></i>Ativar Notificações
                    </button>
                ` : ''}
            </div>
        `;
        
        // Re-attach event listener if button was recreated
        if (config.showButton) {
            document.getElementById('enablePushBtn').addEventListener('click', enablePushNotifications);
        }
    }
    
    function updateStatusSilent(status) {
        const statusMap = {
            'granted': {
                title: 'Status: Ativado',
                description: 'Notificações push estão ativadas neste dispositivo',
                color: 'green',
                showButton: false
            },
            'denied': {
                title: 'Status: Bloqueado',
                description: 'Notificações foram bloqueadas. Ative nas configurações do navegador.',
                color: 'red',
                showButton: false
            },
            'default': {
                title: 'Status: Desabilitado',
                description: 'Ative as notificações push para receber alertas em tempo real',
                color: 'yellow',
                showButton: true
            },
            'error': {
                title: 'Status: Requer Configuração',
                description: 'Clique para configurar as notificações push',
                color: 'orange',
                showButton: true
            },
            'unsupported': {
                title: 'Status: Não Suportado',
                description: 'Seu navegador não suporta notificações push',
                color: 'gray',
                showButton: false
            }
        };
        
        const config = statusMap[status];
        const colorClasses = {
            'green': 'bg-green-100 text-green-800',
            'red': 'bg-red-100 text-red-800',
            'yellow': 'bg-yellow-100 text-yellow-800',
            'orange': 'bg-orange-100 text-orange-800',
            'gray': 'bg-gray-100 text-gray-800'
        };
        
        pushStatusDiv.innerHTML = `
            <div class="flex items-center justify-between p-4 ${colorClasses[config.color]} rounded-lg">
                <div>
                    <h3 class="font-medium">${config.title}</h3>
                    <p class="text-sm">${config.description}</p>
                </div>
                ${config.showButton ? `
                    <button id="enablePushBtn" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-bell mr-2"></i>Ativar Notificações
                    </button>
                ` : ''}
            </div>
        `;
        
        // Re-attach event listener if button was recreated
        if (config.showButton) {
            document.getElementById('enablePushBtn').addEventListener('click', enablePushNotifications);
        }
    }
    
    async function enablePushNotifications() {
        const enableBtn = document.getElementById('enablePushBtn');
        
        try {
            enableBtn.disabled = true;
            enableBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Ativando...';
            
            // Verificar suporte primeiro
            if (!('serviceWorker' in navigator)) {
                throw new Error('Service Worker não é suportado neste navegador');
            }
            
            if (!('PushManager' in window)) {
                throw new Error('Push messaging não é suportado neste navegador');
            }
            
            if (!('Notification' in window)) {
                throw new Error('Notificações não são suportadas neste navegador');
            }
            
            // Solicitar permissão
            console.log('Solicitando permissão...');
            const permission = await Notification.requestPermission();
            console.log('Permissão:', permission);
            
            if (permission !== 'granted') {
                if (permission === 'denied') {
                    throw new Error('Permissão para notificações foi negada. Ative nas configurações do navegador.');
                } else {
                    throw new Error('Permissão para notificações não foi concedida.');
                }
            }
            
            console.log('Registrando service worker...');
            
            // Registrar service worker
            const registration = await navigator.serviceWorker.register('/sw.js', {
                scope: '/'
            });
            
            console.log('Service worker registrado:', registration);
            
            // Aguardar o service worker estar ativo
            await waitForServiceWorker(registration);
            
            console.log('Service worker ativo, criando subscription...');
            
            // Verificar se já existe uma subscription
            let subscription = await registration.pushManager.getSubscription();
            
            if (!subscription) {
                // Criar nova subscription
                subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array('{{ vapid_public_key }}')
                });
            }
            
            console.log('Subscription obtida:', subscription);
            
            // Obter CSRF token
            const csrfToken = getCSRFToken();
            if (!csrfToken) {
                throw new Error('Token CSRF não encontrado');
            }
            
            // Enviar subscription para o servidor
            const response = await fetch('/notifications/register-device/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    subscription: subscription,
                    device_info: {
                        userAgent: navigator.userAgent,
                        platform: navigator.platform,
                        timestamp: new Date().toISOString()
                    }
                })
            });
            
            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
                updateStatus('granted');
                // Mostrar mensagem de sucesso sem alert
                showSuccessMessage('Notificações push ativadas com sucesso!');
                // Recarregar após 2 segundos
                setTimeout(() => location.reload(), 2000);
            } else {
                throw new Error(data.error || 'Erro desconhecido ao registrar dispositivo');
            }
            
        } catch (error) {
            console.error('Erro ao ativar push notifications:', error);
            updateStatus('error');
            showErrorMessage('Erro ao ativar notificações: ' + error.message);
        } finally {
            enableBtn.disabled = false;
            enableBtn.innerHTML = '<i class="fas fa-bell mr-2"></i>Ativar Notificações Push';
        }
    }
    
    async function waitForServiceWorker(registration) {
        return new Promise((resolve, reject) => {
            let timeout;
            
            function cleanup() {
                if (timeout) clearTimeout(timeout);
            }
            
            // Timeout de 10 segundos
            timeout = setTimeout(() => {
                cleanup();
                reject(new Error('Timeout ao aguardar Service Worker'));
            }, 10000);
            
            if (registration.active) {
                cleanup();
                resolve();
                return;
            }
            
            const serviceWorker = registration.installing || registration.waiting;
            if (serviceWorker) {
                serviceWorker.addEventListener('statechange', function() {
                    if (this.state === 'activated') {
                        cleanup();
                        resolve();
                    } else if (this.state === 'redundant') {
                        cleanup();
                        reject(new Error('Service Worker falhou ao ativar'));
                    }
                });
            } else {
                // Tentar aguardar por um novo service worker
                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    if (newWorker) {
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'activated') {
                                cleanup();
                                resolve();
                            }
                        });
                    }
                });
                
                // Fallback: aguardar 2 segundos
                setTimeout(() => {
                    if (registration.active) {
                        cleanup();
                        resolve();
                    } else {
                        cleanup();
                        reject(new Error('Service Worker não foi ativado'));
                    }
                }, 2000);
            }
        });
    }
    
    function getCSRFToken() {
        // Tentar diferentes formas de obter o CSRF token
        let token = null;
        
        // 1. Input hidden
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            token = csrfInput.value;
        }
        
        // 2. Meta tag
        if (!token) {
            const csrfMeta = document.querySelector('meta[name=csrf-token]');
            if (csrfMeta) {
                token = csrfMeta.getAttribute('content');
            }
        }
        
        // 3. Cookie
        if (!token) {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') {
                    token = value;
                    break;
                }
            }
        }
        
        return token;
    }
    
    async function testNotification() {
        if (Notification.permission !== 'granted') {
            alert('Ative as notificações push primeiro!');
            return;
        }
        
        try {
            testNotificationBtn.disabled = true;
            testNotificationBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Enviando...';
            
            // Obter CSRF token
            const csrfToken = getCSRFToken();
            if (!csrfToken) {
                throw new Error('Token CSRF não encontrado. Recarregue a página.');
            }
            
            // Usar FormData em vez de JSON
            const formData = new FormData();
            formData.append('title', 'Teste de Notificação');
            formData.append('message', 'Esta é uma notificação de teste do sistema!');
            
            // Enviar solicitação de teste
            const response = await fetch('/notifications/api/test-push/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                },
                body: formData
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
                showSuccessMessage('Notificação de teste enviada! Verifique se apareceu no seu dispositivo.');
            } else {
                showErrorMessage('Erro ao enviar notificação de teste: ' + data.error);
            }
        } catch (error) {
            console.error('Erro ao testar notificação:', error);
            showErrorMessage('Erro ao testar notificação: ' + error.message);
        } finally {
            testNotificationBtn.disabled = false;
            testNotificationBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Enviar Notificação de Teste';
        }
    }
    
    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding)
            .replace(/\-/g, '+')
            .replace(/_/g, '/');
        
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        
        for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
    }
    
    // Funções para mostrar mensagens
    function showSuccessMessage(message) {
        removeExistingMessages();
        const messageDiv = createMessageDiv(message, 'success');
        document.body.appendChild(messageDiv);
        
        // Auto-remover após 5 segundos
        setTimeout(() => {
            if (messageDiv.parentElement) {
                messageDiv.remove();
            }
        }, 5000);
    }
    
    function showErrorMessage(message) {
        removeExistingMessages();
        const messageDiv = createMessageDiv(message, 'error');
        document.body.appendChild(messageDiv);
        
        // Auto-remover após 7 segundos
        setTimeout(() => {
            if (messageDiv.parentElement) {
                messageDiv.remove();
            }
        }, 7000);
    }
    
    function createMessageDiv(message, type) {
        const div = document.createElement('div');
        div.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm transition-all duration-300 transform translate-x-full`;
        
        if (type === 'success') {
            div.className += ' bg-green-500 text-white';
            div.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-auto text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        } else {
            div.className += ' bg-red-500 text-white';
            div.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-auto text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        }
        
        // Animar entrada
        setTimeout(() => {
            div.classList.remove('translate-x-full');
        }, 100);
        
        return div;
    }
    
    function removeExistingMessages() {
        const existingMessages = document.querySelectorAll('.fixed.top-4.right-4');
        existingMessages.forEach(msg => msg.remove());
    }
});

// Função para deletar dispositivo
async function deleteDevice(tokenId) {
    if (!confirm('Tem certeza que deseja remover este dispositivo? Você não receberá mais notificações nele.')) {
        return;
    }
    
    try {
        const response = await fetch(`/notifications/delete-device/${tokenId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Recarregar a página para atualizar a lista
            window.location.reload();
        } else {
            alert('Erro ao remover dispositivo: ' + data.error);
        }
    } catch (error) {
        console.error('Erro ao remover dispositivo:', error);
        alert('Erro ao remover dispositivo: ' + error.message);
    }
}
</script>
{% endblock %}