{% extends 'base.html' %}
{% load static %}

{% block title %}Gerenciar Notificações{% endblock %}

{% block extra_css %}
<style>
    .notification-admin-item {
        transition: all 0.3s ease;
    }
    
    .notification-admin-item:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        transition: transform 0.3s ease;
    }
    
    .stats-card:hover {
        transform: scale(1.02);
    }
    
    .type-badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }
    
    .type-system { background: #e0f2fe; color: #0277bd; }
    .type-ticket { background: #f3e5f5; color: #7b1fa2; }
    .type-communication { background: #e8f5e8; color: #2e7d32; }
    .type-custom { background: #fff3e0; color: #f57c00; }
</style>
{% endblock %}

{% block content %}
<div class="p-4 sm:p-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6 space-y-4 sm:space-y-0">
        <div class="min-w-0 flex-1">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">
                <i class="fas fa-cogs text-blue-500 mr-2"></i>
                Gerenciar Notificações
            </h1>
            <p class="text-gray-600 mt-1 text-sm sm:text-base">Painel administrativo do sistema de notificações</p>
        </div>
        
        <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
            <button onclick="showCreateModal()" 
                    class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-3 sm:px-4 rounded-lg transition-colors text-sm sm:text-base">
                <i class="fas fa-plus mr-1 sm:mr-2"></i>Nova Notificação
            </button>
            
            <a href="{% url 'notifications:dashboard' %}" 
               class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-3 sm:px-4 rounded-lg transition-colors text-sm sm:text-base text-center">
                <i class="fas fa-arrow-left mr-1 sm:mr-2"></i>Voltar
            </a>
        </div>
    </div>

    <!-- Estatísticas -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-6 sm:mb-8">
        <div class="stats-card text-white rounded-lg p-4 sm:p-6">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-xl sm:text-2xl font-bold">{{ total_notifications }}</h3>
                    <p class="opacity-90 text-sm sm:text-base">Total Criadas</p>
                </div>
                <i class="fas fa-bell text-2xl sm:text-3xl opacity-75"></i>
            </div>
        </div>
        
        <div class="bg-gradient-to-r from-green-500 to-teal-600 text-white rounded-lg p-4 sm:p-6">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-xl sm:text-2xl font-bold">{{ active_notifications }}</h3>
                    <p class="opacity-90 text-sm sm:text-base">Ativas</p>
                </div>
                <i class="fas fa-check-circle text-2xl sm:text-3xl opacity-75"></i>
            </div>
        </div>
        
        <div class="bg-gradient-to-r from-orange-500 to-red-600 text-white rounded-lg p-4 sm:p-6">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-xl sm:text-2xl font-bold">{{ pending_notifications }}</h3>
                    <p class="opacity-90 text-sm sm:text-base">Pendentes</p>
                </div>
                <i class="fas fa-clock text-2xl sm:text-3xl opacity-75"></i>
            </div>
        </div>
        
        <div class="bg-gradient-to-r from-purple-500 to-pink-600 text-white rounded-lg p-4 sm:p-6">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-xl sm:text-2xl font-bold">{{ total_users_notified }}</h3>
                    <p class="opacity-90 text-sm sm:text-base truncate">Usuários Notificados</p>
                </div>
                <i class="fas fa-users text-2xl sm:text-3xl opacity-75"></i>
            </div>
        </div>
    </div>

    <!-- Lista de Notificações -->
    <div class="bg-white rounded-lg shadow-lg">
        <div class="px-4 sm:px-6 py-4 border-b border-gray-200">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center space-y-2 sm:space-y-0">
                <h2 class="text-lg sm:text-xl font-semibold">
                    <i class="fas fa-list text-gray-500 mr-2"></i>
                    Todas as Notificações
                </h2>
                
                <!-- Filtros -->
                <div class="flex gap-2">
                    <select id="typeFilter" onchange="filterNotifications()" 
                            class="border border-gray-300 rounded px-3 py-1 text-sm">
                        <option value="">Todos os Tipos</option>
                        <option value="SYSTEM">Sistema</option>
                        <option value="TICKET">Chamado</option>
                        <option value="COMMUNICATION">Comunicado</option>
                        <option value="CUSTOM">Personalizada</option>
                    </select>
                    
                    <select id="statusFilter" onchange="filterNotifications()" 
                            class="border border-gray-300 rounded px-3 py-1 text-sm">
                        <option value="">Todos os Status</option>
                        <option value="ACTIVE">Ativa</option>
                        <option value="PENDING">Pendente</option>
                        <option value="EXPIRED">Expirada</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="p-6">
            {% if notifications %}
            <div class="space-y-4" id="notificationsList">
                {% for notification in notifications %}
                <div class="notification-admin-item bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all"
                     data-type="{{ notification.type }}" data-status="{{ notification.status }}">
                    
                    <div class="flex items-start justify-between">
                        <div class="flex items-start space-x-4 flex-1">
                            <!-- Ícone -->
                            <div class="flex-shrink-0">
                                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                    <i class="{{ notification.icon }} text-blue-600"></i>
                                </div>
                            </div>
                            
                            <!-- Conteúdo -->
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center justify-between mb-2">
                                    <h3 class="text-lg font-semibold text-gray-900">
                                        {{ notification.title }}
                                    </h3>
                                    
                                    <div class="flex items-center space-x-2">
                                        <!-- Tipo -->
                                        <span class="type-badge type-{{ notification.type|lower }}">
                                            {{ notification.get_type_display }}
                                        </span>
                                        
                                        <!-- Status -->
                                        {% if notification.status == 'ACTIVE' %}
                                        <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium">
                                            <i class="fas fa-check-circle mr-1"></i>Ativa
                                        </span>
                                        {% elif notification.status == 'PENDING' %}
                                        <span class="bg-orange-100 text-orange-800 px-2 py-1 rounded-full text-xs font-medium">
                                            <i class="fas fa-clock mr-1"></i>Pendente
                                        </span>
                                        {% elif notification.status == 'EXPIRED' %}
                                        <span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-medium">
                                            <i class="fas fa-times-circle mr-1"></i>Expirada
                                        </span>
                                        {% endif %}
                                        
                                        <!-- Prioridade -->
                                        {% if notification.priority == 'HIGH' %}
                                        <span class="bg-orange-100 text-orange-800 px-2 py-1 rounded-full text-xs font-medium">
                                            <i class="fas fa-exclamation mr-1"></i>Alta
                                        </span>
                                        {% elif notification.priority == 'URGENT' %}
                                        <span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-medium">
                                            <i class="fas fa-exclamation-triangle mr-1"></i>Urgente
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="text-gray-600 mb-3">{{ notification.message|safe }}</div>
                                
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-gray-500">
                                    <div>
                                        <i class="fas fa-clock mr-1"></i>
                                        {{ notification.created_at|date:"d/m/Y H:i" }}
                                    </div>
                                    
                                    <div>
                                        <i class="fas fa-user mr-1"></i>
                                        {{ notification.created_by.first_name|default:notification.created_by.username }}
                                    </div>
                                    
                                    <div>
                                        <i class="fas fa-users mr-1"></i>
                                        {{ notification.usernotification_set.count }} usuário{{ notification.usernotification_set.count|pluralize }}
                                    </div>
                                    
                                    <div>
                                        <i class="fas fa-eye mr-1"></i>
                                        {{ notification.read_count }} lida{{ notification.read_count|pluralize }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Ações -->
                        <div class="flex items-center space-x-2 ml-4">
                            <button onclick="viewDetails({{ notification.id }})" 
                                    class="text-blue-600 hover:text-blue-800 transition-colors"
                                    title="Ver detalhes">
                                <i class="fas fa-eye"></i>
                            </button>
                            
                            {% if notification.status == 'PENDING' %}
                            <button onclick="activateNotification({{ notification.id }})" 
                                    class="text-green-600 hover:text-green-800 transition-colors"
                                    title="Ativar notificação">
                                <i class="fas fa-play"></i>
                            </button>
                            {% endif %}
                            
                            {% if notification.status == 'ACTIVE' %}
                            <button onclick="deactivateNotification({{ notification.id }})" 
                                    class="text-orange-600 hover:text-orange-800 transition-colors"
                                    title="Desativar notificação">
                                <i class="fas fa-pause"></i>
                            </button>
                            {% endif %}
                            
                            <button onclick="deleteNotification({{ notification.id }})" 
                                    class="text-red-600 hover:text-red-800 transition-colors"
                                    title="Excluir notificação">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-12">
                <i class="fas fa-bell-slash text-gray-300 text-6xl mb-4"></i>
                <h3 class="text-xl font-medium text-gray-500 mb-2">Nenhuma notificação criada</h3>
                <p class="text-gray-400">Comece criando sua primeira notificação personalizada.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal de Criação -->
<div id="createModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-xl font-semibold">Nova Notificação</h3>
        </div>
        
        <form id="createForm" class="p-6">
            {% csrf_token %}
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Título</label>
                <input type="text" name="title" required 
                       class="w-full border border-gray-300 rounded-lg px-3 py-2">
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Mensagem</label>
                <textarea name="message" required rows="3" 
                          class="w-full border border-gray-300 rounded-lg px-3 py-2"></textarea>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                <select name="type" required class="w-full border border-gray-300 rounded-lg px-3 py-2">
                    <option value="CUSTOM">Personalizada</option>
                    <option value="SYSTEM">Sistema</option>
                </select>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                <select name="priority" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                    <option value="NORMAL">Normal</option>
                    <option value="HIGH">Alta</option>
                    <option value="URGENT">Urgente</option>
                </select>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Ícone (FontAwesome)</label>
                <input type="text" name="icon" value="fas fa-info-circle" 
                       class="w-full border border-gray-300 rounded-lg px-3 py-2">
            </div>
            
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="hideCreateModal()" 
                        class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                    Cancelar
                </button>
                <button type="submit" 
                        class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                    Criar Notificação
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function showCreateModal() {
    document.getElementById('createModal').classList.remove('hidden');
}

function hideCreateModal() {
    document.getElementById('createModal').classList.add('hidden');
    document.getElementById('createForm').reset();
}

function filterNotifications() {
    const typeFilter = document.getElementById('typeFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const items = document.querySelectorAll('.notification-admin-item');
    
    items.forEach(item => {
        const type = item.dataset.type;
        const status = item.dataset.status;
        
        const typeMatch = !typeFilter || type === typeFilter;
        const statusMatch = !statusFilter || status === statusFilter;
        
        if (typeMatch && statusMatch) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

function activateNotification(id) {
    if (confirm('Ativar esta notificação?')) {
        updateNotificationStatus(id, 'ACTIVE');
    }
}

function deactivateNotification(id) {
    if (confirm('Desativar esta notificação?')) {
        updateNotificationStatus(id, 'EXPIRED');
    }
}

function updateNotificationStatus(id, status) {
    fetch(`/notifications/update-status/${id}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ status: status })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Erro ao atualizar status da notificação');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao atualizar status da notificação');
    });
}

function deleteNotification(id) {
    if (confirm('Tem certeza que deseja excluir esta notificação?')) {
        fetch(`/notifications/delete/${id}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Erro ao excluir notificação');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao excluir notificação');
        });
    }
}

function viewDetails(id) {
    // Implementar modal de detalhes se necessário
    alert('Funcionalidade de detalhes em desenvolvimento');
}

// Submissão do formulário de criação
document.getElementById('createForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('/notifications/create/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            hideCreateModal();
            location.reload();
        } else {
            alert('Erro ao criar notificação: ' + (data.error || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao criar notificação');
    });
});
</script>
{% endblock %}