<!DOCTYPE html>
{% load static %}
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Rede Confiança - Portal{% endblock %}</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="{% static 'manifest.json' %}">
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Rede Confiança">
    <meta name="theme-color" content="#FF6B35">
    <meta name="msapplication-navbutton-color" content="#FF6B35">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Favicon -->
    <link rel="apple-touch-icon" href="{% static 'images/logo3.png' %}">
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'images/logo3.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'images/logo3.png' %}">
    <link rel="shortcut icon" href="{% static 'images/logo3.png' %}">
    
    <!-- Google Fonts - Montserrat -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Montserrat', 'ui-sans-serif', 'system-ui'],
                        'montserrat': ['Montserrat', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#FF6B35',
                        'secondary': '#2C3E50',
                        'success': '#27AE60',
                        'warning': '#F39C12',
                        'danger': '#E74C3C',
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Custom CSS for sidebar collapse -->
    <style>
        /* Sidebar collapsed state */
        .sidebar-collapsed {
            width: 4rem; /* 64px - w-16 */
            overflow-x: hidden !important;
        }
        
        .sidebar-collapsed .sidebar-text {
            opacity: 0;
            visibility: hidden;
            transform: translateX(-10px);
        }
        
        .sidebar-collapsed .sidebar-logo {
            opacity: 0;
            visibility: hidden;
        }
        
        .sidebar-collapsed .submenu-content {
            display: none !important;
        }
        
        .sidebar-collapsed .submenu-toggle {
            display: none;
        }
        
        /* Prevent flex items from overflowing in collapsed state */
        .sidebar-collapsed .flex.items-center {
            justify-content: center;
        }
        
        .sidebar-collapsed .space-x-2 > * + * {
            margin-left: 0;
        }
        
        /* Main content when sidebar is collapsed */
        .main-content-collapsed {
            margin-left: 0;
            transition: margin-left 0.3s ease-in-out;
        }
        
        @media (min-width: 1024px) {
            .main-content-collapsed {
                margin-left: 4rem; /* w-16 */
            }
        }
        
        /* Transition for text elements */
        .sidebar-text {
            transition: all 0.3s ease-in-out;
        }
        
        /* Tooltip for collapsed items */
        .tooltip-collapsed {
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease-in-out;
            z-index: 100;
            margin-left: 0.5rem;
        }
        
        .sidebar-collapsed .relative:hover .tooltip-collapsed {
            opacity: 1;
            visibility: visible;
        }
        
        /* Prevent horizontal overflow in sidebar */
        #sidebar {
            min-width: 0;
        }
        
        #sidebar * {
            box-sizing: border-box;
        }
        
        /* Ensure menu items don't overflow */
        #sidebar .flex.items-center {
            min-width: 0;
        }
        
        #sidebar .sidebar-text {
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
    </style>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/custom.css' %}">
</head>
<body class="bg-gray-100 min-h-screen font-montserrat">
    {% if user.is_authenticated %}
        <!-- Mobile Menu Button -->
        {% comment %} <button id="mobileMenuToggle" class="lg:hidden fixed top-4 left-4 z-50 bg-black text-white p-2 rounded-md">
            <i class="fas fa-bars"></i>
        </button> {% endcomment %}

        <!-- Mobile Overlay -->
        <div id="mobileOverlay" class="lg:hidden fixed inset-0 bg-black bg-opacity-50 z-30 hidden"></div>

        <!-- Sidebar Navigation -->
        <div class="flex">
            <aside id="sidebar" class="w-64 bg-black text-white h-screen fixed left-0 top-0 z-40 overflow-y-auto overflow-x-hidden pb-20 transform -translate-x-full lg:translate-x-0 transition-all duration-300 ease-in-out"
                   style="height: 100vh; padding-bottom: 4rem;">
                <!-- Logo -->
                <div class="p-3 sm:p-4 border-b border-gray-800 sidebar-logo">
                    <div class="flex items-center justify-center">
                        <img src="{% static 'images/logo.png' %}" alt="Rede Confiança" class="w-14 h-14 sm:w-16 sm:h-16 lg:w-20 lg:h-20">
                    </div>
                </div>
                
                <!-- User Info -->
                <div class="p-2 sm:p-3" id="userInfo">
                    <div class="flex flex-col items-center">
                        {% if user.profile_picture %}
                            <img src="{{ user.profile_picture.url }}" alt="{{ user.full_name }}" class="w-10 h-10 sm:w-12 sm:h-12 lg:w-16 lg:h-16 rounded-full object-cover mb-2">
                        {% else %}
                            <div class="w-10 h-10 sm:w-12 sm:h-12 lg:w-16 lg:h-16 bg-primary rounded-full flex items-center justify-center mb-2">
                                <span class="text-white font-bold text-xs sm:text-sm lg:text-lg">{{ user.first_name.0 }}{{ user.last_name.0 }}</span>
                            </div>
                        {% endif %}
                        {% if user.hierarchy != 'PADRAO' and user.hierarchy != 'ADMINISTRATIVO' and user.hierarchy != 'SUPERVISOR' %}
                        <div class="bg-primary text-white px-2 py-1 rounded-full text-xs font-bold mb-2 sidebar-text">
                            C$ {{ user.balance_cs }}
                        </div>
                        {% endif %}
                        <div class="text-center sidebar-text">
                            <div class="font-medium text-xs sm:text-xs lg:text-sm">{{ user.first_name }} {{ user.last_name }}</div>
                            <div class="text-xs text-gray-400">{{ user.get_hierarchy_display }}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Navigation Menu -->
                <nav class="p-2 pb-8">
                    <ul class="space-y-1">
                        <li>
                            <a href="{% url 'home' %}" class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-800 transition-colors relative group" title="Home">
                                <i class="fas fa-home text-primary flex-shrink-0 w-6 text-center"></i>
                                <span class="text-sm sidebar-text">Home</span>
                                <div class="tooltip-collapsed">Home</div>
                                <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-primary rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                            </a>
                        </li>
                        <li>
                            <a href="{% url 'dashboard' %}" class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-800 transition-colors relative group" title="Dashboard">
                                <i class="fas fa-chart-line text-primary flex-shrink-0 w-6 text-center"></i>
                                <span class="text-sm sidebar-text">Dashboard</span>
                                <div class="tooltip-collapsed">Dashboard</div>
                                <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-primary rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                            </a>
                        </li>
                        <li>
                            <a href="{% url 'communications:communications_list' %}" class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-800 transition-colors relative group" title="Comunicados">
                                <i class="fas fa-bullhorn text-primary flex-shrink-0 w-6 text-center"></i>
                                <span class="text-sm sidebar-text">Comunicados</span>
                                <div class="tooltip-collapsed">Comunicados</div>
                                <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-primary rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                            </a>
                        </li>
                        <li>
                            <a href="{% url 'compliments:dashboard' %}" class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-800 transition-colors relative group" title="Elogios">
                                <i class="fas fa-star text-yellow-400 flex-shrink-0 w-6 text-center"></i>
                                <span class="text-sm sidebar-text">Elogios</span>
                                <div class="tooltip-collapsed">Elogios</div>
                                <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-yellow-400 rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                            </a>
                        </li>
                        <!--
                        {% if user.hierarchy == 'PADRAO' %}
                        <li>
                            <a href="{% url 'commission' %}" class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-800 transition-colors relative group" title="Comissionamento">
                                <i class="fas fa-coins text-yellow-500 flex-shrink-0 w-6 text-center"></i>
                                <span class="text-sm sidebar-text">Comissionamento</span>
                                <div class="tooltip-collapsed">Comissionamento</div>
                                <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-yellow-500 rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                            </a>
                        </li>
                        {% endif %}-->
                        <li>
                            <a href="{% url 'checklists:dashboard' %}" class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-800 transition-colors relative group" title="Checklists">
                                <i class="fas fa-clipboard-check text-green-400 flex-shrink-0 w-6 text-center"></i>
                                <span class="text-sm sidebar-text">Checklists ADM</span>
                                <div class="tooltip-collapsed">Checklists ADM</div>
                                <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-green-400 rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                            </a>
                        </li>
                        {% if user.hierarchy == 'SUPERADMIN' %}
                        <li>
                            <a href="{% url 'notifications:dashboard' %}" class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-800 transition-colors relative group" title="Notificações">
                                <i class="fas fa-bell text-primary flex-shrink-0"></i>
                                <span class="text-sm">Notificações</span>
                                <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-primary rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                                {% if unread_notifications_count > 0 %}
                                <span class="notification-count-badge bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5 ml-auto">
                                    {{ unread_notifications_count }}
                                </span>
                                {% endif %}
                            </a>
                        </li>
                        {% endif %}
                        <li>
                            <a href="{% url 'files:files_list' %}" class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-800 transition-colors relative group" title="Arquivos">
                                <i class="fas fa-folder text-primary flex-shrink-0"></i>
                                <span class="text-sm">Arquivos</span>
                                <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-primary rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                            </a>
                        </li>
                        <li>
                            <a href="{% url 'marketplace' %}" class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-800 transition-colors relative group" title="Marketplace C$">
                                <i class="fas fa-store text-primary flex-shrink-0"></i>
                                <span class="text-sm">Mercadinho</span>
                                <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-primary rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                            </a>
                        </li>
                        <li>
                            <div class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-800 transition-colors relative group cursor-pointer" 
                                 onclick="toggleSubmenu('trainings-menu')" title="Treinamentos">
                                <i class="fas fa-play-circle text-primary flex-shrink-0"></i>
                                <span class="text-sm flex-1">Treinamentos</span>
                                <i class="fas fa-chevron-down text-gray-400 submenu-toggle transition-transform duration-300" id="trainings-menu-icon"></i>
                                <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-primary rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                            </div>
                        </li>
                        
                        <!-- Sub Menu Treinamentos -->
                        <li class="ml-4 submenu-content hidden" id="trainings-menu">
                            <ul class="space-y-1">
                                <li>
                                    <a href="{% url 'trainings_list' %}" class="flex items-center space-x-2 p-2 text-xs rounded-lg hover:bg-gray-800 transition-colors relative group" title="Ver Treinamentos">
                                        <i class="fas fa-list text-purple-400 flex-shrink-0"></i>
                                        <span>Ver Todos</span>
                                        <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-purple-400 rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                                    </a>
                                </li>
                                {% if user.can_manage_users %}
                                    <li>
                                        <a href="{% url 'training_upload' %}" class="flex items-center space-x-2 p-2 text-xs rounded-lg hover:bg-gray-800 transition-colors relative group" title="Novo Treinamento">
                                            <i class="fas fa-upload text-green-400 flex-shrink-0"></i>
                                            <span>Novo</span>
                                            <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-green-400 rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="{% url 'trainings_manage' %}" class="flex items-center space-x-2 p-2 text-xs rounded-lg hover:bg-gray-800 transition-colors relative group" title="Gerenciar">
                                            <i class="fas fa-cog text-yellow-400 flex-shrink-0"></i>
                                            <span>Gerenciar</span>
                                            <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-yellow-400 rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </li>

                        <!-- Menu Clube de Benefícios -->
                        <li>
                            <a href="{% url 'benefits:list' %}" class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-800 transition-colors relative group" title="Clube de Benefícios">
                                <i class="fas fa-gift text-primary flex-shrink-0"></i>
                                <span class="text-sm sidebar-text">Clube de Benefícios</span>
                                <div class="tooltip-collapsed">Clube de Benefícios</div>
                                <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-primary rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                            </a>
                        </li>

                        <!-- Menu Apostas (Oculto por enquanto)
                        <li>
                            <a href="{% url 'betting:home' %}" class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-800 transition-colors relative group" title="Apostas">
                                <i class="fas fa-futbol text-primary flex-shrink-0"></i>
                                <span class="text-sm sidebar-text">Apostas</span>
                                <div class="tooltip-collapsed">Apostas</div>
                                <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-primary rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                            </a>
                        </li>
                        -->

                        <!-- Menu Trilhas de Conhecimento -->
                        <li>
                            <a href="{% url 'knowledge_trails:dashboard' %}" class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-800 transition-colors relative group" title="Trilhas de Conhecimento">
                                <i class="fas fa-graduation-cap text-primary flex-shrink-0"></i>
                                <span class="text-sm sidebar-text">Trilhas de Conhecimento</span>
                                <div class="tooltip-collapsed">Trilhas de Conhecimento</div>
                                <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-primary rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                            </a>
                        </li>

                        <!-- Menu Checklists -->
                        <li>
                            <div class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-800 transition-colors relative group cursor-pointer" 
                                 onclick="toggleSubmenu('checklists-menu')" title="Checklists">
                                <i class="fas fa-clipboard-check text-primary flex-shrink-0"></i>
                                <span class="text-sm flex-1">Checklists</span>
                                <i class="fas fa-chevron-down text-gray-400 submenu-toggle transition-transform duration-300" id="checklists-menu-icon"></i>
                                <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-primary rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                            </div>
                        </li>
                        
                        <!-- Sub Menu Checklists -->
                        <li class="ml-4 submenu-content hidden" id="checklists-menu">
                            <ul class="space-y-1">
                                <li>
                                    <a href="{% url 'checklist_dashboard' %}" class="flex items-center space-x-2 p-2 text-xs rounded-lg hover:bg-gray-800 transition-colors relative group" title="Meus Checklists">
                                        <i class="fas fa-list-check text-blue-400 flex-shrink-0"></i>
                                        <span>Meus Checklists</span>
                                        <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-blue-400 rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                                    </a>
                                </li>
                                {% if user.hierarchy != 'PADRAO' %}
                                    <li>
                                        <a href="{% url 'manage_checklists' %}" class="flex items-center space-x-2 p-2 text-xs rounded-lg hover:bg-gray-800 transition-colors relative group" title="Gerenciar Checklists">
                                            <i class="fas fa-cogs text-yellow-400 flex-shrink-0"></i>
                                            <span>Gerenciar</span>
                                            <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-yellow-400 rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="{% url 'create_daily_checklist' %}" class="flex items-center space-x-2 p-2 text-xs rounded-lg hover:bg-gray-800 transition-colors relative group" title="Criar Checklist">
                                            <i class="fas fa-plus text-green-400 flex-shrink-0"></i>
                                            <span>Criar</span>
                                            <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-green-400 rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="{% url 'checklists:admin_executions' %}" class="flex items-center space-x-2 p-2 text-xs rounded-lg hover:bg-gray-800 transition-colors relative group" title="Controle de Execuções">
                                            <i class="fas fa-chart-bar text-purple-400 flex-shrink-0"></i>
                                            <span>Controle</span>
                                            <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-purple-400 rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </li>

                        <!-- Menu Tarefas -->
                        <li>
                            <div class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-800 transition-colors relative group cursor-pointer" 
                                 onclick="toggleSubmenu('tasks-menu')" title="Tarefas">
                                <i class="fas fa-tasks text-primary flex-shrink-0"></i>
                                <span class="text-sm flex-1">Tarefas</span>
                                <i class="fas fa-chevron-down text-gray-400 submenu-toggle transition-transform duration-300" id="tasks-menu-icon"></i>
                                <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-primary rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                            </div>
                        </li>
                        
                        <!-- Sub Menu Tarefas -->
                        <li class="ml-4 submenu-content hidden" id="tasks-menu">
                            <ul class="space-y-1">
                                <li>
                                    <a href="{% url 'tasks_dashboard' %}" class="flex items-center space-x-2 p-2 text-xs rounded-lg hover:bg-gray-800 transition-colors relative group" title="Minhas Tarefas">
                                        <i class="fas fa-user-check text-blue-400 flex-shrink-0"></i>
                                        <span>Minhas Tarefas</span>
                                        <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-blue-400 rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                                    </a>
                                </li>
                                {% if user.hierarchy in 'SUPERVISOR,ADMINISTRATIVO,ADMIN,SUPERADMIN' %}
                                    <li>
                                        <a href="{% url 'manage_tasks' %}" class="flex items-center space-x-2 p-2 text-xs rounded-lg hover:bg-gray-800 transition-colors relative group" title="Gerenciar Tarefas">
                                            <i class="fas fa-cogs text-yellow-400 flex-shrink-0"></i>
                                            <span>Gerenciar</span>
                                            <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-yellow-400 rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="{% url 'create_task' %}" class="flex items-center space-x-2 p-2 text-xs rounded-lg hover:bg-gray-800 transition-colors relative group" title="Nova Tarefa">
                                            <i class="fas fa-plus text-green-400 flex-shrink-0"></i>
                                            <span>Nova</span>
                                            <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-green-400 rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </li>

                        <li>
                            <div class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-800 transition-colors relative group cursor-pointer" 
                                 onclick="toggleSubmenu('tickets-menu')" title="Chamados">
                                <i class="fas fa-ticket-alt text-primary flex-shrink-0"></i>
                                <span class="text-sm flex-1">Chamados</span>
                                <i class="fas fa-chevron-down text-gray-400 submenu-toggle transition-transform duration-300" id="tickets-menu-icon"></i>
                                <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-primary rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                            </div>
                        </li>
                        
                        <!-- Sub Menu Chamados -->
                        <li class="ml-4 submenu-content hidden" id="tickets-menu">
                            <ul class="space-y-1">
                                <li>
                                    <a href="{% url 'ticket_create' %}" class="flex items-center space-x-2 p-2 text-xs rounded-lg hover:bg-gray-800 transition-colors relative group" title="Novo Chamado">
                                        <i class="fas fa-plus text-green-400 flex-shrink-0"></i>
                                        <span>Novo</span>
                                        <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-green-400 rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                                    </a>
                                </li>
                                <li>
                                    <a href="{% url 'tickets_list' %}" class="flex items-center space-x-2 p-2 text-xs rounded-lg hover:bg-gray-800 transition-colors relative group" title="Meus Tickets">
                                        <i class="fas fa-list text-blue-400 flex-shrink-0"></i>
                                        <span>Meus Tickets</span>
                                        <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-blue-400 rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                                    </a>
                                </li>
                            </ul>
                        </li>
                        
                        <!-- Menu Projetos - Apenas para setores autorizados -->
                        {% load projects_tags %}
                        {% if user|can_access_projects %}
                        <li>
                            <div class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-800 transition-colors relative group cursor-pointer" 
                                 onclick="toggleSubmenu('projects-menu')" title="Projetos">
                                <i class="fas fa-project-diagram text-primary flex-shrink-0"></i>
                                <span class="text-sm flex-1">Projetos</span>
                                <i class="fas fa-chevron-down text-gray-400 submenu-toggle transition-transform duration-300" id="projects-menu-icon"></i>
                                <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-primary rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                            </div>
                        </li>
                        
                        <!-- Sub Menu Projetos -->
                        <li class="ml-4 submenu-content hidden" id="projects-menu">
                            <ul class="space-y-1">
                                <li>
                                    <a href="{% url 'projects:dashboard' %}" class="flex items-center space-x-2 p-2 text-xs rounded-lg hover:bg-gray-800 transition-colors relative group" title="Dashboard">
                                        <i class="fas fa-chart-pie text-blue-400 flex-shrink-0"></i>
                                        <span>Dashboard</span>
                                        <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-blue-400 rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                                    </a>
                                </li>
                                <li>
                                    <a href="{% url 'projects:project_list' %}" class="flex items-center space-x-2 p-2 text-xs rounded-lg hover:bg-gray-800 transition-colors relative group" title="Todos os Projetos">
                                        <i class="fas fa-list text-purple-400 flex-shrink-0"></i>
                                        <span>Todos</span>
                                        <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-purple-400 rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                                    </a>
                                </li>
                                {% if user|can_create_projects %}
                                <li>
                                    <a href="{% url 'projects:project_create' %}" class="flex items-center space-x-2 p-2 text-xs rounded-lg hover:bg-gray-800 transition-colors relative group" title="Novo Projeto">
                                        <i class="fas fa-plus text-green-400 flex-shrink-0"></i>
                                        <span>Novo</span>
                                        <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-green-400 rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                                    </a>
                                </li>
                                {% endif %}
                            </ul>
                        </li>
                        {% endif %}
                        
                        <!-- Menu GESTÃO - Para usuários autorizados -->
                        {% if user.can_manage_users or user.groups.all %}
                        <li class="border-t border-gray-800 pt-2 mt-2">
                            <div class="flex items-center space-x-2 px-2 py-1 rounded-lg hover:bg-gray-800 transition-colors cursor-pointer" 
                                 onclick="toggleSubmenu('management-menu')">
                                <i class="fas fa-cogs text-gray-400 flex-shrink-0"></i>
                                <span class="text-xs text-gray-400 font-medium flex-1">GESTÃO</span>
                                <i class="fas fa-chevron-down text-gray-400 submenu-toggle transition-transform duration-300" id="management-menu-icon"></i>
                            </div>
                        </li>
                        
                        <!-- Sub Menu Gestão -->
                        <li class="submenu-content hidden" id="management-menu">
                            <ul class="space-y-1 ml-4">
                                <!-- Gestão de Fornecedores, Compras, Projetos -->
                                {% for group in user.groups.all %}
                                    {% if group.name == "Gestores de Fornecedores" %}
                                    <li>
                                        <a href="{% url 'suppliers:supplier_list' %}" class="flex items-center space-x-2 p-2 text-xs rounded-lg hover:bg-gray-800 transition-colors relative group" title="Fornecedores">
                                            <i class="fas fa-store text-orange-400 flex-shrink-0"></i>
                                            <span>Fornecedores</span>
                                            <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-orange-400 rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                                        </a>
                                    </li>
                                    {% endif %}
                                    
                                    {% if group.name == "Gestores de Compras" %}
                                    <li>
                                        <a href="{% url 'purchases:purchase_list' %}" class="flex items-center space-x-2 p-2 text-xs rounded-lg hover:bg-gray-800 transition-colors relative group" title="Compras">
                                            <i class="fas fa-shopping-cart text-green-400 flex-shrink-0"></i>
                                            <span>Compras</span>
                                            <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-green-400 rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                                        </a>
                                    </li>
                                    {% endif %}
                                    
                                    {% if group.name == "Gestores de Projetos" %}
                                    <li>
                                        <a href="{% url 'projects:project_list' %}" class="flex items-center space-x-2 p-2 text-xs rounded-lg hover:bg-gray-800 transition-colors relative group" title="Projetos - Gestão">
                                            <i class="fas fa-project-diagram text-purple-400 flex-shrink-0"></i>
                                            <span>Projetos - Gestão</span>
                                            <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-purple-400 rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                                        </a>
                                    </li>
                                    {% endif %}
                                {% endfor %}
                                
                                <!-- Gerenciamento de Grupos - Apenas Superadmin -->
                                {% if user.hierarchy == 'SUPERADMIN' or user.is_superuser %}
                                <li>
                                    <a href="{% url 'groups:group_management' %}" class="flex items-center space-x-2 p-2 text-xs rounded-lg hover:bg-gray-800 transition-colors relative group" title="Gerenciar Grupos">
                                        <i class="fas fa-users-cog text-cyan-400 flex-shrink-0"></i>
                                        <span>Grupos</span>
                                        <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-cyan-400 rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                                    </a>
                                </li>
                                {% endif %}
                                
                                <!-- Menu Administrativo - Para can_manage_users -->
                                {% if user.can_manage_users %}
                                <li>
                                    <a href="{% url 'manage_users' %}" class="flex items-center space-x-2 p-2 text-xs rounded-lg hover:bg-gray-800 transition-colors relative group" title="Usuários">
                                        <i class="fas fa-users text-blue-400 flex-shrink-0"></i>
                                        <span>Usuários</span>
                                        <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-blue-400 rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                                    </a>
                                </li>
                                <li>
                                    <a href="{% url 'manage_sectors' %}" class="flex items-center space-x-2 p-2 text-xs rounded-lg hover:bg-gray-800 transition-colors relative group" title="Setores">
                                        <i class="fas fa-building text-green-400 flex-shrink-0"></i>
                                        <span>Setores</span>
                                        <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-green-400 rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                                    </a>
                                </li>
                                <li>
                                    <a href="{% url 'manage_categories' %}" class="flex items-center space-x-2 p-2 text-xs rounded-lg hover:bg-gray-800 transition-colors relative group" title="Categorias">
                                        <i class="fas fa-tags text-purple-400 flex-shrink-0"></i>
                                        <span>Categorias</span>
                                        <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-purple-400 rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                                    </a>
                                </li>
                                <li>
                                    <a href="{% url 'manage_cs' %}" class="flex items-center space-x-2 p-2 text-xs rounded-lg hover:bg-gray-800 transition-colors relative group" title="Dinheiro Vivo">
                                        <i class="fas fa-coins text-yellow-400 flex-shrink-0"></i>
                                        <span>Dinheiro Vivo</span>
                                        <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-yellow-400 rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                                    </a>
                                </li>
                                <li>
                                    <a href="{% url 'assets:list' %}" class="flex items-center space-x-2 p-2 text-xs rounded-lg hover:bg-gray-800 transition-colors relative group" title="Ativos">
                                        <i class="fas fa-warehouse text-orange-400 flex-shrink-0"></i>
                                        <span>Ativos</span>
                                        <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-orange-400 rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                                    </a>
                                </li>
                                <li>
                                    <a href="{% url 'manage_webhooks' %}" class="flex items-center space-x-2 p-2 text-xs rounded-lg hover:bg-gray-800 transition-colors relative group" title="Webhooks">
                                        <i class="fas fa-cloud text-indigo-400 flex-shrink-0"></i>
                                        <span>Webhooks</span>
                                        <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-indigo-400 rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                                    </a>
                                </li>
                                <li>
                                    <a href="{% url 'communications:create_communication' %}" class="flex items-center space-x-2 p-2 text-xs rounded-lg hover:bg-gray-800 transition-colors relative group" title="Criar Comunicado">
                                        <i class="fas fa-bullhorn text-red-400 flex-shrink-0"></i>
                                        <span>Criar Comunicado</span>
                                        <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-red-400 rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                                    </a>
                                </li>
                                <li>
                                    <a href="{% url 'projects:support_admin_template' %}" class="flex items-center space-x-2 p-2 text-xs rounded-lg hover:bg-gray-800 transition-colors relative group" title="Suporte">
                                        <i class="fas fa-headset text-cyan-400 flex-shrink-0"></i>
                                        <span>Suporte</span>
                                        <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-cyan-400 rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                                    </a>
                                </li>
                                {% if user.hierarchy == 'SUPERADMIN' %}
                                <li>
                                    <a href="{% url 'core:activity_history' %}" class="flex items-center space-x-2 p-2 text-xs rounded-lg hover:bg-gray-800 transition-colors relative group" title="Histórico de Atividades">
                                        <i class="fas fa-history text-indigo-400 flex-shrink-0"></i>
                                        <span>Histórico</span>
                                        <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-indigo-400 rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                                    </a>
                                </li>
                                <li>
                                    <a href="{% url 'reports:manage_reports' %}" class="flex items-center space-x-2 p-2 text-xs rounded-lg hover:bg-gray-800 transition-colors relative group" title="Gerenciar Denúncias">
                                        <i class="fas fa-shield-alt text-red-500 flex-shrink-0"></i>
                                        <span>Denúncias</span>
                                        <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-red-500 rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                                    </a>
                                </li>
                                <li>
                                    <a href="{% url 'manage_purchase_approvers' %}" class="flex items-center space-x-2 p-2 text-xs rounded-lg hover:bg-gray-800 transition-colors relative group" title="Aprovadores de Compras">
                                        <i class="fas fa-clipboard-check text-teal-400 flex-shrink-0"></i>
                                        <span>Aprovadores</span>
                                        <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-teal-400 rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                                    </a>
                                </li>
                                {% endif %}
                            </ul>
                        </li>
                        {% endif %}
                        {% endif %}
                        
                        <!-- Menu Ajuda e Configurações -->
                        <li class="border-t border-gray-800 pt-2 mt-2">
                            <div class="px-2 py-1">
                                <span class="text-xs text-gray-400 font-medium">CONFIGURAÇÕES</span>
                            </div>
                        </li>
                        <li>
                            <ul class="space-y-1">
                                <li>
                                    <a href="{% url 'help_tutorials' %}" class="flex items-center space-x-2 p-2 text-xs rounded-lg hover:bg-gray-800 transition-colors relative group" title="Ajuda">
                                        <i class="fas fa-question-circle text-cyan-400 flex-shrink-0"></i>
                                        <span>Ajuda</span>
                                        <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-cyan-400 rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                                    </a>
                                </li>
                                <li>
                                    <a href="{% url 'core:anonymous_report' %}" class="flex items-center space-x-2 p-2 text-xs rounded-lg hover:bg-gray-800 transition-colors relative group" title="Fazer Denúncia Anônima">
                                        <i class="fas fa-shield-alt text-red-400 flex-shrink-0"></i>
                                        <span>Denuncia</span>
                                        <div class="absolute bottom-1 left-3 right-3 h-0.5 bg-red-400 rounded-full transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                                    </a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </nav>
            </aside>
            
            <!-- Main Content -->
            <main id="mainContent" class="flex-1 ml-0 lg:ml-64 transition-all duration-300 ease-in-out min-h-screen">
                <!-- Top Header -->
                <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-30">
                    <div class="flex items-center justify-between px-2 sm:px-4 lg:px-6 py-2 sm:py-3 lg:py-4">
                        <!-- Mobile menu button for header - mais visível -->
                        <button id="headerMobileMenuToggle" class="block lg:hidden text-gray-600 hover:text-primary focus:outline-none focus:ring-2 focus:ring-primary mr-2 p-2 rounded-lg hover:bg-gray-100 min-w-[44px] min-h-[44px] flex items-center justify-center">
                            <i class="fas fa-bars text-lg md:text-xl"></i>
                        </button>
                        
                        <!-- Desktop sidebar toggle button -->
                        <button id="desktopSidebarToggle" class="hidden lg:block text-gray-600 hover:text-primary focus:outline-none focus:ring-2 focus:ring-primary mr-2 p-2 rounded-lg hover:bg-gray-100 min-w-[44px] min-h-[44px] flex items-center justify-center transition-colors duration-200">
                            <i class="fas fa-bars text-lg" id="desktopToggleIcon"></i>
                        </button>
                        
                        <div class="flex items-center space-x-4 flex-1 lg:flex-initial">
                            {% block header_nav %}
                            <nav class="hidden lg:flex space-x-6">
                                <a href="{% url 'home' %}" class="text-gray-600 hover:text-primary transition-colors {% if request.resolver_match.url_name == 'home' %}text-primary border-b-2 border-primary{% endif %}">Home</a>
                                <a href="{% url 'dashboard' %}" class="text-gray-600 hover:text-primary transition-colors {% if request.resolver_match.url_name == 'dashboard' %}text-primary border-b-2 border-primary{% endif %}">Dashboard</a>
                                <a href="{% url 'communications:communications_list' %}" class="text-gray-600 hover:text-primary transition-colors {% if 'communications' in request.path %}text-primary border-b-2 border-primary{% endif %}">Comunicados</a>
                                <a href="{% url 'tickets_list' %}" class="text-gray-600 hover:text-primary transition-colors {% if 'tickets' in request.path %}text-primary border-b-2 border-primary{% endif %}">Chamados</a>
                            </nav>
                            {% endblock %}
                        </div>
                        
                        <div class="flex items-center space-x-1 sm:space-x-2 lg:space-x-4">
                            <!-- Push Notifications Enable Button (hidden by default) -->
                            <div id="pushNotificationPrompt" class="relative hidden">
                                <button id="enablePushNotificationsBtn" class="p-2 text-orange-600 hover:text-orange-700 focus:outline-none transition-colors rounded-lg hover:bg-orange-50 animate-pulse">
                                    <i class="fas fa-bell-slash text-base sm:text-lg"></i>
                                </button>
                                <div class="absolute right-0 mt-2 w-72 bg-orange-50 border border-orange-200 rounded-lg shadow-lg z-50 p-3 hidden" id="pushPromptTooltip">
                                    <p class="text-sm text-orange-800 mb-2">Ative as notificações push para receber alertas em tempo real!</p>
                                    <button onclick="window.location.href='/notifications/settings/'" class="text-xs bg-orange-500 text-white px-2 py-1 rounded hover:bg-orange-600">
                                        Ativar agora
                                    </button>
                                </div>
                            </div>

                            <!-- Notifications -->
                            <div class="relative">
                                <button id="notification-bell" class="relative p-2 text-gray-600 hover:text-primary focus:outline-none transition-colors rounded-lg hover:bg-gray-100">
                                    <i class="fas fa-bell text-base sm:text-lg"></i>
                                    <span id="notification-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-4 w-4 sm:h-5 sm:w-5 flex items-center justify-center hidden text-xs">0</span>
                                </button>
                                
                                <!-- Notifications Dropdown -->
                                <div id="notification-dropdown" class="absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-lg border border-gray-200 z-50 hidden">
                                    <div class="p-4 border-b border-gray-200">
                                        <h3 class="font-semibold text-gray-800">Notificações</h3>
                                    </div>
                                    <div id="notificationsList" class="max-h-96 overflow-y-auto">
                                        <!-- Notifications will be loaded here -->
                                    </div>
                                    <div class="p-3 border-t border-gray-200">
                                        <a href="{% url 'notifications:dashboard' %}" class="text-sm text-primary hover:text-primary-dark">Ver todas as notificações</a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Search -->
                            <div class="relative hidden lg:block">
                                <input type="text" placeholder="Pesquisar..." class="bg-gray-100 rounded-full px-4 py-2 w-48 xl:w-64 focus:outline-none focus:ring-2 focus:ring-primary">
                                <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
                            </div>
                            
                            <!-- User Menu -->
                            <div class="relative">
                                <button id="userMenuToggle" class="flex items-center space-x-1 sm:space-x-2 text-gray-600 hover:text-primary focus:outline-none p-1 sm:p-2 rounded-lg hover:bg-gray-100">
                                    {% if user.profile_picture %}
                                        <img src="{{ user.profile_picture.url }}" alt="{{ user.full_name }}" class="w-7 h-7 sm:w-8 sm:h-8 rounded-full object-cover">
                                    {% else %}
                                        <div class="w-7 h-7 sm:w-8 sm:h-8 bg-gray-500 rounded-full flex items-center justify-center">
                                            <i class="fas fa-user text-white text-xs sm:text-sm"></i>
                                        </div>
                                    {% endif %}
                                    <span class="hidden sm:block text-xs sm:text-sm">{{ user.first_name }}</span>
                                    <i class="fas fa-chevron-down text-xs"></i>
                                </button>
                                <div id="userMenuDropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg border border-gray-200 py-1 z-50 hidden">
                                    <div class="px-4 py-2 border-b border-gray-100">
                                        <p class="text-sm font-medium text-gray-900">{{ user.full_name }}</p>
                                        <p class="text-xs text-gray-500">{{ user.email }}</p>
                                    </div>
                                    <a href="{% url 'profile' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                                        <i class="fas fa-user mr-2"></i> Meu Perfil
                                    </a>
                                    <a href="{% url 'settings' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                                        <i class="fas fa-cog mr-2"></i> Configurações
                                    </a>
                                    <a href="{% url 'help_tutorials' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                                        <i class="fas fa-question-circle mr-2"></i> Ajuda
                                    </a>
                                    {% if user.can_manage_users %}
                                    <a href="{% url 'admin_panel' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                                        <i class="fas fa-cogs mr-2"></i> Painel Administrativo
                                    </a>
                                    {% endif %}
                                    <div class="border-t border-gray-100"></div>
                                    <a href="{% url 'logout' %}" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center">
                                        <i class="fas fa-sign-out-alt mr-2"></i> Sair da conta
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </header>
                
                <!-- Page Content -->
                <div class="p-2 sm:p-4 lg:p-6 min-h-screen">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="mb-4 p-3 sm:p-4 rounded-md text-sm sm:text-base {% if message.tags == 'error' %}bg-red-100 text-red-700{% elif message.tags == 'success' %}bg-green-100 text-green-700{% elif message.tags == 'warning' %}bg-yellow-100 text-yellow-700{% else %}bg-blue-100 text-blue-700{% endif %}">
                                {{ message }}
                            </div>
                        {% endfor %}
                    {% endif %}
                    
                    {% block content %}
                    {% endblock %}
                </div>
            </main>
        </div>
    {% else %}
        {% block login_content %}
        {% endblock %}
    {% endif %}
    
    <script src="{% static 'js/app.js' %}"></script>
    <script src="{% static 'js/ios-notifications.js' %}"></script>
    <script>
        // Mobile Menu Toggle Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const headerMobileMenuToggle = document.getElementById('headerMobileMenuToggle');
            const mobileOverlay = document.getElementById('mobileOverlay');
            const userMenuToggle = document.getElementById('userMenuToggle');
            const userMenuDropdown = document.getElementById('userMenuDropdown');

            let isMobileOpen = false;

            // Check if we're on mobile
            function isMobile() {
                return window.innerWidth < 1024;
            }

            // Initialize sidebar state
            function initializeSidebar() {
                if (isMobile()) {
                    sidebar.classList.add('-translate-x-full');
                    sidebar.classList.remove('translate-x-0');
                    sidebar.classList.remove('sidebar-collapsed');
                    mainContent.classList.remove('lg:ml-64', 'main-content-collapsed');
                    mainContent.classList.add('ml-0');
                } else {
                    sidebar.classList.remove('-translate-x-full');
                    sidebar.classList.add('translate-x-0');
                    
                    // Check if sidebar was collapsed in desktop mode
                    const savedCollapsedState = localStorage.getItem('sidebarCollapsed');
                    if (savedCollapsedState === 'true') {
                        sidebar.classList.add('sidebar-collapsed');
                        mainContent.classList.add('main-content-collapsed');
                        mainContent.classList.remove('lg:ml-64', 'ml-0');
                    } else {
                        sidebar.classList.remove('sidebar-collapsed');
                        mainContent.classList.add('lg:ml-64');
                        mainContent.classList.remove('ml-0', 'main-content-collapsed');
                    }
                }
            }

            // Mobile menu toggle functions
            function openMobileMenu() {
                if (!isMobile()) return;
                
                isMobileOpen = true;
                sidebar.classList.remove('-translate-x-full');
                sidebar.classList.add('translate-x-0');
                mobileOverlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }

            function closeMobileMenu() {
                if (!isMobile()) return;
                
                isMobileOpen = false;
                sidebar.classList.remove('translate-x-0');
                sidebar.classList.add('-translate-x-full');
                mobileOverlay.classList.add('hidden');
                document.body.style.overflow = '';
            }

            // Mobile menu button events
            if (mobileMenuToggle) {
                mobileMenuToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Mobile menu toggle clicked (sidebar button)');
                    openMobileMenu();
                });
            }

            if (headerMobileMenuToggle) {
                // Múltiplos event listeners para garantir funcionalidade
                headerMobileMenuToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Mobile menu toggle clicked (header button)');
                    openMobileMenu();
                });
                
                // Adicionar suporte para touch em dispositivos móveis
                headerMobileMenuToggle.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    console.log('Mobile menu toggle touched');
                    openMobileMenu();
                });
                
                // Verificar se o botão está visível
                console.log('Header mobile toggle button found and configured:', headerMobileMenuToggle);
                console.log('Button visibility:', getComputedStyle(headerMobileMenuToggle).display);
                console.log('Button dimensions:', headerMobileMenuToggle.getBoundingClientRect());
            } else {
                console.warn('Header mobile menu toggle button not found!');
            }

            // Mobile overlay click to close
            if (mobileOverlay) {
                mobileOverlay.addEventListener('click', closeMobileMenu);
            }

            // Handle window resize
            window.addEventListener('resize', function() {
                if (window.innerWidth >= 1024) {
                    // Desktop mode
                    if (isMobileOpen) {
                        closeMobileMenu();
                    }
                    initializeSidebar();
                } else {
                    // Mobile mode - reset desktop collapse state
                    sidebar.classList.remove('sidebar-collapsed');
                    mainContent.classList.remove('main-content-collapsed');
                    if (!isMobileOpen) {
                        sidebar.classList.add('-translate-x-full');
                        sidebar.classList.remove('translate-x-0');
                        mainContent.classList.remove('lg:ml-64');
                        mainContent.classList.add('ml-0');
                    }
                }
            });

            // User menu dropdown functionality
            if (userMenuToggle && userMenuDropdown) {
                userMenuToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    userMenuDropdown.classList.toggle('hidden');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!userMenuToggle.contains(e.target) && !userMenuDropdown.contains(e.target)) {
                        userMenuDropdown.classList.add('hidden');
                    }
                });
            }

            // Close mobile menu when clicking on sidebar links (mobile only)
            document.querySelectorAll('#sidebar a').forEach(link => {
                link.addEventListener('click', function() {
                    if (isMobile() && isMobileOpen) {
                        setTimeout(() => {
                            closeMobileMenu();
                        }, 150); // Small delay for better UX
                    }
                });
            });

            // Initialize on page load
            initializeSidebar();
            
            // Desktop Sidebar Toggle Functionality
            const desktopSidebarToggle = document.getElementById('desktopSidebarToggle');
            let isDesktopCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            
            function toggleDesktopSidebar(forceCollapse = null) {
                if (isMobile()) return; // Only work on desktop
                
                const shouldCollapse = forceCollapse !== null ? forceCollapse : !isDesktopCollapsed;
                isDesktopCollapsed = shouldCollapse;
                
                if (shouldCollapse) {
                    // Collapse sidebar
                    sidebar.classList.add('sidebar-collapsed');
                    mainContent.classList.remove('lg:ml-64');
                    mainContent.classList.add('main-content-collapsed');
                } else {
                    // Expand sidebar
                    sidebar.classList.remove('sidebar-collapsed');
                    mainContent.classList.remove('main-content-collapsed');
                    mainContent.classList.add('lg:ml-64');
                }
                
                // Save state to localStorage
                localStorage.setItem('sidebarCollapsed', shouldCollapse.toString());
            }
            
            if (desktopSidebarToggle) {
                desktopSidebarToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleDesktopSidebar();
                });
            }
            
            // Debug function para verificar elementos do menu
            function debugMobileMenu() {
                console.log('=== Mobile Menu Debug ===');
                console.log('Screen width:', window.innerWidth);
                console.log('Is mobile:', isMobile());
                console.log('Sidebar element:', sidebar);
                console.log('Mobile overlay element:', mobileOverlay);
                console.log('Header mobile toggle element:', headerMobileMenuToggle);
                console.log('Main content element:', mainContent);
                
                if (headerMobileMenuToggle) {
                    const styles = getComputedStyle(headerMobileMenuToggle);
                    console.log('Header toggle display:', styles.display);
                    console.log('Header toggle visibility:', styles.visibility);
                    console.log('Header toggle opacity:', styles.opacity);
                    console.log('Header toggle position:', headerMobileMenuToggle.getBoundingClientRect());
                }
                console.log('========================');
            }
            
            // Executar debug após um breve delay
            setTimeout(debugMobileMenu, 1000);
            
            // Adicionar debug no resize
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(debugMobileMenu, 500);
            });
            
            // Inicializar sistema de notificações
            if (typeof initializeNotificationSystem === 'function') {
                initializeNotificationSystem();
            }
            
            // Verificar status de push notifications e mostrar prompt se necessário
            checkPushNotificationStatus();
            
            // Função para verificar status das push notifications
            function checkPushNotificationStatus() {
                const pushPrompt = document.getElementById('pushNotificationPrompt');
                const pushBtn = document.getElementById('enablePushNotificationsBtn');
                const pushTooltip = document.getElementById('pushPromptTooltip');
                
                if (!pushPrompt || !('Notification' in window)) {
                    return; // Navegador não suporta
                }
                
                // Verificar se já foi perguntado antes (evitar spam)
                if (sessionStorage.getItem('pushPromptShown') === 'true') {
                    return;
                }
                
                // Verificar permissão atual
                if (Notification.permission === 'default') {
                    // Mostrar prompt após 5 segundos
                    setTimeout(() => {
                        pushPrompt.classList.remove('hidden');
                        
                        // Mostrar tooltip ao passar o mouse
                        if (pushBtn && pushTooltip) {
                            pushBtn.addEventListener('mouseenter', () => {
                                pushTooltip.classList.remove('hidden');
                            });
                            
                            pushBtn.addEventListener('mouseleave', () => {
                                pushTooltip.classList.add('hidden');
                            });
                        }
                        
                        // Auto-esconder após 30 segundos
                        setTimeout(() => {
                            pushPrompt.classList.add('hidden');
                            sessionStorage.setItem('pushPromptShown', 'true');
                        }, 30000);
                        
                    }, 5000);
                }
                // Se permission === 'denied' ou 'granted', não mostrar nada
            }
            
            // Fechar dropdown ao clicar fora
            document.addEventListener('click', function(e) {
                const notificationBell = document.getElementById('notification-bell');
                const notificationDropdown = document.getElementById('notification-dropdown');
                
                if (notificationBell && notificationDropdown && 
                    !notificationBell.contains(e.target) && 
                    !notificationDropdown.contains(e.target)) {
                    notificationDropdown.classList.add('hidden');
                }
            });

            
            // Display notifications
            function displayNotifications(notifications) {
                if (notifications.length === 0) {
                    notificationsList.innerHTML = '<div class="p-4 text-gray-500 text-center">Nenhuma notificação</div>';
                    return;
                }
                
                const notificationsHTML = notifications.map(notification => `
                    <div class="p-3 border-b border-gray-100 hover:bg-gray-50 ${!notification.is_read ? 'bg-blue-50' : ''}" data-id="${notification.id}">
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0">
                                ${getNotificationIcon(notification.notification_type)}
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900 truncate">
                                    ${notification.title}
                                </p>
                                <p class="text-xs text-gray-500 mt-1">
                                    ${stripHtmlTags(notification.message)}
                                </p>
                                <p class="text-xs text-gray-400 mt-1">
                                    ${formatDate(notification.created_at)}
                                </p>
                            </div>
                            ${!notification.is_read ? '<div class="w-2 h-2 bg-blue-500 rounded-full flex-shrink-0"></div>' : ''}
                        </div>
                    </div>
                `).join('');
                
                notificationsList.innerHTML = notificationsHTML;
                
                // Add click handlers to open modal
                notificationsList.querySelectorAll('[data-id]').forEach(item => {
                    item.addEventListener('click', function() {
                        const notificationId = this.getAttribute('data-id');
                        const notification = notifications.find(n => n.id == notificationId);
                        if (notification) {
                            openNotificationModal(notification);
                        }
                    });
                });
            }
            
            // Update notification badge
            function updateNotificationBadge(count) {
                if (count > 0) {
                    notificationBadge.textContent = count > 99 ? '99+' : count;
                    notificationBadge.classList.remove('hidden');
                } else {
                    notificationBadge.classList.add('hidden');
                }
            }
            
            // Mark notification as read
            function markAsRead(notificationId, reloadNotifications = true) {
                fetch(`/api/notifications/${notificationId}/mark-read/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && reloadNotifications) {
                        loadNotifications(); // Reload to update UI
                    }
                });
            }
            
            // Get notification icon based on type
            function getNotificationIcon(type) {
                const icons = {
                    'FILE': '<i class="fas fa-file text-blue-500"></i>',
                    'TICKET': '<i class="fas fa-ticket-alt text-yellow-500"></i>',
                    'TRAINING': '<i class="fas fa-graduation-cap text-green-500"></i>',
                    'COMMUNICATION': '<i class="fas fa-bullhorn text-orange-500"></i>',
                    'TICKET_UPDATE': '<i class="fas fa-sync text-blue-500"></i>',
                    'SYSTEM': '<i class="fas fa-cog text-gray-500"></i>'
                };
                return icons[type] || '<i class="fas fa-bell text-gray-500"></i>';
            }
            
            // Strip HTML tags from text
            function stripHtmlTags(html) {
                const temp = document.createElement('div');
                temp.innerHTML = html;
                return temp.textContent || temp.innerText || '';
            }
            
            // Format date
            function formatDate(dateString) {
                const date = new Date(dateString);
                const now = new Date();
                const diffInMinutes = Math.floor((now - date) / (1000 * 60));
                
                if (diffInMinutes < 1) return 'Agora';
                if (diffInMinutes < 60) return `${diffInMinutes}m atrás`;
                if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}h atrás`;
                return date.toLocaleDateString('pt-BR');
            }
            
            // Load notifications count on page load
            fetch('/api/notifications/count/')
                .then(response => response.json())
                .then(data => updateNotificationBadge(data.count))
                .catch(error => console.error('Error loading notification count:', error));

            // Notification Modal functionality
            const notificationModal = document.getElementById('notificationModal');
            const closeNotificationModalBtn = document.getElementById('closeNotificationModal');
            const modalMarkAsReadBtn = document.getElementById('modalMarkAsRead');
            
            let currentNotification = null;

            // Open notification modal
            function openNotificationModal(notification) {
                currentNotification = notification;
                
                // Populate modal content
                document.getElementById('modalNotificationIcon').innerHTML = getNotificationIcon(notification.notification_type);
                document.getElementById('modalNotificationTitle').textContent = notification.title;
                document.getElementById('modalNotificationMessage').innerHTML = notification.message;
                document.getElementById('modalNotificationType').textContent = getNotificationTypeLabel(notification.notification_type);
                document.getElementById('modalNotificationDate').textContent = formatFullDate(notification.created_at);
                
                // Handle related URL
                const urlContainer = document.getElementById('modalNotificationUrl');
                const linkElement = document.getElementById('modalNotificationLink');
                if (notification.related_url) {
                    linkElement.href = notification.related_url;
                    urlContainer.classList.remove('hidden');
                } else {
                    urlContainer.classList.add('hidden');
                }
                
                // Update mark as read button visibility
                const markAsReadBtn = document.getElementById('modalMarkAsRead');
                if (notification.is_read) {
                    markAsReadBtn.classList.add('hidden');
                } else {
                    markAsReadBtn.classList.remove('hidden');
                }
                
                // Show modal
                notificationModal.classList.remove('hidden');
                
                // Mark as read automatically when opened
                if (!notification.is_read) {
                    markAsRead(notification.id, false); // false = don't reload notifications immediately
                }
            }

            // Close notification modal
            function closeNotificationModal() {
                notificationModal.classList.add('hidden');
                currentNotification = null;
                // Reload notifications to update the dropdown
                if (!notificationDropdown.classList.contains('hidden')) {
                    loadNotifications();
                }
            }

            // Get notification type label
            function getNotificationTypeLabel(type) {
                const labels = {
                    'FILE': 'Novo Arquivo',
                    'TICKET': 'Novo Chamado',
                    'TRAINING': 'Novo Treinamento',
                    'COMMUNICATION': 'Novo Comunicado',
                    'TICKET_UPDATE': 'Atualização de Chamado',
                    'SYSTEM': 'Sistema'
                };
                return labels[type] || 'Notificação';
            }

            // Format full date
            function formatFullDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            // Event listeners for modal
            if (closeNotificationModalBtn) {
                closeNotificationModalBtn.addEventListener('click', closeNotificationModal);
            }

            if (modalMarkAsReadBtn) {
                modalMarkAsReadBtn.addEventListener('click', function() {
                    if (currentNotification) {
                        markAsRead(currentNotification.id, true); // true = reload notifications
                        closeNotificationModal();
                    }
                });
            }

            // Close modal when clicking outside
            if (notificationModal) {
                notificationModal.addEventListener('click', function(e) {
                    if (e.target === notificationModal) {
                        closeNotificationModal();
                    }
                });
            }
        });
    </script>
    
    <!-- Submenu Toggle Script -->
    <script>
        function toggleSubmenu(menuId) {
            const menu = document.getElementById(menuId);
            const icon = document.getElementById(menuId + '-icon');
            
            if (menu.classList.contains('hidden')) {
                // Abrir menu
                menu.classList.remove('hidden');
                menu.style.maxHeight = menu.scrollHeight + 'px';
                icon.style.transform = 'rotate(180deg)';
                
                // Salvar estado no localStorage
                localStorage.setItem('submenu_' + menuId, 'open');
            } else {
                // Fechar menu
                menu.style.maxHeight = '0px';
                icon.style.transform = 'rotate(0deg)';
                setTimeout(() => {
                    menu.classList.add('hidden');
                }, 300);
                
                // Salvar estado no localStorage
                localStorage.setItem('submenu_' + menuId, 'closed');
            }
        }
        
        // Restaurar estado dos menus ao carregar a página
        document.addEventListener('DOMContentLoaded', function() {
            const menus = ['trainings-menu', 'checklists-menu', 'tasks-menu', 'tickets-menu', 'projects-menu', 'management-menu'];
            
            menus.forEach(menuId => {
                const menu = document.getElementById(menuId);
                const icon = document.getElementById(menuId + '-icon');
                const state = localStorage.getItem('submenu_' + menuId);
                
                if (menu && icon) {
                    if (state === 'open') {
                        menu.classList.remove('hidden');
                        menu.style.maxHeight = menu.scrollHeight + 'px';
                        icon.style.transform = 'rotate(180deg)';
                    } else {
                        menu.classList.add('hidden');
                        menu.style.maxHeight = '0px';
                        icon.style.transform = 'rotate(0deg)';
                    }
                }
            });
        });
    </script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    }, function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
    
    <!-- OneSignal Integration Script -->
    <script>
        (function() {
            // Verificar se OneSignal está configurado
            fetch('/notifications/api/onesignal/config/')
                .then(response => response.json())
                .then(config => {
                    if (config.enabled && config.app_id) {
                        // Carregar script do OneSignal dinamicamente
                        var onesignalScript = document.createElement('script');
                        onesignalScript.type = 'text/javascript';
                        onesignalScript.async = true;
                        onesignalScript.src = 'https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js';
                        onesignalScript.defer = true;
                        onesignalScript.onload = function() {
                            // Inicializar OneSignal após carregar o script
                            window.OneSignalDeferred = window.OneSignalDeferred || [];
                            OneSignalDeferred.push(async function(OneSignal) {
                                await OneSignal.init({
                                    appId: config.app_id,
                                    safari_web_id: config.safari_web_id || null,
                                    allowLocalhostAsSecureOrigin: true,
                                    autoResubscribe: true,
                                    notifyButton: {
                                        enable: true,
                                        size: 'large',
                                        position: 'bottom-right',
                                        showCredit: false,
                                        text: {
                                            'tip.state.unsubscribed': 'Ativar notificações',
                                            'tip.state.subscribed': 'Notificações ativas',
                                            'tip.state.blocked': 'Notificações bloqueadas',
                                            'message.prenotify': 'Clique para ativar notificações',
                                            'message.action.subscribed': 'Obrigado por ativar!',
                                            'message.action.resubscribed': 'Notificações reativadas!',
                                            'message.action.unsubscribed': 'Notificações desativadas',
                                            'dialog.main.title': 'Gerenciar Notificações',
                                            'dialog.main.button.subscribe': 'ATIVAR',
                                            'dialog.main.button.unsubscribe': 'DESATIVAR',
                                            'dialog.blocked.title': 'Desbloquear Notificações',
                                            'dialog.blocked.message': 'Siga as instruções para permitir notificações'
                                        }
                                    },
                                    promptOptions: {
                                        slidedown: {
                                            prompts: [{
                                                type: "push",
                                                autoPrompt: true,
                                                text: {
                                                    actionMessage: "🔔 Receba notificações sobre seus chamados e atualizações importantes!",
                                                    acceptButton: "✓ Ativar Notificações",
                                                    cancelButton: "Depois"
                                                },
                                                delay: {
                                                    pageViews: 1,
                                                    timeDelay: 3
                                                }
                                            }]
                                        }
                                    },
                                    welcomeNotification: {
                                        title: "🎉 Notificações Ativadas!",
                                        message: "Você receberá atualizações importantes do sistema."
                                    }
                                });
                                console.log('OneSignal initialized successfully');
                                
                                // Expor função global para solicitar permissão
                                window.requestPushPermission = function() {
                                    OneSignal.Slidedown.promptPush()
                                        .then(function() {
                                            console.log('OneSignal permission requested');
                                        })
                                        .catch(function(err) {
                                            console.error('OneSignal permission request failed:', err);
                                        });
                                };
                                
                                // Função para verificar se está inscrito
                                window.isPushSubscribed = function() {
                                    return OneSignal.User.PushSubscription.optedIn;
                                };
                                
                                // Verificar se usuário não está inscrito e mostrar prompt após 5 segundos
                                setTimeout(function() {
                                    try {
                                        const isSubscribed = OneSignal.User.PushSubscription.optedIn;
                                        console.log('Push subscription status:', isSubscribed);
                                        
                                        if (!isSubscribed) {
                                            showPushBanner();
                                        }
                                    } catch(e) {
                                        console.log('Error checking subscription:', e);
                                        showPushBanner();
                                    }
                                }, 5000);
                                
                                // Função para mostrar banner de push
                                window.showPushBanner = function() {
                                    // Verificar se já foi fechado recentemente
                                    const dismissed = localStorage.getItem('pushBannerDismissed');
                                    if (dismissed) {
                                        const dismissedTime = parseInt(dismissed);
                                        const hoursPassed = (Date.now() - dismissedTime) / (1000 * 60 * 60);
                                        if (hoursPassed < 24) return; // Não mostrar se foi fechado há menos de 24h
                                    }
                                    
                                    // Criar banner flutuante
                                    if (!document.getElementById('pushNotificationBanner')) {
                                        const banner = document.createElement('div');
                                        banner.id = 'pushNotificationBanner';
                                        banner.className = 'fixed bottom-4 left-4 right-4 md:left-auto md:right-4 md:w-96 bg-gradient-to-r from-red-600 to-red-700 text-white p-4 rounded-xl shadow-2xl z-50 transform transition-all duration-300';
                                        banner.innerHTML = `
                                            <div class="flex items-start gap-3">
                                                <div class="flex-shrink-0 w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
                                                    <i class="fas fa-bell text-2xl animate-bounce"></i>
                                                </div>
                                                <div class="flex-1">
                                                    <h4 class="font-bold text-lg mb-1">🔔 Ative as Notificações!</h4>
                                                    <p class="text-sm text-red-100 mb-3">Receba alertas sobre seus chamados e atualizações importantes do sistema.</p>
                                                    <div class="flex gap-2">
                                                        <button onclick="activatePushFromBanner()" class="px-4 py-2 bg-white text-red-600 font-semibold rounded-lg hover:bg-red-50 transition-colors text-sm">
                                                            <i class="fas fa-check mr-1"></i> Ativar Agora
                                                        </button>
                                                        <button onclick="dismissPushBanner()" class="px-4 py-2 bg-white/20 text-white font-medium rounded-lg hover:bg-white/30 transition-colors text-sm">
                                                            Depois
                                                        </button>
                                                    </div>
                                                </div>
                                                <button onclick="dismissPushBanner()" class="text-white/70 hover:text-white">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        `;
                                        document.body.appendChild(banner);
                                    }
                                };
                                
                                // Ativar push a partir do banner
                                window.activatePushFromBanner = function() {
                                    OneSignal.Slidedown.promptPush();
                                    dismissPushBanner();
                                };
                                
                                // Fechar banner
                                window.dismissPushBanner = function() {
                                    const banner = document.getElementById('pushNotificationBanner');
                                    if (banner) {
                                        banner.classList.add('translate-y-full', 'opacity-0');
                                        setTimeout(() => banner.remove(), 300);
                                        localStorage.setItem('pushBannerDismissed', Date.now().toString());
                                    }
                                };
                                
                                // Escutar mudanças no status de inscrição
                                OneSignal.User.PushSubscription.addEventListener('change', function(event) {
                                    console.log('Push subscription changed:', event);
                                    if (event.current.optedIn) {
                                        dismissPushBanner();
                                    }
                                });
                            });
                        };
                        document.head.appendChild(onesignalScript);
                    } else {
                        console.log('OneSignal not configured');
                    }
                })
                .catch(error => {
                    console.log('Could not load OneSignal config:', error);
                });
        })();
    </script>
    
    <!-- Notification Detail Modal -->
    <div id="notificationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-20 mx-auto p-5 border w-11/12 sm:w-1/2 lg:w-1/3 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <!-- Modal Header -->
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center space-x-2">
                        <span id="modalNotificationIcon" class="text-lg"></span>
                        <h3 id="modalNotificationTitle" class="text-lg font-medium text-gray-900"></h3>
                    </div>
                    <button id="closeNotificationModal" class="text-gray-400 hover:text-gray-600 focus:outline-none">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <!-- Modal Content -->
                <div class="mb-4">
                    <div class="mb-3">
                        <span id="modalNotificationType" class="inline-block px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800"></span>
                    </div>
                    <div class="mb-4">
                        <p id="modalNotificationMessage" class="text-gray-700 whitespace-pre-line"></p>
                    </div>
                    <div class="text-xs text-gray-500">
                        <i class="fas fa-clock mr-1"></i>
                        <span id="modalNotificationDate"></span>
                    </div>
                </div>
                
                <!-- Modal Actions -->
                <div class="flex justify-end space-x-3">
                    <div id="modalNotificationUrl" class="hidden">
                        <a id="modalNotificationLink" href="#" target="_blank" class="bg-primary hover:bg-primary-dark text-white px-4 py-2 rounded text-sm transition-colors">
                            <i class="fas fa-external-link-alt mr-1"></i>
                            Abrir Link
                        </a>
                    </div>
                    <button id="modalMarkAsRead" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded text-sm transition-colors">
                        <i class="fas fa-check mr-1"></i>
                        Marcar como Lida
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Support Chat Widget -->
    <div id="supportChatWidget" class="fixed bottom-4 right-4 z-50">
        <!-- Chat Button -->
        <button id="supportChatToggle" 
                onclick="
                    var chatWindow = document.getElementById('supportChatWindow');
                    if (chatWindow) {
                        var currentDisplay = chatWindow.style.display;
                        chatWindow.style.display = (currentDisplay === 'flex') ? 'none' : 'flex';
                        if (currentDisplay !== 'flex') {
                            // Chat está sendo aberto, inicializar na aba 'new' e carregar setores
                            setTimeout(function() { 
                                window.switchTab('new');
                            }, 100);
                        }
                    }
                "
                class="bg-blue-500 hover:bg-blue-600 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg hover:shadow-xl transition-all duration-300 group">
            <i class="fas fa-comment-alt text-xl group-hover:scale-110 transition-transform"></i>
            <span id="supportChatBadge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
        </button>

        <!-- Chat Window -->
        <div id="supportChatWindow" 
             class="absolute bottom-16 right-0 bg-white rounded-lg shadow-2xl border border-gray-200 flex flex-col overflow-hidden z-50 transition-all duration-300"
             style="display: none; height: 500px; width: 320px;"
             data-expanded="false">
            
            <!-- Chat Header -->
            <div class="bg-blue-500 text-white p-4 flex items-center justify-between flex-shrink-0">
                <div>
                    <h3 class="font-semibold">Suporte</h3>
                    <p class="text-xs text-blue-100" id="chatHeaderSubtitle">Como podemos ajudar?</p>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="supportChatExpand" onclick="window.toggleChatExpand()" class="text-blue-100 hover:text-white transition-colors" title="Expandir">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button id="supportChatMinimize" onclick="document.getElementById('supportChatWindow').style.display = 'none';" class="text-blue-100 hover:text-white transition-colors">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button id="supportChatClose" onclick="document.getElementById('supportChatWindow').style.display = 'none';" class="text-blue-100 hover:text-white transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Chat Tabs -->
            <div class="bg-gray-50 border-b border-gray-200 flex-shrink-0">
                <div class="flex">
                    <button id="newChatTab" class="px-4 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600 bg-white">
                        Novo Chat
                    </button>
                    <button id="myChatTab" class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900">
                        Meus Chats
                    </button>
                </div>
            </div>

            <!-- New Chat Form -->
            <div id="newChatForm" class="flex-1 overflow-y-auto p-4 min-h-0">
                <form id="createSupportChatForm" class="space-y-3">
                    {% csrf_token %}
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Setor</label>
                        <select id="supportChatSector" required onchange="window.loadSectorCategories(this.value)"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Selecione o setor</option>
                            {% for sector in user_support_sectors %}
                                {% if 'Ilha de Qualidade' in sector.name %}
                                <option value="{{ sector.id }}" data-virtual="lojas">ILHA - SUPORTE LOJAS</option>
                                <option value="{{ sector.id }}" data-virtual="logins">ILHA - SUPORTE LOGINS</option>
                                {% else %}
                                <option value="{{ sector.id }}">{{ sector.name }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div id="categoryDiv" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Assunto</label>
                        <select id="supportChatCategory" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Selecione o assunto</option>
                        </select>
                    </div>
                    
                    <!-- Queue Info -->
                    <div id="queueInfoDiv" class="hidden bg-blue-50 border border-blue-200 rounded-md p-3">
                        <div class="flex items-center text-blue-700 text-sm">
                            <i class="fas fa-users mr-2"></i>
                            <span id="queueInfoText">Carregando fila...</span>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Mensagem</label>
                        <textarea id="supportChatMessage" rows="4" required
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"
                                  placeholder="Descreva detalhadamente o problema ou dúvida"></textarea>
                    </div>
                    
                    <button type="submit" 
                            class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-md text-sm font-medium transition-colors">
                        <i class="fas fa-paper-plane mr-2"></i>Iniciar Chat de Suporte
                    </button>
                </form>
            </div>

            <!-- My Chats List -->
            <div id="myChatsList" class="hidden flex-1 overflow-y-auto min-h-0">
                <div id="supportChatList" class="p-2">
                    <!-- Chats will be loaded here -->
                </div>
            </div>

            <!-- Active Chat View -->
            <div id="activeChatView" class="hidden flex-1 flex flex-col min-h-0">
                <!-- Chat Header -->
                <div class="border-b border-gray-200 p-3 flex-shrink-0">
                    <div class="flex items-center justify-between">
                        <div class="flex-1 min-w-0">
                            <h4 id="activeChatTitle" class="font-medium text-sm text-gray-900 truncate"></h4>
                            <p id="activeChatStatus" class="text-xs text-gray-500"></p>
                            <p id="activeChatProtocol" class="text-xs text-blue-600 font-mono"></p>
                        </div>
                        <button id="backToChatList" class="text-gray-400 hover:text-gray-600 ml-2">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                    </div>
                    <!-- Queue Position Info -->
                    <div id="queuePositionDiv" class="hidden mt-2 bg-yellow-50 border border-yellow-200 rounded px-2 py-1">
                        <span class="text-xs text-yellow-700">
                            <i class="fas fa-clock mr-1"></i>
                            <span id="queuePositionText">Posição na fila: -</span>
                        </span>
                    </div>
                </div>

                <!-- Messages -->
                <div id="activeChatMessages" class="flex-1 overflow-y-auto p-3 space-y-2 min-h-0">
                    <!-- Messages will be loaded here -->
                </div>

                <!-- Message Input with File Upload -->
                <div class="border-t border-gray-200 p-3">
                    <form id="sendMessageForm" class="space-y-2">
                        <!-- File Preview -->
                        <div id="filePreviewContainer" class="hidden">
                            <div class="flex items-center bg-gray-100 rounded-md p-2">
                                <i id="filePreviewIcon" class="fas fa-file text-gray-500 mr-2"></i>
                                <span id="filePreviewName" class="text-sm text-gray-700 flex-1 truncate"></span>
                                <button type="button" onclick="window.clearFilePreview()" class="text-gray-400 hover:text-red-500">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <!-- Pasted Image Preview -->
                        <div id="pastedImagePreviewContainer" class="hidden">
                            <div class="bg-gray-50 p-2 rounded-lg flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <img id="pastedImagePreview" class="h-16 w-16 object-cover rounded" alt="Preview">
                                    <span class="text-sm text-gray-600">Imagem colada - Pronta para enviar</span>
                                </div>
                                <button type="button" onclick="window.clearPastedImage()" class="text-red-500 hover:text-red-700">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <!-- File Upload Button -->
                            <label class="cursor-pointer bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-2 rounded-md transition-colors">
                                <i class="fas fa-paperclip"></i>
                                <input type="file" id="fileInput" class="hidden" accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx,.txt" onchange="window.handleFileSelect(this)">
                            </label>
                            <input type="text" id="messageInput" 
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="Digite sua mensagem ou cole uma imagem (Ctrl+V)..."
                                   onpaste="window.handlePasteInChat(event)">
                            <button type="submit" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-md transition-colors">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {% block extra_js %}{% endblock %}
    
    <script>
    // ====================================================================
    // FUNÇÕES GLOBAIS CRÍTICAS - DEFINIDAS PRIMEIRO
    // ====================================================================
    window.switchTab = function(tab) {
        const newChatTab = document.getElementById('newChatTab');
        const myChatTab = document.getElementById('myChatTab');
        const newChatForm = document.getElementById('newChatForm');
        const myChatsList = document.getElementById('myChatsList');
        const activeChatView = document.getElementById('activeChatView');
        
        if (!newChatTab || !myChatTab || !newChatForm || !myChatsList || !activeChatView) {
            console.error('switchTab: elementos não encontrados');
            return;
        }
        
        if (tab === 'new') {
            newChatTab.classList.add('text-blue-600', 'border-blue-600', 'bg-white');
            newChatTab.classList.remove('text-gray-600');
            myChatTab.classList.remove('text-blue-600', 'border-blue-600', 'bg-white');
            myChatTab.classList.add('text-gray-600');
            newChatForm.classList.remove('hidden');
            myChatsList.classList.add('hidden');
            activeChatView.classList.add('hidden');
            if (window.loadSectors) window.loadSectors();
        } else {
            myChatTab.classList.add('text-blue-600', 'border-blue-600', 'bg-white');
            myChatTab.classList.remove('text-gray-600');
            newChatTab.classList.remove('text-blue-600', 'border-blue-600', 'bg-white');
            newChatTab.classList.add('text-gray-600');
            newChatForm.classList.add('hidden');
            myChatsList.classList.remove('hidden');
            activeChatView.classList.add('hidden');
        }
    };
    
    window.toggleChatExpand = function() {
        const chatWindow = document.getElementById('supportChatWindow');
        const expandBtn = document.getElementById('supportChatExpand');
        if (!chatWindow) return;
        const isExpanded = chatWindow.dataset.expanded === 'true';
        if (isExpanded) {
            chatWindow.style.position = 'absolute';
            chatWindow.style.width = '320px';
            chatWindow.style.height = '500px';
            chatWindow.style.top = '';
            chatWindow.style.left = '';
            chatWindow.style.right = '0';
            chatWindow.style.bottom = '64px';
            chatWindow.style.borderRadius = '0.5rem';
            chatWindow.dataset.expanded = 'false';
            if (expandBtn) {
                expandBtn.innerHTML = '<i class="fas fa-expand"></i>';
                expandBtn.title = 'Expandir';
            }
        } else {
            chatWindow.style.position = 'fixed';
            chatWindow.style.width = '100%';
            chatWindow.style.height = '100%';
            chatWindow.style.top = '0';
            chatWindow.style.left = '0';
            chatWindow.style.right = '0';
            chatWindow.style.bottom = '0';
            chatWindow.style.borderRadius = '0';
            chatWindow.dataset.expanded = 'true';
            if (expandBtn) {
                expandBtn.innerHTML = '<i class="fas fa-compress"></i>';
                expandBtn.title = 'Reduzir';
            }
        }
    };
    </script>
    
    <script>
        console.log('=== INÍCIO DO SCRIPT PRINCIPAL ===');
        console.log('Verificando funções:', {
            switchTab: typeof window.switchTab,
            toggleChatExpand: typeof window.toggleChatExpand
        });
        
        // Dados pré-carregados do backend
        try {
            window.userSupportSectors = {{ user_support_sectors_json|safe }};
            console.log('Setores pré-carregados do backend:', window.userSupportSectors);
        } catch(e) {
            console.error('Erro ao carregar setores:', e);
            window.userSupportSectors = [];
        }
        
        // ============ VARIÁVEIS GLOBAIS ============
        let currentChatId = null;
        let lastMessageId = 0;
        let pollingInterval = null;
        let selectedFile = null;
        window.pastedImageFile = window.pastedImageFile || null;
        
        console.log('=== DEFININDO FUNÇÕES GLOBAIS ===');
        
        // ============ FUNÇÕES DE ARQUIVO ============
        window.handleFileSelect = function(input) {
            const file = input.files[0];
            if (!file) return;
            
            // Validar tamanho (25MB)
            if (file.size > 25 * 1024 * 1024) {
                alert('Arquivo muito grande. Máximo: 25MB');
                input.value = '';
                return;
            }
            
            selectedFile = file;
            
            // Mostrar preview
            const container = document.getElementById('filePreviewContainer');
            const icon = document.getElementById('filePreviewIcon');
            const name = document.getElementById('filePreviewName');
            
            // Determinar ícone baseado no tipo
            if (file.type.startsWith('image/')) {
                icon.className = 'fas fa-image text-blue-500 mr-2';
            } else if (file.type.startsWith('video/')) {
                icon.className = 'fas fa-video text-purple-500 mr-2';
            } else if (file.type.startsWith('audio/')) {
                icon.className = 'fas fa-music text-green-500 mr-2';
            } else {
                icon.className = 'fas fa-file text-gray-500 mr-2';
            }
            
            name.textContent = file.name;
            container.classList.remove('hidden');
        };
        
        window.clearFilePreview = function() {
            selectedFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('filePreviewContainer').classList.add('hidden');
        };
        
        window.handlePasteInChat = function(event) {
            console.log('handlePasteInChat chamado');
            
            const clipboardData = event.clipboardData || event.originalEvent?.clipboardData;
            if (!clipboardData) {
                console.log('Sem clipboardData');
                return;
            }
            
            const items = clipboardData.items;
            console.log('Items no clipboard:', items.length);
            
            for (let item of items) {
                console.log('Item type:', item.type);
                if (item.type.indexOf('image') !== -1) {
                    console.log('Imagem detectada!');
                    event.preventDefault();
                    
                    const blob = item.getAsFile();
                    console.log('Blob:', blob);
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        console.log('FileReader onload');
                        const preview = document.getElementById('pastedImagePreviewContainer');
                        const img = document.getElementById('pastedImagePreview');
                        
                        console.log('Preview element:', preview);
                        console.log('Img element:', img);
                        
                        if (preview && img) {
                            img.src = e.target.result;
                            preview.classList.remove('hidden');
                            
                            // Limpar arquivo selecionado anteriormente
                            clearFilePreview();
                            
                            // Armazenar arquivo para envio
                            window.pastedImageFile = new File([blob], `imagem-colada-${Date.now()}.png`, {
                                type: blob.type
                            });
                            
                            console.log('pastedImageFile criado:', window.pastedImageFile);
                            showToastNotification('Imagem colada! Clique em Enviar para anexar.', 'info');
                        } else {
                            console.error('Elementos de preview não encontrados');
                        }
                    };
                    
                    reader.readAsDataURL(blob);
                    break;
                }
            }
        };
        
        window.clearPastedImage = function() {
            const preview = document.getElementById('pastedImagePreviewContainer');
            if (preview) {
                preview.classList.add('hidden');
            }
            window.pastedImageFile = null;
        };
        
        window.showToastNotification = function(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg shadow-lg text-white ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                'bg-blue-500'
            }`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.5s';
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        };
        
        // ============ FUNÇÕES DE POLLING TEMPO REAL ============
        function startPolling(chatId) {
            console.log('[Polling] Iniciando polling para chat:', chatId);
            stopPolling();
            
            // Primeira chamada imediata
            pollChatUpdates(chatId);
            
            pollingInterval = setInterval(() => {
                pollChatUpdates(chatId);
            }, 3000); // A cada 3 segundos
            
            console.log('[Polling] Polling ativo a cada 3 segundos');
        }
        
        function stopPolling() {
            if (pollingInterval) {
                console.log('[Polling] Parando polling');
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        }
        
        function pollChatUpdates(chatId) {
            if (!chatId || !currentChatId) {
                console.log('[Polling] Chat não está ativo, ignorando');
                return;
            }
            
            fetch(`/projects/support/chat/${chatId}/poll/?last_message_id=${lastMessageId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Adicionar novas mensagens
                        if (data.messages && data.messages.length > 0) {
                            const messagesContainer = document.getElementById('activeChatMessages');
                            if (messagesContainer) {
                                data.messages.forEach(msg => {
                                    if (msg.id > lastMessageId) {
                                        appendMessage(messagesContainer, msg);
                                        lastMessageId = msg.id;
                                    }
                                });
                                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                            }
                        }
                        
                        // Atualizar status
                        const statusEl = document.getElementById('activeChatStatus');
                        if (statusEl) {
                            statusEl.textContent = `Status: ${data.chat_status_display}${data.assigned_to ? ' | Atendente: ' + data.assigned_to : ''}`;
                        }
                        
                        // Atualizar posição na fila
                        const queueDiv = document.getElementById('queuePositionDiv');
                        const queueText = document.getElementById('queuePositionText');
                        
                        if (queueDiv && queueText) {
                            if (data.queue_position && data.chat_status !== 'EM_ANDAMENTO' && data.chat_status !== 'RESOLVIDO' && data.chat_status !== 'FECHADO') {
                                queueText.textContent = `Posição na fila: ${data.queue_position}º`;
                                queueDiv.classList.remove('hidden');
                            } else {
                                queueDiv.classList.add('hidden');
                            }
                        }
                        
                        // Atualizar protocolo se disponível
                        const protocolEl = document.getElementById('activeChatProtocol');
                        if (protocolEl && data.protocol) {
                            protocolEl.textContent = `Protocolo: ${data.protocol}`;
                        }
                    }
                })
                .catch(error => {
                    console.error('[Polling] Erro:', error);
                    // NÃO parar o polling, apenas log do erro
                });
        }
        
        function appendMessage(container, msg) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${msg.is_own ? 'justify-end' : 'justify-start'}`;
            
            let filesHtml = '';
            if (msg.files && msg.files.length > 0) {
                filesHtml = msg.files.map(file => {
                    if (file.type === 'IMAGE') {
                        return `<a href="${file.url}" target="_blank" class="block mt-2"><img src="${file.url}" class="max-w-full rounded" style="max-height: 200px;"></a>`;
                    } else if (file.type === 'VIDEO') {
                        return `<video src="${file.url}" controls class="max-w-full rounded mt-2" style="max-height: 200px;"></video>`;
                    } else {
                        return `<a href="${file.url}" target="_blank" class="flex items-center mt-2 text-blue-600 hover:underline"><i class="fas fa-file mr-1"></i>${file.name}</a>`;
                    }
                }).join('');
            }
            
            messageDiv.innerHTML = `
                <div class="max-w-xs px-3 py-2 rounded-lg text-sm ${msg.is_own ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-900'}">
                    ${!msg.is_own ? `<div class="text-xs font-medium mb-1">${msg.user.name}</div>` : ''}
                    <div>${msg.message}</div>
                    ${filesHtml}
                    <div class="text-xs ${msg.is_own ? 'text-blue-100' : 'text-gray-500'} mt-1">${msg.created_at}</div>
                    ${msg.is_internal ? '<div class="text-xs text-red-400 mt-1">Mensagem interna</div>' : ''}
                </div>
            `;
            container.appendChild(messageDiv);
        }
        
        // Global functions for support chat (called from onclick)
        window.toggleSupportChat = function() {
            console.log('toggleSupportChat called'); // Debug log
            
            // Força buscar o elemento na hora da execução
            const chatWindow = document.getElementById('supportChatWindow');
            console.log('Chat window element:', chatWindow); // Debug log
            
            if (chatWindow) {
                console.log('Chat window found'); // Debug log
                console.log('Current display:', chatWindow.style.display); // Debug log
                
                // Usar apenas display ao invés de classes
                if (chatWindow.style.display === 'none' || chatWindow.style.display === '') {
                    chatWindow.style.display = 'flex';
                    console.log('Chat window opened'); // Debug log
                    // Verificar se os setores precisam ser carregados (só se não estiverem no HTML)
                    const sectorSelect = document.getElementById('supportChatSector');
                    const currentOptions = sectorSelect ? sectorSelect.querySelectorAll('option:not([value=""])') : [];
                    if (currentOptions.length === 0) {
                        console.log('Setores não encontrados no HTML, tentando carregar...');
                        if (typeof window.loadSectors === 'function') {
                            window.loadSectors();
                        }
                    } else {
                        console.log('Setores já estão carregados:', currentOptions.length);
                    }
                } else {
                    chatWindow.style.display = 'none';
                    console.log('Chat window closed'); // Debug log
                    stopPolling();
                }
            } else {
                console.error('Chat window not found - element is null'); // Debug log
                
                // Debug: mostrar todos os elementos com ID
                const allIds = Array.from(document.querySelectorAll('[id]')).map(el => el.id);
                console.log('All IDs on page:', allIds.filter(id => id.includes('Chat') || id.includes('chat')));
            }
        };

        window.closeSupportChat = function() {
            console.log('closeSupportChat called'); // Debug log
            const chatWindow = document.getElementById('supportChatWindow');
            if (chatWindow) {
                chatWindow.style.display = 'none';
                console.log('Chat window closed'); // Debug log
                stopPolling();
            } else {
                console.error('Chat window not found'); // Debug log
            }
        };

        window.minimizeSupportChat = function() {
            console.log('minimizeSupportChat called'); // Debug log
            const chatWindow = document.getElementById('supportChatWindow');
            if (chatWindow) {
                chatWindow.style.display = 'none';
                console.log('Chat window minimized'); // Debug log
                stopPolling();
            } else {
                console.error('Chat window not found'); // Debug log
            }
        };

        // Debug function to test chat functionality
        window.testSupportChat = function() {
            console.log('Testing support chat functions...');
            const chatToggle = document.getElementById('supportChatToggle');
            const chatWindow = document.getElementById('supportChatWindow');
            
            console.log('Chat toggle button:', chatToggle);
            console.log('Chat window:', chatWindow);
            console.log('toggleSupportChat function:', typeof window.toggleSupportChat);
            
            if (chatToggle && chatWindow) {
                console.log('All elements found - chat should work!');
                // Testar diretamente
                chatWindow.style.display = chatWindow.style.display === 'none' ? 'flex' : 'none';
                console.log('Toggled display to:', chatWindow.style.display);
            } else {
                console.error('Missing elements - check HTML structure');
                if (!chatToggle) console.error('Chat toggle button not found');
                if (!chatWindow) console.error('Chat window not found');
            }
        };
        
        // Função alternativa mais direta
        window.forceToggleChat = function() {
            const chatWindow = document.getElementById('supportChatWindow');
            if (chatWindow) {
                const isVisible = chatWindow.style.display === 'flex';
                chatWindow.style.display = isVisible ? 'none' : 'flex';
                console.log('Force toggled to:', chatWindow.style.display);
            } else {
                alert('Chat window not found!');
            }
        };

        // Support Chat Widget JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded - Initializing support chat');
            
            const chatToggle = document.getElementById('supportChatToggle');
            const chatWindow = document.getElementById('supportChatWindow');
            const chatClose = document.getElementById('supportChatClose');
            const chatMinimize = document.getElementById('supportChatMinimize');
            const newChatTab = document.getElementById('newChatTab');
            const myChatTab = document.getElementById('myChatTab');
            const newChatForm = document.getElementById('newChatForm');
            const myChatsList = document.getElementById('myChatsList');
            const activeChatView = document.getElementById('activeChatView');
            const backToChatList = document.getElementById('backToChatList');

            console.log('Elements found:', {
                chatToggle: !!chatToggle,
                chatWindow: !!chatWindow,
                newChatTab: !!newChatTab,
                myChatTab: !!myChatTab,
                newChatForm: !!newChatForm,
                myChatsList: !!myChatsList
            });

            // currentChatId já declarado no escopo global
            let isMinimized = false;

            // Toggle chat window (backup event listener)
            if (chatToggle) {
                chatToggle.addEventListener('click', function(e) {
                    // Prevent double triggering if onclick is also defined
                    if (e.target.onclick) return;
                    
                    if (isMinimized) {
                        chatWindow.classList.remove('hidden');
                        isMinimized = false;
                    } else {
                        chatWindow.classList.toggle('hidden');
                    }
                });
            }

            // Close chat
            if (chatClose) {
                chatClose.addEventListener('click', function() {
                    chatWindow.style.display = 'none';
                    isMinimized = false;
                });
            }

            // Minimize chat
            if (chatMinimize) {
                chatMinimize.addEventListener('click', function() {
                    chatWindow.style.display = 'none';
                    isMinimized = true;
                });
            }

            // Tab switching
            if (newChatTab) {
                newChatTab.addEventListener('click', function() {
                    console.log('New Chat tab clicked');
                    window.switchTab('new');
                });
            }

            if (myChatTab) {
                myChatTab.addEventListener('click', function() {
                    console.log('=== My Chats tab clicked ===');
                    console.log('Chamando window.switchTab(my)');
                    window.switchTab('my');
                    console.log('Chamando window.loadMyChats()');
                    window.loadMyChats();
                });
            } else {
                console.error('myChatTab button not found!');
            }

            // Create new support chat
            document.getElementById('createSupportChatForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                console.log('Form submitted');
                
                const sectorSelect = document.getElementById('supportChatSector');
                const categorySelect = document.getElementById('supportChatCategory');
                const messageInput = document.getElementById('supportChatMessage');
                
                console.log('Form values:', {
                    sector: sectorSelect.value,
                    category: categorySelect.value,
                    message: messageInput.value
                });
                
                // Create title based on sector and category
                const sectorText = sectorSelect.options[sectorSelect.selectedIndex]?.text || '';
                const categoryText = categorySelect.options[categorySelect.selectedIndex]?.text || '';
                const title = `${sectorText} - ${categoryText}`;
                
                const formData = new FormData();
                formData.append('title', title);
                formData.append('sector_id', sectorSelect.value);
                formData.append('category_id', categorySelect.value);
                formData.append('message', messageInput.value);
                formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

                fetch('/projects/support/chat/create/', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    console.log('Create chat response:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Create chat data:', data);
                    if (data.success) {
                        // Clear form
                        this.reset();
                        document.getElementById('categoryDiv').classList.add('hidden');
                        
                        // Mostrar notificação de sucesso
                        const message = data.queue_position 
                            ? `Chat criado com sucesso! Protocolo: ${data.protocol}. Você está na posição ${data.queue_position} da fila.`
                            : `Chat criado com sucesso! Protocolo: ${data.protocol}`;
                        
                        if (typeof showToast === 'function') {
                            showToast(message, 'success');
                        } else {
                            alert(message);
                        }
                        
                        // Switch to my chats and load the new chat
                        window.switchTab('my');
                        window.loadMyChats();
                        setTimeout(() => window.openChat(data.chat_id), 1000);
                    } else {
                        alert('Erro ao criar chat: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error creating chat:', error);
                    alert('Erro ao criar chat de suporte');
                });
            });

            // Load my chats
            window.loadMyChats = function() {
                console.log('loadMyChats() called');
                fetch('/projects/support/chats/')
                .then(response => {
                    console.log('My chats response:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('My chats data:', data);
                    if (data.success) {
                        const chatList = document.getElementById('supportChatList');
                        chatList.innerHTML = '';
                        
                        if (data.chats.length === 0) {
                            chatList.innerHTML = '<div class="text-center text-gray-500 text-sm py-4">Nenhum chat encontrado</div>';
                            return;
                        }

                        data.chats.forEach(chat => {
                            const chatItem = document.createElement('div');
                            chatItem.className = 'p-2 border border-gray-200 rounded-md mb-2 cursor-pointer hover:bg-gray-50';
                            
                            // Mostrar posição na fila se aplicável
                            let queueInfo = '';
                            if (chat.queue_position && ['AGUARDANDO', 'ABERTO'].includes(chat.status_code)) {
                                queueInfo = `<span class="text-xs text-yellow-600"><i class="fas fa-clock mr-1"></i>${chat.queue_position}º na fila</span>`;
                            }
                            
                            chatItem.innerHTML = `
                                <div class="flex items-center justify-between mb-1">
                                    <h5 class="text-sm font-medium text-gray-900 truncate flex-1">${chat.title}</h5>
                                    <span class="text-xs px-2 py-1 rounded-full ${getStatusColor(chat.status_code)}">${chat.status}</span>
                                </div>
                                ${chat.protocol ? `<p class="text-xs text-blue-600 font-mono mb-1">📋 ${chat.protocol}</p>` : ''}
                                <p class="text-xs text-gray-600 truncate">${chat.last_message}</p>
                                <div class="flex items-center justify-between mt-1">
                                    <span class="text-xs text-gray-500">${chat.updated_at}</span>
                                    ${queueInfo}
                                    <span class="text-xs px-1 py-0.5 rounded ${getPriorityColor(chat.priority)}">${chat.priority}</span>
                                </div>
                            `;
                            chatItem.addEventListener('click', () => window.openChat(chat.id));
                            chatList.appendChild(chatItem);
                        });
                        console.log('Chats loaded:', data.chats.length);
                    } else {
                        console.error('Error in response:', data);
                    }
                })
                .catch(error => {
                    console.error('Error loading chats:', error);
                });
            };

            function getStatusColor(status) {
                switch (status) {
                    case 'AGUARDANDO': return 'bg-purple-100 text-purple-800';
                    case 'ABERTO': return 'bg-blue-100 text-blue-800';
                    case 'EM_ANDAMENTO': return 'bg-yellow-100 text-yellow-800';
                    case 'RESOLVIDO': return 'bg-green-100 text-green-800';
                    case 'FECHADO': return 'bg-gray-100 text-gray-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            }

            function getPriorityColor(priority) {
                switch (priority) {
                    case 'Baixa': return 'bg-green-100 text-green-800';
                    case 'Média': return 'bg-yellow-100 text-yellow-800';
                    case 'Alta': return 'bg-orange-100 text-orange-800';
                    case 'Urgente': return 'bg-red-100 text-red-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            }

            // Open specific chat
            window.openChat = function(chatId) {
                console.log('openChat() called with chatId:', chatId);
                currentChatId = chatId;
                lastMessageId = 0;
                
                fetch(`/projects/support/chat/${chatId}/`)
                .then(response => {
                    console.log('Chat response:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Chat data:', data);
                    if (data.success) {
                        // Update chat header
                        document.getElementById('activeChatTitle').textContent = data.chat.title;
                        document.getElementById('activeChatStatus').textContent = `Status: ${data.chat.get_status_display}${data.chat.assigned_to ? ' | Atendente: ' + data.chat.assigned_to.get_full_name : ''}`;
                        
                        // Mostrar protocolo se existir
                        const protocolEl = document.getElementById('activeChatProtocol');
                        if (data.chat.protocol) {
                            protocolEl.textContent = `Protocolo: ${data.chat.protocol}`;
                        } else {
                            protocolEl.textContent = '';
                        }
                        
                        // Verificar e mostrar posição na fila
                        const queueDiv = document.getElementById('queuePositionDiv');
                        const queueText = document.getElementById('queuePositionText');
                        if (data.chat.queue_position && ['AGUARDANDO', 'ABERTO'].includes(data.chat.status)) {
                            queueText.textContent = `Posição na fila: ${data.chat.queue_position}º`;
                            queueDiv.classList.remove('hidden');
                        } else {
                            queueDiv.classList.add('hidden');
                        }
                        
                        // Load messages
                        const messagesContainer = document.getElementById('activeChatMessages');
                        messagesContainer.innerHTML = '';
                        
                        data.messages.forEach(msg => {
                            appendMessage(messagesContainer, msg);
                            if (msg.id > lastMessageId) {
                                lastMessageId = msg.id;
                            }
                        });

                        // Scroll to bottom
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        
                        // Show chat view
                        const myChatsList = document.getElementById('myChatsList');
                        const activeChatView = document.getElementById('activeChatView');
                        myChatsList.classList.add('hidden');
                        activeChatView.classList.remove('hidden');
                        
                        // Iniciar polling para tempo real
                        startPolling(chatId);
                        
                        console.log('Chat loaded successfully');
                    } else {
                        console.error('Error in chat response:', data);
                    }
                })
                .catch(error => {
                    console.error('Error loading chat:', error);
                });
            };

            // Back to chat list
            if (backToChatList) {
                backToChatList.addEventListener('click', function() {
                    const activeChatView = document.getElementById('activeChatView');
                    const myChatsList = document.getElementById('myChatsList');
                    activeChatView.classList.add('hidden');
                    myChatsList.classList.remove('hidden');
                    currentChatId = null;
                    stopPolling();
                    clearFilePreview();
                });
            }

            // Send message (com suporte a arquivos)
            const sendMessageForm = document.getElementById('sendMessageForm');
            if (sendMessageForm) {
                sendMessageForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    console.log('[Envio] Formulário submetido');
                    console.log('[Envio] currentChatId:', currentChatId);
                    
                    if (!currentChatId) {
                        console.error('[Envio] Nenhum chat ativo');
                        return;
                    }
                    
                    const messageInput = document.getElementById('messageInput');
                    const message = messageInput.value.trim();
                    
                    console.log('[Envio] Mensagem:', message);
                    console.log('[Envio] Arquivo:', selectedFile);
                    console.log('[Envio] Imagem colada:', window.pastedImageFile);
                    
                    // Se não tem mensagem nem arquivo nem imagem colada, não enviar
                    if (!message && !selectedFile && !window.pastedImageFile) {
                        console.log('[Envio] Nada para enviar');
                        return;
                    }
                    
                    const formData = new FormData();
                    formData.append('message', message || '');
                    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
                    
                    // URL diferente se tem arquivo
                    let url = `/projects/support/chat/${currentChatId}/send/`;
                    if (selectedFile) {
                        formData.append('file', selectedFile);
                        url = `/projects/support/chat/${currentChatId}/upload/`;
                    } else if (window.pastedImageFile) {
                        formData.append('file', window.pastedImageFile);
                        formData.append('message', message || '🖼️ Imagem');
                        url = `/projects/support/chat/${currentChatId}/upload/`;
                    }

                    console.log('[Envio] URL:', url);

                    fetch(url, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        console.log('[Envio] Resposta status:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('[Envio] Resposta data:', data);
                        if (data.success) {
                            // Add message to chat
                            const messagesContainer = document.getElementById('activeChatMessages');
                            if (messagesContainer) {
                                appendMessage(messagesContainer, data.message);
                                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                            }
                            
                            // Atualizar lastMessageId
                            if (data.message.id > lastMessageId) {
                                lastMessageId = data.message.id;
                            }
                        
                            // Clear input and file
                            messageInput.value = '';
                            if (window.clearFilePreview) window.clearFilePreview();
                            if (window.clearPastedImage) window.clearPastedImage();
                            
                            console.log('[Envio] Mensagem enviada com sucesso');
                        } else {
                            console.error('[Envio] Erro no envio:', data.error);
                            alert('Erro ao enviar mensagem: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('[Envio] Erro na requisição:', error);
                        alert('Erro ao enviar mensagem');
                    });
                });
            } else {
                console.error('[Envio] Formulário sendMessageForm não encontrado');
            }
        });

        // Load available sectors (now pre-loaded from backend)
        window.loadSectors = function() {
            console.log('loadSectors() called');
            const sectorSelect = document.getElementById('supportChatSector');
            console.log('sectorSelect element:', sectorSelect);
            
            if (!sectorSelect) {
                console.error('Elemento supportChatSector não encontrado!');
                return;
            }
            
            // Setores já estão pré-carregados no template, mas podemos verificar se precisam ser atualizados
            if (window.userSupportSectors && window.userSupportSectors.length > 0) {
                console.log('Usando setores pré-carregados:', window.userSupportSectors.length);
                // Os setores já estão no HTML, apenas verificamos
                const currentOptions = sectorSelect.querySelectorAll('option:not([value=""])');
                console.log('Opções atuais no select:', currentOptions.length);
                
                if (currentOptions.length === 0) {
                    // Se por algum motivo não estiver no HTML, adiciona via JS
                    window.userSupportSectors.forEach(sector => {
                        const option = document.createElement('option');
                        option.value = sector.id;
                        option.textContent = sector.name;
                        sectorSelect.appendChild(option);
                    });
                    console.log('Setores adicionados via JS:', window.userSupportSectors.length);
                }
            } else {
                console.warn('Nenhum setor pré-carregado, tentando buscar da API');
                // Fallback: tentar buscar da API
                fetch('/projects/support/sectors/')
                    .then(response => {
                        console.log('API Response received:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('API Data received:', data);
                        if (data.success) {
                            sectorSelect.innerHTML = '<option value="">Selecione o setor</option>';
                            
                            data.sectors.forEach(sector => {
                                const option = document.createElement('option');
                                option.value = sector.id;
                                option.textContent = sector.name;
                                sectorSelect.appendChild(option);
                            });
                            console.log('Setores carregados da API:', data.sectors.length);
                        } else {
                            console.error('Erro na resposta da API:', data);
                        }
                    })
                    .catch(error => {
                        console.error('Error loading sectors from API:', error);
                    });
            }
        };

        // Load categories based on selected sector
        window.loadSectorCategories = function(sectorId) {
            console.log('loadSectorCategories() called with sectorId:', sectorId);
            const categoryDiv = document.getElementById('categoryDiv');
            const categorySelect = document.getElementById('supportChatCategory');
            const queueInfoDiv = document.getElementById('queueInfoDiv');
            const queueInfoText = document.getElementById('queueInfoText');
            
            if (!categoryDiv || !categorySelect) {
                console.error('Elementos de categoria não encontrados!');
                return;
            }
            
            if (!sectorId) {
                categoryDiv.classList.add('hidden');
                categorySelect.innerHTML = '<option value="">Selecione o assunto</option>';
                if (queueInfoDiv) queueInfoDiv.classList.add('hidden');
                return;
            }
            
            console.log('Buscando categorias para setor:', sectorId);
            
            // Resetar o estilo do queueInfoDiv para o padrão
            if (queueInfoDiv) {
                queueInfoDiv.className = 'hidden bg-blue-50 border border-blue-200 rounded-md p-3';
                if (queueInfoText && queueInfoText.parentElement) {
                    queueInfoText.parentElement.className = 'flex items-center text-blue-700 text-sm';
                }
            }
            
            // Buscar informações da fila do setor
            fetch(`/projects/support/queue-status/?sector_id=${sectorId}`)
                .then(response => response.json())
                .then(data => {
                    console.log('Queue status response:', data);
                    if (data.success && queueInfoDiv && queueInfoText) {
                        // Sempre mostrar a fila, mesmo se não houver dados
                        if (data.queue && data.queue.length > 0) {
                            const sectorQueue = data.queue[0];
                            if (sectorQueue.waiting > 0) {
                                queueInfoText.innerHTML = `<strong>${sectorQueue.waiting}</strong> pessoa(s) aguardando neste setor`;
                                queueInfoDiv.className = 'bg-yellow-50 border border-yellow-200 rounded-md p-3';
                                queueInfoText.parentElement.className = 'flex items-center text-yellow-700 text-sm';
                            } else {
                                queueInfoText.innerHTML = `<i class="fas fa-check-circle mr-1"></i> Nenhuma pessoa na fila - atendimento imediato!`;
                                queueInfoDiv.className = 'bg-green-50 border border-green-200 rounded-md p-3';
                                queueInfoText.parentElement.className = 'flex items-center text-green-700 text-sm';
                            }
                        } else {
                            queueInfoText.innerHTML = `<i class="fas fa-check-circle mr-1"></i> Nenhuma pessoa na fila - atendimento imediato!`;
                            queueInfoDiv.className = 'bg-green-50 border border-green-200 rounded-md p-3';
                            queueInfoText.parentElement.className = 'flex items-center text-green-700 text-sm';
                        }
                        queueInfoDiv.classList.remove('hidden');
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar fila:', error);
                    // Mostrar fila vazia em caso de erro
                    if (queueInfoDiv && queueInfoText) {
                        queueInfoText.innerHTML = `Não foi possível verificar a fila`;
                        queueInfoDiv.className = 'bg-gray-50 border border-gray-200 rounded-md p-3';
                        queueInfoText.parentElement.className = 'flex items-center text-gray-600 text-sm';
                        queueInfoDiv.classList.remove('hidden');
                    }
                });
            
            fetch(`/projects/support/sectors/${sectorId}/categories/`)
                .then(response => {
                    console.log('Categories response received:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Categories data received:', data);
                    if (data.success) {
                        categorySelect.innerHTML = '<option value="">Selecione o assunto</option>';
                        
                        if (data.categories && data.categories.length > 0) {
                            data.categories.forEach(category => {
                                const option = document.createElement('option');
                                option.value = category.id;
                                option.textContent = category.name;
                                categorySelect.appendChild(option);
                            });
                            
                            categoryDiv.classList.remove('hidden');
                            console.log('Categorias carregadas:', data.categories.length);
                        } else {
                            console.warn('Nenhuma categoria encontrada para este setor');
                            categoryDiv.classList.add('hidden');
                            alert('Nenhuma categoria disponível para este setor. Por favor, contate o administrador.');
                        }
                    } else {
                        console.error('Erro na resposta de categorias:', data);
                        alert('Erro ao carregar categorias: ' + (data.error || 'Erro desconhecido'));
                    }
                })
                .catch(error => {
                    console.error('Error loading categories:', error);
                    alert('Erro ao carregar categorias. Verifique sua conexão.');
                });
        };
        
        // Helper functions
        function getTimeAgo(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const diff = now - date;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Agora';
            if (minutes < 60) return `${minutes}m`;
            if (hours < 24) return `${hours}h`;
            if (days < 7) return `${days}d`;
            
            return date.toLocaleDateString('pt-BR', { 
                day: '2-digit', 
                month: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function minimizeTaskChat() {
            // Could implement minimization functionality here
            const modal = document.querySelector('.fixed.inset-0');
            if (modal) {
                modal.style.display = 'none';
                // Could add to a minimized chat list
            }
        }
        
        function showToast(message, type = 'info') {
            // Simple toast implementation
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 z-50 px-4 py-2 rounded-lg text-white transition-all duration-300 ${
                type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500'
            }`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(100%)';
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }
        
        // Debug: Log available global functions
        console.log('Support Chat Functions Loaded:', {
            toggleSupportChat: typeof window.toggleSupportChat,
            loadSectors: typeof window.loadSectors,
            loadSectorCategories: typeof window.loadSectorCategories,
            loadMyChats: typeof window.loadMyChats,
            openChat: typeof window.openChat
        });
    </script>
</body>
</html>
