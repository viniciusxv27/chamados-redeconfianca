{% extends 'base.html' %}
{% load static %}

{% block title %}Novo Projeto - Rede Confian√ßa{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Projetos</h1>
        <p class="text-gray-600 mt-2">Criar novo projeto</p>
    </div>
    
    <!-- Tabs Navigation -->
    <div class="mb-6">
        <nav class="flex space-x-8 border-b border-gray-200">
            <a href="#" class="border-b-2 border-primary text-primary py-2 px-1 text-sm font-medium">
                Novo Projeto
            </a>
        </nav>
    </div>

    <!-- Form -->
    <div class="bg-white rounded-lg shadow-sm p-6">
        <form method="POST" class="space-y-6">
            {% csrf_token %}
            
            <div>
                <label for="name" class="block text-sm font-medium text-gray-700 mb-2">Nome do Projeto *</label>
                <input 
                    type="text" 
                    name="name" 
                    id="name" 
                    required
                    maxlength="200"
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 hover:border-orange-300 transition-colors"
                    placeholder="üìù Digite o nome do projeto"
                >
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="sector" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-building text-orange-500 mr-2"></i>Setor Respons√°vel *
                    </label>
                    <select 
                        name="sector" 
                        id="sector" 
                        required
                        class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-white hover:border-orange-300 transition-colors appearance-none"
                        style="background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 4 5\"><path fill=\"%23666\" d=\"M2 0L0 2h4zm0 5L0 3h4z\"/></svg>'); background-repeat: no-repeat; background-position: right 0.7rem center; background-size: 0.65rem;"
                    >
                        <option value="" disabled selected>üè¢ Selecione o setor respons√°vel</option>
                        {% for sector in sectors %}
                            <option value="{{ sector.id }}">{{ sector.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label for="priority" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-flag text-orange-500 mr-2"></i>Prioridade *
                    </label>
                    <select 
                        name="priority" 
                        id="priority" 
                        required
                        class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-white hover:border-orange-300 transition-colors appearance-none"
                        style="background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 4 5\"><path fill=\"%23666\" d=\"M2 0L0 2h4zm0 5L0 3h4z\"/></svg>'); background-repeat: no-repeat; background-position: right 0.7rem center; background-size: 0.65rem;"
                    >
                        <option value="" disabled selected>‚ö° Definir n√≠vel de prioridade</option>
                        {% for priority, label in priority_choices %}
                            <option value="{{ priority }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="deadline" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-calendar-check text-orange-500 mr-2"></i>Prazo Final *
                    </label>
                    <input 
                        type="date" 
                        name="deadline" 
                        id="deadline" 
                        required
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 hover:border-orange-300 transition-colors"
                    >
                </div>
                
                <div>
                    <label for="responsible_user" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-user-tie text-orange-500 mr-2"></i>Respons√°vel Principal
                    </label>
                    <select 
                        name="responsible_user" 
                        id="responsible_user"
                        class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-white hover:border-orange-300 transition-colors appearance-none"
                        style="background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 4 5\"><path fill=\"%23666\" d=\"M2 0L0 2h4zm0 5L0 3h4z\"/></svg>'); background-repeat: no-repeat; background-position: right 0.7rem center; background-size: 0.65rem;"
                    >
                        <option value="">üë§ Definir depois (opcional)</option>
                    </select>
                </div>
            </div>
            
            <div>
                <label for="description" class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o *</label>
                <textarea 
                    name="description" 
                    id="description" 
                    rows="4"
                    required
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 hover:border-orange-300 transition-colors resize-vertical"
                    placeholder="üìã Descreva brevemente o projeto..."
                ></textarea>
            </div>
            
            <div>
                <label for="scope" class="block text-sm font-medium text-gray-700 mb-2">Escopo Completo *</label>
                <textarea 
                    name="scope" 
                    id="scope" 
                    rows="6"
                    required
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 hover:border-orange-300 transition-colors resize-vertical"
                    placeholder="üéØ Descreva detalhadamente o escopo do projeto, objetivos, entregas esperadas e crit√©rios de sucesso..."
                ></textarea>
            </div>
            
            <div>
                <label for="reason" class="block text-sm font-medium text-gray-700 mb-2">Motivo/Justificativa *</label>
                <textarea 
                    name="reason" 
                    id="reason" 
                    rows="4"
                    required
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 hover:border-orange-300 transition-colors resize-vertical"
                    placeholder="üí° Explique a necessidade e justificativa para este projeto..."
                ></textarea>
            </div>
            
            <!-- Submit Button -->
            <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
                <a href="{% url 'projects:project_list' %}" 
                   class="px-6 py-3 border-2 border-gray-300 rounded-lg text-gray-700 hover:border-orange-500 hover:text-orange-600 transition-all duration-200 font-medium">
                    <i class="fas fa-arrow-left mr-2"></i>Cancelar
                </a>
                <button type="submit" id="submit-btn"
                        class="px-6 py-3 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-lg hover:from-orange-600 hover:to-orange-700 transition-all duration-200 font-medium shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                    <i class="fas fa-plus mr-2"></i>Criar Projeto
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Setar data m√≠nima para hoje
    const deadlineInput = document.getElementById('deadline');
    const today = new Date().toISOString().split('T')[0];
    deadlineInput.min = today;
    
    // Carregar usu√°rios quando o setor for selecionado
    const sectorSelect = document.getElementById('sector');
    const responsibleSelect = document.getElementById('responsible_user');
    
    sectorSelect.addEventListener('change', function() {
        const sectorId = this.value;
        
        // Adicionar spinner de carregamento
        responsibleSelect.innerHTML = '<option value="">üîÑ Carregando usu√°rios...</option>';
        responsibleSelect.disabled = true;
        
        if (!sectorId) {
            responsibleSelect.innerHTML = '<option value="">Definir respons√°vel depois...</option>';
            responsibleSelect.disabled = false;
            return;
        }
        
        // Fazer requisi√ß√£o para buscar usu√°rios do setor
        fetch(`/projects/api/sectors/${sectorId}/users/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    responsibleSelect.innerHTML = '<option value="">Definir depois (opcional)</option>';
                    
                    data.users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = `${user.full_name} (${user.hierarchy})`;
                        responsibleSelect.appendChild(option);
                    });
                } else {
                    throw new Error(data.error || 'Erro desconhecido');
                }
                
                responsibleSelect.disabled = false;
            })
            .catch(error => {
                console.error('Erro ao carregar usu√°rios:', error);
                responsibleSelect.innerHTML = '<option value="">‚ö†Ô∏è Erro ao carregar usu√°rios</option>';
                responsibleSelect.disabled = false;
                
                // Mostrar notifica√ß√£o de erro
                showNotification(`Erro ao carregar usu√°rios do setor: ${error.message}`, 'error');
            });
    });
    
    // Valida√ß√£o do formul√°rio
    const form = document.querySelector('form');
    const submitBtn = document.getElementById('submit-btn');
    
    form.addEventListener('submit', function(e) {
        const deadline = new Date(deadlineInput.value);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (deadline < today) {
            e.preventDefault();
            showNotification('O prazo final deve ser maior ou igual √† data atual.', 'error');
            deadlineInput.focus();
            deadlineInput.style.borderColor = 'var(--danger-color)';
            return false;
        }
        
        // Adicionar loading no bot√£o
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Criando Projeto...';
    });
    
    // Auto-resize das textareas
    const textareas = document.querySelectorAll('textarea');
    textareas.forEach(textarea => {
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
    });
    
    // Feedback visual para prioridade
    const prioritySelect = document.getElementById('priority');
    prioritySelect.addEventListener('change', function() {
        const priority = this.value;
        this.className = this.className.replace(/priority-\w+/g, '');
        
        if (priority === 'CRITICA') {
            this.classList.add('priority-high');
        } else if (priority === 'ALTA') {
            this.classList.add('priority-medium');  
        } else if (priority === 'BAIXA') {
            this.classList.add('priority-low');
        }
    });
    
    // Limpar erros ao corrigir campos
    deadlineInput.addEventListener('input', function() {
        this.style.borderColor = '';
    });
});

// Fun√ß√£o para mostrar notifica√ß√µes usando o padr√£o da plataforma
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = 'notification';
    
    let bgColor, icon;
    switch(type) {
        case 'success':
            bgColor = 'var(--success-color)';
            icon = 'fa-check-circle';
            break;
        case 'error':
            bgColor = 'var(--danger-color)';
            icon = 'fa-exclamation-triangle';
            break;
        case 'warning':
            bgColor = 'var(--warning-color)';
            icon = 'fa-exclamation-circle';
            break;
        default:
            bgColor = 'var(--primary-color)';
            icon = 'fa-info-circle';
    }
    
    notification.style.backgroundColor = bgColor;
    notification.style.color = 'white';
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas ${icon} mr-3"></i>
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-auto text-white hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove ap√≥s 5 segundos
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 5000);
}
</script>
{% endblock %}