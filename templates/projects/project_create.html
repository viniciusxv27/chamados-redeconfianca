{% extends 'base.html' %}
{% load static %}

{% block title %}Novo Projeto - Rede Confiança{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Projetos</h1>
        <p class="text-gray-600 mt-2">Criar novo projeto</p>
    </div>
    
    <!-- Tabs Navigation -->
    <div class="mb-6">
        <nav class="flex space-x-8 border-b border-gray-200">
            <a href="#" class="border-b-2 border-primary text-primary py-2 px-1 text-sm font-medium">
                Novo Projeto
            </a>
        </nav>
    </div>

    <!-- Form -->
    <div class="bg-white rounded-lg shadow-sm p-6">
        <form method="POST" class="space-y-6">
            {% csrf_token %}
            
            <div>
                <label for="name" class="block text-sm font-medium text-gray-700 mb-2">Nome do Projeto *</label>
                <input 
                    type="text" 
                    name="name" 
                    id="name" 
                    required
                    maxlength="200"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                    placeholder="Digite o nome do projeto"
                >
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="sector" class="block text-sm font-medium text-gray-700 mb-2">Setor Responsável *</label>
                    <select 
                        name="sector" 
                        id="sector" 
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                    >
                        <option value="">Selecione o setor</option>
                        {% for sector in sectors %}
                            <option value="{{ sector.id }}">{{ sector.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label for="priority" class="block text-sm font-medium text-gray-700 mb-2">Prioridade *</label>
                    <select 
                        name="priority" 
                        id="priority" 
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                    >
                        <option value="">Selecione a prioridade</option>
                        {% for priority, label in priority_choices %}
                            <option value="{{ priority }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="deadline" class="block text-sm font-medium text-gray-700 mb-2">Prazo Final *</label>
                    <input 
                        type="date" 
                        name="deadline" 
                        id="deadline" 
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                    >
                </div>
                
                <div>
                    <label for="responsible_user" class="block text-sm font-medium text-gray-700 mb-2">Responsável Principal</label>
                    <select 
                        name="responsible_user" 
                        id="responsible_user"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                    >
                        <option value="">Definir depois (opcional)</option>
                    </select>
                </div>
            </div>
            
            <div>
                <label for="description" class="block text-sm font-medium text-gray-700 mb-2">Descrição *</label>
                <textarea 
                    name="description" 
                    id="description" 
                    rows="4"
                    required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-vertical"
                    placeholder="Descreva brevemente o projeto..."
                ></textarea>
            </div>
            
            <div>
                <label for="scope" class="block text-sm font-medium text-gray-700 mb-2">Escopo Completo *</label>
                <textarea 
                    name="scope" 
                    id="scope" 
                    rows="6"
                    required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-vertical"
                    placeholder="Descreva detalhadamente o escopo do projeto, objetivos, entregas esperadas e critérios de sucesso..."
                ></textarea>
            </div>
            
            <div>
                <label for="reason" class="block text-sm font-medium text-gray-700 mb-2">Motivo/Justificativa *</label>
                <textarea 
                    name="reason" 
                    id="reason" 
                    rows="4"
                    required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-vertical"
                    placeholder="Explique a necessidade e justificativa para este projeto..."
                ></textarea>
            </div>
            
            <!-- Submit Button -->
            <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
                <a href="{% url 'projects:project_list' %}" 
                   class="px-6 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors">
                    Cancelar
                </a>
                <button type="submit" 
                        class="px-6 py-2 bg-primary text-white rounded-md hover:bg-orange-600 transition-colors font-medium">
                    Criar Projeto
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Setar data mínima para hoje
    const deadlineInput = document.getElementById('deadline');
    const today = new Date().toISOString().split('T')[0];
    deadlineInput.min = today;
    
    // Carregar usuários quando o setor for selecionado
    const sectorSelect = document.getElementById('sector');
    const responsibleSelect = document.getElementById('responsible_user');
    
    sectorSelect.addEventListener('change', function() {
        const sectorId = this.value;
        
        // Adicionar spinner de carregamento
        responsibleSelect.innerHTML = '<option value="">🔄 Carregando usuários...</option>';
        responsibleSelect.disabled = true;
        
        if (!sectorId) {
            responsibleSelect.innerHTML = '<option value="">Definir responsável depois...</option>';
            responsibleSelect.disabled = false;
            return;
        }
        
        // Fazer requisição para buscar usuários do setor
        fetch(`/projects/api/sectors/${sectorId}/users/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    responsibleSelect.innerHTML = '<option value="">Definir depois (opcional)</option>';
                    
                    data.users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = `${user.full_name} (${user.hierarchy})`;
                        responsibleSelect.appendChild(option);
                    });
                } else {
                    throw new Error(data.error || 'Erro desconhecido');
                }
                
                responsibleSelect.disabled = false;
            })
            .catch(error => {
                console.error('Erro ao carregar usuários:', error);
                responsibleSelect.innerHTML = '<option value="">⚠️ Erro ao carregar usuários</option>';
                responsibleSelect.disabled = false;
                
                // Mostrar notificação de erro
                showNotification(`Erro ao carregar usuários do setor: ${error.message}`, 'error');
            });
    });
    
    // Validação do formulário
    const form = document.querySelector('form');
    const submitBtn = document.getElementById('submit-btn');
    
    form.addEventListener('submit', function(e) {
        const deadline = new Date(deadlineInput.value);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (deadline < today) {
            e.preventDefault();
            showNotification('O prazo final deve ser maior ou igual à data atual.', 'error');
            deadlineInput.focus();
            deadlineInput.style.borderColor = 'var(--danger-color)';
            return false;
        }
        
        // Adicionar loading no botão
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Criando Projeto...';
    });
    
    // Auto-resize das textareas
    const textareas = document.querySelectorAll('textarea');
    textareas.forEach(textarea => {
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
    });
    
    // Feedback visual para prioridade
    const prioritySelect = document.getElementById('priority');
    prioritySelect.addEventListener('change', function() {
        const priority = this.value;
        this.className = this.className.replace(/priority-\w+/g, '');
        
        if (priority === 'CRITICA') {
            this.classList.add('priority-high');
        } else if (priority === 'ALTA') {
            this.classList.add('priority-medium');  
        } else if (priority === 'BAIXA') {
            this.classList.add('priority-low');
        }
    });
    
    // Limpar erros ao corrigir campos
    deadlineInput.addEventListener('input', function() {
        this.style.borderColor = '';
    });
});

// Função para mostrar notificações usando o padrão da plataforma
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = 'notification';
    
    let bgColor, icon;
    switch(type) {
        case 'success':
            bgColor = 'var(--success-color)';
            icon = 'fa-check-circle';
            break;
        case 'error':
            bgColor = 'var(--danger-color)';
            icon = 'fa-exclamation-triangle';
            break;
        case 'warning':
            bgColor = 'var(--warning-color)';
            icon = 'fa-exclamation-circle';
            break;
        default:
            bgColor = 'var(--primary-color)';
            icon = 'fa-info-circle';
    }
    
    notification.style.backgroundColor = bgColor;
    notification.style.color = 'white';
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas ${icon} mr-3"></i>
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-auto text-white hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove após 5 segundos
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 5000);
}
</script>
{% endblock %}