{% extends 'base.html' %}
{% load static %}

{% block title %}{{ project.name }} - Projeto{% endblock %}

{% block extra_css %}
<style>
    .project-hero {
        background: linear-gradient(135deg, #FF6B35 0%, #F7931E 50%, #FFB74D 100%);
        border-radius: 20px;
        padding: 2.5rem;
        margin-bottom: 2rem;
        color: white;
        position: relative;
        overflow: hidden;
    }
    
    .project-hero::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 200px;
        height: 200px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        transform: translate(50px, -50px);
    }
    
    .status-chip {
        display: inline-flex;
        align-items: center;
        padding: 0.5rem 1rem;
        border-radius: 25px;
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .priority-chip {
        display: inline-flex;
        align-items: center;
        padding: 0.5rem 1rem;
        border-radius: 25px;
        font-size: 0.875rem;
        font-weight: 600;
        border: 2px solid;
    }
    
    .info-panel {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        border: 1px solid #f1f5f9;
        margin-bottom: 1.5rem;
    }
    
    .progress-container {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .progress-bar {
        background: #e2e8f0;
        height: 12px;
        border-radius: 6px;
        overflow: hidden;
        position: relative;
    }
    
    .progress-fill {
        background: linear-gradient(90deg, #FF6B35 0%, #27AE60 100%);
        height: 100%;
        border-radius: 6px;
        position: relative;
        transition: width 0.6s ease;
    }
    
    .activity-section {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        border: 1px solid #f1f5f9;
    }
    
    .activity-item {
        background: #fafbfc;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        transition: all 0.2s ease;
    }
    
    .activity-item:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-color: #FF6B35;
    }
    
    .hierarchy-line {
        border-left: 2px solid #e2e8f0;
        margin-left: 1rem;
        padding-left: 1rem;
    }
    
    .btn-action {
        background: #FF6B35;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.2s ease;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
    }
    
    .btn-action:hover {
        background: #e55a2b;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
        color: white;
    }
    
    .btn-secondary {
        background: white;
        color: #64748b;
        border: 2px solid #e2e8f0;
        padding: 0.75rem 1.5rem;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.2s ease;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
    }
    
    .btn-secondary:hover {
        border-color: #FF6B35;
        color: #FF6B35;
        transform: translateY(-1px);
    }
    
    .metric-card {
        text-align: center;
        padding: 1.5rem;
        border-radius: 16px;
        background: white;
        border: 1px solid #f1f5f9;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .metric-number {
        font-size: 2rem;
        font-weight: bold;
        color: #FF6B35;
        display: block;
    }
    
    .metric-label {
        color: #64748b;
        font-size: 0.875rem;
        font-weight: 500;
        text-transform: uppercase;
    }
    
    /* Kanban Styles */
    .kanban-board {
        min-height: 400px;
    }
    
    .kanban-column {
        background: #f8fafc;
        border-radius: 12px;
        padding: 1rem;
        min-height: 400px;
        display: flex;
        flex-direction: column;
    }
    
    .kanban-header {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        font-weight: 600;
        font-size: 0.875rem;
    }
    
    .kanban-content {
        flex-grow: 1;
        min-height: 300px;
    }
    
    .kanban-card {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #e2e8f0;
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
    }
    
    .kanban-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    .kanban-card.priority-alta {
        border-left-color: #f59e0b;
    }
    
    .kanban-card.priority-critica {
        border-left-color: #ef4444;
    }
    
    .kanban-card.priority-baixa {
        border-left-color: #10b981;
    }
    
    .kanban-card.overdue {
        border-left-color: #dc2626;
        background: #fef2f2;
    }
    
    .kanban-card .activity-title {
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 0.5rem;
        line-height: 1.3;
    }
    
    .kanban-card .activity-description {
        color: #6b7280;
        font-size: 0.875rem;
        margin-bottom: 0.75rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .kanban-card .activity-meta {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 0.75rem;
        color: #9ca3af;
    }
    
    .kanban-card .activity-assignee {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    .kanban-card .activity-deadline {
        font-weight: 500;
    }
    
    .kanban-card.compact {
        padding: 0.75rem;
    }
    
    .kanban-card.compact .activity-title {
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
    }
    
    .kanban-card.compact .activity-description {
        font-size: 0.75rem;
        -webkit-line-clamp: 1;
    }
    
    .kanban-card.compact .activity-meta {
        font-size: 0.625rem;
        letter-spacing: 0.05em;
    }
    
    .section-title {
        font-size: 1.25rem;
        font-weight: bold;
        color: #1f2937;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
    }
    
    /* Drag & Drop Styles */
    .drop-zone {
        min-height: 400px;
        transition: all 0.3s ease;
    }
    
    .drop-zone.drag-over {
        background-color: rgba(59, 130, 246, 0.1);
        border: 2px dashed #3b82f6;
        border-radius: 8px;
    }
    
    .kanban-card.dragging {
        opacity: 0.5;
        transform: rotate(5deg);
        z-index: 1000;
    }
    
    .drag-handle {
        cursor: grab;
        user-select: none;
    }
    
    .drag-handle:active {
        cursor: grabbing;
    }
    
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    /* Estilos para botões de ação dos cartões */
    .activity-actions {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        display: none;
        gap: 0.25rem;
        z-index: 10;
    }
    
    .kanban-card:hover .activity-actions {
        display: flex;
    }
    
    .action-btn {
        width: 1.5rem;
        height: 1.5rem;
        border-radius: 0.25rem;
        border: none;
        background: rgba(255, 255, 255, 0.9);
        color: #6b7280;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease;
        backdrop-filter: blur(4px);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .action-btn:hover {
        background: #ffffff;
        color: #374151;
        transform: scale(1.1);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }
    
    /* Posição relativa para o cartão permitir posicionamento absoluto dos botões */
    .kanban-card {
        position: relative;
    }
    
    /* Melhorar hover do cartão */
    .kanban-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-6 py-8 max-w-7xl">
    <!-- Hero Section -->
    <div class="project-hero">
        <div class="relative z-10">
            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6">
                <div class="flex-1">
                    <div class="flex flex-col lg:flex-row lg:items-center gap-4 mb-4">
                        <h1 class="text-4xl font-bold">{{ project.name }}</h1>
                        <div class="flex flex-wrap gap-3">
                            {% if project.status == 'active' %}
                                <span class="status-chip bg-emerald-500 text-white">
                                    <i class="fas fa-play-circle mr-2"></i>Ativo
                                </span>
                            {% elif project.status == 'on_hold' %}
                                <span class="status-chip bg-amber-500 text-white">
                                    <i class="fas fa-pause-circle mr-2"></i>Em Espera
                                </span>
                            {% elif project.status == 'completed' %}
                                <span class="status-chip bg-blue-500 text-white">
                                    <i class="fas fa-check-circle mr-2"></i>Concluído
                                </span>
                            {% elif project.status == 'cancelled' %}
                                <span class="status-chip bg-red-500 text-white">
                                    <i class="fas fa-times-circle mr-2"></i>Cancelado
                                </span>
                            {% endif %}
                            
                            {% if project.priority == 'low' %}
                                <span class="priority-chip border-gray-300 text-gray-600 bg-white">
                                    <i class="fas fa-arrow-down mr-2"></i>Baixa
                                </span>
                            {% elif project.priority == 'medium' %}
                                <span class="priority-chip border-yellow-400 text-yellow-700 bg-white">
                                    <i class="fas fa-minus mr-2"></i>Média
                                </span>
                            {% elif project.priority == 'high' %}
                                <span class="priority-chip border-red-400 text-red-600 bg-white">
                                    <i class="fas fa-arrow-up mr-2"></i>Alta
                                </span>
                            {% elif project.priority == 'urgent' %}
                                <span class="priority-chip border-red-600 text-red-700 bg-white">
                                    <i class="fas fa-exclamation mr-2"></i>Urgente
                                </span>
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if project.description %}
                    <p class="text-lg opacity-95 mb-4 leading-relaxed">{{ project.description }}</p>
                    {% endif %}
                    
                    {% if project.scope %}
                    <div class="mb-6 p-4 bg-white bg-opacity-25 rounded-lg border border-white border-opacity-30">
                        <h4 class="font-semibold mb-2 flex items-center">
                            <i class="fas fa-list-ul mr-2"></i>
                            Escopo do Projeto
                        </h4>
                        <p class="opacity-95 leading-relaxed">{{ project.scope }}</p>
                    </div>
                    {% endif %}
                    
                    <div class="flex flex-wrap gap-6 text-sm opacity-90">
                        <div class="flex items-center">
                            <i class="fas fa-calendar-plus mr-2"></i>
                            <span>Criado em {{ project.created_at|date:"d/m/Y" }}</span>
                        </div>
                        {% if project.start_date %}
                        <div class="flex items-center">
                            <i class="fas fa-calendar-day mr-2"></i>
                            <span>Início: {{ project.start_date|date:"d/m/Y" }}</span>
                        </div>
                        {% endif %}
                        {% if project.end_date %}
                        <div class="flex items-center">
                            <i class="fas fa-calendar-check mr-2"></i>
                            <span>Prazo: {{ project.end_date|date:"d/m/Y" }}</span>
                        </div>
                        {% endif %}
                        {% if project.deadline %}
                        <div class="flex items-center">
                            <i class="fas fa-calendar-check mr-2"></i>
                            <span>Prazo: {{ project.deadline|date:"d/m/Y" }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="flex gap-3">
                    <a href="{% url 'projects:project_list' %}" class="px-6 py-3 bg-gray-100 text-gray-600 rounded-2xl font-semibold hover:bg-gray-200 transition-colors duration-200 inline-flex items-center gap-2">
                        <i class="fas fa-arrow-left"></i>Voltar
                    </a>
                    {% if can_edit %}
                    <a href="{% url 'projects:project_edit' project.pk %}" class="px-6 py-3 bg-orange-500 text-white rounded-2xl font-semibold hover:bg-orange-600 transition-colors duration-200 inline-flex items-center gap-2">
                        <i class="fas fa-edit"></i>Editar Projeto
                    </a>
                    {% endif %}
                    {% if user.is_superuser %}
                    <a href="{% url 'projects:project_delete' project.pk %}" class="px-6 py-3 bg-red-500 text-white rounded-2xl font-semibold hover:bg-red-600 transition-colors duration-200 inline-flex items-center gap-2">
                        <i class="fas fa-trash"></i>Excluir
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Overview -->
    <div class="progress-container">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">Progresso Geral</h3>
            <span class="text-2xl font-bold text-gray-700">{{ progress_percentage|default:0 }}%</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" style="width: {{ progress_percentage|default:0 }}%;"></div>
        </div>
        <div class="flex justify-between mt-4 text-sm text-gray-600">
            <span>{{ completed_activities|default:0 }} de {{ total_activities|default:0 }} atividades concluídas</span>
            <span>{{ remaining_activities|default:0 }} restantes</span>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 xl:grid-cols-4 gap-8">
        <!-- Project Details -->
        <div class="xl:col-span-3 space-y-8">
            <!-- Project Information -->
            <div class="info-panel">
                <h3 class="section-title">
                    <i class="fas fa-info-circle mr-3 text-orange-500"></i>
                    Detalhes do Projeto
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Setor</label>
                            <p class="text-gray-900 font-medium mt-1">{{ project.sector.name }}</p>
                        </div>
                        {% if project.assigned_to %}
                        <div>
                            <label class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Responsável</label>
                            <p class="text-gray-900 font-medium mt-1">{{ project.assigned_to.get_full_name|default:project.assigned_to.username }}</p>
                        </div>
                        {% endif %}
                        {% if project.responsible_user %}
                        <div>
                            <label class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Responsável</label>
                            <p class="text-gray-900 font-medium mt-1">{{ project.responsible_user.get_full_name|default:project.responsible_user.username }}</p>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Criado por</label>
                            <p class="text-gray-900 font-medium mt-1">{{ project.created_by.get_full_name|default:project.created_by.username }}</p>
                        </div>
                        <div>
                            <label class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Última atualização</label>
                            <p class="text-gray-900 font-medium mt-1">{{ project.updated_at|date:"d/m/Y H:i" }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activities Section -->
            <div class="activity-section">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h3 class="section-title">
                        <i class="fas fa-tasks mr-3 text-orange-500"></i>
                        {% if view_mode == 'kanban' %}Kanban de Atividades{% else %}Hierarquia de Atividades{% endif %}
                    </h3>
                    
                    <div class="flex flex-wrap items-center gap-3">
                        <!-- View Mode Toggle -->
                        <div class="flex bg-gray-100 rounded-lg p-1">
                            <a href="?view=hierarchy" 
                               class="px-3 py-1.5 text-sm font-medium rounded-md transition-colors {% if view_mode != 'kanban' %}bg-white text-gray-900 shadow-sm{% else %}text-gray-600 hover:text-gray-900{% endif %}">
                                <i class="fas fa-sitemap mr-1.5"></i>Hierárquica
                            </a>
                            <a href="?view=kanban" 
                               class="px-3 py-1.5 text-sm font-medium rounded-md transition-colors {% if view_mode == 'kanban' %}bg-white text-gray-900 shadow-sm{% else %}text-gray-600 hover:text-gray-900{% endif %}">
                                <i class="fas fa-columns mr-1.5"></i>Kanban
                            </a>
                        </div>
                        
                        {% if can_edit %}
                        <button onclick="openNewActivityModal()" class="btn-action">
                            <i class="fas fa-plus mr-2"></i>Nova Atividade
                        </button>
                        {% endif %}
                    </div>
                </div>
                
                {% if view_mode == 'kanban' %}
                    <!-- Kanban View -->
                    {% if kanban_activities %}
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <!-- Não Iniciada Column -->
                            <div class="bg-gray-50 rounded-xl border border-gray-200 min-h-[500px]">
                                <div class="flex items-center justify-between p-4 bg-gray-100 rounded-t-xl border-b border-gray-200">
                                    <div class="flex items-center space-x-2 text-gray-700">
                                        <i class="fas fa-clock"></i>
                                        <span class="font-semibold">Não Iniciada</span>
                                    </div>
                                    <span class="bg-gray-200 text-gray-600 px-3 py-1 rounded-full text-xs font-medium">
                                        {{ kanban_activities.NAO_INICIADA.count }}
                                    </span>
                                </div>
                                <div class="p-4 drop-zone" 
                                     ondrop="handleDrop(event, 'NAO_INICIADA')"
                                     ondragover="handleDragOver(event)"
                                     ondragenter="handleDragEnter(event)"
                                     ondragleave="handleDragLeave(event)"
                                     data-status="NAO_INICIADA">
                                    {% for activity in kanban_activities.NAO_INICIADA %}
                                        {% include 'projects/kanban_card.html' with activity=activity %}
                                    {% endfor %}
                                    {% if not kanban_activities.NAO_INICIADA %}
                                    <div class="text-center text-gray-400 mt-8">
                                        <i class="fas fa-plus-circle text-3xl mb-2"></i>
                                        <p class="text-sm">Arraste atividades para cá</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Em Andamento Column -->
                            <div class="bg-blue-50 rounded-xl border border-blue-200 min-h-[500px]">
                                <div class="flex items-center justify-between p-4 bg-blue-100 rounded-t-xl border-b border-blue-200">
                                    <div class="flex items-center space-x-2 text-blue-700">
                                        <i class="fas fa-play"></i>
                                        <span class="font-semibold">Em Andamento</span>
                                    </div>
                                    <span class="bg-blue-200 text-blue-600 px-3 py-1 rounded-full text-xs font-medium">
                                        {{ kanban_activities.EM_ANDAMENTO.count }}
                                    </span>
                                </div>
                                <div class="p-4 drop-zone" 
                                     ondrop="handleDrop(event, 'EM_ANDAMENTO')"
                                     ondragover="handleDragOver(event)"
                                     ondragenter="handleDragEnter(event)"
                                     ondragleave="handleDragLeave(event)"
                                     data-status="EM_ANDAMENTO">
                                    {% for activity in kanban_activities.EM_ANDAMENTO %}
                                        {% include 'projects/kanban_card.html' with activity=activity %}
                                    {% endfor %}
                                    {% if not kanban_activities.EM_ANDAMENTO %}
                                    <div class="text-center text-gray-400 mt-8">
                                        <i class="fas fa-plus-circle text-3xl mb-2"></i>
                                        <p class="text-sm">Arraste atividades para cá</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Concluída Column -->
                            <div class="bg-green-50 rounded-xl border border-green-200 min-h-[500px]">
                                <div class="flex items-center justify-between p-4 bg-green-100 rounded-t-xl border-b border-green-200">
                                    <div class="flex items-center space-x-2 text-green-700">
                                        <i class="fas fa-check"></i>
                                        <span class="font-semibold">Concluída</span>
                                    </div>
                                    <span class="bg-green-200 text-green-600 px-3 py-1 rounded-full text-xs font-medium">
                                        {{ kanban_activities.CONCLUIDA.count }}
                                    </span>
                                </div>
                                <div class="p-4 drop-zone" 
                                     ondrop="handleDrop(event, 'CONCLUIDA')"
                                     ondragover="handleDragOver(event)"
                                     ondragenter="handleDragEnter(event)"
                                     ondragleave="handleDragLeave(event)"
                                     data-status="CONCLUIDA">
                                    {% for activity in kanban_activities.CONCLUIDA %}
                                        {% include 'projects/kanban_card.html' with activity=activity %}
                                    {% endfor %}
                                    {% if not kanban_activities.CONCLUIDA %}
                                    <div class="text-center text-gray-400 mt-8">
                                        <i class="fas fa-plus-circle text-3xl mb-2"></i>
                                        <p class="text-sm">Arraste atividades para cá</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Cancelada Column -->
                            <div class="bg-red-50 rounded-xl border border-red-200 min-h-[500px]">
                                <div class="flex items-center justify-between p-4 bg-red-100 rounded-t-xl border-b border-red-200">
                                    <div class="flex items-center space-x-2 text-red-700">
                                        <i class="fas fa-times"></i>
                                        <span class="font-semibold">Cancelada</span>
                                    </div>
                                    <span class="bg-red-200 text-red-600 px-3 py-1 rounded-full text-xs font-medium">
                                        {{ kanban_activities.CANCELADA.count }}
                                    </span>
                                </div>
                                <div class="p-4 drop-zone" 
                                     ondrop="handleDrop(event, 'CANCELADA')"
                                     ondragover="handleDragOver(event)"
                                     ondragenter="handleDragEnter(event)"
                                     ondragleave="handleDragLeave(event)"
                                     data-status="CANCELADA">
                                    {% for activity in kanban_activities.CANCELADA %}
                                        {% include 'projects/kanban_card.html' with activity=activity %}
                                    {% endfor %}
                                    {% if not kanban_activities.CANCELADA %}
                                    <div class="text-center text-gray-400 mt-8">
                                        <i class="fas fa-plus-circle text-3xl mb-2"></i>
                                        <p class="text-sm">Arraste atividades para cá</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                    {% else %}
                        <div class="text-center py-16">
                            <div class="w-24 h-24 mx-auto mb-6 bg-gray-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-clipboard-list text-3xl text-gray-400"></i>
                            </div>
                            <h4 class="text-xl font-semibold text-gray-600 mb-2">Nenhuma atividade cadastrada</h4>
                            <p class="text-gray-500 mb-6">Comece criando a primeira atividade para este projeto</p>
                            {% if can_edit %}
                            <button onclick="openNewActivityModal()" class="btn-action">
                                <i class="fas fa-plus mr-2"></i>Criar Primeira Atividade
                            </button>
                            {% endif %}
                        </div>
                    {% endif %}
                {% else %}
                    <!-- Hierarchy View -->
                    {% if activities or root_activities %}
                        <div class="space-y-3">
                            {% include 'projects/activity_hierarchy.html' with activities=activities|default:root_activities can_edit=can_edit project=project %}
                        </div>
                    {% else %}
                        <div class="text-center py-16">
                            <div class="w-24 h-24 mx-auto mb-6 bg-gray-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-clipboard-list text-3xl text-gray-400"></i>
                            </div>
                            <h4 class="text-xl font-semibold text-gray-600 mb-2">Nenhuma atividade cadastrada</h4>
                            <p class="text-gray-500 mb-6">Comece criando a primeira atividade para este projeto</p>
                            {% if can_edit %}
                            <button onclick="openNewActivityModal()" class="btn-action">
                                <i class="fas fa-plus mr-2"></i>Criar Primeira Atividade
                            </button>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endif %}
            </div>
        </div>

        <!-- Sidebar Stats -->
        <div class="space-y-6">
            <!-- Quick Stats -->
            <div class="grid grid-cols-2 xl:grid-cols-1 gap-4">
                <div class="metric-card">
                    <span class="metric-number">{{ total_activities|default:0 }}</span>
                    <span class="metric-label">Total Atividades</span>
                </div>
                
                <div class="metric-card">
                    <span class="metric-number">{{ completed_activities|default:0 }}</span>
                    <span class="metric-label">Concluídas</span>
                </div>
                
                <div class="metric-card">
                    <span class="metric-number">{{ in_progress_activities|default:0 }}</span>
                    <span class="metric-label">Em Andamento</span>
                </div>
                
                <div class="metric-card">
                    <span class="metric-number" style="color: #ef4444;">{{ remaining_activities|default:0 }}</span>
                    <span class="metric-label">Pendentes</span>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="info-panel">
                <h4 class="font-bold text-gray-800 mb-4">Ações Rápidas</h4>
                <div class="space-y-3">
                    <button class="w-full text-left px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-xl transition-colors">
                        <i class="fas fa-eye mr-3 text-gray-600"></i>
                        <span class="text-sm font-medium">Ver Relatório</span>
                    </button>
                    <button class="w-full text-left px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-xl transition-colors">
                        <i class="fas fa-download mr-3 text-gray-600"></i>
                        <span class="text-sm font-medium">Exportar Dados</span>
                    </button>
                    <button class="w-full text-left px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-xl transition-colors">
                        <i class="fas fa-share mr-3 text-gray-600"></i>
                        <span class="text-sm font-medium">Compartilhar</span>
                    </button>
                </div>
            </div>

            <!-- Project Timeline -->
            <div class="info-panel">
                <h4 class="font-bold text-gray-800 mb-4">Cronograma</h4>
                <div class="space-y-4">
                    <div class="flex items-center text-sm">
                        <div class="w-3 h-3 bg-green-500 rounded-full mr-3"></div>
                        <div>
                            <div class="font-medium">Projeto Criado</div>
                            <div class="text-gray-500">{{ project.created_at|date:"d/m/Y" }}</div>
                        </div>
                    </div>
                    {% if project.start_date %}
                    <div class="flex items-center text-sm">
                        <div class="w-3 h-3 bg-blue-500 rounded-full mr-3"></div>
                        <div>
                            <div class="font-medium">Data de Início</div>
                            <div class="text-gray-500">{{ project.start_date|date:"d/m/Y" }}</div>
                        </div>
                    </div>
                    {% endif %}
                    {% if project.end_date %}
                    <div class="flex items-center text-sm">
                        <div class="w-3 h-3 bg-orange-500 rounded-full mr-3"></div>
                        <div>
                            <div class="font-medium">Prazo Final</div>
                            <div class="text-gray-500">{{ project.end_date|date:"d/m/Y" }}</div>
                        </div>
                    </div>
                    {% endif %}
                    {% if project.deadline %}
                    <div class="flex items-center text-sm">
                        <div class="w-3 h-3 bg-orange-500 rounded-full mr-3"></div>
                        <div>
                            <div class="font-medium">Prazo Final</div>
                            <div class="text-gray-500 {% if project.is_overdue %}text-red-600{% endif %}">
                                {{ project.deadline|date:"d/m/Y" }}
                                {% if project.is_overdue %}
                                    <i class="fas fa-exclamation-triangle ml-1 text-red-500"></i>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Nova Atividade -->
{% if can_edit %}
<div id="activityModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Nova Atividade</h3>
                    <button onclick="closeActivityModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form id="activityForm" action="{% url 'projects:activity_create' project.id %}" method="POST">
                    {% csrf_token %}
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Atividade</label>
                            <input type="text" name="name" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Descrição</label>
                            <textarea name="description" rows="3" required
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"></textarea>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Prazo</label>
                                <input type="date" name="deadline" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                                <select name="priority" required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                                    <option value="low">Baixa</option>
                                    <option value="medium" selected>Média</option>
                                    <option value="high">Alta</option>
                                    <option value="urgent">Urgente</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-4 mt-6 pt-4 border-t">
                        <button type="button" onclick="closeActivityModal()" 
                                class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                            Cancelar
                        </button>
                        <button type="submit" 
                                class="px-4 py-2 bg-orange-500 text-white rounded-md hover:bg-orange-600">
                            Criar Atividade
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Incluir Modal de Detalhes da Atividade -->
{% include 'projects/activity_modal.html' %}

<!-- Modal de Subtarefa Global -->
<div id="subtaskModal" class="fixed inset-0 bg-black bg-opacity-50 z-[9999] hidden flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Criar Subtarefa</h3>
            <button onclick="closeSubtaskModalGlobal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="subtaskFormGlobal" onsubmit="saveSubtaskFromModalGlobal(event)">
            <div class="space-y-4">
                <div>
                    <label for="subtaskNameGlobal" class="block text-sm font-medium text-gray-700 mb-1">Nome da Subtarefa*</label>
                    <input type="text" id="subtaskNameGlobal" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label for="subtaskDescriptionGlobal" class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
                    <textarea id="subtaskDescriptionGlobal" rows="3" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                </div>
                
                <div>
                    <label for="subtaskPriorityGlobal" class="block text-sm font-medium text-gray-700 mb-1">Prioridade</label>
                    <select id="subtaskPriorityGlobal" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="BAIXA">Baixa</option>
                        <option value="MEDIA" selected>Média</option>
                        <option value="ALTA">Alta</option>
                        <option value="URGENTE">Urgente</option>
                    </select>
                </div>
                
                <div>
                    <label for="subtaskDeadlineGlobal" class="block text-sm font-medium text-gray-700 mb-1">Prazo</label>
                    <input type="datetime-local" id="subtaskDeadlineGlobal" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                {% if project.members.exists %}
                <div>
                    <label for="subtaskAssignedToGlobal" class="block text-sm font-medium text-gray-700 mb-1">Responsável</label>
                    <select id="subtaskAssignedToGlobal" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Não atribuído</option>
                        {% for member in project.members.all %}
                        <option value="{{ member.id }}">{{ member.get_full_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
            </div>
            
            <div class="flex justify-end gap-3 mt-6">
                <button type="button" onclick="closeSubtaskModalGlobal()" 
                        class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors">
                    Cancelar
                </button>
                <button type="submit" 
                        class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md transition-colors">
                    Criar Subtarefa
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Funções para o modal de atividade
function openNewActivityModal() {
    document.getElementById('activityModal').classList.remove('hidden');
    // Definir data mínima para hoje
    const deadlineInput = document.querySelector('#activityForm input[name="deadline"]');
    const today = new Date().toISOString().split('T')[0];
    deadlineInput.min = today;
}

function closeActivityModal() {
    document.getElementById('activityModal').classList.add('hidden');
    document.getElementById('activityForm').reset();
}

function closeActivityDetailModal() {
    document.getElementById('activityDetailModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
    currentActivityId = null;
}

// Atualizar status da atividade via AJAX
function updateActivityStatus(activityId, newStatus) {
    fetch(`/projects/activity/${activityId}/status/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            status: newStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Atualizar progresso do projeto na página
            updateProjectProgress(data.new_progress);
            
            // Mostrar mensagem de sucesso
            showNotification('Status atualizado com sucesso!', 'success');
        } else {
            showNotification('Erro ao atualizar status: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showNotification('Erro ao atualizar status', 'error');
    });
}

// Atualizar barra de progresso
function updateProjectProgress(newProgress) {
    const progressFill = document.querySelector('.progress-fill');
    const progressText = document.querySelector('.progress-container .text-2xl');
    
    if (progressFill && progressText) {
        progressFill.style.width = newProgress + '%';
        progressText.textContent = newProgress.toFixed(1) + '%';
    }
}

// Mostrar notificações
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-md text-white ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Fechar modal com ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeActivityModal();
    }
});

// Formulário de atividade via AJAX
document.getElementById('activityForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            closeActivityModal();
            // Recarregar página para mostrar nova atividade
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showNotification('Erro ao criar atividade', 'error');
    });
});

// Funções para hierarquia de atividades
function openSubActivityModal(parentId) {
    // Adicionar campo hidden para parent_activity
    const form = document.getElementById('activityForm');
    let parentInput = form.querySelector('input[name="parent_activity"]');
    if (!parentInput) {
        parentInput = document.createElement('input');
        parentInput.type = 'hidden';
        parentInput.name = 'parent_activity';
        form.appendChild(parentInput);
    }
    parentInput.value = parentId;
    
    // Atualizar título do modal
    document.querySelector('#activityModal h3').textContent = 'Nova Sub-atividade';
    
    openNewActivityModal();
}

function toggleSubActivities(activityId) {
    const subActivities = document.getElementById(`sub-activities-${activityId}`);
    const icon = document.getElementById(`toggle-icon-${activityId}`);
    
    if (subActivities && subActivities.classList.contains('hidden')) {
        subActivities.classList.remove('hidden');
        if (icon) {
            icon.classList.remove('fa-chevron-right');
            icon.classList.add('fa-chevron-down');
        }
    } else if (subActivities) {
        subActivities.classList.add('hidden');
        if (icon) {
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-right');
        }
    }
}

// Drag & Drop Functionality
let draggedElement = null;
let draggedActivityId = null;

function handleDragStart(event, activityId) {
    draggedElement = event.target;
    draggedActivityId = activityId;
    
    // Add dragging class for visual feedback
    event.target.classList.add('dragging');
    
    // Set drag data
    event.dataTransfer.effectAllowed = 'move';
    event.dataTransfer.setData('text/html', event.target.outerHTML);
    event.dataTransfer.setData('text/plain', activityId);
    
    // Style drag image
    setTimeout(() => {
        event.target.style.opacity = '0.5';
    }, 0);
}

function handleDragEnd(event) {
    // Reset visual state
    event.target.classList.remove('dragging');
    event.target.style.opacity = '1';
    
    // Remove drag over styles from all drop zones
    document.querySelectorAll('.drop-zone').forEach(zone => {
        zone.classList.remove('drag-over');
    });
    
    draggedElement = null;
    draggedActivityId = null;
}

function handleDragOver(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'move';
}

function handleDragEnter(event) {
    event.preventDefault();
    if (event.target.classList.contains('drop-zone') || event.target.closest('.drop-zone')) {
        const dropZone = event.target.classList.contains('drop-zone') ? 
                        event.target : event.target.closest('.drop-zone');
        dropZone.classList.add('drag-over');
    }
}

function handleDragLeave(event) {
    if (event.target.classList.contains('drop-zone') || event.target.closest('.drop-zone')) {
        const dropZone = event.target.classList.contains('drop-zone') ? 
                        event.target : event.target.closest('.drop-zone');
        
        // Only remove drag-over if we're actually leaving the drop zone
        if (!dropZone.contains(event.relatedTarget)) {
            dropZone.classList.remove('drag-over');
        }
    }
}

function handleDrop(event, newStatus) {
    event.preventDefault();
    
    const dropZone = event.target.classList.contains('drop-zone') ? 
                    event.target : event.target.closest('.drop-zone');
    
    if (dropZone) {
        dropZone.classList.remove('drag-over');
    }
    
    if (!draggedActivityId) return;
    
    const currentStatus = draggedElement.dataset.status;
    
    // If status is the same, don't make API call
    if (currentStatus === newStatus) {
        return;
    }
    
    // Move the card immediately for better UX
    if (draggedElement && dropZone) {
        // Update the card's data attribute
        draggedElement.dataset.status = newStatus;
        
        // Append to new column
        dropZone.appendChild(draggedElement);
        
        // Update column counts
        updateColumnCounts();
        
        // Reset visual state
        draggedElement.style.opacity = '1';
        draggedElement.style.pointerEvents = 'auto';
        
        // Show success message immediately
        showNotification(`Atividade movida para "${getStatusLabel(newStatus)}"`, 'success');
    }
    
    // Make API call to update status in background
    fetch(`/projects/activity/${draggedActivityId}/status/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            status: newStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update project progress if available
            if (data.new_progress !== undefined) {
                updateProjectProgress(data.new_progress);
            }
        } else {
            // Revert on error
            location.reload();
            showNotification('Erro ao mover atividade: ' + (data.message || 'Erro desconhecido'), 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        // Revert on error
        location.reload();
        showNotification('Erro ao mover atividade', 'error');
    });
}

function updateColumnCounts() {
    // Update count badges for each column
    const columns = document.querySelectorAll('.drop-zone');
    columns.forEach(column => {
        const status = column.dataset.status;
        const cards = column.querySelectorAll('[data-activity-id]').length;
        const badge = column.parentElement.querySelector('.rounded-full');
        if (badge) {
            badge.textContent = cards;
        }
        
        // Show/hide empty state
        const emptyState = column.querySelector('.text-center.text-gray-400');
        if (emptyState) {
            emptyState.style.display = cards === 0 ? 'block' : 'none';
        }
    });
}

function getStatusLabel(status) {
    const labels = {
        'NAO_INICIADA': 'Não Iniciada',
        'EM_ANDAMENTO': 'Em Andamento',
        'CONCLUIDA': 'Concluída',
        'CANCELADA': 'Cancelada'
    };
    return labels[status] || status;
}

// Função para editar atividade
function editActivity(activityId) {
    window.location.href = `/projects/activity/${activityId}/edit/`;
}

// Initialize drag and drop on page load
document.addEventListener('DOMContentLoaded', function() {
    // Add touch support for mobile drag & drop
    if ('ontouchstart' in window) {
        // Add mobile drag & drop support here if needed
        console.log('Mobile drag & drop could be implemented here');
    }
    
    // Initialize column counts
    updateColumnCounts();
});

// Modal functions for activity details
function openActivityModal(activityId) {
    window.currentActivityId = activityId;
    
    // Fazer requisição para buscar dados da atividade
    fetch(`/projects/activity/${activityId}/detail/`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Erro: ' + data.error);
                return;
            }
            
            // Preencher dados do modal
            document.getElementById('modalTitle').textContent = data.title;
            document.getElementById('modalStatus').textContent = data.status_display;
            document.getElementById('modalPriority').textContent = data.priority_display;
            document.getElementById('modalCategory').textContent = data.category_name || 'Sem categoria';
            document.getElementById('modalResponsible').textContent = data.responsible_name || 'Não atribuído';
            document.getElementById('modalDeadline').textContent = data.deadline || 'Sem prazo';
            document.getElementById('modalProgressText').textContent = `${data.progress}%`;
            document.getElementById('modalProgressBar').style.width = `${data.progress}%`;
            document.getElementById('modalCreatedAt').textContent = data.created_at;
            document.getElementById('modalUpdatedAt').textContent = data.updated_at;
            document.getElementById('modalCreatedBy').textContent = data.created_by;
            document.getElementById('modalDescription').innerHTML = data.description || 'Sem descrição';
            
            // Carregar subtarefas
            loadSubtasks(data.subtasks);
            
            // Carregar comentários
            loadComments(data.comments);
            
            // Mostrar modal
            document.getElementById('activityDetailModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        })
        .catch(error => {
            console.error('Erro ao carregar atividade:', error);
            alert('Erro ao carregar detalhes da atividade');
        });
}

function editActivity(activityId) {
    // Check if there's an edit modal or redirect to edit page
    window.location.href = `/projects/activity/${activityId}/edit/`;
}

// Function to handle card clicks (prevent event bubbling from action buttons)
function handleCardClick(event, activityId) {
    // Check if the click was on an action button or drag handle
    if (event.target.closest('.opacity-0') || event.target.closest('.drag-handle')) {
        return;
    }
    
    // Open activity modal
    openActivityModal(activityId);
}

// Função para adicionar subtarefa na view hierárquica
function addSubtaskHierarchy(parentActivityId) {
    window.currentParentActivityId = parentActivityId;
    
    // Mostrar modal de subtarefa
    const modal = document.getElementById('subtaskModal');
    if (modal) {
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        
        // Limpar formulário
        document.getElementById('subtaskNameGlobal').value = '';
        document.getElementById('subtaskDescriptionGlobal').value = '';
        document.getElementById('subtaskPriorityGlobal').value = 'MEDIA';
        document.getElementById('subtaskDeadlineGlobal').value = '';
        if (document.getElementById('subtaskAssignedToGlobal')) {
            document.getElementById('subtaskAssignedToGlobal').value = '';
        }
    }
}

function closeSubtaskModalGlobal() {
    const modal = document.getElementById('subtaskModal');
    if (modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = '';
    }
}

function saveSubtaskFromModalGlobal(event) {
    event.preventDefault();
    
    const parentActivityId = window.currentParentActivityId;
    if (!parentActivityId) {
        alert('Erro: ID da atividade pai não encontrado');
        return;
    }
    
    const formData = {
        title: document.getElementById('subtaskNameGlobal').value.trim(),
        description: document.getElementById('subtaskDescriptionGlobal').value.trim(),
        priority: document.getElementById('subtaskPriorityGlobal').value,
        deadline: document.getElementById('subtaskDeadlineGlobal').value,
        assigned_to: document.getElementById('subtaskAssignedToGlobal') ? document.getElementById('subtaskAssignedToGlobal').value || null : null
    };
    
    // Validação
    if (!formData.title) {
        alert('Nome da subtarefa é obrigatório');
        return;
    }
    
    // Loading state
    const submitBtn = event.target.querySelector('[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Criando...';
    submitBtn.disabled = true;
    
    // Fazer requisição
    fetch(`/projects/activity/${parentActivityId}/subtask/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeSubtaskModalGlobal();
            // Recarregar a página para mostrar a nova subtarefa
            location.reload();
        } else {
            alert('Erro ao criar subtarefa: ' + (data.error || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao criar subtarefa');
    })
    .finally(() => {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    });
}

// Fechar modal com ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeSubtaskModalGlobal();
    }
});
</script>
{% endblock %}