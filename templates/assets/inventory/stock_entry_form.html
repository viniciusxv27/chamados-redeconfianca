{% extends 'base.html' %}

{% block title %}Entrada de Estoque - Inventário{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto py-4 sm:py-6 px-4 sm:px-0">
    <!-- Header -->
    <div class="mb-6">
        <nav class="flex mb-4" aria-label="Breadcrumb">
            <ol class="inline-flex items-center space-x-1 md:space-x-3">
                <li class="inline-flex items-center">
                    <a href="{% url 'assets:inventory_dashboard' %}" class="text-sm text-gray-500 hover:text-indigo-600">
                        <i class="fas fa-warehouse mr-1"></i> Inventário
                    </a>
                </li>
                <li>
                    <div class="flex items-center">
                        <i class="fas fa-chevron-right text-gray-400 mx-2 text-xs"></i>
                        <span class="text-sm text-gray-700">Entrada de Estoque</span>
                    </div>
                </li>
            </ol>
        </nav>

        <h2 class="text-2xl font-bold text-gray-900">
            <i class="fas fa-arrow-down text-green-600 mr-2"></i>
            Registrar Entrada de Estoque
        </h2>
        <p class="mt-1 text-sm text-gray-500">
            Registre a entrada de itens no estoque (compra, devolução, etc.)
        </p>
    </div>

    <!-- Info Box -->
    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-info-circle text-green-500 text-xl"></i>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-green-800">O que é uma entrada?</h3>
                <div class="mt-2 text-sm text-green-700">
                    <p>Entradas são registros de itens que estão sendo adicionados ou retornando ao estoque:</p>
                    <ul class="list-disc list-inside mt-1 space-y-1">
                        <li><strong>Compra:</strong> Novos itens adquiridos</li>
                        <li><strong>Devolução:</strong> Itens retornados por usuários</li>
                        <li><strong>Ajuste:</strong> Correção de inventário</li>
                        <li><strong>Doação:</strong> Itens recebidos como doação</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Form -->
    <form method="post" class="space-y-6">
        {% csrf_token %}
        
        <!-- Seleção de Item -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-box text-green-600 mr-2"></i>
                    Selecione o Item
                </h3>
            </div>
            <div class="px-4 py-5 sm:p-6">
                <div>
                    <label for="id_item" class="block text-sm font-medium text-gray-700 mb-1">
                        Item de Inventário <span class="text-red-500">*</span>
                    </label>
                    <select name="item" id="id_item" required
                            class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 {% if form.item.errors %}border-red-500{% endif %}">
                        <option value="">Selecione um item</option>
                        {% for item in form.fields.item.queryset %}
                        <option value="{{ item.pk }}" 
                                data-status="{{ item.status }}"
                                data-product="{{ item.product.name }}"
                                {% if form.item.value == item.pk|stringformat:"s" or selected_item and selected_item.pk == item.pk %}selected{% endif %}>
                            {{ item.inventory_number }} - {{ item.product.name }} ({{ item.get_status_display }})
                        </option>
                        {% endfor %}
                    </select>
                    {% if form.item.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.item.errors|join:", " }}</p>
                    {% endif %}
                </div>
                
                <!-- Item Info Box (shows when item is selected) -->
                <div id="item-info" class="mt-4 p-4 bg-gray-50 rounded-lg hidden">
                    <p class="text-sm font-medium text-gray-700 mb-2">Informações do Item:</p>
                    <div id="item-details" class="text-sm text-gray-600"></div>
                </div>
            </div>
        </div>

        <!-- Motivo da Entrada -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-tag text-green-600 mr-2"></i>
                    Motivo da Entrada
                </h3>
            </div>
            <div class="px-4 py-5 sm:p-6">
                <div>
                    <label for="id_reason" class="block text-sm font-medium text-gray-700 mb-3">
                        Selecione o Motivo <span class="text-red-500">*</span>
                    </label>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        {% for value, label in form.fields.reason.choices %}
                        <label class="relative flex items-center justify-center p-4 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                            <input type="radio" name="reason" value="{{ value }}" 
                                   class="sr-only peer" 
                                   {% if form.reason.value == value %}checked{% endif %}
                                   required>
                            <div class="text-center peer-checked:text-green-600">
                                {% if value == 'purchase' %}
                                <i class="fas fa-shopping-cart text-2xl mb-2"></i>
                                {% elif value == 'return' %}
                                <i class="fas fa-undo text-2xl mb-2"></i>
                                {% elif value == 'adjustment' %}
                                <i class="fas fa-balance-scale text-2xl mb-2"></i>
                                {% elif value == 'donation' %}
                                <i class="fas fa-gift text-2xl mb-2"></i>
                                {% else %}
                                <i class="fas fa-box text-2xl mb-2"></i>
                                {% endif %}
                                <p class="text-sm font-medium">{{ label }}</p>
                            </div>
                            <span class="absolute inset-0 border-2 rounded-lg peer-checked:border-green-500 pointer-events-none"></span>
                        </label>
                        {% endfor %}
                    </div>
                    {% if form.reason.errors %}
                    <p class="mt-2 text-sm text-red-600">{{ form.reason.errors|join:", " }}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Novo Status e Localização -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-map-marker-alt text-green-600 mr-2"></i>
                    Status e Localização
                </h3>
            </div>
            <div class="px-4 py-5 sm:p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="id_new_status" class="block text-sm font-medium text-gray-700 mb-1">
                            Novo Status do Item <span class="text-red-500">*</span>
                        </label>
                        <select name="new_status" id="id_new_status" required
                                class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            {% for value, label in form.fields.new_status.choices %}
                            <option value="{{ value }}" {% if form.new_status.value == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                        {% if form.new_status.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.new_status.errors|join:", " }}</p>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label for="id_location" class="block text-sm font-medium text-gray-700 mb-1">
                            Nova Localização
                        </label>
                        <input type="text" name="location" id="id_location" 
                               value="{{ form.location.value|default:'' }}"
                               placeholder="Almoxarifado Central, Prateleira A"
                               class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        {% if form.location.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.location.errors|join:", " }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Observações -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-comment text-green-600 mr-2"></i>
                    Observações
                </h3>
            </div>
            <div class="px-4 py-5 sm:p-6">
                <div>
                    <label for="id_notes" class="block text-sm font-medium text-gray-700 mb-1">
                        Observações Adicionais
                    </label>
                    <textarea name="notes" id="id_notes" rows="4"
                              placeholder="Detalhes sobre a entrada, número da nota fiscal, etc..."
                              class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">{{ form.notes.value|default:'' }}</textarea>
                    {% if form.notes.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.notes.errors|join:", " }}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Resumo -->
        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
            <div class="flex items-center">
                <i class="fas fa-arrow-down text-green-600 text-xl mr-3"></i>
                <div>
                    <p class="text-sm font-medium text-green-900">Confirmar Entrada</p>
                    <p class="text-sm text-green-700">
                        O item será marcado como disponível no estoque e a movimentação será registrada.
                    </p>
                </div>
            </div>
        </div>

        <!-- Botões -->
        <div class="flex justify-end space-x-4">
            <a href="{% url 'assets:inventory_dashboard' %}" 
               class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                Cancelar
            </a>
            <button type="submit" 
                    class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                <i class="fas fa-arrow-down mr-2"></i>
                Registrar Entrada
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const itemSelect = document.getElementById('id_item');
    const itemInfo = document.getElementById('item-info');
    const itemDetails = document.getElementById('item-details');
    
    itemSelect.addEventListener('change', function() {
        const selected = this.options[this.selectedIndex];
        
        if (this.value) {
            const status = selected.dataset.status;
            const product = selected.dataset.product;
            
            itemDetails.innerHTML = `
                <p><strong>Produto:</strong> ${product}</p>
                <p><strong>Status atual:</strong> <span class="px-2 py-1 text-xs rounded-full ${status === 'available' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${selected.text.match(/\(([^)]+)\)/)[1]}</span></p>
            `;
            itemInfo.classList.remove('hidden');
        } else {
            itemInfo.classList.add('hidden');
        }
    });
    
    // Trigger on load if item is pre-selected
    if (itemSelect.value) {
        itemSelect.dispatchEvent(new Event('change'));
    }
});
</script>
{% endblock %}
