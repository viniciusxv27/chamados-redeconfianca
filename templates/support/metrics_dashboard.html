{% extends 'base.html' %}
{% load static %}

{% block title %}Métricas de Suporte{% endblock %}

{% block extra_css %}
<style>
    .metric-card {
        background: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .metric-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: #1f2937;
    }
    
    .metric-label {
        color: #6b7280;
        font-size: 0.875rem;
        margin-top: 0.5rem;
    }
    
    .trend-up {
        color: #10b981;
    }
    
    .trend-down {
        color: #ef4444;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
        margin-top: 1rem;
    }
    
    .top-categories {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .category-item {
        display: flex;
        justify-content: between;
        align-items: center;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background: #f8fafc;
        border-radius: 0.375rem;
        border: 1px solid #e2e8f0;
    }
    
    .category-bar {
        height: 20px;
        background: linear-gradient(90deg, #3b82f6, #1d4ed8);
        border-radius: 10px;
        margin-left: 1rem;
        flex: 1;
        max-width: 200px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Métricas de Suporte</h1>
            <p class="text-gray-600">Visão executiva dos atendimentos</p>
        </div>
        
        <div class="flex space-x-3">
            <select id="periodFilter" class="px-4 py-2 border border-gray-300 rounded-lg" onchange="updateMetrics()">
                <option value="7">Últimos 7 dias</option>
                <option value="30" selected>Últimos 30 dias</option>
                <option value="90">Últimos 90 dias</option>
                <option value="365">Último ano</option>
            </select>
            <button onclick="exportReport()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">
                <i class="fas fa-download mr-2"></i>Exportar
            </button>
        </div>
    </div>

    <!-- KPIs Principais -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Total de Atendimentos -->
        <div class="metric-card">
            <div class="flex items-center justify-between">
                <div>
                    <div class="metric-value" id="totalTickets">{{ metrics.total_tickets }}</div>
                    <div class="metric-label">Total de Atendimentos</div>
                </div>
                <div class="text-blue-500">
                    <i class="fas fa-ticket-alt text-3xl"></i>
                </div>
            </div>
            <div class="flex items-center mt-2">
                <span class="trend-up text-sm">
                    <i class="fas fa-arrow-up mr-1"></i>+{{ metrics.tickets_growth }}%
                </span>
                <span class="text-gray-500 text-sm ml-2">vs período anterior</span>
            </div>
        </div>

        <!-- Tempo Médio de Atendimento -->
        <div class="metric-card">
            <div class="flex items-center justify-between">
                <div>
                    <div class="metric-value" id="avgResponseTime">{{ metrics.avg_response_time }}</div>
                    <div class="metric-label">Tempo Médio (horas)</div>
                </div>
                <div class="text-yellow-500">
                    <i class="fas fa-clock text-3xl"></i>
                </div>
            </div>
            <div class="flex items-center mt-2">
                <span class="trend-down text-sm">
                    <i class="fas fa-arrow-down mr-1"></i>-{{ metrics.time_improvement }}%
                </span>
                <span class="text-gray-500 text-sm ml-2">vs período anterior</span>
            </div>
        </div>

        <!-- Taxa de Resolução -->
        <div class="metric-card">
            <div class="flex items-center justify-between">
                <div>
                    <div class="metric-value" id="resolutionRate">{{ metrics.resolution_rate }}%</div>
                    <div class="metric-label">Taxa de Resolução</div>
                </div>
                <div class="text-green-500">
                    <i class="fas fa-check-circle text-3xl"></i>
                </div>
            </div>
            <div class="flex items-center mt-2">
                <span class="trend-up text-sm">
                    <i class="fas fa-arrow-up mr-1"></i>+{{ metrics.resolution_improvement }}%
                </span>
                <span class="text-gray-500 text-sm ml-2">vs período anterior</span>
            </div>
        </div>

        <!-- Avaliação Média -->
        <div class="metric-card">
            <div class="flex items-center justify-between">
                <div>
                    <div class="metric-value" id="avgRating">{{ metrics.avg_rating }}</div>
                    <div class="metric-label">Avaliação Média</div>
                </div>
                <div class="text-purple-500">
                    <i class="fas fa-star text-3xl"></i>
                </div>
            </div>
            <div class="flex items-center mt-2">
                <div class="flex text-yellow-400">
                    {% for i in "12345" %}
                        {% if forloop.counter <= metrics.avg_rating %}
                            <i class="fas fa-star text-sm"></i>
                        {% else %}
                            <i class="far fa-star text-sm"></i>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Gráfico de Tickets por Dia -->
        <div class="metric-card">
            <h3 class="text-lg font-semibold mb-4">Tickets por Dia</h3>
            <div class="chart-container">
                <canvas id="ticketsChart"></canvas>
            </div>
        </div>

        <!-- Gráfico de Status -->
        <div class="metric-card">
            <h3 class="text-lg font-semibold mb-4">Distribuição por Status</h3>
            <div class="chart-container">
                <canvas id="statusChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Análises Detalhadas -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Assuntos Mais Solicitados -->
        <div class="metric-card">
            <h3 class="text-lg font-semibold mb-4">Assuntos Mais Solicitados</h3>
            <div class="top-categories">
                {% for category in metrics.top_categories %}
                <div class="category-item">
                    <div class="flex-1">
                        <div class="font-medium">{{ category.name }}</div>
                        <div class="text-sm text-gray-600">{{ category.count }} tickets</div>
                    </div>
                    <div class="category-bar" style="width: {{ category.percentage }}%"></div>
                    <div class="text-sm font-medium ml-2">{{ category.percentage }}%</div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Performance dos Agentes -->
        <div class="metric-card">
            <h3 class="text-lg font-semibold mb-4">Performance dos Agentes</h3>
            <div class="top-categories">
                {% for agent in metrics.agent_performance %}
                <div class="category-item">
                    <div class="flex-1">
                        <div class="font-medium">{{ agent.name }}</div>
                        <div class="text-sm text-gray-600">
                            {{ agent.tickets_resolved }} tickets | Média: {{ agent.avg_rating }}★
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-medium">{{ agent.avg_time }}h</div>
                        <div class="text-xs text-gray-500">tempo médio</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Tabela de Tickets Recentes -->
    <div class="metric-card mt-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">Tickets Recentes</h3>
            <button onclick="loadAllTickets()" class="text-blue-500 hover:text-blue-700 text-sm">
                Ver todos
            </button>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assunto</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Agente</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Criado</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="ticketsTableBody">
                    {% for ticket in metrics.recent_tickets %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#{{ ticket.id }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ ticket.user.get_full_name }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ ticket.title }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                        bg-{{ ticket.status|lower }}-100 text-{{ ticket.status|lower }}-800">
                                {{ ticket.get_status_display }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {{ ticket.assigned_to.get_full_name|default:"Não atribuído" }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ ticket.created_at|date:"d/m/Y H:i" }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="viewTicket({{ ticket.id }})" class="text-blue-600 hover:text-blue-900">
                                Ver
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
});

function initializeCharts() {
    // Gráfico de Tickets por Dia
    const ticketsCtx = document.getElementById('ticketsChart').getContext('2d');
    new Chart(ticketsCtx, {
        type: 'line',
        data: {
            labels: {{ metrics.daily_labels|safe }},
            datasets: [{
                label: 'Tickets Criados',
                data: {{ metrics.daily_tickets|safe }},
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4
            }, {
                label: 'Tickets Resolvidos',
                data: {{ metrics.daily_resolved|safe }},
                borderColor: 'rgb(16, 185, 129)',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Gráfico de Status
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: {{ metrics.status_labels|safe }},
            datasets: [{
                data: {{ metrics.status_data|safe }},
                backgroundColor: [
                    'rgba(239, 68, 68, 0.8)',   // Aberto - Vermelho
                    'rgba(245, 158, 11, 0.8)',  // Em Andamento - Amarelo
                    'rgba(59, 130, 246, 0.8)',  // Resolvido - Azul
                    'rgba(16, 185, 129, 0.8)'   // Fechado - Verde
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function updateMetrics() {
    const period = document.getElementById('periodFilter').value;
    
    fetch(`/projects/support/metrics/?period=${period}`)
        .then(response => response.json())
        .then(data => {
            // Atualizar KPIs
            document.getElementById('totalTickets').textContent = data.total_tickets;
            document.getElementById('avgResponseTime').textContent = data.avg_response_time;
            document.getElementById('resolutionRate').textContent = data.resolution_rate + '%';
            document.getElementById('avgRating').textContent = data.avg_rating;
            
            // Reinicializar gráficos com novos dados
            initializeCharts();
        })
        .catch(error => {
            console.error('Erro ao atualizar métricas:', error);
        });
}

function exportReport() {
    const period = document.getElementById('periodFilter').value;
    window.open(`/projects/support/metrics/export/?period=${period}`, '_blank');
}

function viewTicket(ticketId) {
    window.open(`/projects/support/admin/#ticket-${ticketId}`, '_blank');
}

function loadAllTickets() {
    window.location.href = '/projects/support/admin/';
}
</script>
{% endblock %}