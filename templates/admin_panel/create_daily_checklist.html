{% extends 'base.html' %}
{% load static %}

{% block title %}Criar Checklist Diário{% endblock %}

{% block content %}
<div class="p-6">
    <!-- Header -->
    <div class="bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg p-6 mb-8">
        <div class="flex justify-between items-center">
            <div>
                <nav class="mb-2" aria-label="breadcrumb">
                    <ol class="flex space-x-2 text-green-100">
                        <li>
                            <a href="{% url 'manage_checklists' %}" class="hover:text-white transition-colors">
                                <i class="fas fa-clipboard-list mr-1"></i>Checklists
                            </a>
                        </li>
                        <li class="before:content-['/'] before:mr-2">/</li>
                        <li class="text-white">Criar Checklist Diário</li>
                    </ol>
                </nav>
                <h1 class="text-3xl font-bold mb-2">
                    <i class="fas fa-calendar-plus mr-3"></i>
                    Criar Checklist Diário
                </h1>
                <p class="text-green-100">
                    Atribua um template de checklist aos usuários para uma data específica
                </p>
            </div>
        </div>
    </div>

    <form method="post" id="createChecklistForm">
        {% csrf_token %}
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Formulário Principal -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                        <h2 class="text-xl font-semibold text-gray-900">
                            <i class="fas fa-cog text-primary mr-2"></i>Configurações do Checklist
                        </h2>
                    </div>
                    <div class="p-6 space-y-6">
                        <!-- Tipo de Criação -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-3">Tipo de Criação</label>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="relative">
                                    <input type="radio" name="creation_type" value="template" id="type_template" 
                                           class="peer sr-only" checked onchange="toggleCreationType()">
                                    <label for="type_template" 
                                           class="flex items-center justify-center p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 peer-checked:border-primary peer-checked:bg-primary peer-checked:text-white transition-all">
                                        <div class="text-center">
                                            <i class="fas fa-clipboard-list text-2xl mb-2"></i>
                                            <div class="font-medium">Usar Template</div>
                                            <div class="text-sm opacity-75">Baseado em template existente</div>
                                        </div>
                                    </label>
                                </div>
                                <div class="relative">
                                    <input type="radio" name="creation_type" value="custom" id="type_custom" 
                                           class="peer sr-only" onchange="toggleCreationType()">
                                    <label for="type_custom" 
                                           class="flex items-center justify-center p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 peer-checked:border-primary peer-checked:bg-primary peer-checked:text-white transition-all">
                                        <div class="text-center">
                                            <i class="fas fa-plus-circle text-2xl mb-2"></i>
                                            <div class="font-medium">Criar Customizado</div>
                                            <div class="text-sm opacity-75">Criar do zero</div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Template Selection (apenas para tipo template) -->
                        <div id="template-section">
                            <label for="template_id" class="block text-sm font-medium text-gray-700 mb-2">
                                Template de Checklist *
                            </label>
                            <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" 
                                    id="template_id" name="template_id" onchange="previewTemplate()">
                                <option value="">Selecione um template...</option>
                                {% for template in templates %}
                                <option value="{{ template.id }}" 
                                        data-description="{{ template.description }}"
                                        data-items="{{ template.items.count }}">
                                    {{ template.title }} ({{ template.items.count }} itens)
                                </option>
                                {% endfor %}
                            </select>
                            <div id="template-preview" class="bg-gray-50 rounded-lg p-4 mt-3 hidden">
                                <!-- Preview será carregado aqui via JavaScript -->
                            </div>
                        </div>

                        <!-- Custom Creation Section (apenas para tipo customizado) -->
                        <div id="custom-section" class="hidden space-y-4">
                            <div>
                                <label for="custom_title" class="block text-sm font-medium text-gray-700 mb-2">
                                    Título do Checklist *
                                </label>
                                <input type="text" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" 
                                       id="custom_title" name="custom_title" 
                                       placeholder="Digite o título do checklist...">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Itens do Checklist</label>
                                <div id="custom-items-container" class="space-y-2">
                                    <div class="flex items-center space-x-2 custom-item">
                                        <span class="bg-gray-100 text-gray-700 px-3 py-2 rounded-md font-medium min-w-[40px] text-center">1</span>
                                        <input type="text" 
                                               class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" 
                                               name="custom_items[]" 
                                               placeholder="Digite o primeiro item...">
                                        <button type="button" 
                                                class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-md transition-colors" 
                                                onclick="removeCustomItem(this)">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                <button type="button" 
                                        class="mt-3 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors"
                                        onclick="addCustomItem()">
                                    <i class="fas fa-plus mr-2"></i>Adicionar Item
                                </button>
                            </div>
                        </div>

                        <!-- Data Selection -->
                        <div>
                            <label for="date" class="block text-sm font-medium text-gray-700 mb-2">
                                Data do Checklist *
                            </label>
                            <input type="date" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" 
                                   id="date" name="date" value="{{ today|date:'Y-m-d' }}" required>
                            <p class="text-sm text-gray-500 mt-1">
                                Se já existir um checklist para um usuário nesta data, ele não será substituído.
                            </p>
                        </div>

                        <!-- Repeat Daily Option -->
                        <div>
                            <div class="flex items-center">
                                <input type="checkbox" name="repeat_daily" id="repeat_daily" 
                                       class="h-4 w-4 text-primary rounded border-gray-300 focus:ring-primary mr-3">
                                <label for="repeat_daily" class="text-sm font-medium text-gray-700">
                                    Repetir todos os dias
                                </label>
                            </div>
                            <p class="text-sm text-gray-500 mt-1 ml-7">
                                Se marcado, criará este checklist automaticamente para os próximos 30 dias
                            </p>
                        </div>

                        <!-- User Selection -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Selecionar Usuários *
                            </label>
                            <div class="mb-4 flex space-x-2">
                                <button type="button" 
                                        class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition-colors text-sm"
                                        onclick="selectAllUsers()">
                                    <i class="fas fa-check-square mr-1"></i>Selecionar Todos
                                </button>
                                <button type="button" 
                                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm"
                                        onclick="deselectAllUsers()">
                                    <i class="fas fa-square mr-1"></i>Desmarcar Todos
                                </button>
                            </div>

                            <div class="max-h-96 overflow-y-auto border border-gray-200 rounded-lg p-4 space-y-3">
                                {% if users %}
                                    {% for user in users %}
                                    <div class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors user-checkbox">
                                        <input type="checkbox" name="user_ids" value="{{ user.id }}" 
                                               class="h-4 w-4 text-primary rounded border-gray-300 focus:ring-primary mr-4 user-checkbox-input">
                                        <div class="flex-1 min-w-0">
                                            <div class="flex justify-between items-center">
                                                <div>
                                                    <p class="font-medium text-gray-900">{{ user.get_full_name|default:user.username }}</p>
                                                    {% if user.email %}
                                                    <p class="text-sm text-gray-500">{{ user.email }}</p>
                                                    {% endif %}
                                                </div>
                                                <div class="text-right">
                                                    {% if user.sector %}
                                                    <span class="inline-block bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded-full">
                                                        {{ user.sector.name }}
                                                    </span>
                                                    {% endif %}
                                                    <p class="text-xs text-gray-400 mt-1">ID: {{ user.id }}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="text-center py-8">
                                        <i class="fas fa-users text-4xl text-gray-400 mb-4"></i>
                                        <p class="text-gray-500">Nenhum usuário encontrado</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar com Resumo -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-lg overflow-hidden sticky top-6">
                    <div class="bg-blue-500 text-white px-6 py-4">
                        <h3 class="font-semibold">
                            <i class="fas fa-clipboard-check mr-2"></i>Resumo da Criação
                        </h3>
                    </div>
                    <div class="p-6 space-y-4">
                        <div>
                            <p class="font-medium text-gray-900 mb-1">Tipo:</p>
                            <p id="selected-type" class="text-gray-600">Template</p>
                        </div>

                        <div>
                            <p class="font-medium text-gray-900 mb-1">Checklist:</p>
                            <p id="selected-template" class="text-gray-600">
                                Nenhum template selecionado
                            </p>
                        </div>

                        <div>
                            <p class="font-medium text-gray-900 mb-1">Itens:</p>
                            <p id="selected-items" class="text-gray-600">0 itens</p>
                        </div>

                        <div>
                            <p class="font-medium text-gray-900 mb-1">Data:</p>
                            <p id="selected-date" class="text-gray-600">
                                {{ today|date:"d/m/Y" }}
                            </p>
                        </div>

                        <div>
                            <p class="font-medium text-gray-900 mb-1">Repetição:</p>
                            <p id="selected-repeat" class="text-gray-600">Apenas uma vez</p>
                        </div>

                        <div>
                            <p class="font-medium text-gray-900 mb-1">Usuários:</p>
                            <p id="selected-users-count" class="text-gray-600">
                                0 usuário(s) selecionado(s)
                            </p>
                        </div>

                        <hr class="border-gray-200">

                        <div class="space-y-3">
                            <button type="submit" 
                                    class="w-full bg-green-500 hover:bg-green-600 text-white font-medium py-3 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                    id="createButton" disabled>
                                <i class="fas fa-plus mr-2"></i>Criar Checklists
                            </button>

                            <a href="{% url 'manage_checklists' %}" 
                               class="w-full bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg transition-colors inline-block text-center">
                                <i class="fas fa-arrow-left mr-2"></i>Voltar para Checklists
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Modal de Confirmação -->
<div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg max-w-md w-full mx-4">
        <div class="bg-green-500 text-white px-6 py-4 rounded-t-lg">
            <h3 class="text-lg font-semibold">
                <i class="fas fa-check mr-2"></i>Confirmar Criação
            </h3>
        </div>
        <div class="p-6">
            <p class="text-gray-700 mb-4">Você está prestes a criar checklists diários com as seguintes configurações:</p>
            <ul id="confirmation-details" class="list-disc list-inside text-gray-600 mb-4 space-y-1">
                <!-- Será preenchido via JavaScript -->
            </ul>
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                <p class="text-blue-800 text-sm">
                    <i class="fas fa-info-circle mr-2"></i>
                    <strong>Importante:</strong> Se já existir um checklist para um usuário na data selecionada, 
                    ele não será substituído.
                </p>
            </div>
            <p class="font-medium text-gray-900">Deseja continuar?</p>
        </div>
        <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
            <button type="button" 
                    class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors"
                    onclick="closeModal()">
                Cancelar
            </button>
            <button type="button" 
                    class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors"
                    onclick="submitForm()">
                <i class="fas fa-check mr-2"></i>Confirmar e Criar
            </button>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
{% endblock %}

{% block extra_js %}
<script>
let customItemCounter = 1;

function toggleCreationType() {
    const templateType = document.getElementById('type_template').checked;
    const templateSection = document.getElementById('template-section');
    const customSection = document.getElementById('custom-section');
    const templateSelect = document.getElementById('template_id');
    const customTitle = document.getElementById('custom_title');
    
    if (templateType) {
        templateSection.classList.remove('hidden');
        customSection.classList.add('hidden');
        templateSelect.required = true;
        customTitle.required = false;
    } else {
        templateSection.classList.add('hidden');
        customSection.classList.remove('hidden');
        templateSelect.required = false;
        customTitle.required = true;
    }
    
    updateCreateButton();
    updateSummary();
}

function previewTemplate() {
    const select = document.getElementById('template_id');
    const preview = document.getElementById('template-preview');
    const selectedTemplate = document.getElementById('selected-template');
    
    if (select.value) {
        const option = select.options[select.selectedIndex];
        const templateName = option.text;
        const description = option.dataset.description;
        const itemsCount = option.dataset.items;
        
        selectedTemplate.textContent = templateName;
        
        preview.innerHTML = `
            <h4 class="font-semibold text-gray-900 mb-2">${templateName}</h4>
            ${description ? `<p class="text-gray-600 mb-2">${description}</p>` : ''}
            <p class="text-blue-600 text-sm"><i class="fas fa-list mr-1"></i>${itemsCount} itens</p>
        `;
        preview.classList.remove('hidden');
    } else {
        selectedTemplate.textContent = 'Nenhum template selecionado';
        preview.classList.add('hidden');
    }
    
    updateCreateButton();
    updateSummary();
}

function addCustomItem() {
    customItemCounter++;
    const container = document.getElementById('custom-items-container');
    const newItem = document.createElement('div');
    newItem.className = 'flex items-center space-x-2 custom-item';
    newItem.innerHTML = `
        <span class="bg-gray-100 text-gray-700 px-3 py-2 rounded-md font-medium min-w-[40px] text-center">${customItemCounter}</span>
        <input type="text" 
               class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" 
               name="custom_items[]" 
               placeholder="Digite o item..." 
               oninput="updateSummary()">
        <button type="button" 
                class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-md transition-colors" 
                onclick="removeCustomItem(this)">
            <i class="fas fa-times"></i>
        </button>
    `;
    container.appendChild(newItem);
    updateSummary();
}

function removeCustomItem(button) {
    button.parentElement.remove();
    
    // Reordenar números
    const items = document.querySelectorAll('.custom-item');
    items.forEach((item, index) => {
        const numberSpan = item.querySelector('span');
        numberSpan.textContent = index + 1;
    });
    
    customItemCounter = items.length;
    updateSummary();
}

function updateSummary() {
    const templateType = document.getElementById('type_template').checked;
    const selectedTemplate = document.getElementById('selected-template');
    const selectedType = document.getElementById('selected-type');
    const selectedItems = document.getElementById('selected-items');
    
    // Atualizar tipo
    selectedType.textContent = templateType ? 'Template' : 'Customizado';
    
    if (templateType) {
        // Usando template
        const select = document.getElementById('template_id');
        if (select.value) {
            const option = select.options[select.selectedIndex];
            selectedTemplate.textContent = option.text;
            selectedItems.textContent = `${option.dataset.items} itens`;
        } else {
            selectedTemplate.textContent = 'Nenhum template selecionado';
            selectedItems.textContent = '0 itens';
        }
    } else {
        // Criação customizada
        const customTitle = document.getElementById('custom_title').value;
        const customItems = document.querySelectorAll('input[name="custom_items[]"]');
        const filledItems = Array.from(customItems).filter(item => item.value.trim() !== '');
        
        selectedTemplate.textContent = customTitle || 'Digite o título...';
        selectedItems.textContent = `${filledItems.length} itens`;
    }
}

function selectAllUsers() {
    const checkboxes = document.querySelectorAll('input[name="user_ids"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
    updateUsersCount();
}

function deselectAllUsers() {
    const checkboxes = document.querySelectorAll('input[name="user_ids"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    updateUsersCount();
}

function updateUsersCount() {
    const checkedBoxes = document.querySelectorAll('input[name="user_ids"]:checked');
    const count = checkedBoxes.length;
    
    document.getElementById('selected-users-count').textContent = 
        `${count} usuário(s) selecionado(s)`;
    
    updateCreateButton();
}

function updateDate() {
    const dateInput = document.getElementById('date');
    const selectedDate = document.getElementById('selected-date');
    
    if (dateInput.value) {
        const date = new Date(dateInput.value);
        selectedDate.textContent = date.toLocaleDateString('pt-BR');
    }
}

function updateRepeat() {
    const repeatCheckbox = document.getElementById('repeat_daily');
    const selectedRepeat = document.getElementById('selected-repeat');
    
    selectedRepeat.textContent = repeatCheckbox.checked ? 
        'Repetir por 30 dias' : 'Apenas uma vez';
}

function updateCreateButton() {
    const templateType = document.getElementById('type_template').checked;
    const checkedUsers = document.querySelectorAll('input[name="user_ids"]:checked');
    const createButton = document.getElementById('createButton');
    
    let isValid = false;
    
    if (templateType) {
        const templateSelect = document.getElementById('template_id');
        isValid = templateSelect.value !== '' && checkedUsers.length > 0;
    } else {
        const customTitle = document.getElementById('custom_title').value;
        const customItems = document.querySelectorAll('input[name="custom_items[]"]');
        const filledItems = Array.from(customItems).filter(item => item.value.trim() !== '');
        
        isValid = customTitle.trim() !== '' && filledItems.length > 0 && checkedUsers.length > 0;
    }
    
    createButton.disabled = !isValid;
}

function openModal() {
    document.getElementById('confirmModal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('confirmModal').classList.add('hidden');
}

function submitForm() {
    closeModal();
    
    const createButton = document.getElementById('createButton');
    createButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Criando...';
    createButton.disabled = true;
    
    document.getElementById('createChecklistForm').submit();
}

function showToast(message, type) {
    const toast = document.createElement('div');
    const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
    const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
    
    toast.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300`;
    toast.innerHTML = `
        <div class="flex items-center">
            <i class="fas ${icon} mr-3"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.getElementById('toast-container').appendChild(toast);
    
    setTimeout(() => toast.classList.remove('translate-x-full'), 100);
    
    setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Checkboxes de usuários
    document.querySelectorAll('input[name="user_ids"]').forEach(checkbox => {
        checkbox.addEventListener('change', updateUsersCount);
    });
    
    // Input de data
    document.getElementById('date').addEventListener('change', updateDate);
    
    // Checkbox de repetição
    document.getElementById('repeat_daily').addEventListener('change', updateRepeat);
    
    // Input do título customizado
    document.getElementById('custom_title').addEventListener('input', function() {
        updateSummary();
        updateCreateButton();
    });
    
    // Interceptar submit do formulário
    document.getElementById('createChecklistForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const templateType = document.getElementById('type_template').checked;
        const dateText = new Date(document.getElementById('date').value).toLocaleDateString('pt-BR');
        const usersCount = document.querySelectorAll('input[name="user_ids"]:checked').length;
        const repeatDaily = document.getElementById('repeat_daily').checked;
        
        let confirmationDetails = '';
        
        if (templateType) {
            const templateText = document.getElementById('template_id').options[document.getElementById('template_id').selectedIndex].text;
            confirmationDetails = `
                <li><strong>Tipo:</strong> Template</li>
                <li><strong>Template:</strong> ${templateText}</li>
            `;
        } else {
            const customTitle = document.getElementById('custom_title').value;
            const customItems = document.querySelectorAll('input[name="custom_items[]"]');
            const filledItems = Array.from(customItems).filter(item => item.value.trim() !== '');
            
            confirmationDetails = `
                <li><strong>Tipo:</strong> Customizado</li>
                <li><strong>Título:</strong> ${customTitle}</li>
                <li><strong>Itens:</strong> ${filledItems.length} itens</li>
            `;
        }
        
        confirmationDetails += `
            <li><strong>Data:</strong> ${dateText}</li>
            <li><strong>Usuários:</strong> ${usersCount} selecionado(s)</li>
            <li><strong>Repetição:</strong> ${repeatDaily ? 'Repetir por 30 dias' : 'Apenas uma vez'}</li>
        `;
        
        document.getElementById('confirmation-details').innerHTML = confirmationDetails;
        openModal();
    });
    
    // Fechar modal clicando fora
    document.getElementById('confirmModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
    
    // Inicializar
    toggleCreationType();
    updateUsersCount();
    updateDate();
    updateRepeat();
    updateSummary();
});
</script>
{% endblock %}