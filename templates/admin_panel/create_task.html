{% extends 'base.html' %}
{% load static %}

{% block title %}Criar Nova Tarefa{% endblock %}

{% block extra_css %}
<style>
.user-option {
    transition: all 0.2s ease-in-out;
}

.user-option:hover {
    transform: translateX(2px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.search-highlight {
    background-color: #fef3c7;
    color: #92400e;
    padding: 1px 3px;
    border-radius: 3px;
    font-weight: 500;
}

.fade-in {
    animation: fadeIn 0.3s ease-in-out;
}

.fade-out {
    animation: fadeOut 0.3s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes fadeOut {
    from { opacity: 1; transform: translateY(0); }
    to { opacity: 0; transform: translateY(-10px); }
}

.user-search-container {
    position: relative;
}

.user-search-container .search-icon {
    transition: color 0.2s ease-in-out;
}

.user-search-container input:focus + .search-icon {
    color: #3b82f6;
}

#user-select::-webkit-scrollbar {
    width: 6px;
}

#user-select::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 3px;
}

#user-select::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
}

#user-select::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}
</style>
{% endblock %}

{% block content %}
<div class="p-6">
    <!-- Header -->
    <div class="bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg p-6 mb-8">
        <div class="flex justify-between items-center">
            <div>
                <nav class="mb-3">
                    <ol class="flex space-x-2 text-green-100">
                        <li>
                            <a href="{% url 'manage_tasks' %}" class="hover:text-white transition-colors">
                                <i class="fas fa-tasks mr-1"></i>Tarefas
                            </a>
                        </li>
                        <li>/</li>
                        <li class="text-white font-medium">Nova Tarefa</li>
                    </ol>
                </nav>
                <h1 class="text-3xl font-bold mb-2">
                    <i class="fas fa-plus mr-3"></i>Criar Nova Tarefa
                </h1>
                <p class="text-green-100">
                    Atribua uma nova tarefa ou atividade para um usuário
                </p>
            </div>
        </div>
    </div>

    <form method="post" id="createTaskForm" class="grid grid-cols-1 lg:grid-cols-3 gap-8" enctype="multipart/form-data">
        {% csrf_token %}
        
        <!-- Formulário Principal -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="bg-primary text-white px-6 py-4">
                    <h2 class="text-lg font-semibold">
                        <i class="fas fa-cog mr-2"></i>Informações da Tarefa
                    </h2>
                </div>
                <div class="p-6 space-y-6">
                    <!-- Título -->
                    <div>
                        <label for="title" class="block text-sm font-medium text-gray-700 mb-2">
                            Título da Tarefa *
                        </label>
                        <input type="text" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                               id="title" name="title" required
                               placeholder="Digite um título claro e objetivo..."
                               maxlength="200">
                        <p class="text-sm text-gray-600 mt-1">
                            Seja específico sobre o que precisa ser feito (máx. 200 caracteres)
                        </p>
                    </div>

                    <!-- Descrição -->
                    <div>
                        <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
                            Descrição Detalhada
                        </label>
                        <textarea class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                  id="description" name="description" rows="4"
                                  placeholder="Descreva detalhadamente o que precisa ser feito, incluindo instruções específicas, recursos necessários, critérios de conclusão, etc."></textarea>
                        <p class="text-sm text-gray-600 mt-1">
                            Quanto mais detalhes, melhor será o entendimento da tarefa
                        </p>
                    </div>

                    <!-- Usuário -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Atribuir para *
                        </label>
                        {% if users %}
                        <!-- Campo de busca -->
                        <div class="mb-3">
                            <div class="relative">
                                <input type="text" 
                                       id="user-search" 
                                       placeholder="Digite o nome do usuário para buscar..."
                                       class="w-full px-4 py-2 pl-10 pr-10 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                       oninput="filterUsers(this.value)"
                                       autocomplete="off">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-search text-gray-400"></i>
                                </div>
                                <button type="button" 
                                        id="clear-search" 
                                        class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 hidden"
                                        onclick="clearUserSearch()"
                                        title="Limpar busca">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="flex justify-between items-center mt-1">
                                <div class="text-sm text-gray-600">
                                    <span>Digite parte do nome, email ou setor para filtrar</span>
                                    <div class="text-xs text-gray-500 mt-1">
                                        <i class="fas fa-keyboard mr-1"></i>
                                        <kbd class="px-1 py-0.5 text-xs bg-gray-100 border border-gray-300 rounded">Enter</kbd> para selecionar o primeiro
                                        • <kbd class="px-1 py-0.5 text-xs bg-gray-100 border border-gray-300 rounded">Esc</kbd> para limpar
                                    </div>
                                </div>
                                <div class="text-xs text-gray-500">
                                    <span id="user-count">{{ users|length }}</span> usuário(s)
                                </div>
                            </div>
                        </div>
                        
                        <div class="border border-gray-300 rounded-md p-4 max-h-80 overflow-y-auto" id="user-select">
                            <div class="space-y-2" id="user-list">
                                {% for user in users %}
                                <div class="user-option p-3 rounded-lg cursor-pointer transition-colors hover:bg-gray-50 border border-transparent" 
                                     data-user-id="{{ user.id }}" 
                                     data-user-name="{{ user.get_full_name|default:user.username }}"
                                     data-user-email="{{ user.email|default:'' }}"
                                     data-user-sector="{{ user.sector.name|default:'' }}"
                                     onclick="selectUser(this)">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <div class="font-medium text-gray-900">
                                                {{ user.get_full_name|default:user.username }}
                                            </div>
                                            {% if user.email %}
                                            <div class="text-sm text-gray-600">{{ user.email }}</div>
                                            {% endif %}
                                        </div>
                                        <div class="text-right">
                                            {% if user.sector %}
                                            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-medium">
                                                {{ user.sector.name }}
                                            </span>
                                            {% endif %}
                                            <div class="text-xs text-gray-500 mt-1">ID: {{ user.id }}</div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Mensagem quando nenhum usuário é encontrado -->
                        <div id="no-users-found" class="hidden text-center py-4 text-gray-500">
                            <i class="fas fa-user-slash text-2xl mb-2"></i>
                            <p>Nenhum usuário encontrado com esse critério de busca.</p>
                            <p class="text-sm mt-1">Tente buscar por nome, email ou setor.</p>
                        </div>
                        <input type="hidden" id="assigned_to" name="assigned_to" required>
                        <div id="selected-user-info" class="mt-3 p-3 bg-blue-50 rounded-lg hidden">
                            <!-- Informações do usuário selecionado -->
                        </div>
                        {% else %}
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                                <span class="text-yellow-800">Nenhum usuário disponível para atribuir tarefas.</span>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Prioridade -->
                    <div>
                        <label for="priority" class="block text-sm font-medium text-gray-700 mb-2">
                            Prioridade
                        </label>
                        <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                id="priority" name="priority" onchange="updatePriorityPreview()">
                            {% for priority_choice in PRIORITY_CHOICES %}
                            <option value="{{ priority_choice.0 }}" 
                                    {% if priority_choice.0 == 'MEDIUM' %}selected{% endif %}>
                                {{ priority_choice.1 }}
                            </option>
                            {% endfor %}
                        </select>
                        <div id="priority-preview" class="mt-2">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                                <i class="fas fa-flag mr-1"></i> Prioridade Média
                            </span>
                        </div>
                    </div>

                    <!-- Data/Prazo -->
                    <div>
                        <label for="due_date" class="block text-sm font-medium text-gray-700 mb-2">
                            Prazo (Opcional)
                        </label>
                        <input type="datetime-local" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                               id="due_date" name="due_date">
                        <p class="text-sm text-gray-600 mt-1">
                            Se não definido, a tarefa não terá prazo específico
                        </p>
                    </div>

                    <!-- Anexos -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Anexos (Opcional)
                        </label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 hover:border-primary transition-colors">
                            <div class="text-center">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                                <div class="mb-3">
                                    <label for="attachments" class="cursor-pointer">
                                        <span class="bg-primary hover:bg-orange-600 text-white font-medium py-2 px-4 rounded-lg inline-block transition-colors">
                                            <i class="fas fa-paperclip mr-2"></i>Selecionar Arquivos
                                        </span>
                                        <input type="file" 
                                               id="attachments" 
                                               name="attachments" 
                                               multiple 
                                               class="hidden"
                                               accept="image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.csv"
                                               onchange="handleFileSelect(event)">
                                    </label>
                                </div>
                                <p class="text-sm text-gray-600">
                                    Arraste arquivos aqui ou clique para selecionar
                                </p>
                                <p class="text-xs text-gray-500 mt-1">
                                    Máximo 50MB por arquivo • Imagens, vídeos e documentos
                                </p>
                            </div>
                            
                            <!-- Lista de arquivos selecionados -->
                            <div id="selected-files" class="mt-4 space-y-2 hidden">
                                <!-- Arquivos serão adicionados aqui via JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar com Resumo -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow-lg overflow-hidden sticky top-6">
                <div class="bg-green-500 text-white px-6 py-4">
                    <h3 class="text-lg font-semibold">
                        <i class="fas fa-clipboard-check mr-2"></i>Resumo da Tarefa
                    </h3>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <div class="text-sm font-medium text-gray-700 mb-1">Título:</div>
                        <div id="title-preview" class="text-gray-600">
                            Digite o título da tarefa...
                        </div>
                    </div>

                    <div>
                        <div class="text-sm font-medium text-gray-700 mb-1">Atribuído para:</div>
                        <div id="user-preview" class="text-gray-600">
                            Selecione um usuário...
                        </div>
                    </div>

                    <div>
                        <div class="text-sm font-medium text-gray-700 mb-1">Prioridade:</div>
                        <div id="priority-display" class="text-gray-600">
                            Média
                        </div>
                    </div>

                    <div>
                        <div class="text-sm font-medium text-gray-700 mb-1">Prazo:</div>
                        <div id="due-date-preview" class="text-gray-600">
                            Sem prazo definido
                        </div>
                    </div>

                    <div>
                        <div class="text-sm font-medium text-gray-700 mb-1">Criado por:</div>
                        <div class="text-primary font-medium">
                            {{ request.user.get_full_name|default:request.user.username }}
                        </div>
                    </div>

                    <hr class="border-gray-200">

                    <div class="space-y-3">
                        <button type="submit" 
                                class="w-full bg-green-500 hover:bg-green-600 text-white font-medium py-3 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                id="createButton" disabled>
                            <i class="fas fa-plus mr-2"></i>Criar Tarefa
                        </button>

                        <a href="{% url 'manage_tasks' %}" 
                           class="block w-full text-center bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                            <i class="fas fa-arrow-left mr-2"></i>Voltar para Tarefas
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Modal de Confirmação -->
<div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg max-w-md w-full mx-4">
        <div class="bg-green-500 text-white px-6 py-4 rounded-t-lg">
            <h3 class="text-lg font-semibold">
                <i class="fas fa-check mr-2"></i>Confirmar Criação
            </h3>
        </div>
        <div class="p-6">
            <p class="text-gray-700 mb-4">Você está prestes a criar uma nova tarefa com as seguintes informações:</p>
            <ul id="confirmation-details" class="space-y-2 text-sm text-gray-600 mb-4">
                <!-- Será preenchido via JavaScript -->
            </ul>
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                <div class="flex items-center">
                    <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                    <div>
                        <div class="text-sm font-medium text-blue-800">Importante:</div>
                        <div class="text-sm text-blue-700">O usuário será notificado sobre a nova tarefa atribuída.</div>
                    </div>
                </div>
            </div>
            <p class="font-medium text-gray-900">Deseja continuar?</p>
        </div>
        <div class="bg-gray-50 px-6 py-4 rounded-b-lg flex justify-end space-x-3">
            <button type="button" 
                    class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors"
                    onclick="closeConfirmModal()">
                Cancelar
            </button>
            <button type="button" 
                    class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors"
                    onclick="submitForm()">
                <i class="fas fa-check mr-2"></i>Confirmar e Criar
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function filterUsers(searchTerm) {
    const userOptions = document.querySelectorAll('.user-option');
    const noUsersFound = document.getElementById('no-users-found');
    const clearButton = document.getElementById('clear-search');
    const userCount = document.getElementById('user-count');
    let visibleCount = 0;
    
    // Normalizar termo de busca (remover acentos e converter para lowercase)
    const normalizedSearch = normalizeText(searchTerm.toLowerCase());
    
    userOptions.forEach(option => {
        const userName = normalizeText(option.getAttribute('data-user-name').toLowerCase());
        const userEmail = normalizeText(option.getAttribute('data-user-email').toLowerCase());
        const userSector = normalizeText(option.getAttribute('data-user-sector').toLowerCase());
        
        // Verificar se o termo de busca existe no nome, email ou setor
        const matchesName = userName.includes(normalizedSearch);
        const matchesEmail = userEmail.includes(normalizedSearch);
        const matchesSector = userSector.includes(normalizedSearch);
        
        if (matchesName || matchesEmail || matchesSector || searchTerm === '') {
            option.style.display = 'block';
            visibleCount++;
            
            // Destacar texto encontrado
            highlightSearchTerm(option, searchTerm);
        } else {
            option.style.display = 'none';
        }
    });
    
    // Atualizar contador de usuários
    userCount.textContent = visibleCount;
    
    // Mostrar/ocultar botão de limpar busca
    if (searchTerm !== '') {
        clearButton.classList.remove('hidden');
    } else {
        clearButton.classList.add('hidden');
    }
    
    // Mostrar/ocultar mensagem de "nenhum usuário encontrado"
    if (visibleCount === 0 && searchTerm !== '') {
        noUsersFound.classList.remove('hidden');
    } else {
        noUsersFound.classList.add('hidden');
    }
}

function normalizeText(text) {
    // Remove acentos e caracteres especiais
    return text.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
}

function highlightSearchTerm(element, searchTerm) {
    // Resetar highlights anteriores
    const textElements = element.querySelectorAll('.font-medium, .text-sm');
    textElements.forEach(el => {
        if (el.getAttribute('data-original-text')) {
            el.innerHTML = el.getAttribute('data-original-text');
        } else {
            el.setAttribute('data-original-text', el.innerHTML);
        }
    });
    
    if (searchTerm === '' || searchTerm.length < 2) {
        return;
    }
    
    // Destacar termo de busca
    const normalizedSearch = normalizeText(searchTerm.toLowerCase());
    
    textElements.forEach(el => {
        const originalText = el.getAttribute('data-original-text');
        const normalizedText = normalizeText(originalText.toLowerCase());
        
        if (normalizedText.includes(normalizedSearch)) {
            // Encontrar a posição real do texto para manter a capitalização original
            const regex = new RegExp(`(${escapeRegExp(searchTerm)})`, 'gi');
            const highlightedText = originalText.replace(regex, '<span class="search-highlight">$1</span>');
            el.innerHTML = highlightedText;
        }
    });
}

function escapeRegExp(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function clearUserSearch() {
    const searchInput = document.getElementById('user-search');
    searchInput.value = '';
    searchInput.focus();
    filterUsers('');
}

function selectUser(element) {
    // Remover seleção anterior
    document.querySelectorAll('.user-option').forEach(option => {
        option.classList.remove('border-primary', 'bg-blue-50');
        option.classList.add('border-transparent');
    });
    
    // Selecionar atual
    element.classList.remove('border-transparent');
    element.classList.add('border-primary', 'bg-blue-50');
    
    // Pegar informações do usuário
    const userId = element.getAttribute('data-user-id');
    const userName = element.querySelector('.font-medium').textContent;
    const userEmail = element.querySelector('.text-gray-600')?.textContent || '';
    const userSector = element.querySelector('.bg-blue-100')?.textContent || '';
    
    // Atualizar campo hidden
    document.getElementById('assigned_to').value = userId;
    
    // Mostrar informações do usuário selecionado
    let userInfo = `<div class="font-medium text-blue-800">${userName}</div>`;
    if (userEmail) userInfo += `<div class="text-sm text-blue-600">${userEmail}</div>`;
    if (userSector) userInfo += `<div class="text-sm"><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-medium">${userSector}</span></div>`;
    
    document.getElementById('selected-user-info').innerHTML = userInfo;
    document.getElementById('selected-user-info').classList.remove('hidden');
    document.getElementById('user-preview').textContent = userName;
    
    updateCreateButton();
}

function updatePriorityPreview() {
    const priority = document.getElementById('priority').value;
    const priorityText = document.getElementById('priority').selectedOptions[0].textContent;
    
    let priorityClasses = 'bg-yellow-100 text-yellow-800';
    let priorityIcon = 'fa-flag';
    
    if (priority === 'HIGH') {
        priorityClasses = 'bg-red-100 text-red-800';
    } else if (priority === 'LOW') {
        priorityClasses = 'bg-green-100 text-green-800';
    }
    
    document.getElementById('priority-preview').innerHTML = 
        `<span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${priorityClasses}">
            <i class="fas ${priorityIcon} mr-1"></i> ${priorityText}
        </span>`;
    
    document.getElementById('priority-display').textContent = priorityText;
}

function updateTitlePreview() {
    const title = document.getElementById('title').value;
    document.getElementById('title-preview').textContent = title || 'Digite o título da tarefa...';
    updateCreateButton();
}

function updateDueDatePreview() {
    const dueDate = document.getElementById('due_date').value;
    if (dueDate) {
        const date = new Date(dueDate);
        const formattedDate = date.toLocaleString('pt-BR');
        document.getElementById('due-date-preview').textContent = formattedDate;
    } else {
        document.getElementById('due-date-preview').textContent = 'Sem prazo definido';
    }
}

function updateCreateButton() {
    const title = document.getElementById('title').value.trim();
    const userId = document.getElementById('assigned_to').value;
    const createButton = document.getElementById('createButton');
    
    const isValid = title !== '' && userId !== '';
    createButton.disabled = !isValid;
}

function submitForm() {
    closeConfirmModal();
    
    // Mostrar loading
    const createButton = document.getElementById('createButton');
    createButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Criando...';
    createButton.disabled = true;
    
    // Submeter formulário
    document.getElementById('createTaskForm').submit();
}

function closeConfirmModal() {
    document.getElementById('confirmModal').classList.add('hidden');
}

function openConfirmModal() {
    document.getElementById('confirmModal').classList.remove('hidden');
}

document.addEventListener('DOMContentLoaded', function() {
    // Event listeners
    document.getElementById('title').addEventListener('input', updateTitlePreview);
    document.getElementById('due_date').addEventListener('change', updateDueDatePreview);
    
    // Event listener para busca de usuários
    const userSearch = document.getElementById('user-search');
    if (userSearch) {
        userSearch.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                this.value = '';
                filterUsers('');
                this.blur();
            } else if (e.key === 'Enter') {
                e.preventDefault();
                // Selecionar primeiro usuário visível
                const firstVisible = document.querySelector('.user-option[style="display: block"], .user-option:not([style])');
                if (firstVisible) {
                    selectUser(firstVisible);
                    this.value = '';
                    filterUsers('');
                    this.blur();
                    
                    // Animação de feedback visual
                    const selectedUserInfo = document.getElementById('selected-user-info');
                    selectedUserInfo.classList.add('fade-in');
                    setTimeout(() => {
                        selectedUserInfo.classList.remove('fade-in');
                    }, 300);
                }
            }
        });
        
        // Focar no campo de busca com Ctrl+F ou Cmd+F quando estiver na página
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'f' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
                userSearch.focus();
                userSearch.select();
            }
        });
    }
    
    // Inicializar valores
    updateTitlePreview();
    updateDueDatePreview();
    updatePriorityPreview();
    
    // Interceptar submit do formulário para mostrar confirmação
    document.getElementById('createTaskForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Preencher detalhes da confirmação
        const title = document.getElementById('title').value;
        const userName = document.getElementById('user-preview').textContent;
        const priority = document.getElementById('priority').selectedOptions[0].textContent;
        const dueDate = document.getElementById('due-date-preview').textContent;
        const description = document.getElementById('description').value;
        
        let confirmationDetails = `
            <li><span class="font-medium">Título:</span> ${title}</li>
            <li><span class="font-medium">Atribuído para:</span> ${userName}</li>
            <li><span class="font-medium">Prioridade:</span> ${priority}</li>
            <li><span class="font-medium">Prazo:</span> ${dueDate}</li>
        `;
        
        if (description.trim()) {
            const shortDescription = description.length > 100 ? description.substring(0, 100) + '...' : description;
            confirmationDetails += `<li><span class="font-medium">Descrição:</span> ${shortDescription}</li>`;
        }
        
        document.getElementById('confirmation-details').innerHTML = confirmationDetails;
        openConfirmModal();
    });
    
    // Definir data mínima como hoje
    const today = new Date();
    today.setMinutes(today.getMinutes() - today.getTimezoneOffset());
    document.getElementById('due_date').setAttribute('min', today.toISOString().slice(0, 16));
});

// Gerenciamento de anexos
let selectedFiles = [];

function handleFileSelect(event) {
    const files = Array.from(event.target.files);
    const maxSize = 50 * 1024 * 1024; // 50MB
    
    files.forEach(file => {
        // Validar tamanho
        if (file.size > maxSize) {
            alert(`O arquivo "${file.name}" é muito grande. Máximo 50MB.`);
            return;
        }
        
        // Adicionar à lista se não existir
        if (!selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
            selectedFiles.push(file);
        }
    });
    
    updateFileList();
    event.target.value = ''; // Limpar input para permitir selecionar o mesmo arquivo novamente
}

function removeFile(index) {
    selectedFiles.splice(index, 1);
    updateFileList();
    updateAttachmentsInput();
}

function updateFileList() {
    const container = document.getElementById('selected-files');
    
    if (selectedFiles.length === 0) {
        container.classList.add('hidden');
        return;
    }
    
    container.classList.remove('hidden');
    container.innerHTML = selectedFiles.map((file, index) => {
        const fileSize = formatFileSize(file.size);
        const fileIcon = getFileIcon(file.name);
        
        return `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                <div class="flex items-center space-x-3 flex-1 min-w-0">
                    <i class="${fileIcon} text-2xl text-gray-600"></i>
                    <div class="flex-1 min-w-0">
                        <div class="font-medium text-gray-900 truncate">${file.name}</div>
                        <div class="text-sm text-gray-500">${fileSize}</div>
                    </div>
                </div>
                <button type="button" 
                        onclick="removeFile(${index})"
                        class="ml-3 text-red-600 hover:text-red-800 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
    }).join('');
    
    updateAttachmentsInput();
}

function updateAttachmentsInput() {
    const input = document.getElementById('attachments');
    const dataTransfer = new DataTransfer();
    
    selectedFiles.forEach(file => {
        dataTransfer.items.add(file);
    });
    
    input.files = dataTransfer.files;
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function getFileIcon(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    
    // Imagens
    if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'].includes(ext)) {
        return 'fas fa-image text-blue-500';
    }
    // Vídeos
    if (['mp4', 'avi', 'mov', 'wmv', 'flv', 'webm', 'mkv'].includes(ext)) {
        return 'fas fa-video text-purple-500';
    }
    // PDFs
    if (ext === 'pdf') {
        return 'fas fa-file-pdf text-red-500';
    }
    // Excel
    if (['xls', 'xlsx', 'csv'].includes(ext)) {
        return 'fas fa-file-excel text-green-500';
    }
    // Word
    if (['doc', 'docx'].includes(ext)) {
        return 'fas fa-file-word text-blue-600';
    }
    // PowerPoint
    if (['ppt', 'pptx'].includes(ext)) {
        return 'fas fa-file-powerpoint text-orange-500';
    }
    // Texto
    if (ext === 'txt') {
        return 'fas fa-file-alt text-gray-500';
    }
    // Padrão
    return 'fas fa-file text-gray-500';
}

// Drag and drop
const dropZone = document.querySelector('.border-dashed');
if (dropZone) {
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
            dropZone.classList.add('border-primary', 'bg-orange-50');
        }, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
            dropZone.classList.remove('border-primary', 'bg-orange-50');
        }, false);
    });

    dropZone.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        const input = document.getElementById('attachments');
        input.files = files;
        handleFileSelect({ target: input });
    }, false);
}
</script>
{% endblock %}