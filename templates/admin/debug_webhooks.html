{% extends 'base.html' %}

{% block title %}Debug Webhooks{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b border-gray-200 mb-6">
        <div class="px-6 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-bug text-red-500 mr-3"></i>
                        Debug de Webhooks
                    </h1>
                    <p class="text-gray-600 mt-1">Testar e diagnosticar webhooks configurados</p>
                </div>
                <a href="{% url 'manage_webhooks' %}" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors flex items-center">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Voltar
                </a>
            </div>
        </div>
    </div>

    <div class="px-6 space-y-6">
        <!-- Estatísticas -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100">
                        <i class="fas fa-cloud text-blue-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">Total de Webhooks</p>
                        <p class="text-2xl font-bold text-gray-900">{{ stats.total_webhooks }}</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100">
                        <i class="fas fa-check-circle text-green-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">Webhooks Ativos</p>
                        <p class="text-2xl font-bold text-gray-900">{{ stats.active_webhooks }}</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-purple-100">
                        <i class="fas fa-bullhorn text-purple-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">Comunicados</p>
                        <p class="text-2xl font-bold text-gray-900">{{ stats.communication_webhooks }}</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-orange-100">
                        <i class="fas fa-gavel text-orange-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">Aprovações</p>
                        <p class="text-2xl font-bold text-gray-900">{{ stats.approval_webhooks }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Testes -->
        <div class="bg-white rounded-lg shadow-sm">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">Testes de Webhooks</h3>
                <p class="text-gray-600">Execute testes para verificar se os webhooks estão funcionando</p>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="border border-gray-200 rounded-lg p-6">
                        <h4 class="text-lg font-medium text-gray-900 mb-3">
                            <i class="fas fa-bullhorn text-purple-500 mr-2"></i>
                            Webhook Simulado
                        </h4>
                        <p class="text-gray-600 mb-4">Testa webhooks sem criar dados reais</p>
                        <button onclick="testWebhook('communication')" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors w-full">
                            <i class="fas fa-play mr-2"></i>
                            Teste Simulado
                        </button>
                    </div>

                    <div class="border border-gray-200 rounded-lg p-6">
                        <h4 class="text-lg font-medium text-gray-900 mb-3">
                            <i class="fas fa-bullhorn text-blue-500 mr-2"></i>
                            Comunicado Real
                        </h4>
                        <p class="text-gray-600 mb-4">Cria um comunicado de teste real (recomendado)</p>
                        <button onclick="testWebhook('communication_real')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors w-full">
                            <i class="fas fa-plus mr-2"></i>
                            Criar & Testar
                        </button>
                    </div>

                    <div class="border border-gray-200 rounded-lg p-6">
                        <h4 class="text-lg font-medium text-gray-900 mb-3">
                            <i class="fas fa-gavel text-orange-500 mr-2"></i>
                            Webhook de Aprovação
                        </h4>
                        <p class="text-gray-600 mb-4">Testa webhooks de aprovação</p>
                        <button onclick="testWebhook('approval')" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors w-full">
                            <i class="fas fa-play mr-2"></i>
                            Testar Aprovação
                        </button>
                    </div>
                </div>

                <!-- Listar Webhooks Detalhadamente -->
                <div class="mt-6 border-t border-gray-200 pt-6">
                    <h4 class="font-medium text-gray-900 mb-3">Diagnóstico Avançado</h4>
                    <button onclick="listWebhooksDetailed()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                        <i class="fas fa-list mr-2"></i>
                        Listar Webhooks Detalhados
                    </button>
                </div>

                <!-- Resultado dos Testes -->
                <div id="testResults" class="mt-6 hidden">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-medium text-gray-900 mb-2">Resultado do Teste:</h4>
                        <div id="testContent" class="text-sm"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de Webhooks -->
        <div class="bg-white rounded-lg shadow-sm">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">Webhooks Configurados</h3>
                <p class="text-gray-600">Lista completa de webhooks no sistema</p>
            </div>
            <div class="p-6">
                {% if webhooks %}
                    <div class="space-y-4">
                        {% for webhook in webhooks %}
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-medium text-gray-900">
                                        {{ webhook.name }}
                                        {% if webhook.is_active %}
                                            <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                Ativo
                                            </span>
                                        {% else %}
                                            <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                                Inativo
                                            </span>
                                        {% endif %}
                                    </h4>
                                    <p class="text-sm text-gray-600">{{ webhook.url }}</p>
                                    <p class="text-xs text-gray-500">Evento: {{ webhook.get_event_display }}</p>
                                </div>
                                <div class="text-right">
                                    {% if webhook.category %}
                                        <p class="text-xs text-gray-500">Categoria: {{ webhook.category.name }}</p>
                                    {% endif %}
                                    {% if webhook.sector %}
                                        <p class="text-xs text-gray-500">Setor: {{ webhook.sector.name }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-12">
                        <i class="fas fa-cloud text-gray-400 text-4xl mb-4"></i>
                        <p class="text-gray-500">Nenhum webhook configurado</p>
                        <a href="{% url 'create_webhook' %}" class="mt-4 inline-flex items-center text-blue-600 hover:text-blue-700">
                            <i class="fas fa-plus mr-2"></i>
                            Criar primeiro webhook
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Comunicados Recentes -->
        <div class="bg-white rounded-lg shadow-sm">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">Comunicados Recentes</h3>
                <p class="text-gray-600">Últimos comunicados que podem ter disparado webhooks</p>
            </div>
            <div class="p-6">
                {% if recent_communications %}
                    <div class="space-y-3">
                        {% for comm in recent_communications %}
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div>
                                <p class="font-medium text-gray-900">{{ comm.title }}</p>
                                <p class="text-sm text-gray-600">Por: {{ comm.sender.get_full_name }}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-gray-500">{{ comm.created_at|date:"d/m/Y H:i" }}</p>
                                {% if comm.send_to_all %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                                        Para todos
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-gray-500 text-center">Nenhum comunicado encontrado</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function testWebhook(type) {
    const formData = new FormData();
    
    if (type === 'communication') {
        formData.append('action', 'test_communication');
    } else if (type === 'communication_real') {
        formData.append('action', 'test_communication_real');
    } else if (type === 'approval') {
        formData.append('action', 'test_approval');
    }

    // Adicionar CSRF token
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

    fetch('{% url "debug_webhooks" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        const resultsDiv = document.getElementById('testResults');
        const contentDiv = document.getElementById('testContent');
        
        if (data.success) {
            contentDiv.innerHTML = `
                <div class="flex items-center text-green-600">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span>${data.message}</span>
                </div>
            `;
        } else {
            contentDiv.innerHTML = `
                <div class="flex items-center text-red-600">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <span>Erro: ${data.error}</span>
                </div>
            `;
        }
        
        resultsDiv.classList.remove('hidden');
    })
    .catch(error => {
        console.error('Erro:', error);
        const resultsDiv = document.getElementById('testResults');
        const contentDiv = document.getElementById('testContent');
        
        contentDiv.innerHTML = `
            <div class="flex items-center text-red-600">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                <span>Erro na requisição: ${error.message}</span>
            </div>
        `;
        
        resultsDiv.classList.remove('hidden');
    });
}

function listWebhooksDetailed() {
    const formData = new FormData();
    formData.append('action', 'list_webhooks');
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

    fetch('{% url "debug_webhooks" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        const resultsDiv = document.getElementById('testResults');
        const contentDiv = document.getElementById('testContent');
        
        if (data.success) {
            let content = '<div class="space-y-3">';
            content += `<p class="font-medium text-green-600">Total de webhooks encontrados: ${data.count}</p>`;
            
            if (data.webhooks.length === 0) {
                content += '<p class="text-red-600">❌ Nenhum webhook configurado! Este é provavelmente o problema.</p>';
                content += '<p class="text-sm text-gray-600 mt-2">Para corrigir:</p>';
                content += '<ol class="text-sm text-gray-600 list-decimal list-inside ml-4">';
                content += '<li>Vá para Administração → Webhooks → Novo Webhook</li>';
                content += '<li>Configure um webhook com evento "COMMUNICATION_CREATED"</li>';
                content += '<li>Defina a URL do seu endpoint externo</li>';
                content += '</ol>';
            } else {
                data.webhooks.forEach(webhook => {
                    const statusBadge = webhook.is_active 
                        ? '<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">Ativo</span>'
                        : '<span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs">Inativo</span>';
                    
                    content += `
                        <div class="border border-gray-200 rounded p-3">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-medium">${webhook.name} ${statusBadge}</p>
                                    <p class="text-sm text-gray-600">URL: ${webhook.url}</p>
                                    <p class="text-sm text-gray-600">Evento: ${webhook.event}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            content += '</div>';
            
            contentDiv.innerHTML = content;
        } else {
            contentDiv.innerHTML = `
                <div class="flex items-center text-red-600">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <span>Erro: ${data.error}</span>
                </div>
            `;
        }
        
        resultsDiv.classList.remove('hidden');
    })
    .catch(error => {
        console.error('Erro:', error);
    });
}
</script>

{% csrf_token %}
{% endblock %}