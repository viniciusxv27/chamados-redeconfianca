{% extends 'base.html' %}
{% load static %}

{% block title %}Chamados - Rede Confiança{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Page Header -->
    <div class="mb-8 flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Chamados</h1>
            <p class="text-gray-600 mt-2">Gerencie seus chamados e solicitações</p>
        </div>
        <div class="flex space-x-3">
            <a href="{% url 'tickets_history' %}" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors font-medium">
                <i class="fas fa-history mr-2"></i>
                Histórico
            </a>
            <a href="{% url 'ticket_create' %}" class="bg-secondary text-white px-6 py-3 rounded-lg hover:bg-gray-800 transition-colors font-medium">
                Novo Chamado
            </a>
        </div>
    </div>
    
    <!-- User Info Section -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <div class="flex items-center space-x-4">
            {% if user.profile_picture %}
                <img src="{{ user.profile_picture.url }}" alt="{{ user.full_name }}" class="w-16 h-16 rounded-full object-cover border-2 border-primary/20">
            {% elif user.avatar %}
                <img src="{{ user.avatar.url }}" alt="{{ user.full_name }}" class="w-16 h-16 rounded-full object-cover border-2 border-primary/20">
            {% else %}
                <div class="w-16 h-16 bg-gradient-to-br from-primary to-orange-500 rounded-full flex items-center justify-center border-2 border-primary/20">
                    <span class="text-white font-bold text-xl">{{ user.first_name.0 }}{{ user.last_name.0 }}</span>
                </div>
            {% endif %}
            <div>
                <h2 class="text-xl font-semibold text-gray-900">{{ user.first_name }} {{ user.last_name }}</h2>
                <p class="text-gray-600">{{ user.get_hierarchy_display }}{% if user.sectors_display != "Nenhum setor" %} - {{ user.sectors_display }}{% endif %}</p>
            </div>
        </div>
    </div>
    
    <!-- Tabs Navigation -->
    <div class="mb-6">
        <nav class="flex space-x-8 border-b border-gray-200">
            <a href="#" onclick="showTab('todos')" id="tab-todos" class="border-b-2 border-primary text-primary py-2 px-1 text-sm font-medium">
                Todos
            </a>
            <a href="#" onclick="showTab('meus')" id="tab-meus" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-2 px-1 text-sm font-medium">
                Meus Chamados
            </a>
        </nav>
    </div>
    
    <!-- Tickets Table -->
    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Status do Chamado
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            ID
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Título
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Data da solicitação
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Setor
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Responsável
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Ações
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for ticket in tickets %}
                    <tr class="hover:bg-gray-50 ticket-row" data-created-by="{{ ticket.created_by.id }}" data-current-user="{{ user.id }}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if ticket.status == 'ABERTO' %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary text-white">
                                    Aberto
                                </span>
                            {% elif ticket.status == 'EM_ANDAMENTO' %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-500 text-white">
                                    Em Andamento
                                </span>
                            {% elif ticket.status == 'RESOLVIDO' or ticket.status == 'FECHADO' %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-success text-white">
                                    Concluído
                                </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            #{{ ticket.id|stringformat:"04d" }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">{{ ticket.title }}</div>
                            <div class="text-sm text-gray-500">{{ ticket.category.name }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ ticket.created_at|date:"d/m/Y - H:i" }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ ticket.sector.name }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {% if ticket.assigned_to %}
                                {{ ticket.assigned_to.first_name }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <a href="{% url 'ticket_detail' ticket.id %}" class="bg-secondary text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition-colors">
                                Ver
                            </a>
                            {% if ticket.status == 'RESOLVIDO' and ticket.created_by == user %}
                                <span class="ml-2 bg-red-500 text-white px-2 py-1 rounded text-xs">
                                    Pendente
                                </span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr id="no-tickets-row">
                        <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                            Nenhum chamado encontrado.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
function showTab(tabName) {
    // Remove active classes from all tabs
    document.getElementById('tab-todos').className = 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-2 px-1 text-sm font-medium';
    document.getElementById('tab-meus').className = 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-2 px-1 text-sm font-medium';
    
    // Add active class to selected tab
    document.getElementById('tab-' + tabName).className = 'border-b-2 border-primary text-primary py-2 px-1 text-sm font-medium';
    
    // Get all ticket rows
    const ticketRows = document.querySelectorAll('.ticket-row');
    const noTicketsRow = document.getElementById('no-tickets-row');
    let visibleCount = 0;
    
    if (tabName === 'todos') {
        // Show all tickets
        ticketRows.forEach(row => {
            row.style.display = '';
            visibleCount++;
        });
    } else if (tabName === 'meus') {
        // Show only tickets created by current user
        ticketRows.forEach(row => {
            const createdBy = row.getAttribute('data-created-by');
            const currentUser = row.getAttribute('data-current-user');
            
            if (createdBy === currentUser) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    // Show/hide "no tickets" message
    if (noTicketsRow) {
        if (visibleCount === 0 && ticketRows.length > 0) {
            // Create a temporary "no tickets found" message for filtered view
            if (!document.getElementById('no-filtered-tickets')) {
                const newRow = noTicketsRow.cloneNode(true);
                newRow.id = 'no-filtered-tickets';
                newRow.querySelector('td').textContent = 'Nenhum chamado encontrado para este filtro.';
                noTicketsRow.parentNode.appendChild(newRow);
            }
            document.getElementById('no-filtered-tickets').style.display = '';
            if (noTicketsRow) noTicketsRow.style.display = 'none';
        } else {
            // Hide temporary message and show/hide original based on total tickets
            const filteredRow = document.getElementById('no-filtered-tickets');
            if (filteredRow) filteredRow.style.display = 'none';
            
            if (ticketRows.length === 0) {
                noTicketsRow.style.display = '';
            } else {
                noTicketsRow.style.display = 'none';
            }
        }
    }
}

// Initialize with "Todos" tab active
document.addEventListener('DOMContentLoaded', function() {
    showTab('todos');
});
</script>
{% endblock %}
