{% extends 'base.html' %}
{% load static %}

{% block title %}Editar Chamado #{{ ticket.id }} - Rede Confiança{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto p-6">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">
                    <i class="fas fa-edit text-primary mr-2"></i>
                    Editar Chamado #{{ ticket.id|stringformat:"04d" }}
                </h1>
                <p class="text-gray-600 mt-1">Editando todas as propriedades do chamado</p>
            </div>
            <a href="{% url 'ticket_detail' ticket.id %}" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>
                Voltar
            </a>
        </div>
    </div>
    
    <!-- Formulário de Edição -->
    <form method="POST" class="bg-white rounded-lg shadow-sm p-6">
        {% csrf_token %}
        <input type="hidden" name="next" value="{{ request.GET.next }}">
        
        <!-- Informações Básicas -->
        <div class="mb-8">
            <h2 class="text-lg font-semibold text-gray-900 mb-4 pb-2 border-b">
                <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                Informações Básicas
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Título -->
                <div class="md:col-span-2">
                    <label for="title" class="block text-sm font-medium text-gray-700 mb-2">
                        Título <span class="text-red-500">*</span>
                    </label>
                    <input type="text" 
                           id="title" 
                           name="title" 
                           value="{{ ticket.title }}"
                           required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                
                <!-- Descrição -->
                <div class="md:col-span-2">
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
                        Descrição <span class="text-red-500">*</span>
                    </label>
                    <textarea id="description" 
                              name="description" 
                              rows="4"
                              required
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">{{ ticket.description }}</textarea>
                </div>
                
                <!-- Setor -->
                <div>
                    <label for="sector" class="block text-sm font-medium text-gray-700 mb-2">
                        Setor <span class="text-red-500">*</span>
                    </label>
                    <select id="sector" 
                            name="sector" 
                            required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        {% for sector in sectors %}
                            <option value="{{ sector.id }}" {% if ticket.sector.id == sector.id %}selected{% endif %}>
                                {{ sector.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Categoria -->
                <div>
                    <label for="category" class="block text-sm font-medium text-gray-700 mb-2">
                        Categoria
                    </label>
                    <select id="category" 
                            name="category" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="">Sem categoria</option>
                        {% for category in categories %}
                            <option value="{{ category.id }}" 
                                    data-sector="{{ category.sector.id }}"
                                    {% if ticket.category and ticket.category.id == category.id %}selected{% endif %}>
                                {{ category.name }} ({{ category.sector.name }})
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Status e Prioridade -->
        <div class="mb-8">
            <h2 class="text-lg font-semibold text-gray-900 mb-4 pb-2 border-b">
                <i class="fas fa-tasks text-green-500 mr-2"></i>
                Status e Prioridade
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Status -->
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700 mb-2">
                        Status <span class="text-red-500">*</span>
                    </label>
                    <select id="status" 
                            name="status" 
                            required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        {% for value, label in status_choices %}
                            <option value="{{ value }}" {% if ticket.status == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Prioridade -->
                <div>
                    <label for="priority" class="block text-sm font-medium text-gray-700 mb-2">
                        Prioridade <span class="text-red-500">*</span>
                    </label>
                    <select id="priority" 
                            name="priority" 
                            required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        {% for value, label in priority_choices %}
                            <option value="{{ value }}" {% if ticket.priority == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Responsável -->
                <div>
                    <label for="assigned_to" class="block text-sm font-medium text-gray-700 mb-2">
                        Responsável
                    </label>
                    <select id="assigned_to" 
                            name="assigned_to" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="">Sem responsável</option>
                        {% for u in users %}
                            <option value="{{ u.id }}" {% if ticket.assigned_to and ticket.assigned_to.id == u.id %}selected{% endif %}>
                                {{ u.get_full_name }} {% if u.sector %}({{ u.sector.name }}){% endif %}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Campos Adicionais -->
        <div class="mb-8">
            <h2 class="text-lg font-semibold text-gray-900 mb-4 pb-2 border-b">
                <i class="fas fa-building text-purple-500 mr-2"></i>
                Informações Adicionais
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Loja/Local -->
                <div>
                    <label for="store_location" class="block text-sm font-medium text-gray-700 mb-2">
                        Loja/Local
                    </label>
                    <input type="text" 
                           id="store_location" 
                           name="store_location" 
                           value="{{ ticket.store_location|default:'' }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                
                <!-- Responsável do Local -->
                <div>
                    <label for="responsible_person" class="block text-sm font-medium text-gray-700 mb-2">
                        Responsável do Local
                    </label>
                    <input type="text" 
                           id="responsible_person" 
                           name="responsible_person" 
                           value="{{ ticket.responsible_person|default:'' }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                
                <!-- Telefone -->
                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">
                        Telefone
                    </label>
                    <input type="text" 
                           id="phone" 
                           name="phone" 
                           value="{{ ticket.phone|default:'' }}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
            </div>
        </div>
        
        <!-- Solução -->
        <div class="mb-8">
            <h2 class="text-lg font-semibold text-gray-900 mb-4 pb-2 border-b">
                <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                Solução
            </h2>
            
            <div>
                <label for="solution" class="block text-sm font-medium text-gray-700 mb-2">
                    Descrição da Solução
                </label>
                <textarea id="solution" 
                          name="solution" 
                          rows="4"
                          placeholder="Descreva a solução aplicada ao chamado..."
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">{{ ticket.solution|default:'' }}</textarea>
            </div>
        </div>
        
        <!-- Informações do Sistema (Somente Leitura) -->
        <div class="mb-8 bg-gray-50 rounded-lg p-4">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-clock text-gray-500 mr-2"></i>
                Informações do Sistema
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
                <div>
                    <span class="text-gray-500">Criado por:</span>
                    <p class="font-medium">{{ ticket.created_by.get_full_name }}</p>
                </div>
                <div>
                    <span class="text-gray-500">Data de Criação:</span>
                    <p class="font-medium">{{ ticket.created_at|date:"d/m/Y H:i" }}</p>
                </div>
                <div>
                    <span class="text-gray-500">Última Atualização:</span>
                    <p class="font-medium">{{ ticket.updated_at|date:"d/m/Y H:i" }}</p>
                </div>
                <div>
                    <span class="text-gray-500">Data de Resolução:</span>
                    <p class="font-medium">{% if ticket.resolved_at %}{{ ticket.resolved_at|date:"d/m/Y H:i" }}{% else %}-{% endif %}</p>
                </div>
            </div>
        </div>
        
        <!-- Botões de Ação -->
        <div class="flex items-center justify-between pt-4 border-t">
            <a href="{% url 'ticket_detail' ticket.id %}" class="text-gray-600 hover:text-gray-800">
                <i class="fas fa-times mr-2"></i>
                Cancelar
            </a>
            
            <button type="submit" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-orange-600 transition-colors">
                <i class="fas fa-save mr-2"></i>
                Salvar Alterações
            </button>
        </div>
    </form>
</div>

<script>
// Filtrar categorias por setor
document.getElementById('sector').addEventListener('change', function() {
    const selectedSectorId = this.value;
    const categorySelect = document.getElementById('category');
    const options = categorySelect.querySelectorAll('option[data-sector]');
    
    // Mostrar/ocultar categorias baseado no setor
    options.forEach(option => {
        if (option.dataset.sector === selectedSectorId || !selectedSectorId) {
            option.style.display = '';
        } else {
            option.style.display = 'none';
            // Se a opção estava selecionada e foi ocultada, desmarcar
            if (option.selected) {
                categorySelect.value = '';
            }
        }
    });
});

// Executar ao carregar para filtrar categorias inicialmente
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('sector').dispatchEvent(new Event('change'));
});
</script>
{% endblock %}
