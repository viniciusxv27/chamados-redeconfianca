{% extends 'base.html' %}
{% load static %}

{% block title %}Chamado #{{ ticket.id }} - Rede Confiança{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Page Header -->
    <div class="mb-6 sm:mb-8 px-4 sm:px-0">
        <div class="flex flex-col sm:flex-row sm:items-center justify-between space-y-4 sm:space-y-0">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Chamados</h1>
                <p class="text-gray-600 mt-1 sm:mt-2 text-sm sm:text-base">Visualizar e responder chamado</p>
            </div>
            <div class="flex space-x-3">
                {% if ticket.created_by == user and ticket.status == 'RESOLVIDO' %}
                    <button class="bg-success text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors text-sm sm:text-base">
                        Concluir e Fechar
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- User Info Section -->
    <div class="bg-white rounded-lg shadow-sm p-4 sm:p-6 mb-6 mx-4 sm:mx-0">
        <div class="flex items-center space-x-3 sm:space-x-4">
            <div class="w-12 h-12 sm:w-16 sm:h-16 bg-gray-300 rounded-full flex items-center justify-center overflow-hidden flex-shrink-0">
                {% if user.profile_picture %}
                    <img src="{{ user.profile_picture.url }}" alt="{{ user.get_full_name }}" class="w-full h-full object-cover">
                {% else %}
                    <i class="fas fa-user text-lg sm:text-2xl text-gray-600"></i>
                {% endif %}
            </div>
            <div class="min-w-0 flex-1">
                <h2 class="text-lg sm:text-xl font-semibold text-gray-900 truncate">{{ user.first_name }} {{ user.last_name }}</h2>
                <p class="text-sm sm:text-base text-gray-600 truncate">{{ user.sector.name }}</p>
            </div>
        </div>
    </div>
    
    <!-- Tabs Navigation -->
    <div class="mb-6 mx-4 sm:mx-0">
        <nav class="flex space-x-4 sm:space-x-8 border-b border-gray-200">
            <a href="#" class="border-b-2 border-primary text-primary py-2 px-1 text-sm font-medium">
                Ver/Responder
            </a>
        </nav>
    </div>
    
    <!-- Ticket Details -->
    <div class="bg-white rounded-lg shadow-sm p-4 sm:p-6 mb-6 mx-4 sm:mx-0">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6">
            <!-- Ticket Info -->
            <div class="lg:col-span-2">
                <div class="flex items-start justify-between mb-4">
                    <div>
                        <h3 class="text-lg sm:text-xl font-semibold text-gray-900 leading-tight">{{ ticket.title }}</h3>
                        <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-4 mt-2 text-xs sm:text-sm text-gray-500 space-y-1 sm:space-y-0">
                            <span class="font-medium">ID: #{{ ticket.id|stringformat:"04d" }}</span>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium w-fit
                                {% if ticket.status == 'ABERTO' %}bg-primary text-white
                                {% elif ticket.status == 'EM_ANDAMENTO' %}bg-blue-500 text-white
                                {% elif ticket.status == 'RESOLVIDO' %}bg-success text-white
                                {% elif ticket.status == 'FECHADO' %}bg-gray-500 text-white
                                {% endif %}">
                                {{ ticket.get_status_display }}
                            </span>
                            <span class="hidden sm:inline">Data da solicitação: {{ ticket.created_at|date:"d/m/Y" }}</span>
                            <span class="sm:hidden">{{ ticket.created_at|date:"d/m/Y" }}</span>
                            <span class="truncate text-xs">Última Resposta: 
                                {% if ticket.comments.last %}
                                    {{ ticket.comments.last.user.first_name|upper }} {{ ticket.comments.last.user.last_name|upper }}
                                {% else %}
                                    {{ ticket.created_by.first_name|upper }} {{ ticket.created_by.user.last_name|upper }}
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- Original Message -->
                <div class="mb-6">
                    <div class="flex items-center space-x-3 mb-3">
                        {% if ticket.created_by.profile_picture %}
                            <img src="{{ ticket.created_by.profile_picture.url }}" alt="{{ ticket.created_by.full_name }}" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full object-cover flex-shrink-0">
                        {% else %}
                            <div class="w-8 h-8 sm:w-10 sm:h-10 bg-primary rounded-full flex items-center justify-center flex-shrink-0">
                                <span class="text-white font-medium text-xs sm:text-sm">{{ ticket.created_by.first_name.0 }}{{ ticket.created_by.last_name.0 }}</span>
                            </div>
                        {% endif %}
                        <div class="min-w-0">
                            <p class="font-medium text-gray-900 text-sm sm:text-base truncate">{{ ticket.created_by.first_name }} {{ ticket.created_by.last_name }}</p>
                            <p class="text-xs sm:text-sm text-gray-500">{{ ticket.created_at|date:"d/m/Y \à\s H:i" }}</p>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-3 sm:p-4 mb-4">
                        <div class="text-gray-700 text-sm sm:text-base leading-relaxed">{{ ticket.description|linebreaks }}</div>
                    </div>
                    
                    <!-- Attachments Section -->
                    {% if ticket.attachments.exists %}
                        <div class="mb-6">
                            <h4 class="font-medium text-gray-900 mb-3 flex items-center text-sm sm:text-base">
                                <i class="fas fa-paperclip mr-2 text-gray-600"></i>
                                Arquivos Anexados ({{ ticket.attachments.count }})
                            </h4>
                            <div class="space-y-2">
                                {% for attachment in ticket.attachments.all %}
                                    <div class="flex items-center justify-between p-2 sm:p-3 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                        <div class="flex items-center space-x-2 sm:space-x-3 min-w-0 flex-1">
                                            <!-- File Icon -->
                                            <div class="flex-shrink-0">
                                                {% if attachment.is_image %}
                                                    <i class="fas fa-image text-blue-500"></i>
                                                {% elif attachment.file_extension == '.pdf' %}
                                                    <i class="fas fa-file-pdf text-red-500"></i>
                                                {% elif attachment.file_extension in '.doc,.docx' %}
                                                    <i class="fas fa-file-word text-blue-600"></i>
                                                {% elif attachment.file_extension in '.xls,.xlsx' %}
                                                    <i class="fas fa-file-excel text-green-600"></i>
                                                {% else %}
                                                    <i class="fas fa-file text-gray-500"></i>
                                                {% endif %}
                                            </div>
                                            
                                            <!-- File Info -->
                                            <div class="min-w-0 flex-1">
                                                <p class="text-xs sm:text-sm font-medium text-gray-900 truncate">{{ attachment.original_filename }}</p>
                                                <div class="flex items-center space-x-2 text-xs text-gray-500 flex-wrap">
                                                    <span>{{ attachment.file_size_formatted }}</span>
                                                    <span class="hidden sm:inline">•</span>
                                                    <span class="hidden sm:inline">{{ attachment.uploaded_by.full_name }}</span>
                                                    <span class="hidden sm:inline">•</span>
                                                    <span>{{ attachment.uploaded_at|date:"d/m/Y H:i" }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Download Button -->
                                        <div class="flex-shrink-0 ml-2">
                                            <a href="{{ attachment.file.url }}" 
                                               target="_blank" 
                                               class="inline-flex items-center px-2 sm:px-3 py-1 text-xs sm:text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors">
                                                <i class="fas fa-download mr-1"></i>
                                                <span class="hidden sm:inline">Baixar</span>
                                            </a>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                    
                    <!-- Upload New Files Section -->
                    {% if can_upload and ticket.status != 'FECHADO' %}
                        <div class="mb-6">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 sm:p-4">
                                <h4 class="font-medium text-blue-900 mb-3 flex items-center text-sm sm:text-base">
                                    <i class="fas fa-plus mr-2"></i>
                                    Adicionar Arquivos
                                </h4>
                                <form method="post" enctype="multipart/form-data" class="space-y-3">
                                    {% csrf_token %}
                                    <input type="hidden" name="upload_files" value="1">
                                    
                                    <div>
                                        <label for="new_attachments" class="block text-sm font-medium text-blue-900 mb-2">
                                            Selecionar arquivos:
                                        </label>
                                        <input 
                                            type="file" 
                                            name="new_attachments" 
                                            id="new_attachments"
                                            multiple
                                            accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,.jpg,.jpeg,.png,.gif,.zip,.rar"
                                            class="w-full px-3 py-2 border border-blue-300 rounded-md bg-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent file:mr-4 file:py-1 file:px-2 file:rounded file:border-0 file:text-sm file:bg-blue-500 file:text-white hover:file:bg-blue-600"
                                            onchange="updateFileInfo(this)"
                                        >
                                        <p class="text-xs text-blue-600 mt-1">
                                            Tipos aceitos: PDF, DOC, DOCX, XLS, XLSX, TXT, JPG, PNG, GIF, ZIP, RAR (máx. 50MB por arquivo)
                                        </p>
                                    </div>
                                    
                                    <!-- File Preview -->
                                    <div id="filePreview" class="hidden">
                                        <div class="bg-white border border-blue-200 rounded p-3">
                                            <h5 class="text-sm font-medium text-blue-900 mb-2">Arquivos selecionados:</h5>
                                            <div id="fileList" class="space-y-1"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="flex justify-end">
                                        <button 
                                            type="submit" 
                                            id="uploadBtn"
                                            disabled
                                            class="px-4 py-2 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"
                                        >
                                            <i class="fas fa-upload mr-1"></i>Adicionar Arquivos
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    {% endif %}
                    
                    {% if ticket.status == 'RESOLVIDO' %}
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                            <div class="flex items-start">
                                <i class="fas fa-check-circle text-green-500 mt-1 mr-3"></i>
                                <div>
                                    <p class="font-medium text-green-900">Aprovado por: {{ ticket.approved_by.first_name }} {{ ticket.approved_by.last_name }}</p>
                                    <p class="text-sm text-green-700 mt-1">Hoje 25/08 às 08:55</p>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Comments Section -->
                <div class="space-y-4">
                    {% for comment in ticket.comments.all %}
                        <div class="flex items-start space-x-3">
                            {% if comment.user.profile_picture %}
                                <img src="{{ comment.user.profile_picture.url }}" alt="{{ comment.user.full_name }}" class="w-10 h-10 rounded-full object-cover flex-shrink-0">
                            {% elif comment.user.avatar %}
                                <img src="{{ comment.user.avatar.url }}" alt="{{ comment.user.full_name }}" class="w-10 h-10 rounded-full object-cover flex-shrink-0">
                            {% else %}
                                <div class="w-10 h-10 bg-gradient-to-br from-primary to-orange-500 rounded-full flex items-center justify-center flex-shrink-0">
                                    <span class="text-white font-medium text-sm">{{ comment.user.first_name.0 }}{{ comment.user.last_name.0 }}</span>
                                </div>
                            {% endif %}
                            <div class="flex-1">
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center space-x-2">
                                            <div class="flex items-center space-x-2">
                                                {% if comment.comment_type == 'ASSUMPTION' %}
                                                    <i class="fas fa-user-check text-blue-600 text-sm"></i>
                                                {% elif comment.comment_type == 'ASSIGNMENT' %}
                                                    <i class="fas fa-user-plus text-purple-600 text-sm"></i>
                                                {% elif comment.comment_type == 'STATUS_CHANGE' %}
                                                    <i class="fas fa-exchange-alt text-orange-600 text-sm"></i>
                                                {% elif comment.comment_type == 'FOLLOW_UP' %}
                                                    <i class="fas fa-eye text-green-600 text-sm"></i>
                                                {% else %}
                                                    <i class="fas fa-comment text-gray-600 text-sm"></i>
                                                {% endif %}
                                                <p class="font-medium text-gray-900">{{ comment.user.first_name }} {{ comment.user.last_name }}</p>
                                            </div>
                                            <span class="text-xs px-2 py-1 rounded-full
                                                {% if comment.comment_type == 'ASSUMPTION' %}bg-blue-100 text-blue-800
                                                {% elif comment.comment_type == 'ASSIGNMENT' %}bg-purple-100 text-purple-800
                                                {% elif comment.comment_type == 'STATUS_CHANGE' %}bg-orange-100 text-orange-800
                                                {% elif comment.comment_type == 'FOLLOW_UP' %}bg-green-100 text-green-800
                                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                                {{ comment.get_comment_type_display }}
                                            </span>
                                        </div>
                                        <p class="text-sm text-gray-500">{{ comment.created_at|date:"d/m/Y H:i" }}</p>
                                    </div>
                                    <p class="text-gray-700">{{ comment.comment }}</p>
                                    {% if comment.assigned_to %}
                                        <div class="mt-2 pt-2 border-t border-gray-200">
                                            <p class="text-sm text-purple-700">
                                                <i class="fas fa-user-plus mr-1"></i>
                                                Atribuído para: <strong>{{ comment.assigned_to.full_name }}</strong>
                                            </p>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Right Sidebar -->
            <div class="space-y-6">
                {% if can_assume %}
                    <!-- Assume Ticket Section -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h4 class="font-medium text-blue-900 mb-3">Assumir Chamado</h4>
                        <p class="text-sm text-blue-700 mb-4">Você pode assumir este chamado para ser o responsável pela resolução.</p>
                        <form method="post" action="{% url 'assume_ticket' ticket.id %}">
                            {% csrf_token %}
                            <div class="mb-3">
                                <textarea 
                                    name="comment" 
                                    class="w-full px-3 py-2 border border-blue-300 rounded text-sm" 
                                    rows="2" 
                                    placeholder="Comentário opcional..."
                                ></textarea>
                            </div>
                            <button type="submit" class="w-full bg-blue-500 text-white py-2 px-3 rounded text-sm hover:bg-blue-600 transition-colors">
                                <i class="fas fa-user-check mr-2"></i>Assumir Chamado
                            </button>
                        </form>
                    </div>
                {% endif %}
                
                {% if ticket.status == 'RESOLVIDO' and ticket.created_by == user %}
                    <!-- User Approval Section -->
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <h4 class="font-medium text-yellow-900 mb-3">Aprovação Pendente</h4>
                        <p class="text-sm text-yellow-700 mb-4">O chamado foi marcado como resolvido. Você precisa aprovar a solução para fechar o chamado.</p>
                        
                        {% if ticket.solution %}
                        <div class="bg-white rounded p-3 mb-4">
                            <h5 class="font-medium text-gray-900 mb-2">Solução apresentada:</h5>
                            <p class="text-sm text-gray-700">{{ ticket.solution }}</p>
                        </div>
                        {% endif %}
                        
                        <div class="flex space-x-2">
                            <form method="post" action="{% url 'update_ticket_status' ticket.id %}" class="flex-1">
                                {% csrf_token %}
                                <input type="hidden" name="status" value="FECHADO">
                                <input type="hidden" name="observation" value="Aprovado pelo usuário">
                                <button type="submit" class="w-full bg-success text-white px-3 py-2 rounded text-sm hover:bg-green-600 transition-colors">
                                    <i class="fas fa-check mr-1"></i>Aprovar Solução
                                </button>
                            </form>
                            <button onclick="showRejectModal()" class="flex-1 bg-danger text-white px-3 py-2 rounded text-sm hover:bg-red-600 transition-colors">
                                <i class="fas fa-times mr-1"></i>Reprovar
                            </button>
                        </div>
                    </div>
                {% endif %}
                
                <!-- Ticket Info -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="font-medium text-gray-900 mb-3">Informações do Chamado</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Setor:</span>
                            <span class="text-gray-900">{{ ticket.sector.name }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Categoria:</span>
                            <span class="text-gray-900">{{ ticket.category.name }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Prioridade:</span>
                            <span class="text-gray-900 
                                {% if ticket.priority == 'CRITICA' %}text-red-600
                                {% elif ticket.priority == 'ALTA' %}text-orange-600
                                {% elif ticket.priority == 'MEDIA' %}text-yellow-600
                                {% else %}text-green-600{% endif %}">
                                {{ ticket.get_priority_display }}
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Criado por:</span>
                            <span class="text-gray-900">{{ ticket.created_by.full_name }}</span>
                        </div>
                        {% if ticket.assigned_to %}
                        <div class="flex justify-between">
                            <span class="text-gray-600">Responsável:</span>
                            <span class="text-gray-900">{{ ticket.assigned_to.full_name }}</span>
                        </div>
                        {% endif %}
                        {% if additional_assignments %}
                        <div class="pt-2 border-t">
                            <span class="text-gray-600 block mb-1">Auxiliares:</span>
                            {% for assignment in additional_assignments %}
                                <div class="text-sm text-gray-900">
                                    {{ assignment.user.full_name }}
                                    <span class="text-xs text-gray-500">(por {{ assignment.assigned_by.full_name }})</span>
                                </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        {% if ticket.due_date %}
                        <div class="flex justify-between">
                            <span class="text-gray-600">Prazo:</span>
                            <span class="text-gray-900 {% if ticket.is_overdue %}text-red-600{% endif %}">
                                {{ ticket.due_date|date:"d/m/Y H:i" }}
                                {% if ticket.is_overdue %}
                                    <i class="fas fa-exclamation-triangle text-red-500 ml-1"></i>
                                {% endif %}
                            </span>
                        </div>
                        {% endif %}
                        {% if ticket.solution and ticket.status in 'RESOLVIDO,FECHADO' %}
                        <div class="pt-2 border-t">
                            <span class="text-gray-600 block mb-1">Solução:</span>
                            <div class="bg-green-50 border border-green-200 rounded p-2">
                                <span class="text-gray-900 text-sm">{{ ticket.solution }}</span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Action Panel -->
                {% if user.can_view_sector_tickets or ticket.assigned_to == user or user in assigned_users %}
                    {% if ticket.status != 'FECHADO' %}
                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                            <h4 class="font-medium text-gray-900 mb-3">Ações Rápidas</h4>
                            <div class="space-y-2">
                {% if ticket.status == 'EM_ANDAMENTO' and ticket.assigned_to == user or user.can_view_sector_tickets or user.can_view_all_tickets %}
                    <button onclick="showResolveModal()" class="w-full bg-success text-white py-2 px-3 rounded text-sm hover:bg-green-600 transition-colors">
                        <i class="fas fa-check mr-2"></i>Marcar como Resolvido
                    </button>
                {% endif %}
                
                <!-- Botão de Reabrir para quem está respondendo -->
                {% if ticket.status in 'RESOLVIDO,FECHADO,AGUARDANDO_APROVACAO' and ticket.assigned_to == user or user.can_view_sector_tickets or user.can_view_all_tickets %}
                    <button onclick="showReopenModal()" class="w-full bg-blue-500 text-white py-2 px-3 rounded text-sm hover:bg-blue-600 transition-colors">
                        <i class="fas fa-redo mr-2"></i>Reabrir Chamado
                    </button>
                {% endif %}
                
                {% if can_assign %}
                                    <!-- Assign User Modal Trigger -->
                                    <button onclick="toggleAssignModal()" class="w-full bg-purple-500 text-white py-2 px-3 rounded text-sm hover:bg-purple-600 transition-colors">
                                        <i class="fas fa-user-plus mr-2"></i>Atribuir Usuário
                                    </button>
                                {% endif %}
                                
                                <!-- Update Status Button -->
                                {% if ticket.status != 'FECHADO' and ticket.status != 'RESOLVIDO' %}
                                    <button onclick="showStatusModal()" class="w-full bg-orange-500 text-white py-2 px-3 rounded text-sm hover:bg-orange-600 transition-colors">
                                        <i class="fas fa-edit mr-2"></i>Atualizar Status
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                {% endif %}
            </div>
        </div>
        
        <!-- Reply Section -->
        {% if ticket.status != 'FECHADO' and ticket.status != 'AGUARDANDO_APROVACAO' and ticket.status != 'RESOLVIDO' %}
            <div class="mt-8 pt-6 border-t border-gray-200">
                <h4 class="font-medium text-gray-900 mb-4">Responder</h4>
                <form method="post" action="{% url 'add_comment' ticket.id %}" class="space-y-4">
                    {% csrf_token %}
                    
                    <!-- Comment Type Selection -->
                    <div>
                        <label for="comment_type" class="block text-sm font-medium text-gray-700 mb-2">Tipo de Resposta:</label>
                        <select name="comment_type" id="comment_type" onchange="toggleAssignField()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="COMMENT">Comentário</option>
                            <option value="FOLLOW_UP">Acompanhamento</option>
                            {% if can_assign %}
                                <option value="ASSIGNMENT">Atribuir Usuário</option>
                            {% endif %}
                        </select>
                    </div>
                    
                    <!-- User Assignment Field (hidden by default) -->
                    <div id="assignUserField" class="hidden">
                        <label for="assigned_to" class="block text-sm font-medium text-gray-700 mb-2">Atribuir para:</label>
                        <select name="assigned_to" id="assigned_to" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="">Selecione um usuário...</option>
                            {% if sector_users %}
                                {% for sector_user in sector_users %}
                                    <option value="{{ sector_user.id }}">{{ sector_user.full_name }} ({{ sector_user.sector.name }}) - {{ sector_user.email }}</option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    
                    <div>
                        <label for="comment" class="block text-sm font-medium text-gray-700 mb-2">Mensagem:</label>
                        <textarea 
                            name="comment" 
                            id="comment" 
                            rows="4"
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                            placeholder="Digite sua resposta..."
                        ></textarea>
                    </div>
                    
                    <div class="flex justify-end">
                        <button 
                            type="submit" 
                            class="bg-secondary text-white px-6 py-2 rounded-lg hover:bg-gray-800 transition-colors"
                        >
                            <i class="fas fa-paper-plane mr-2"></i>Enviar Resposta
                        </button>
                    </div>
                </form>
            </div>
        {% endif %}
    </div>
    
    <!-- Status History -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <h3 class="font-medium text-gray-900 mb-4">Histórico do Chamado</h3>
        <div class="space-y-3">
            {% for log in logs %}
            <div class="flex items-start space-x-3 py-2 border-b border-gray-100 last:border-b-0">
                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-history text-blue-600 text-xs"></i>
                </div>
                <div class="flex-1">
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="text-sm font-medium text-gray-900">{{ log.user.full_name }}</span>
                            <span class="text-sm text-gray-600">
                                {% if log.old_status %}
                                    alterou status de "{{ log.old_status }}" para "{{ log.new_status }}"
                                {% else %}
                                    definiu status como "{{ log.new_status }}"
                                {% endif %}
                            </span>
                        </div>
                        <span class="text-xs text-gray-500">{{ log.created_at|date:"d/m/Y H:i" }}</span>
                    </div>
                    {% if log.observation %}
                    <p class="text-sm text-gray-600 mt-1">{{ log.observation }}</p>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <p class="text-gray-500 text-sm">Nenhum histórico disponível.</p>
            {% endfor %}
        </div>
    </div>
    
    {% if ticket.status == 'FECHADO' %}
        <div class="bg-white rounded-lg shadow-sm p-6">
            <h3 class="font-medium text-gray-900 mb-4">
                Chamado fechado
                {% if ticket.approved_by %}
                    por: {{ ticket.approved_by.full_name }} - {{ ticket.closed_at|date:"d/m/Y H:i" }}
                {% endif %}
            </h3>
        </div>
    {% endif %}
</div>

<!-- Modal para Marcar como Resolvido -->
<div id="resolveModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Marcar como Resolvido</h3>
            <form method="post" action="{% url 'update_ticket_status' ticket.id %}">
                {% csrf_token %}
                <input type="hidden" name="status" value="RESOLVIDO">
                
                <div class="mb-4">
                    <label for="solution" class="block text-sm font-medium text-gray-700 mb-2">
                        Solução aplicada: <span class="text-gray-400 text-xs">(opcional)</span>
                    </label>
                    <textarea 
                        name="solution" 
                        id="solution" 
                        rows="4" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                        placeholder="Descreva a solução aplicada para resolver o chamado (opcional)..."
                    ></textarea>
                </div>
                
                <div class="mb-4">
                    <label for="observation" class="block text-sm font-medium text-gray-700 mb-2">Observações adicionais:</label>
                    <textarea 
                        name="observation" 
                        id="observation" 
                        rows="2"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                        placeholder="Observações opcionais..."
                    ></textarea>
                </div>
                
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="hideResolveModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-success text-white rounded hover:bg-green-600 transition-colors">
                        <i class="fas fa-check mr-1"></i>Resolver Chamado
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Reabrir Chamado -->
<div id="reopenModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Reabrir Chamado</h3>
            <form method="post" action="{% url 'update_ticket_status' ticket.id %}">
                {% csrf_token %}
                <input type="hidden" name="status" value="EM_ANDAMENTO">
                
                <div class="mb-4">
                    <label for="reopen_observation" class="block text-sm font-medium text-gray-700 mb-2">
                        Motivo da reabertura: <span class="text-red-500">*</span>
                    </label>
                    <textarea 
                        name="observation" 
                        id="reopen_observation" 
                        rows="4" 
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                        placeholder="Por que o chamado está sendo reaberto?..."
                    ></textarea>
                    <p class="mt-1 text-xs text-gray-500">
                        Explique o motivo da reabertura para que todos fiquem cientes.
                    </p>
                </div>
                
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="hideReopenModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                        <i class="fas fa-redo mr-1"></i>Reabrir Chamado
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Reprovação -->
<div id="rejectModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Reprovar Solução</h3>
            <form method="post" action="{% url 'update_ticket_status' ticket.id %}">
                {% csrf_token %}
                <input type="hidden" name="status" value="EM_ANDAMENTO">
                
                <div class="mb-4">
                    <label for="reject_reason" class="block text-sm font-medium text-gray-700 mb-2">
                        Motivo da reprovação: <span class="text-red-500">*</span>
                    </label>
                    <textarea 
                        name="observation" 
                        id="reject_reason" 
                        rows="4" 
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                        placeholder="Explique por que a solução não foi satisfatória..."
                    ></textarea>
                </div>
                
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="hideRejectModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-danger text-white rounded hover:bg-red-600 transition-colors">
                        <i class="fas fa-times mr-1"></i>Reprovar Solução
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Atualizar Status -->
<div id="statusModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Atualizar Status</h3>
            <form method="post" action="{% url 'update_ticket_status' ticket.id %}">
                {% csrf_token %}
                
                <div class="mb-4">
                    <label for="new_status" class="block text-sm font-medium text-gray-700 mb-2">
                        Novo Status: <span class="text-red-500">*</span>
                    </label>
                    <select name="status" id="new_status" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="">Selecione um status...</option>
                        {% if ticket.status == 'ABERTO' %}
                            <option value="EM_ANDAMENTO">Em Andamento</option>
                        {% endif %}
                        {% if ticket.status == 'EM_ANDAMENTO' %}
                            <option value="ABERTO">Aberto</option>
                        {% endif %}
                        <option value="FECHADO">Fechar (Admin)</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label for="status_observation" class="block text-sm font-medium text-gray-700 mb-2">Observações:</label>
                    <textarea 
                        name="observation" 
                        id="status_observation" 
                        rows="3"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                        placeholder="Observações sobre a mudança de status..."
                    ></textarea>
                </div>
                
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="hideStatusModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600 transition-colors">
                        <i class="fas fa-save mr-1"></i>Atualizar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Atribuir Usuário -->
<div id="assignModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Atribuir Usuário</h3>
            <form method="post" action="{% url 'add_comment' ticket.id %}">
                {% csrf_token %}
                <input type="hidden" name="comment_type" value="ASSIGNMENT">
                
                <div class="mb-4">
                    <label for="assign_to_user" class="block text-sm font-medium text-gray-700 mb-2">
                        Atribuir para: <span class="text-red-500">*</span>
                    </label>
                    <select name="assigned_to" id="assign_to_user" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="">Selecione um usuário...</option>
                        <!-- Debug: Total de usuários: {{ sector_users|length }} -->
                        {% if sector_users %}
                            {% for sector_user in sector_users %}
                                <option value="{{ sector_user.id }}">{{ sector_user.full_name }} ({{ sector_user.sector.name }}) - {{ sector_user.email }}</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>
                
                <div class="mb-4">
                    <label for="assign_comment" class="block text-sm font-medium text-gray-700 mb-2">
                        Mensagem: <span class="text-red-500">*</span>
                    </label>
                    <textarea 
                        name="comment" 
                        id="assign_comment" 
                        rows="3"
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                        placeholder="Mensagem de atribuição..."
                    ></textarea>
                </div>
                
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="hideAssignModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 transition-colors">
                        <i class="fas fa-user-plus mr-1"></i>Atribuir
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function toggleAssignField() {
    const commentType = document.getElementById('comment_type').value;
    const assignField = document.getElementById('assignUserField');
    
    if (commentType === 'ASSIGNMENT') {
        assignField.classList.remove('hidden');
        document.getElementById('assigned_to').required = true;
    } else {
        assignField.classList.add('hidden');
        document.getElementById('assigned_to').required = false;
    }
}

function showResolveModal() {
    document.getElementById('resolveModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function hideResolveModal() {
    document.getElementById('resolveModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

function showReopenModal() {
    document.getElementById('reopenModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function hideReopenModal() {
    document.getElementById('reopenModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

function showRejectModal() {
    document.getElementById('rejectModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function hideRejectModal() {
    document.getElementById('rejectModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

function showStatusModal() {
    console.log('Tentando abrir modal de status');
    const modal = document.getElementById('statusModal');
    if (modal) {
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        console.log('Modal de status aberto');
    } else {
        console.error('Modal statusModal não encontrado');
    }
}

function hideStatusModal() {
    document.getElementById('statusModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

function showAssignModal() {
    document.getElementById('assignModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function hideAssignModal() {
    document.getElementById('assignModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

function toggleAssignModal() {
    const modal = document.getElementById('assignModal');
    if (modal.classList.contains('hidden')) {
        showAssignModal();
    } else {
        hideAssignModal();
    }
}

// Close modals when clicking outside
window.onclick = function(event) {
    const resolveModal = document.getElementById('resolveModal');
    const rejectModal = document.getElementById('rejectModal');
    const statusModal = document.getElementById('statusModal');
    const assignModal = document.getElementById('assignModal');
    
    if (event.target === resolveModal) {
        hideResolveModal();
    }
    if (event.target === rejectModal) {
        hideRejectModal();
    }
    if (event.target === statusModal) {
        hideStatusModal();
    }
    if (event.target === assignModal) {
        hideAssignModal();
    }
}

// File upload functionality
function updateFileInfo(input) {
    const filePreview = document.getElementById('filePreview');
    const fileList = document.getElementById('fileList');
    const uploadBtn = document.getElementById('uploadBtn');
    
    if (input.files && input.files.length > 0) {
        fileList.innerHTML = '';
        
        for (let i = 0; i < input.files.length; i++) {
            const file = input.files[i];
            const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
            
            const fileItem = document.createElement('div');
            fileItem.className = 'flex items-center justify-between text-xs text-blue-800';
            
            let fileIcon = 'fas fa-file';
            if (file.type.includes('image/')) fileIcon = 'fas fa-image';
            else if (file.type.includes('pdf')) fileIcon = 'fas fa-file-pdf';
            else if (file.type.includes('word') || file.name.endsWith('.doc') || file.name.endsWith('.docx')) fileIcon = 'fas fa-file-word';
            else if (file.type.includes('excel') || file.name.endsWith('.xls') || file.name.endsWith('.xlsx')) fileIcon = 'fas fa-file-excel';
            
            fileItem.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="${fileIcon}"></i>
                    <span>${file.name}</span>
                </div>
                <span class="${fileSizeMB > 50 ? 'text-red-600 font-medium' : ''}">${fileSizeMB} MB</span>
            `;
            
            if (fileSizeMB > 50) {
                const errorSpan = document.createElement('span');
                errorSpan.className = 'text-red-600 text-xs font-medium';
                errorSpan.textContent = ' (Muito grande!)';
                fileItem.appendChild(errorSpan);
            }
            
            fileList.appendChild(fileItem);
        }
        
        filePreview.classList.remove('hidden');
        uploadBtn.disabled = false;
    } else {
        filePreview.classList.add('hidden');
        uploadBtn.disabled = true;
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    toggleAssignField();
});
</script>
{% endblock %}
