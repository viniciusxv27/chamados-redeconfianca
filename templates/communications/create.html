{% extends 'base.html' %}

{% block title %}Criar Comunicado - Rede de Confiança{% endblock %}

{% block extra_css %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
<style>
    .primary { background-color: #f97316; }
    .primary:hover { background-color: #ea580c; }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-6">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
            <div class="px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fas fa-plus-circle text-primary text-2xl mr-3"></i>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900">Criar Novo Comunicado</h1>
                            <p class="text-sm text-gray-600">Compartilhe informações importantes com sua equipe</p>
                        </div>
                    </div>
                    <a href="{% url 'communications:communications_list' %}" 
                       class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Voltar
                    </a>
                </div>
            </div>
        </div>

        <!-- Formulário -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="px-6 py-6">
                <form method="post" enctype="multipart/form-data" class="space-y-6">
                    {% csrf_token %}
                    
                    <!-- Título -->
                    <div>
                        <label for="title" class="block text-sm font-semibold text-gray-900 mb-2">
                            Título <span class="text-red-500">*</span>
                        </label>
                        <input type="text" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-colors" 
                               id="title" 
                               name="title" 
                               placeholder="Digite o título do comunicado"
                               required>
                    </div>

                    <!-- Upload de Foto com Editor de Crop Melhorado -->
                    <div>
                        <label for="photo" class="block text-sm font-semibold text-gray-900 mb-2">
                            <i class="fas fa-camera text-primary mr-1"></i>
                            Foto do Comunicado
                        </label>
                        
                        <!-- Upload nova foto -->
                        <div class="flex items-center justify-center w-full">
                            <label for="photo" class="flex flex-col items-center justify-center w-full h-64 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100" id="upload-area-label">
                                <div class="flex flex-col items-center justify-center pt-5 pb-6" id="upload-area">
                                    <i class="fas fa-cloud-upload-alt text-gray-400 text-4xl mb-4"></i>
                                    <p class="mb-2 text-sm text-gray-500">
                                        <span class="font-semibold">Clique para fazer upload</span> ou arraste a imagem
                                    </p>
                                    <p class="text-xs text-gray-500">PNG, JPG ou JPEG (MAX. 5MB)</p>
                                </div>
                                <input id="photo" name="photo" type="file" class="hidden" accept="image/*" onchange="previewImage(this)">
                            </label>
                        </div>
                        
                        <!-- Preview da nova imagem com crop -->
                        <div id="photo-preview" class="hidden mt-4">
                            <p class="text-sm text-gray-600 mb-2">Ajustar posição da imagem:</p>
                            <div class="bg-gray-100 rounded-lg p-4">
                                <div id="crop-container" class="relative bg-white rounded overflow-hidden" style="max-width: 100%; height: 400px;">
                                    <img id="preview-img" src="" alt="Preview" class="max-w-full max-h-full" style="display: block;">
                                </div>
                                <div class="mt-4 flex flex-wrap items-center justify-between gap-3">
                                    <div class="flex flex-wrap items-center gap-3">
                                        <button type="button" onclick="cropImage()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors text-sm">
                                            <i class="fas fa-crop mr-2"></i>
                                            Aplicar Corte
                                        </button>
                                        <button type="button" onclick="resetCrop()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors text-sm">
                                            <i class="fas fa-undo mr-2"></i>
                                            Resetar
                                        </button>
                                    </div>
                                    <button type="button" onclick="removePhoto()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors text-sm">
                                        <i class="fas fa-times mr-2"></i>
                                        Remover Foto
                                    </button>
                                </div>
                            </div>
                            <!-- Canvas oculto para processar o crop -->
                            <canvas id="crop-canvas" style="display: none;"></canvas>
                            <!-- Input hidden para enviar a imagem processada -->
                            <input type="hidden" id="cropped-image-data" name="cropped_image_data">
                        </div>
                        <p class="text-sm text-gray-500 mt-1">A foto será exibida como destaque no feed de comunicados. Use a ferramenta de corte para ajustar a posição.</p>
                    </div>

                    <!-- Mensagem -->
                    <div>
                        <label for="message" class="block text-sm font-semibold text-gray-900 mb-2">
                            Mensagem <span class="text-red-500">*</span>
                        </label>
                        <textarea class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-colors" 
                                  id="message" 
                                  name="message" 
                                  rows="8" 
                                  placeholder="Digite a mensagem do comunicado"
                                  required></textarea>
                        <p class="text-sm text-gray-500 mt-1">Use uma linguagem clara e objetiva para melhor compreensão.</p>
                    </div>

                    <!-- Período de Ativação -->
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-calendar-alt text-blue-600 mr-2"></i>
                            Período de Ativação
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Ativo a partir de -->
                            <div>
                                <label for="active_from" class="block text-sm font-semibold text-gray-900 mb-2">
                                    Ativo a partir de
                                </label>
                                <input type="datetime-local" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-colors" 
                                       id="active_from" 
                                       name="active_from">
                                <p class="text-sm text-gray-500 mt-1">Deixe em branco para ativar imediatamente</p>
                            </div>

                            <!-- Ativo até -->
                            <div>
                                <label for="active_until" class="block text-sm font-semibold text-gray-900 mb-2">
                                    Ativo até
                                </label>
                                <input type="datetime-local" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-colors" 
                                       id="active_until" 
                                       name="active_until">
                                <p class="text-sm text-gray-500 mt-1">Deixe em branco para não ter data limite</p>
                            </div>
                        </div>
                    </div>

                    <!-- Opções de Envio -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Opções de Envio</h3>
                        
                        <div class="space-y-4">
                            <!-- Fixar na Dashboard -->
                            <div class="flex items-start">
                                <div class="flex items-center h-5">
                                    <input class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary" 
                                           type="checkbox" 
                                           id="is_pinned" 
                                           name="is_pinned">
                                </div>
                                <div class="ml-3">
                                    <label for="is_pinned" class="text-sm font-medium text-gray-900">
                                        Fixar na Dashboard
                                    </label>
                                    <p class="text-sm text-gray-500">O comunicado será destacado na página inicial</p>
                                </div>
                            </div>

                            <!-- Exibir como Pop-up -->
                            <div class="flex items-start">
                                <div class="flex items-center h-5">
                                    <input class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary" 
                                           type="checkbox" 
                                           id="is_popup" 
                                           name="is_popup">
                                </div>
                                <div class="ml-3">
                                    <label for="is_popup" class="text-sm font-medium text-gray-900">
                                        Exibir como Pop-up
                                    </label>
                                    <p class="text-sm text-gray-500">Será exibido automaticamente quando usuários acessarem o sistema</p>
                                </div>
                            </div>

                            <!-- Grupo Remetente - Mostrar apenas grupos do usuário -->
                            <div>
                                <label for="sender_group" class="block text-sm font-semibold text-gray-900 mb-2">
                                    Representar Grupo
                                </label>
                                <select name="sender_group" id="sender_group" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-colors">
                                    <option value="">Enviar como {{ user.get_full_name }}</option>
                                    {% for group in user_groups %}
                                        <option value="{{ group.0 }}">{{ group.1 }}</option>
                                    {% endfor %}
                                    <!-- Grupos personalizados em que o usuário é membro -->
                                    {% for group in user.communication_groups.all %}
                                        <option value="custom_{{ group.id }}">{{ group.name }} (Grupo Personalizado)</option>
                                    {% endfor %}
                                </select>
                                <p class="text-sm text-gray-500 mt-1">Selecione o grupo que você representa ao enviar este comunicado</p>
                            </div>

                            <!-- Destinatários - Grupos + Usuários -->
                            <div>
                                <label for="custom_group" class="block text-sm font-semibold text-gray-900 mb-2">
                                    Destinatários Específicos
                                </label>
                                <select name="custom_group" id="custom_group" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-colors" onchange="toggleGroupRecipients()">
                                    <option value="">Selecionar destinatários individuais</option>
                                    <optgroup label="Grupos de Comunicação">
                                        {% for group in communication_groups %}
                                            <option value="{{ group.id }}">{{ group.name }} ({{ group.members.count }} membros)</option>
                                        {% endfor %}
                                    </optgroup>
                                </select>
                                <p class="text-sm text-gray-500 mt-1">Escolha um grupo para enviar automaticamente para todos os membros, ou selecione usuários individualmente abaixo</p>
                            </div>

                            <!-- Enviar para todos -->
                            <div class="flex items-start">
                                <div class="flex items-center h-5">
                                    <input class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary" 
                                           type="checkbox" 
                                           id="send_to_all" 
                                           name="send_to_all" 
                                           onchange="toggleRecipients()">
                                </div>
                                <div class="ml-3">
                                    <label for="send_to_all" class="text-sm font-medium text-gray-900">
                                        Enviar para todos os usuários
                                    </label>
                                    <p class="text-sm text-gray-500">O comunicado será enviado para todos os usuários ativos do sistema</p>
                                </div>
                            </div>

                            <!-- Destinatários específicos -->
                            <div id="recipients-section">
                                <label for="recipients" class="block text-sm font-semibold text-gray-900 mb-2">
                                    Destinatários Específicos
                                </label>
                                
                                <!-- Grupos de Comunicação -->
                                {% if communication_groups %}
                                <div class="mb-4">
                                    <h4 class="text-sm font-medium text-gray-700 mb-2">Grupos de Comunicação</h4>
                                    <div class="border border-gray-200 rounded-lg p-3 bg-gray-50 max-h-48 overflow-y-auto">
                                        {% for group in communication_groups %}
                                        <div class="flex items-center py-2 px-2 hover:bg-white rounded">
                                            <input type="checkbox" 
                                                   name="communication_groups" 
                                                   value="{{ group.id }}" 
                                                   id="group_{{ group.id }}"
                                                   class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary"
                                                   onchange="toggleGroupRecipients()">
                                            <label for="group_{{ group.id }}" class="ml-3 flex-1 cursor-pointer">
                                                <div class="flex items-center">
                                                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center mr-3">
                                                        <i class="fas fa-users text-white text-xs"></i>
                                                    </div>
                                                    <div>
                                                        <div class="text-sm font-medium text-gray-900">{{ group.name }}</div>
                                                        <div class="text-xs text-gray-500">{{ group.description|default:"Sem descrição" }} • {{ group.members.count }} membro{{ group.members.count|pluralize }}</div>
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <p class="text-sm text-gray-500 mt-1">Selecione um ou mais grupos para enviar o comunicado para todos os seus membros</p>
                                </div>
                                {% endif %}
                                
                                <!-- Usuários Individuais -->
                                <div id="individual-users-section">
                                    <h4 class="text-sm font-medium text-gray-700 mb-2">Usuários Individuais</h4>
                                    <div class="border border-gray-300 rounded-lg p-3 bg-white max-h-64 overflow-y-auto">
                                        {% for user_option in users %}
                                        <div class="flex items-center py-2 px-2 hover:bg-gray-50 rounded">
                                            <input type="checkbox" 
                                                   name="recipients" 
                                                   value="{{ user_option.id }}" 
                                                   id="user_{{ user_option.id }}"
                                                   class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary">
                                            <label for="user_{{ user_option.id }}" class="ml-3 flex-1 cursor-pointer">
                                                <div class="flex items-center">
                                                    {% if user_option.profile_picture %}
                                                        <img src="{{ user_option.profile_picture.url }}" alt="{{ user_option.get_full_name }}" class="w-8 h-8 rounded-full mr-3">
                                                    {% else %}
                                                        <div class="w-8 h-8 bg-gray-500 rounded-full flex items-center justify-center mr-3">
                                                            <i class="fas fa-user text-white text-xs"></i>
                                                        </div>
                                                    {% endif %}
                                                    <div>
                                                        <div class="text-sm font-medium text-gray-900">{{ user_option.get_full_name }}</div>
                                                        <div class="text-xs text-gray-500">{{ user_option.email }} • {{ user_option.sector.name|default:"Sem setor" }}</div>
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <p class="text-sm text-gray-500 mt-1">Selecione os usuários específicos que devem receber este comunicado</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Botões -->
                    <div class="flex items-center justify-end space-x-4 pt-6 border-t border-gray-200">
                        <a href="{% url 'communications:communications_list' %}" 
                           class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            Cancelar
                        </a>
                        <button type="submit" 
                                class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-orange-600 transition-colors flex items-center">
                            <i class="fas fa-paper-plane mr-2"></i>
                            Criar Comunicado
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
let cropper = null;
let originalImageData = null;

function toggleRecipients() {
    const sendToAll = document.getElementById('send_to_all');
    const recipientsSection = document.getElementById('recipients-section');
    const recipientCheckboxes = document.querySelectorAll('input[name="recipients"]');
    const groupCheckboxes = document.querySelectorAll('input[name="communication_groups"]');
    
    if (sendToAll.checked) {
        recipientsSection.style.display = 'none';
        recipientCheckboxes.forEach(checkbox => {
            checkbox.required = false;
            checkbox.checked = false;
        });
        groupCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
    } else {
        recipientsSection.style.display = 'block';
    }
}

function toggleGroupRecipients() {
    const groupCheckboxes = document.querySelectorAll('input[name="communication_groups"]');
    const sendToAll = document.getElementById('send_to_all');
    const recipientCheckboxes = document.querySelectorAll('input[name="recipients"]');
    const individualSection = document.getElementById('individual-users-section');
    
    // Verificar se algum grupo foi selecionado
    const selectedGroups = Array.from(groupCheckboxes).filter(checkbox => checkbox.checked);
    
    if (selectedGroups.length > 0) {
        // Se grupos selecionados, desmarcar "enviar para todos" e desabilitar usuários individuais
        sendToAll.checked = false;
        recipientCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
            checkbox.disabled = true;
        });
        individualSection.style.opacity = '0.5';
        
        // Adicionar texto informativo
        const infoText = individualSection.querySelector('.group-info') || document.createElement('p');
        if (!individualSection.querySelector('.group-info')) {
            infoText.className = 'group-info text-xs text-blue-600 mt-2 font-medium';
            infoText.innerHTML = '<i class="fas fa-info-circle mr-1"></i>Usuários individuais desabilitados (grupos selecionados)';
            individualSection.appendChild(infoText);
        }
    } else {
        // Se nenhum grupo selecionado, reabilitar usuários individuais
        recipientCheckboxes.forEach(checkbox => {
            checkbox.disabled = false;
        });
        individualSection.style.opacity = '1';
        
        // Remover texto informativo
        const infoText = individualSection.querySelector('.group-info');
        if (infoText) {
            infoText.remove();
        }
    }
}

function previewImage(input) {
    const preview = document.getElementById('photo-preview');
    const previewImg = document.getElementById('preview-img');
    const popupCheckbox = document.getElementById('is_popup');
    const uploadAreaLabel = document.getElementById('upload-area-label');
    
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // Validar tamanho do arquivo (5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('Arquivo muito grande. Máximo 5MB.');
            return;
        }
        
        const reader = new FileReader();
        
        reader.onload = function(e) {
            originalImageData = e.target.result;
            previewImg.src = e.target.result;
            preview.classList.remove('hidden');
            uploadAreaLabel.classList.add('hidden');
            
            // Desabilitar pop-up se tem imagem
            popupCheckbox.disabled = true;
            popupCheckbox.checked = false;
            
            // Destruir cropper anterior se existir
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            
            // Aguardar a imagem carregar para inicializar o cropper
            previewImg.onload = function() {
                // Inicializar novo cropper
                cropper = new Cropper(previewImg, {
                    aspectRatio: 16 / 9, // Proporção para feed
                    viewMode: 1,
                    autoCropArea: 0.8,
                    responsive: true,
                    restore: false,
                    guides: true,
                    center: true,
                    highlight: false,
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                    toggleDragModeOnDblclick: false,
                    ready: function () {
                        console.log('Cropper ready');
                    }
                });
            };
        }
        
        reader.readAsDataURL(file);
    }
}

function cropImage() {
    if (!cropper) {
        alert('Nenhuma imagem para cortar');
        return;
    }
    
    const canvas = cropper.getCroppedCanvas({
        width: 800,
        height: 450,
        minWidth: 400,
        minHeight: 225,
        maxWidth: 1200,
        maxHeight: 675,
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high'
    });
    
    if (!canvas) {
        alert('Erro ao processar o corte da imagem');
        return;
    }
    
    // Converter para blob
    canvas.toBlob(function(blob) {
        if (!blob) {
            alert('Erro ao gerar imagem cortada');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function() {
            // Salvar dados da imagem cortada
            document.getElementById('cropped-image-data').value = reader.result;
            
            // Destruir cropper após corte
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            
            // Atualizar preview com imagem cortada (sem cropper)
            const previewImg = document.getElementById('preview-img');
            previewImg.src = reader.result;
            previewImg.style.maxWidth = '100%';
            previewImg.style.height = 'auto';
            
            alert('Imagem cortada com sucesso!');
        };
        reader.readAsDataURL(blob);
    }, 'image/jpeg', 0.9);
}

function resetCrop() {
    if (originalImageData) {
        const previewImg = document.getElementById('preview-img');
        previewImg.src = originalImageData;
        
        if (cropper) {
            cropper.destroy();
        }
        
        // Aguardar a imagem carregar para reinicializar o cropper
        previewImg.onload = function() {
            cropper = new Cropper(previewImg, {
                aspectRatio: 16 / 9,
                viewMode: 1,
                autoCropArea: 0.8,
                responsive: true,
                restore: false,
                guides: true,
                center: true,
                highlight: false,
                cropBoxMovable: true,
                cropBoxResizable: true,
                toggleDragModeOnDblclick: false
            });
        };
        
        document.getElementById('cropped-image-data').value = '';
    }
}

function removePhoto() {
    const photoInput = document.getElementById('photo');
    const preview = document.getElementById('photo-preview');
    const popupCheckbox = document.getElementById('is_popup');
    const uploadAreaLabel = document.getElementById('upload-area-label');
    
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
    
    photoInput.value = '';
    preview.classList.add('hidden');
    uploadAreaLabel.classList.remove('hidden');
    popupCheckbox.disabled = false;
    document.getElementById('cropped-image-data').value = '';
    originalImageData = null;
}

// Executar na carga da página
document.addEventListener('DOMContentLoaded', function() {
    toggleRecipients();
    
    // Validação do formulário
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        const sendToAll = document.getElementById('send_to_all');
        const recipientCheckboxes = document.querySelectorAll('input[name="recipients"]:checked');
        const groupCheckboxes = document.querySelectorAll('input[name="communication_groups"]:checked');
        
        if (!sendToAll.checked && recipientCheckboxes.length === 0 && groupCheckboxes.length === 0) {
            e.preventDefault();
            alert('Por favor, selecione "Enviar para todos", escolha um ou mais grupos ou selecione destinatários individuais.');
            return false;
        }
        
        // Se há imagem cortada, substituir o arquivo original
        const croppedImageData = document.getElementById('cropped-image-data').value;
        if (croppedImageData) {
            // Criar um novo arquivo blob da imagem cortada
            fetch(croppedImageData)
                .then(res => res.blob())
                .then(blob => {
                    const file = new File([blob], 'comunicado_image.jpg', { type: 'image/jpeg' });
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    document.getElementById('photo').files = dataTransfer.files;
                });
        }
    });
});
</script>
{% endblock %}
