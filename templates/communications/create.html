{% extends 'base.html' %}

{% block title %}Criar Comunicado - Rede de Confiança{% endblock %}

{% block extra_css %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
<style>
    .primary { background-color: #f97316; }
    .primary:hover { background-color: #ea580c; }
    
    /* Estilos específicos para o cropper - melhorados para Safari/macOS */
    #crop-container {
        position: relative;
        width: 100%;
        background: #f9fafb;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    #crop-img {
        max-width: 100%;
        max-height: 100%;
        display: block !important;
    }
    
    /* Melhorias para Safari e dispositivos Apple */
    .cropper-container {
        direction: ltr !important;
        font-size: 0 !important;
        line-height: 0 !important;
        position: relative !important;
        -ms-touch-action: none !important;
        touch-action: none !important;
        -webkit-user-select: none !important;
        -moz-user-select: none !important;
        -ms-user-select: none !important;
        user-select: none !important;
    }
    
    .cropper-container img {
        display: block !important;
        height: 100% !important;
        image-orientation: 0deg !important;
        max-height: none !important;
        max-width: none !important;
        min-height: 0 !important;
        min-width: 0 !important;
        width: 100% !important;
    }
    
    .cropper-wrap-box,
    .cropper-canvas,
    .cropper-drag-box,
    .cropper-crop-box,
    .cropper-modal {
        bottom: 0 !important;
        left: 0 !important;
        position: absolute !important;
        right: 0 !important;
        top: 0 !important;
    }
    
    .cropper-drag-box {
        background-color: inherit !important;
        opacity: 0 !important;
    }
    
    .cropper-modal {
        background-color: #000 !important;
        opacity: 0.5 !important;
    }
    
    .cropper-view-box {
        display: block !important;
        height: 100% !important;
        outline: 1px solid #39f !important;
        outline-color: rgba(51, 153, 255, 0.75) !important;
        overflow: hidden !important;
        width: 100% !important;
    }
    
    .cropper-dashed {
        border: 0 dashed #eee !important;
        display: block !important;
        opacity: 0.5 !important;
        position: absolute !important;
    }
    
    .cropper-dashed.dashed-h {
        border-bottom-width: 1px !important;
        border-top-width: 1px !important;
        height: calc(100% / 3) !important;
        left: 0 !important;
        top: calc(100% / 3) !important;
        width: 100% !important;
    }
    
    .cropper-dashed.dashed-v {
        border-left-width: 1px !important;
        border-right-width: 1px !important;
        height: 100% !important;
        left: calc(100% / 3) !important;
        top: 0 !important;
        width: calc(100% / 3) !important;
    }
    
    .cropper-center {
        display: block !important;
        height: 0 !important;
        left: 50% !important;
        opacity: 0.75 !important;
        position: absolute !important;
        top: 50% !important;
        width: 0 !important;
    }
    
    .cropper-face,
    .cropper-line,
    .cropper-point {
        display: block !important;
        height: 100% !important;
        opacity: 0.1 !important;
        position: absolute !important;
        width: 100% !important;
    }
    
    .cropper-face {
        background-color: #fff !important;
        left: 0 !important;
        top: 0 !important;
    }
    
    .cropper-line {
        background-color: #39f !important;
    }
    
    .cropper-point {
        background-color: #39f !important;
        height: 5px !important;
        opacity: 0.75 !important;
        width: 5px !important;
    }
    
    /* Melhores controles para trackpad do Mac */
    .cropper-container {
        -webkit-transform: translateZ(0);
        transform: translateZ(0);
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-6">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
            <div class="px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fas fa-plus-circle text-primary text-2xl mr-3"></i>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900">Criar Novo Comunicado</h1>
                            <p class="text-sm text-gray-600">Compartilhe informações importantes com sua equipe</p>
                        </div>
                    </div>
                    <a href="{% url 'communications:communications_list' %}" 
                       class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Voltar
                    </a>
                </div>
            </div>
        </div>

        <!-- Formulário -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="px-6 py-6">
                <form method="post" enctype="multipart/form-data" class="space-y-6">
                    {% csrf_token %}
                    
                    <!-- Título -->
                    <div>
                        <label for="title" class="block text-sm font-semibold text-gray-900 mb-2">
                            Título <span class="text-red-500">*</span>
                        </label>
                        <input type="text" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-colors" 
                               id="title" 
                               name="title" 
                               placeholder="Digite o título do comunicado"
                               required>
                    </div>

                    <!-- Upload de Foto com Editor de Crop Melhorado -->
                    <div>
                        <label for="photo" class="block text-sm font-semibold text-gray-900 mb-2">
                            <i class="fas fa-camera text-primary mr-1"></i>
                            Foto do Comunicado
                        </label>
                        
                        <!-- Upload nova foto -->
                        <div class="flex items-center justify-center w-full">
                            <label for="photo" class="flex flex-col items-center justify-center w-full h-64 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100" id="upload-area-label">
                                <div class="flex flex-col items-center justify-center pt-5 pb-6" id="upload-area">
                                    <i class="fas fa-cloud-upload-alt text-gray-400 text-4xl mb-4"></i>
                                    <p class="mb-2 text-sm text-gray-500">
                                        <span class="font-semibold">Clique para fazer upload</span> ou arraste a imagem
                                    </p>
                                    <p class="text-xs text-gray-500">PNG, JPG ou JPEG (MAX. 5MB)</p>
                                </div>
                                <input id="photo" name="photos" type="file" class="hidden" accept="image/*" multiple onchange="previewImages(this)">
                            </label>
                        </div>
                        
                        <!-- Preview das imagens -->
                        <div id="photos-preview" class="hidden mt-4">
                            <div class="bg-gray-100 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <p class="text-sm text-gray-600">Imagens selecionadas: <span id="images-count">0</span></p>
                                    <button type="button" onclick="removeAllPhotos()" class="bg-red-500 text-white px-3 py-1.5 rounded text-sm hover:bg-red-600 transition-colors">
                                        <i class="fas fa-trash mr-1"></i>
                                        Remover Todas
                                    </button>
                                </div>
                                <div id="images-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                    <!-- Imagens serão inseridas aqui via JavaScript -->
                                </div>
                            </div>
                        </div>
                        <p class="text-sm text-gray-500 mt-1">Você pode selecionar múltiplas fotos. Elas serão exibidas como carrossel no comunicado. Máximo: 10 imagens.</p>
                    </div>

                    <!-- Mensagem -->
                    <div>
                        <label for="message" class="block text-sm font-semibold text-gray-900 mb-2">
                            Mensagem <span class="text-red-500">*</span>
                        </label>
                        
                        <!-- Rich Text Editor Toolbar -->
                        <div class="border border-gray-300 rounded-lg overflow-hidden">
                            <div class="bg-gray-50 px-3 py-2 border-b border-gray-300">
                                <div class="flex items-center space-x-1">
                                    <button type="button" onclick="formatText('bold')" class="p-2 hover:bg-gray-200 rounded">
                                        <i class="fas fa-bold text-gray-600"></i>
                                    </button>
                                    <button type="button" onclick="formatText('italic')" class="p-2 hover:bg-gray-200 rounded">
                                        <i class="fas fa-italic text-gray-600"></i>
                                    </button>
                                    <button type="button" onclick="formatText('underline')" class="p-2 hover:bg-gray-200 rounded">
                                        <i class="fas fa-underline text-gray-600"></i>
                                    </button>
                                    <div class="w-px h-6 bg-gray-300 mx-2"></div>
                                    <button type="button" onclick="formatText('insertUnorderedList')" class="p-2 hover:bg-gray-200 rounded">
                                        <i class="fas fa-list-ul text-gray-600"></i>
                                    </button>
                                    <button type="button" onclick="formatText('insertOrderedList')" class="p-2 hover:bg-gray-200 rounded">
                                        <i class="fas fa-list-ol text-gray-600"></i>
                                    </button>
                                    <div class="w-px h-6 bg-gray-300 mx-2"></div>
                                    <button type="button" onclick="formatText('justifyLeft')" class="p-2 hover:bg-gray-200 rounded">
                                        <i class="fas fa-align-left text-gray-600"></i>
                                    </button>
                                    <button type="button" onclick="formatText('justifyCenter')" class="p-2 hover:bg-gray-200 rounded">
                                        <i class="fas fa-align-center text-gray-600"></i>
                                    </button>
                                    <button type="button" onclick="formatText('justifyRight')" class="p-2 hover:bg-gray-200 rounded">
                                        <i class="fas fa-align-right text-gray-600"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Editor Area -->
                            <div 
                                id="message-editor" 
                                class="min-h-[200px] p-4 outline-none focus:ring-0 bg-white"
                                contenteditable="true"
                                placeholder="Digite a mensagem do comunicado..."
                                style="max-height: 400px; overflow-y: auto;"
                                onkeyup="syncContent()"
                                onpaste="handlePaste(event)"
                            ></div>
                        </div>
                        
                        <!-- Hidden textarea for form submission -->
                        <textarea 
                            class="hidden" 
                            id="message" 
                            name="message" 
                            required
                        ></textarea>
                        
                        <p class="text-sm text-gray-500 mt-2">
                            Use a barra de ferramentas para formatar o texto. Suporte a <strong>negrito</strong>, 
                            <em>itálico</em>, listas e alinhamento.
                        </p>
                    </div>

                    <!-- Período de Ativação -->
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-calendar-alt text-blue-600 mr-2"></i>
                            Período de Ativação
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Ativo a partir de -->
                            <div>
                                <label for="active_from" class="block text-sm font-semibold text-gray-900 mb-2">
                                    Ativo a partir de
                                </label>
                                <input type="datetime-local" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-colors" 
                                       id="active_from" 
                                       name="active_from">
                                <p class="text-sm text-gray-500 mt-1">Deixe em branco para ativar imediatamente</p>
                            </div>

                            <!-- Ativo até -->
                            <div>
                                <label for="active_until" class="block text-sm font-semibold text-gray-900 mb-2">
                                    Ativo até
                                </label>
                                <input type="datetime-local" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-colors" 
                                       id="active_until" 
                                       name="active_until">
                                <p class="text-sm text-gray-500 mt-1">Deixe em branco para não ter data limite</p>
                            </div>
                        </div>
                    </div>

                    <!-- Opções de Envio -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Opções de Envio</h3>
                        
                        <div class="space-y-4">
                            <!-- Fixar na Dashboard -->
                            <div class="flex items-start">
                                <div class="flex items-center h-5">
                                    <input class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary" 
                                           type="checkbox" 
                                           id="is_pinned" 
                                           name="is_pinned">
                                </div>
                                <div class="ml-3">
                                    <label for="is_pinned" class="text-sm font-medium text-gray-900">
                                        Fixar na Dashboard
                                    </label>
                                    <p class="text-sm text-gray-500">O comunicado será destacado na página inicial</p>
                                </div>
                            </div>

                            <!-- Exibir como Pop-up -->
                            <div class="flex items-start">
                                <div class="flex items-center h-5">
                                    <input class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary" 
                                           type="checkbox" 
                                           id="is_popup" 
                                           name="is_popup">
                                </div>
                                <div class="ml-3">
                                    <label for="is_popup" class="text-sm font-medium text-gray-900">
                                        Exibir como Pop-up
                                    </label>
                                    <p class="text-sm text-gray-500">Será exibido automaticamente quando usuários acessarem o sistema</p>
                                </div>
                            </div>

                            <!-- Grupo Remetente - Mostrar apenas grupos do usuário -->
                            <div>
                                <label for="sender_group" class="block text-sm font-semibold text-gray-900 mb-2">
                                    Enviar como
                                </label>
                                <select name="sender_group" id="sender_group" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-colors">
                                    <option value="">{{ user.get_full_name }}</option>
                                    {% for group in user_groups %}
                                        <option value="{{ group.0 }}">{{ group.1 }}</option>
                                    {% endfor %}
                                    <!-- Grupos personalizados em que o usuário é membro -->
                                    {% for group in user.communication_groups.all %}
                                        <option value="custom_{{ group.id }}">{{ group.name }}</option>
                                    {% endfor %}
                                </select>
                                <p class="text-sm text-gray-500 mt-1">Selecione o grupo que você representa ao enviar este comunicado</p>
                            </div>

                            <!-- Destinatários - Grupos + Usuários -->
                            <div>
                                <label for="custom_group" class="block text-sm font-semibold text-gray-900 mb-2">
                                    Destinatários Específicos
                                </label>
                                <select name="custom_group" id="custom_group" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-colors" onchange="toggleGroupRecipients()">
                                    <option value="">Selecionar destinatários individuais</option>
                                    <optgroup label="Grupos de Comunicação">
                                        {% for group in communication_groups %}
                                            <option value="{{ group.id }}">{{ group.name }} ({{ group.members.count }} membros)</option>
                                        {% endfor %}
                                    </optgroup>
                                </select>
                                <p class="text-sm text-gray-500 mt-1">Escolha um grupo para enviar automaticamente para todos os membros, ou selecione usuários individualmente abaixo</p>
                            </div>

                            <!-- Enviar para todos -->
                            <div class="flex items-start">
                                <div class="flex items-center h-5">
                                    <input class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary" 
                                           type="checkbox" 
                                           id="send_to_all" 
                                           name="send_to_all" 
                                           onchange="toggleRecipients()">
                                </div>
                                <div class="ml-3">
                                    <label for="send_to_all" class="text-sm font-medium text-gray-900">
                                        Enviar para todos os usuários
                                    </label>
                                    <p class="text-sm text-gray-500">O comunicado será enviado para todos os usuários ativos do sistema</p>
                                </div>
                            </div>

                            <!-- Destinatários específicos -->
                            <div id="recipients-section">
                                <label for="recipients" class="block text-sm font-semibold text-gray-900 mb-2">
                                    Destinatários Específicos
                                </label>
                                
                                <!-- Grupos de Comunicação -->
                                {% if communication_groups %}
                                <div class="mb-4">
                                    <h4 class="text-sm font-medium text-gray-700 mb-2">Grupos de Comunicação</h4>
                                    <div class="border border-gray-200 rounded-lg p-3 bg-gray-50 max-h-48 overflow-y-auto">
                                        {% for group in communication_groups %}
                                        <div class="flex items-center py-2 px-2 hover:bg-white rounded">
                                            <input type="checkbox" 
                                                   name="communication_groups" 
                                                   value="{{ group.id }}" 
                                                   id="group_{{ group.id }}"
                                                   class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary"
                                                   onchange="toggleGroupRecipients()">
                                            <label for="group_{{ group.id }}" class="ml-3 flex-1 cursor-pointer">
                                                <div class="flex items-center">
                                                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center mr-3">
                                                        <i class="fas fa-users text-white text-xs"></i>
                                                    </div>
                                                    <div>
                                                        <div class="text-sm font-medium text-gray-900">{{ group.name }}</div>
                                                        <div class="text-xs text-gray-500">{{ group.description|default:"Sem descrição" }} • {{ group.members.count }} membro{{ group.members.count|pluralize }}</div>
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <p class="text-sm text-gray-500 mt-1">Selecione um ou mais grupos para enviar o comunicado para todos os seus membros</p>
                                </div>
                                {% endif %}
                                
                                <!-- Usuários Individuais -->
                                <div id="individual-users-section">
                                    <h4 class="text-sm font-medium text-gray-700 mb-2">Usuários Individuais</h4>
                                    <div class="border border-gray-300 rounded-lg p-3 bg-white max-h-64 overflow-y-auto">
                                        {% for user_option in users %}
                                        <div class="flex items-center py-2 px-2 hover:bg-gray-50 rounded">
                                            <input type="checkbox" 
                                                   name="recipients" 
                                                   value="{{ user_option.id }}" 
                                                   id="user_{{ user_option.id }}"
                                                   class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary">
                                            <label for="user_{{ user_option.id }}" class="ml-3 flex-1 cursor-pointer">
                                                <div class="flex items-center">
                                                    {% if user_option.profile_picture %}
                                                        <img src="{{ user_option.profile_picture.url }}" alt="{{ user_option.get_full_name }}" class="w-8 h-8 rounded-full mr-3">
                                                    {% else %}
                                                        <div class="w-8 h-8 bg-gray-500 rounded-full flex items-center justify-center mr-3">
                                                            <i class="fas fa-user text-white text-xs"></i>
                                                        </div>
                                                    {% endif %}
                                                    <div>
                                                        <div class="text-sm font-medium text-gray-900">{{ user_option.get_full_name }}</div>
                                                        <div class="text-xs text-gray-500">{{ user_option.email }} • {{ user_option.sector.name|default:"Sem setor" }}</div>
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <p class="text-sm text-gray-500 mt-1">Selecione os usuários específicos que devem receber este comunicado</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Botões -->
                    <div class="flex items-center justify-end space-x-4 pt-6 border-t border-gray-200">
                        <a href="{% url 'communications:communications_list' %}" 
                           class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            Cancelar
                        </a>
                        <button type="submit" 
                                class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-orange-600 transition-colors flex items-center">
                            <i class="fas fa-paper-plane mr-2"></i>
                            Criar Comunicado
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Crop da Imagem -->
<div id="cropModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden">
        <!-- Header do Modal -->
        <div class="flex items-center justify-between p-6 border-b border-gray-200">
            <div>
                <h3 class="text-lg font-semibold text-gray-900">Recortar Imagem</h3>
                <p class="text-sm text-gray-600">Ajuste a área de recorte arrastando e redimensionando</p>
            </div>
            <button onclick="closeCropModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <!-- Área de Crop -->
        <div class="p-6">
            <div id="crop-container" class="bg-gray-100 rounded-lg border-2 border-dashed border-gray-300" style="height: 500px; overflow: hidden; position: relative;">
                <img id="crop-img" src="" alt="Crop Image" style="display: none; max-width: 100%; max-height: 100%; object-fit: contain;">
            </div>
            
            <!-- Controles adicionais para dispositivos touch -->
            <div class="mt-4 flex items-center justify-between bg-gray-50 rounded-lg p-3">
                <div class="flex items-center space-x-4">
                    <button type="button" onclick="zoomIn()" class="bg-blue-500 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-600">
                        <i class="fas fa-search-plus"></i>
                    </button>
                    <button type="button" onclick="zoomOut()" class="bg-blue-500 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-600">
                        <i class="fas fa-search-minus"></i>
                    </button>
                </div>
                <div class="text-sm text-gray-600">
                    <i class="fas fa-mouse-pointer mr-1"></i>
                    Use o mouse ou toque para ajustar
                </div>
            </div>
        </div>
        
        <!-- Instruções -->
        <div class="px-6 pb-4">
            <div class="bg-blue-50 rounded-lg p-4">
                <h4 class="text-sm font-medium text-blue-900 mb-2">
                    <i class="fas fa-info-circle mr-2"></i>Como usar:
                </h4>
                <ul class="text-sm text-blue-800 space-y-1">
                    <li>• <strong>Arrastar:</strong> Mova a área de recorte</li>
                    <li>• <strong>Redimensionar:</strong> Puxe as bordas para ajustar o tamanho</li>
                    <li>• <strong>Zoom:</strong> Use a roda do mouse ou pinch para ampliar/reduzir</li>
                    <li>• <strong>Proporção:</strong> Mantém automaticamente a proporção 16:9 ideal para feeds</li>
                </ul>
            </div>
        </div>
        
        <!-- Botões do Modal -->
        <div class="flex items-center justify-between px-6 py-4 bg-gray-50 border-t border-gray-200">
            <button onclick="resetCropInModal()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                <i class="fas fa-undo mr-2"></i>
                Resetar
            </button>
            <div class="flex gap-3">
                <button onclick="closeCropModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    Cancelar
                </button>
                <button onclick="applyCrop()" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition-colors">
                    <i class="fas fa-check mr-2"></i>
                    Aplicar Recorte
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let cropper = null;
let originalImageData = null;

function toggleRecipients() {
    const sendToAll = document.getElementById('send_to_all');
    const recipientsSection = document.getElementById('recipients-section');
    const recipientCheckboxes = document.querySelectorAll('input[name="recipients"]');
    const groupCheckboxes = document.querySelectorAll('input[name="communication_groups"]');
    
    if (sendToAll.checked) {
        recipientsSection.style.display = 'none';
        recipientCheckboxes.forEach(checkbox => {
            checkbox.required = false;
            checkbox.checked = false;
        });
        groupCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
    } else {
        recipientsSection.style.display = 'block';
    }
}

function toggleGroupRecipients() {
    const groupCheckboxes = document.querySelectorAll('input[name="communication_groups"]');
    const sendToAll = document.getElementById('send_to_all');
    const recipientCheckboxes = document.querySelectorAll('input[name="recipients"]');
    const individualSection = document.getElementById('individual-users-section');
    
    // Verificar se algum grupo foi selecionado
    const selectedGroups = Array.from(groupCheckboxes).filter(checkbox => checkbox.checked);
    
    if (selectedGroups.length > 0) {
        // Se grupos selecionados, desmarcar "enviar para todos" e desabilitar usuários individuais
        sendToAll.checked = false;
        recipientCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
            checkbox.disabled = true;
        });
        individualSection.style.opacity = '0.5';
        
        // Adicionar texto informativo
        const infoText = individualSection.querySelector('.group-info') || document.createElement('p');
        if (!individualSection.querySelector('.group-info')) {
            infoText.className = 'group-info text-xs text-blue-600 mt-2 font-medium';
            infoText.innerHTML = '<i class="fas fa-info-circle mr-1"></i>Usuários individuais desabilitados (grupos selecionados)';
            individualSection.appendChild(infoText);
        }
    } else {
        // Se nenhum grupo selecionado, reabilitar usuários individuais
        recipientCheckboxes.forEach(checkbox => {
            checkbox.disabled = false;
        });
        individualSection.style.opacity = '1';
        
        // Remover texto informativo
        const infoText = individualSection.querySelector('.group-info');
        if (infoText) {
            infoText.remove();
        }
    }
}

let selectedFiles = [];
let imageDataArray = [];

function previewImages(input) {
    const preview = document.getElementById('photos-preview');
    const imagesGrid = document.getElementById('images-grid');
    const imagesCount = document.getElementById('images-count');
    const popupCheckbox = document.getElementById('is_popup');
    const uploadAreaLabel = document.getElementById('upload-area-label');
    
    if (input.files && input.files.length > 0) {
        const files = Array.from(input.files);
        
        // Limitar a 10 imagens
        if (files.length > 10) {
            alert('Máximo de 10 imagens permitidas.');
            return;
        }
        
        // Validar tamanho dos arquivos
        for (let file of files) {
            if (file.size > 5 * 1024 * 1024) {
                alert(`Arquivo "${file.name}" muito grande. Máximo 5MB por imagem.`);
                return;
            }
        }
        
        selectedFiles = files;
        imageDataArray = [];
        imagesGrid.innerHTML = '';
        
        let loadedCount = 0;
        
        files.forEach((file, index) => {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                imageDataArray[index] = e.target.result;
                
                // Criar preview da imagem
                const imageContainer = document.createElement('div');
                imageContainer.className = 'relative bg-white rounded border p-2';
                imageContainer.innerHTML = `
                    <div class="aspect-w-16 aspect-h-9 mb-2">
                        <img src="${e.target.result}" alt="Preview ${index + 1}" class="w-full h-32 object-cover rounded">
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-600 truncate">${file.name}</span>
                        <button type="button" onclick="removeImage(${index})" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                    </div>
                    <div class="mt-1">
                        <input type="text" placeholder="Legenda (opcional)" class="w-full text-xs border border-gray-200 rounded px-2 py-1" id="caption-${index}">
                    </div>
                `;
                
                imagesGrid.appendChild(imageContainer);
                loadedCount++;
                
                if (loadedCount === files.length) {
                    // Todas as imagens foram carregadas
                    preview.classList.remove('hidden');
                    uploadAreaLabel.classList.add('hidden');
                    imagesCount.textContent = files.length;
                    
                    // Desabilitar pop-up se tem imagens
                    if (popupCheckbox) {
                        popupCheckbox.disabled = true;
                        popupCheckbox.checked = false;
                    }
                }
            };
            
            reader.readAsDataURL(file);
        });
    }
}

function removeImage(index) {
    selectedFiles.splice(index, 1);
    imageDataArray.splice(index, 1);
    
    if (selectedFiles.length === 0) {
        removeAllPhotos();
    } else {
        // Recriar o preview
        const input = document.getElementById('photo');
        const dt = new DataTransfer();
        selectedFiles.forEach(file => dt.items.add(file));
        input.files = dt.files;
        previewImages(input);
    }
}

function removeAllPhotos() {
    const preview = document.getElementById('photos-preview');
    const uploadAreaLabel = document.getElementById('upload-area-label');
    const popupCheckbox = document.getElementById('is_popup');
    const input = document.getElementById('photo');
    
    selectedFiles = [];
    imageDataArray = [];
    input.value = '';
    
    preview.classList.add('hidden');
    uploadAreaLabel.classList.remove('hidden');
    
    // Reabilitar pop-up
    if (popupCheckbox) {
        popupCheckbox.disabled = false;
    }
}

function openCropModal() {
    if (!originalImageData) {
        alert('Nenhuma imagem selecionada');
        return;
    }
    
    const modal = document.getElementById('cropModal');
    const cropImg = document.getElementById('crop-img');
    
    // Mostrar modal
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    
    // Limpar cropper anterior
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
    
    // Configurar imagem
    cropImg.src = originalImageData;
    cropImg.style.display = 'block';
    
    // Aguardar carregamento da imagem
    cropImg.onload = function() {
        console.log('Imagem carregada no modal');
        
        // Aguardar um pouco mais para garantir renderização
        setTimeout(() => {
            try {
                // Verificar se Cropper está disponível
                if (typeof Cropper === 'undefined') {
                    console.error('Cropper.js não carregado');
                    alert('Erro: Biblioteca de recorte não carregada. Recarregue a página.');
                    return;
                }
                
                console.log('Inicializando Cropper...');
                
                // Configurações otimizadas para Safari/macOS
                cropper = new Cropper(cropImg, {
                    aspectRatio: 16 / 9,
                    viewMode: 1,
                    dragMode: 'move',
                    autoCropArea: 0.8,
                    responsive: true,
                    restore: false,
                    guides: true,
                    center: true,
                    highlight: false,
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                    toggleDragModeOnDblclick: false,
                    
                    // Configurações específicas para melhor compatibilidade
                    scalable: true,
                    zoomable: true,
                    zoomOnTouch: true,
                    zoomOnWheel: true,
                    wheelZoomRatio: 0.1,
                    minCanvasWidth: 0,
                    minCanvasHeight: 0,
                    minCropBoxWidth: 100,
                    minCropBoxHeight: 56,
                    
                    // Callbacks para debug
                    ready: function() {
                        console.log('✅ Cropper inicializado com sucesso');
                        
                        // Forçar atualização inicial
                        setTimeout(() => {
                            this.cropper.crop();
                        }, 100);
                    },
                    
                    cropstart: function(e) {
                        console.log('Crop start:', e.detail.action);
                    },
                    
                    cropmove: function(e) {
                        // console.log('Crop move:', e.detail.action);
                    },
                    
                    cropend: function(e) {
                        console.log('Crop end:', e.detail.action);
                    },
                    
                    crop: function(e) {
                        // console.log('Crop data:', e.detail);
                    },
                    
                    error: function(error) {
                        console.error('❌ Erro no Cropper:', error);
                    }
                });
                
            } catch (error) {
                console.error('❌ Erro ao inicializar Cropper:', error);
                alert('Erro ao inicializar o editor de imagem: ' + error.message);
            }
        }, 300);
    };
    
    // Fallback se a imagem já estiver carregada
    if (cropImg.complete) {
        cropImg.onload();
    }
}

// Funções de zoom para controles manuais
function zoomIn() {
    if (cropper) {
        cropper.zoom(0.1);
    }
}

function zoomOut() {
    if (cropper) {
        cropper.zoom(-0.1);
    }
}

function closeCropModal() {
    const modal = document.getElementById('cropModal');
    modal.classList.add('hidden');
    document.body.style.overflow = 'auto';
    
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
}

function resetCropInModal() {
    if (cropper && originalImageData) {
        cropper.reset();
    }
}

function applyCrop() {
    console.log('🔄 Aplicando crop...');
    
    if (!cropper) {
        console.error('❌ Cropper não está inicializado');
        alert('Erro: Editor de recorte não está ativo. Tente fechar e abrir o modal novamente.');
        return;
    }
    
    try {
        // Obter dados do crop
        const cropData = cropper.getData();
        console.log('📊 Dados do crop:', cropData);
        
        // Gerar canvas com a imagem cortada
        const canvas = cropper.getCroppedCanvas({
            width: 800,
            height: 450,
            minWidth: 400,
            minHeight: 225,
            maxWidth: 1200,
            maxHeight: 675,
            fillColor: '#fff',
            imageSmoothingEnabled: true,
            imageSmoothingQuality: 'high'
        });
        
        if (!canvas) {
            console.error('❌ Erro ao gerar canvas');
            alert('Erro ao processar o recorte da imagem. Tente com uma imagem menor.');
            return;
        }
        
        console.log('✅ Canvas gerado:', canvas.width, 'x', canvas.height);
        
        // Converter para blob com melhor compatibilidade
        canvas.toBlob(function(blob) {
            if (!blob) {
                console.error('❌ Erro ao gerar blob');
                alert('Erro ao gerar imagem recortada');
                return;
            }
            
            console.log('✅ Blob gerado:', blob.size, 'bytes');
            
            const reader = new FileReader();
            reader.onload = function() {
                console.log('✅ Data URL gerado');
                
                // Salvar dados da imagem cortada
                document.getElementById('cropped-image-data').value = reader.result;
                
                // Atualizar preview principal
                const previewImg = document.getElementById('preview-img');
                previewImg.src = reader.result;
                
                // Fechar modal
                closeCropModal();
                
                // Mostrar feedback de sucesso
                showSuccessNotification('Recorte aplicado com sucesso!');
            };
            
            reader.onerror = function() {
                console.error('❌ Erro ao ler blob');
                alert('Erro ao processar imagem recortada');
            };
            
            reader.readAsDataURL(blob);
            
        }, 'image/jpeg', 0.9);
        
    } catch (error) {
        console.error('❌ Erro geral no applyCrop:', error);
        alert('Erro ao aplicar recorte: ' + error.message);
    }
}

function showSuccessNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center animate-pulse';
    notification.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${message}`;
    document.body.appendChild(notification);
    
    // Animar entrada
    setTimeout(() => {
        notification.classList.remove('animate-pulse');
        notification.style.transform = 'translateY(0)';
    }, 100);
    
    // Remover após 4 segundos
    setTimeout(() => {
        notification.style.transform = 'translateY(-100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 300);
    }, 4000);
}

function removePhoto() {
    const photoInput = document.getElementById('photo');
    const preview = document.getElementById('photo-preview');
    const popupCheckbox = document.getElementById('is_popup');
    const uploadAreaLabel = document.getElementById('upload-area-label');
    
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
    
    photoInput.value = '';
    preview.classList.add('hidden');
    uploadAreaLabel.classList.remove('hidden');
    
    if (popupCheckbox) {
        popupCheckbox.disabled = false;
    }
    
    document.getElementById('cropped-image-data').value = '';
    originalImageData = null;
}

// Rich Text Editor Functions
function formatText(command) {
    document.execCommand(command, false, null);
    document.getElementById('message-editor').focus();
    syncContent();
}

function syncContent() {
    const editor = document.getElementById('message-editor');
    const hiddenTextarea = document.getElementById('message');
    hiddenTextarea.value = editor.innerHTML;
}

function handlePaste(event) {
    event.preventDefault();
    
    // Get pasted data
    const paste = (event.clipboardData || window.clipboardData).getData('text');
    
    // Insert as plain text to avoid unwanted formatting
    document.execCommand('insertText', false, paste);
    syncContent();
}

// Add placeholder behavior
function setupPlaceholder() {
    const editor = document.getElementById('message-editor');
    
    editor.addEventListener('focus', function() {
        if (this.textContent.trim() === '') {
            this.innerHTML = '';
        }
    });
    
    editor.addEventListener('blur', function() {
        if (this.textContent.trim() === '') {
            this.innerHTML = '';
        }
    });
    
    // Set placeholder appearance
    if (editor.textContent.trim() === '') {
        editor.classList.add('placeholder-visible');
    }
}

// CSS for placeholder
const style = document.createElement('style');
style.textContent = `
    #message-editor:empty:before {
        content: attr(placeholder);
        color: #9CA3AF;
        pointer-events: none;
        font-style: italic;
    }
    #message-editor:focus:before {
        display: none;
    }
`;
document.head.appendChild(style);

// Executar na carga da página
document.addEventListener('DOMContentLoaded', function() {
    console.log('🔧 DOM carregado');
    
    // Verificar se Cropper.js carregou
    if (typeof Cropper !== 'undefined') {
        console.log('✅ Cropper.js carregado com sucesso');
    } else {
        console.error('❌ Cropper.js não foi carregado');
    }
    
    toggleRecipients();
    setupPlaceholder();
    
    // Fechar modal com ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !document.getElementById('cropModal').classList.contains('hidden')) {
            closeCropModal();
        }
    });
    
    // Debug: Verificar user agent (Safari, Chrome, etc)
    console.log('🔍 User Agent:', navigator.userAgent);
    console.log('🔍 É Safari?', /^((?!chrome|android).)*safari/i.test(navigator.userAgent));
    console.log('🔍 É macOS?', /Mac/i.test(navigator.userAgent));
    
    // Validação do formulário
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        // Sincronizar conteúdo do editor antes de enviar
        syncContent();
        
        // Adicionar legendas das imagens ao formulário
        if (selectedFiles.length > 0) {
            selectedFiles.forEach((file, index) => {
                const captionInput = document.getElementById(`caption-${index}`);
                if (captionInput && captionInput.value.trim()) {
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = `caption-${index}`;
                    hiddenInput.value = captionInput.value.trim();
                    form.appendChild(hiddenInput);
                }
            });
        }
        
        const sendToAll = document.getElementById('send_to_all');
        const recipientCheckboxes = document.querySelectorAll('input[name="recipients"]:checked');
        const groupCheckboxes = document.querySelectorAll('input[name="communication_groups"]:checked');
        const messageEditor = document.getElementById('message-editor');
        const messageContent = messageEditor.textContent.trim();
        
        // Validar mensagem
        if (!messageContent) {
            e.preventDefault();
            alert('Por favor, digite uma mensagem para o comunicado.');
            messageEditor.focus();
            return false;
        }
        
        // Validar destinatários
        if (!sendToAll.checked && recipientCheckboxes.length === 0 && groupCheckboxes.length === 0) {
            e.preventDefault();
            alert('Por favor, selecione "Enviar para todos", escolha um ou mais grupos ou selecione destinatários individuais.');
            return false;
        }
        
        // Se há imagem cortada, substituir o arquivo original
        const croppedImageData = document.getElementById('cropped-image-data').value;
        if (croppedImageData) {
            // Criar um novo arquivo blob da imagem cortada
            fetch(croppedImageData)
                .then(res => res.blob())
                .then(blob => {
                    const file = new File([blob], 'comunicado_image.jpg', { type: 'image/jpeg' });
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    document.getElementById('photo').files = dataTransfer.files;
                });
        }
    });
});
</script>
{% endblock %}
