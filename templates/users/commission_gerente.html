{% extends 'base.html' %}
{% load static %}

{% block title %}Comissionamento - Gerente{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6 max-w-7xl">
    
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">Comissionamento</h1>
            <p class="text-gray-500 text-sm mt-1">Vis√£o Gerencial - Acompanhe sua equipe</p>
        </div>
        
        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3 mt-4 md:mt-0">
            {% if sector_users %}
            <form method="get" class="flex items-center gap-2">
                <select name="user" onchange="this.form.submit()" 
                    class="text-sm border border-gray-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                    <option value="">Meus dados</option>
                    {% for u in sector_users %}
                    <option value="{{ u.id }}" {% if target_user.id == u.id and viewing_other %}selected{% endif %}>
                        {{ u.get_full_name }}
                    </option>
                    {% endfor %}
                </select>
            </form>
            {% endif %}
            
            <a href="{% url 'commission_export' %}" 
                class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                Exportar
            </a>
            
            <a href="{% url 'commission_refresh' %}" 
                class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-600 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                Atualizar
            </a>
        </div>
    </div>
    
    {% if viewing_other %}
    <div class="mb-6 p-4 bg-primary/5 border border-primary/20 rounded-xl flex items-center gap-3">
        <div class="w-10 h-10 bg-primary/10 rounded-full flex items-center justify-center">
            <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
        </div>
        <div>
            <p class="text-sm text-gray-500">Visualizando dados de</p>
            <p class="font-semibold text-gray-800">{{ target_user.get_full_name }}</p>
        </div>
        {% if target_is_gerente %}
        <span class="ml-auto px-3 py-1 text-xs font-medium bg-primary text-white rounded-full">Gerente</span>
        {% else %}
        <span class="ml-auto px-3 py-1 text-xs font-medium bg-blue-500 text-white rounded-full">Consultor</span>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Resumo dos CNs da Loja -->
    {% if not viewing_other and cns_resumo %}
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-6">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-lg font-semibold text-gray-800">CNs da Loja</h2>
                <p class="text-sm text-gray-500">{{ cns_resumo|length }} consultores na equipe</p>
            </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        <th class="pb-3 pr-4">Nome</th>
                        <th class="pb-3 px-2 text-center">M√≥vel</th>
                        <th class="pb-3 px-2 text-center">Fixa</th>
                        <th class="pb-3 px-2 text-center">Smart</th>
                        <th class="pb-3 px-2 text-center">Eletro</th>
                        <th class="pb-3 px-2 text-center">Essen</th>
                        <th class="pb-3 px-2 text-center">Seguro</th>
                        <th class="pb-3 px-2 text-center">SVA</th>
                        <th class="pb-3 px-2 text-right">Comiss√£o</th>
                        <th class="pb-3 pl-4 text-right">Remunera√ß√£o</th>
                        <th class="pb-3 pl-4"></th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for cn in cns_resumo %}
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="py-3 pr-4">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-primary font-semibold text-sm">
                                    {{ cn.nome|slice:":1" }}
                                </div>
                                <span class="font-medium text-gray-800">{{ cn.nome }}</span>
                            </div>
                        </td>
                        {% for pilar in cn.pilares %}
                        <td class="py-3 px-2 text-center">
                            <span class="inline-flex items-center justify-center w-14 py-1 text-xs font-medium rounded-full
                                {% if pilar.pct >= 100 %}bg-green-100 text-green-700
                                {% elif pilar.pct >= 80 %}bg-yellow-100 text-yellow-700
                                {% elif pilar.pct > 0 %}bg-red-100 text-red-700
                                {% else %}bg-gray-100 text-gray-500{% endif %}">
                                {{ pilar.pct|floatformat:0 }}%
                            </span>
                        </td>
                        {% endfor %}
                        <td class="py-3 px-2 text-right font-medium text-gray-700">
                            R$ {{ cn.comissao_total|floatformat:2 }}
                        </td>
                        <td class="py-3 pl-4 text-right font-semibold text-primary">
                            R$ {{ cn.remuneracao_final|floatformat:2 }}
                        </td>
                        <td class="py-3 pl-4">
                            <a href="?user={{ cn.user_id }}" class="text-primary hover:text-primary/80 text-sm font-medium">
                                Ver detalhes
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="11" class="py-8 text-center text-gray-500">
                            Nenhum CN encontrado na loja
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    
    {% if result.error %}
    <!-- Estado de Erro -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-12 text-center">
        <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
        </div>
        <h3 class="text-lg font-semibold text-gray-800 mb-2">Dados n√£o encontrados</h3>
        <p class="text-gray-500 mb-1">{{ result.error }}</p>
        {% if result.user_name %}
        <p class="text-sm text-gray-400">Nome pesquisado: {{ result.user_name }}</p>
        {% endif %}
        <a href="{% url 'commission_refresh' %}" class="inline-flex items-center gap-2 mt-6 px-6 py-2.5 bg-primary text-white font-medium rounded-lg hover:bg-primary/90 transition-colors">
            Tentar novamente
        </a>
    </div>
    {% elif data %}
    
    <!-- Card Principal - Total -->
    <div class="bg-gradient-to-br from-primary to-orange-500 rounded-2xl p-6 md:p-8 text-white mb-6 shadow-lg shadow-primary/20">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <p class="text-white/80 text-sm font-medium mb-1">Remunera√ß√£o Final Total</p>
                <p class="text-4xl md:text-5xl font-bold">
                    R$ {{ data.totais.remuneracao_final|floatformat:2 }}
                </p>
                <p class="text-white/70 text-sm mt-2">
                    {{ data.info.nome }} ‚Ä¢ {{ data.info.cargo|default:"Gerente" }}
                </p>
            </div>
        </div>
    </div>
    
    <!-- Grid de M√©tricas R√°pidas -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-xl p-4 border border-gray-100">
            <p class="text-gray-500 text-xs font-medium mb-1">PDV</p>
            <p class="text-lg font-semibold text-gray-800">{{ data.info.pdv|default:"N/A" }}</p>
        </div>
        <div class="bg-white rounded-xl p-4 border border-gray-100">
            <p class="text-gray-500 text-xs font-medium mb-1">Coordenador(a)</p>
            <p class="text-lg font-semibold text-gray-800 truncate">{{ data.info.coordenador|default:"N/A" }}</p>
        </div>
        <div class="bg-white rounded-xl p-4 border border-gray-100">
            <p class="text-gray-500 text-xs font-medium mb-1">Total Comiss√µes</p>
            <p class="text-lg font-semibold text-green-600">R$ {{ data.comissoes.total|floatformat:2 }}</p>
        </div>
        <div class="bg-white rounded-xl p-4 border border-gray-100">
            <p class="text-gray-500 text-xs font-medium mb-1">Total Premia√ß√£o</p>
            <p class="text-lg font-semibold text-blue-600">R$ {{ data.totais.premiacao_cargo|floatformat:2 }}</p>
        </div>
    </div>
    
    <!-- Grid de Gr√°ficos -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Gr√°fico de Barras - Comiss√µes -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-1">Comiss√µes por Pilar</h2>
            <p class="text-sm text-gray-500 mb-6">Valores em R$</p>
            <div class="h-64">
                <canvas id="chartComissoes"></canvas>
            </div>
        </div>
        
        <!-- Gr√°fico Donut - Composi√ß√£o -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-1">Composi√ß√£o da Remunera√ß√£o</h2>
            <p class="text-sm text-gray-500 mb-6">Distribui√ß√£o por categoria</p>
            <div class="h-64">
                <canvas id="chartComposicao"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Tabela Consolidada de Comissionamento -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-6">
        <div class="px-6 py-4 border-b border-gray-100">
            <h2 class="text-lg font-semibold text-gray-800">Detalhamento por Pilar</h2>
            <p class="text-sm text-gray-500">Vis√£o consolidada de todas as comiss√µes e b√¥nus</p>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="bg-gray-50 text-xs font-medium text-gray-500 uppercase tracking-wider">
                        <th class="px-4 py-3 text-left">Pilar</th>
                        <th class="px-3 py-3 text-right">Comiss√µes</th>
                        <th class="px-3 py-3 text-right">B√¥nus Carteira</th>
                        <th class="px-3 py-3 text-right">Alto Desemp.</th>
                        <th class="px-3 py-3 text-right">Hunter</th>
                        <th class="px-3 py-3 text-right">B√¥nus Hunter</th>
                        <th class="px-3 py-3 text-right bg-green-50 text-green-700">Pago</th>
                        <th class="px-3 py-3 text-right bg-red-50 text-red-700">Exclus√£o</th>
                        <th class="px-3 py-3 text-center bg-green-50 text-green-700">% Pago</th>
                        <th class="px-3 py-3 text-center bg-red-50 text-red-700">% Exclus√£o</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    <!-- M√≥vel -->
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">üì±</span>
                                <span class="font-medium text-gray-800">M√≥vel</span>
                            </div>
                        </td>
                        <td class="px-3 py-3 text-right font-medium text-gray-700">R$ {{ data.comissoes.movel|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right font-medium text-gray-700">R$ {{ data.bonus.movel|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right font-medium text-gray-700">R$ {{ data.alto_desempenho.movel|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right font-medium text-gray-700">R$ {{ data.hunter.movel|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right font-medium text-gray-700">{{ data.bonus_hunter.movel|default:"-" }}</td>
                        <td class="px-3 py-3 text-right font-semibold text-green-600 bg-green-50/50">R$ {{ data.pilares.0.pago|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right font-semibold text-red-600 bg-red-50/50">R$ {{ data.pilares.0.exclusao|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-center bg-green-50/50">
                            <span class="inline-flex items-center justify-center px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-700">
                                {% widthratio data.pilares.0.pago data.pilares.0.total 100 %}%
                            </span>
                        </td>
                        <td class="px-3 py-3 text-center bg-red-50/50">
                            <span class="inline-flex items-center justify-center px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700">
                                {% widthratio data.pilares.0.exclusao data.pilares.0.total 100 %}%
                            </span>
                        </td>
                    </tr>
                    <!-- Fixa -->
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">üè†</span>
                                <span class="font-medium text-gray-800">Fixa</span>
                            </div>
                        </td>
                        <td class="px-3 py-3 text-right font-medium text-gray-700">R$ {{ data.comissoes.fixa|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right font-medium text-gray-700">R$ {{ data.bonus.fixa|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right font-medium text-gray-700">R$ {{ data.alto_desempenho.fixa|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right font-medium text-gray-700">R$ {{ data.hunter.fixa|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right font-medium text-gray-700">{{ data.bonus_hunter.fixa|default:"-" }}</td>
                        <td class="px-3 py-3 text-right font-semibold text-green-600 bg-green-50/50">R$ {{ data.pilares.1.pago|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right font-semibold text-red-600 bg-red-50/50">R$ {{ data.pilares.1.exclusao|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-center bg-green-50/50">
                            <span class="inline-flex items-center justify-center px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-700">
                                {% widthratio data.pilares.1.pago data.pilares.1.total 100 %}%
                            </span>
                        </td>
                        <td class="px-3 py-3 text-center bg-red-50/50">
                            <span class="inline-flex items-center justify-center px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700">
                                {% widthratio data.pilares.1.exclusao data.pilares.1.total 100 %}%
                            </span>
                        </td>
                    </tr>
                    <!-- Smartphone -->
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">üì≤</span>
                                <span class="font-medium text-gray-800">Smartphone</span>
                            </div>
                        </td>
                        <td class="px-3 py-3 text-right font-medium text-gray-700">R$ {{ data.comissoes.smartphone|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right font-medium text-gray-700">R$ {{ data.bonus.smartphone|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right font-medium text-gray-700">R$ {{ data.alto_desempenho.smartphone|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right font-medium text-gray-700">R$ {{ data.hunter.smartphone|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right font-medium text-gray-700">{{ data.bonus_hunter.smartphone|default:"-" }}</td>
                        <td class="px-3 py-3 text-right font-semibold text-green-600 bg-green-50/50">R$ {{ data.pilares.2.pago|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right font-semibold text-red-600 bg-red-50/50">R$ {{ data.pilares.2.exclusao|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-center bg-green-50/50">
                            <span class="inline-flex items-center justify-center px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-700">
                                {% widthratio data.pilares.2.pago data.pilares.2.total 100 %}%
                            </span>
                        </td>
                        <td class="px-3 py-3 text-center bg-red-50/50">
                            <span class="inline-flex items-center justify-center px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700">
                                {% widthratio data.pilares.2.exclusao data.pilares.2.total 100 %}%
                            </span>
                        </td>
                    </tr>
                    <!-- Eletr√¥nicos -->
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">üíª</span>
                                <span class="font-medium text-gray-800">Eletr√¥nicos</span>
                            </div>
                        </td>
                        <td class="px-3 py-3 text-right font-medium text-gray-700">R$ {{ data.comissoes.eletronicos_a|add:data.comissoes.eletronicos_b|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right font-medium text-gray-700">R$ {{ data.bonus.eletronicos|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right font-medium text-gray-700">R$ {{ data.alto_desempenho.eletronicos_a|add:data.alto_desempenho.eletronicos_b|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right font-medium text-gray-700">R$ {{ data.hunter.eletronicos|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right font-medium text-gray-700">{{ data.bonus_hunter.eletronicos|default:"-" }}</td>
                        <td class="px-3 py-3 text-right font-semibold text-green-600 bg-green-50/50">R$ {{ data.pilares.3.pago|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right font-semibold text-red-600 bg-red-50/50">R$ {{ data.pilares.3.exclusao|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-center bg-green-50/50">
                            <span class="inline-flex items-center justify-center px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-700">
                                {% widthratio data.pilares.3.pago data.pilares.3.total 100 %}%
                            </span>
                        </td>
                        <td class="px-3 py-3 text-center bg-red-50/50">
                            <span class="inline-flex items-center justify-center px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700">
                                {% widthratio data.pilares.3.exclusao data.pilares.3.total 100 %}%
                            </span>
                        </td>
                    </tr>
                    <!-- Essenciais -->
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">üõí</span>
                                <span class="font-medium text-gray-800">Essenciais</span>
                            </div>
                        </td>
                        <td class="px-3 py-3 text-right font-medium text-gray-700">R$ {{ data.comissoes.essenciais_a|add:data.comissoes.essenciais_b|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right font-medium text-gray-700">R$ {{ data.bonus.essenciais|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right font-medium text-gray-700">R$ {{ data.alto_desempenho.essenciais_a|add:data.alto_desempenho.essenciais_b|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right font-medium text-gray-700">R$ {{ data.hunter.essenciais|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right font-medium text-gray-700">{{ data.bonus_hunter.essenciais|default:"-" }}</td>
                        <td class="px-3 py-3 text-right font-semibold text-green-600 bg-green-50/50">R$ {{ data.pilares.4.pago|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right font-semibold text-red-600 bg-red-50/50">R$ {{ data.pilares.4.exclusao|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-center bg-green-50/50">
                            <span class="inline-flex items-center justify-center px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-700">
                                {% widthratio data.pilares.4.pago data.pilares.4.total 100 %}%
                            </span>
                        </td>
                        <td class="px-3 py-3 text-center bg-red-50/50">
                            <span class="inline-flex items-center justify-center px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700">
                                {% widthratio data.pilares.4.exclusao data.pilares.4.total 100 %}%
                            </span>
                        </td>
                    </tr>
                    <!-- Seguro -->
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">üõ°Ô∏è</span>
                                <span class="font-medium text-gray-800">Seguro</span>
                            </div>
                        </td>
                        <td class="px-3 py-3 text-right font-medium text-gray-700">R$ {{ data.comissoes.seguro|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right font-medium text-gray-700">R$ {{ data.bonus.seguro|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right font-medium text-gray-700">R$ {{ data.alto_desempenho.seguro|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right font-medium text-gray-700">R$ {{ data.hunter.seguros|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right font-medium text-gray-700">{{ data.bonus_hunter.seguro|default:"-" }}</td>
                        <td class="px-3 py-3 text-right font-semibold text-green-600 bg-green-50/50">R$ {{ data.pilares.5.pago|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right font-semibold text-red-600 bg-red-50/50">R$ {{ data.pilares.5.exclusao|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-center bg-green-50/50">
                            <span class="inline-flex items-center justify-center px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-700">
                                {% widthratio data.pilares.5.pago data.pilares.5.total 100 %}%
                            </span>
                        </td>
                        <td class="px-3 py-3 text-center bg-red-50/50">
                            <span class="inline-flex items-center justify-center px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700">
                                {% widthratio data.pilares.5.exclusao data.pilares.5.total 100 %}%
                            </span>
                        </td>
                    </tr>
                    <!-- SVA -->
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">‚≠ê</span>
                                <span class="font-medium text-gray-800">SVA</span>
                            </div>
                        </td>
                        <td class="px-3 py-3 text-right font-medium text-gray-700">R$ {{ data.comissoes.sva|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right font-medium text-gray-700">R$ {{ data.bonus.sva|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right font-medium text-gray-700">R$ {{ data.alto_desempenho.sva|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right font-medium text-gray-700">R$ {{ data.hunter.sva|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right font-medium text-gray-700">{{ data.bonus_hunter.sva|default:"-" }}</td>
                        <td class="px-3 py-3 text-right font-semibold text-green-600 bg-green-50/50">R$ {{ data.pilares.6.pago|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right font-semibold text-red-600 bg-red-50/50">R$ {{ data.pilares.6.exclusao|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-center bg-green-50/50">
                            <span class="inline-flex items-center justify-center px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-700">
                                {% widthratio data.pilares.6.pago data.pilares.6.total 100 %}%
                            </span>
                        </td>
                        <td class="px-3 py-3 text-center bg-red-50/50">
                            <span class="inline-flex items-center justify-center px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700">
                                {% widthratio data.pilares.6.exclusao data.pilares.6.total 100 %}%
                            </span>
                        </td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr class="bg-gray-100 font-semibold">
                        <td class="px-4 py-3 text-gray-800">Total</td>
                        <td class="px-3 py-3 text-right text-primary">R$ {{ data.comissoes.total|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right text-blue-600">R$ {{ data.bonus.total|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right text-amber-600">R$ {{ data.alto_desempenho.total|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right text-purple-600">R$ {{ data.hunter.total|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right text-indigo-600">-</td>
                        <td class="px-3 py-3 text-right text-green-700 bg-green-100">R$ {{ data.totais.total_pago|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-right text-red-700 bg-red-100">R$ {{ data.totais.total_exclusao|floatformat:2 }}</td>
                        <td class="px-3 py-3 text-center bg-green-100">-</td>
                        <td class="px-3 py-3 text-center bg-red-100">-</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    
    {% endif %}
</div>

{% if data %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chartData = {{ charts_json|safe }};
    
    // Gr√°fico de Evolu√ß√£o
    const ctxEvolucao = document.getElementById('chartEvolucao');
    if (ctxEvolucao) {
        new Chart(ctxEvolucao, {
            type: 'line',
            data: {
                labels: chartData.atingimentos.labels,
                datasets: [
                    {
                        label: '{{ meses.m3 }}',
                        data: [{% for p in data.pilares %}{{ p.pct_3 }}{% if not forloop.last %},{% endif %}{% endfor %}],
                        borderColor: '#9CA3AF',
                        backgroundColor: 'rgba(156, 163, 175, 0.1)',
                        tension: 0.4,
                        fill: false
                    },
                    {
                        label: '{{ meses.m2 }}',
                        data: [{% for p in data.pilares %}{{ p.pct_2 }}{% if not forloop.last %},{% endif %}{% endfor %}],
                        borderColor: '#F59E0B',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4,
                        fill: false
                    },
                    {
                        label: '{{ meses.m1 }}',
                        data: [{% for p in data.pilares %}{{ p.pct_1 }}{% if not forloop.last %},{% endif %}{% endfor %}],
                        borderColor: '#660099',
                        backgroundColor: 'rgba(102, 0, 153, 0.1)',
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 150
                    }
                }
            }
        });
    }
    
    // Gr√°fico de Comiss√µes
    const ctxComissoes = document.getElementById('chartComissoes');
    if (ctxComissoes) {
        new Chart(ctxComissoes, {
            type: 'bar',
            data: {
                labels: chartData.comissoes.labels,
                datasets: [{
                    data: chartData.comissoes.data,
                    backgroundColor: [
                        'rgba(102, 0, 153, 0.8)',
                        'rgba(155, 48, 255, 0.8)',
                        'rgba(186, 85, 211, 0.8)',
                        'rgba(147, 112, 219, 0.8)',
                        'rgba(138, 43, 226, 0.8)',
                        'rgba(123, 104, 238, 0.8)',
                        'rgba(106, 90, 205, 0.8)'
                    ],
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'R$ ' + value.toLocaleString('pt-BR');
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Gr√°fico de Composi√ß√£o
    const ctxComposicao = document.getElementById('chartComposicao');
    if (ctxComposicao) {
        new Chart(ctxComposicao, {
            type: 'doughnut',
            data: {
                labels: chartData.composicao.labels,
                datasets: [{
                    data: chartData.composicao.data,
                    backgroundColor: [
                        '#660099',
                        '#FF6B35',
                        '#00B4D8',
                        '#95C623',
                        '#FFC107'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                },
                cutout: '60%'
            }
        });
    }
    
    // Animar c√≠rculos de progresso
    document.querySelectorAll('.progress-circle').forEach(circle => {
        const value = parseFloat(circle.dataset.value) || 0;
        const circumference = 176;
        const offset = circumference - (value / 100 * circumference);
        setTimeout(() => {
            circle.style.transition = 'stroke-dashoffset 1s ease-out';
            circle.style.strokeDashoffset = Math.max(offset, 0);
        }, 100);
    });
});
</script>
{% endif %}
{% endblock %}
