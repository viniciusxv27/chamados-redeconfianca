{% extends 'base.html' %}
{% load static %}

{% block title %}Checklists de Hoje{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-blue-50 p-6">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent mb-2">
                        üìã Checklists de Hoje
                    </h1>
                    <p class="text-gray-600">
                        {{ today|date:"d/m/Y" }} - {{ user.get_full_name|default:user.username }}
                    </p>
                </div>
                <a href="{% url 'checklists:dashboard' %}" 
                   class="px-6 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-colors font-semibold">
                    ‚Üê Voltar
                </a>
            </div>

            <!-- Progress Bar -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-6">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-lg font-semibold text-gray-700">Progresso Geral</span>
                    <span class="text-2xl font-bold text-blue-600">{{ progress_percentage }}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-6 overflow-hidden">
                    <div class="bg-gradient-to-r from-blue-500 to-indigo-600 h-full rounded-full transition-all duration-500 flex items-center justify-end px-3"
                         style="width: {{ progress_percentage }}%">
                        {% if progress_percentage > 0 %}
                            <span class="text-white text-xs font-bold">{{ completed_tasks }}/{{ total_tasks }}</span>
                        {% endif %}
                    </div>
                </div>
                <p class="text-sm text-gray-600 mt-2">
                    {{ completed_tasks }} de {{ total_tasks }} tarefas conclu√≠das
                </p>
            </div>
        </div>

        {% if not today_executions %}
            <!-- Sem Checklists -->
            <div class="bg-white rounded-2xl shadow-xl p-12 text-center">
                <div class="text-6xl mb-4">üéâ</div>
                <h2 class="text-2xl font-bold text-gray-700 mb-2">Nenhum checklist para hoje!</h2>
                <p class="text-gray-600">Voc√™ n√£o tem checklists atribu√≠dos para esta data.</p>
            </div>
        {% else %}
            <!-- Form -->
            <form method="post" enctype="multipart/form-data" id="todayChecklistsForm">
                {% csrf_token %}

                {% for execution in today_executions %}
                    <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
                        <!-- Checklist Header -->
                        <div class="border-b border-gray-200 pb-6 mb-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-800 mb-2">
                                        {{ execution.assignment.template.name }}
                                    </h2>
                                    <div class="flex items-center gap-3">
                                        <span class="px-3 py-1 rounded-full text-sm font-semibold
                                            {% if execution.period == 'morning' %}bg-yellow-100 text-yellow-800
                                            {% elif execution.period == 'afternoon' %}bg-blue-100 text-blue-800
                                            {% else %}bg-purple-100 text-purple-800{% endif %}">
                                            {% if execution.period == 'morning' %}üåû Manh√£
                                            {% elif execution.period == 'afternoon' %}üåô Tarde
                                            {% else %}üåûüåô Manh√£ e Tarde{% endif %}
                                        </span>
                                        <span class="text-sm text-gray-600">
                                            {{ execution.assignment.template.sector.name }}
                                        </span>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-3xl font-bold text-blue-600">
                                        {{ execution.completed_tasks_count }}/{{ execution.total_tasks_count }}
                                    </div>
                                    <p class="text-sm text-gray-600">tarefas</p>
                                </div>
                            </div>
                        </div>

                        <!-- Tasks -->
                        <div class="space-y-4">
                            {% for task_exec in execution.task_executions.all %}
                                <div class="bg-gradient-to-r from-gray-50 to-blue-50 rounded-xl p-6 border-2
                                    {% if task_exec.is_completed %}border-green-300{% else %}border-gray-200{% endif %}"
                                     id="task_{{ execution.id }}_{{ task_exec.task.id }}">
                                    
                                    <!-- Task Header -->
                                    <div class="flex items-start gap-4 mb-4">
                                        <!-- Checkbox -->
                                        <div class="flex-shrink-0 pt-1">
                                            <label class="relative inline-block w-14 h-8 cursor-pointer">
                                                <input type="checkbox" 
                                                       name="task_{{ execution.id }}_{{ task_exec.task.id }}"
                                                       class="peer sr-only task-checkbox"
                                                       {% if task_exec.is_completed %}checked{% endif %}
                                                       data-execution="{{ execution.id }}"
                                                       data-task="{{ task_exec.task.id }}">
                                                <span class="absolute inset-0 bg-gray-300 rounded-full transition-all
                                                    peer-checked:bg-gradient-to-r peer-checked:from-green-400 peer-checked:to-green-600"></span>
                                                <span class="absolute left-1 top-1 w-6 h-6 bg-white rounded-full transition-all
                                                    peer-checked:translate-x-6"></span>
                                            </label>
                                        </div>

                                        <!-- Task Info -->
                                        <div class="flex-1">
                                            <h3 class="text-lg font-bold text-gray-800 mb-2">
                                                {{ task_exec.task.title }}
                                                {% if task_exec.task.is_required %}
                                                    <span class="text-red-500">*</span>
                                                {% endif %}
                                            </h3>
                                            {% if task_exec.task.description %}
                                                <div class="text-gray-600 mb-3">{{ task_exec.task.description|markdown_simple }}</div>
                                            {% endif %}

                                            <!-- Instruction Media -->
                                            {% if task_exec.task.instruction_image or task_exec.task.instruction_video or task_exec.task.instruction_document %}
                                                <div class="mb-4 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border-2 border-blue-200">
                                                    <p class="text-sm font-bold text-blue-800 mb-3">üìñ Material de Aux√≠lio</p>
                                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                        {% if task_exec.task.instruction_image %}
                                                            <div>
                                                                <p class="text-xs font-semibold text-gray-700 mb-2">üì∑ Imagem</p>
                                                                <img src="{{ task_exec.task.instruction_image.url }}" 
                                                                     alt="Instru√ß√£o" 
                                                                     onclick="openImageModal(this.src)"
                                                                     class="w-full rounded-lg shadow-md cursor-pointer hover:opacity-90 transition-opacity">
                                                            </div>
                                                        {% endif %}
                                                        {% if task_exec.task.instruction_video %}
                                                            <div>
                                                                <p class="text-xs font-semibold text-gray-700 mb-2">üé• V√≠deo</p>
                                                                <video controls class="w-full rounded-lg shadow-md">
                                                                    <source src="{{ task_exec.task.instruction_video.url }}">
                                                                </video>
                                                            </div>
                                                        {% endif %}
                                                        {% if task_exec.task.instruction_document %}
                                                            <div>
                                                                <p class="text-xs font-semibold text-gray-700 mb-2">üìÑ Documento</p>
                                                                <a href="{{ task_exec.task.instruction_document.url }}" 
                                                                   target="_blank"
                                                                   class="flex flex-col items-center justify-center p-4 bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow border-2 border-gray-200 hover:border-blue-400">
                                                                    <i class="fas fa-file-alt text-4xl text-blue-600 mb-2"></i>
                                                                    <span class="text-xs text-center text-gray-700 font-medium">
                                                                        {{ task_exec.task.instruction_document.name|slice:"-30:" }}
                                                                    </span>
                                                                    <span class="text-xs text-blue-600 mt-1">Clique para abrir</span>
                                                                </a>
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            {% endif %}

                                            <!-- Notes -->
                                            <div class="mb-4">
                                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                                    üí¨ Observa√ß√µes
                                                </label>
                                                <textarea name="notes_{{ execution.id }}_{{ task_exec.task.id }}"
                                                          rows="2"
                                                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                          placeholder="Adicione observa√ß√µes sobre esta tarefa...">{{ task_exec.notes|default:'' }}</textarea>
                                            </div>

                                            <!-- Evidence Upload -->
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <!-- Image Evidence -->
                                                <div>
                                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                                        üì∑ Evid√™ncia (Imagem)
                                                    </label>
                                                    <div class="relative">
                                                        <input type="file" 
                                                               name="evidence_image_{{ execution.id }}_{{ task_exec.task.id }}"
                                                               accept="image/*"
                                                               class="w-full px-4 py-2 border border-gray-300 rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                                                    </div>
                                                    {% if task_exec.evidence_image %}
                                                        <img src="{{ task_exec.evidence_image.url }}" 
                                                             alt="Evid√™ncia atual" 
                                                             class="mt-2 max-w-xs rounded-lg shadow-md">
                                                    {% endif %}
                                                </div>

                                                <!-- Video Evidence -->
                                                <div>
                                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                                        üé• Evid√™ncia (V√≠deo)
                                                    </label>
                                                    <div class="relative">
                                                        <input type="file" 
                                                               name="evidence_video_{{ execution.id }}_{{ task_exec.task.id }}"
                                                               accept="video/*"
                                                               class="w-full px-4 py-2 border border-gray-300 rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                                                    </div>
                                                    {% if task_exec.evidence_video %}
                                                        <video controls class="mt-2 max-w-xs rounded-lg shadow-md">
                                                            <source src="{{ task_exec.evidence_video.url }}">
                                                        </video>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}

                <!-- Submit Button -->
                <div class="bg-white rounded-2xl shadow-xl p-8 sticky bottom-6">
                    <div class="flex items-center justify-between">
                        <div class="text-gray-700">
                            <p class="text-sm mb-1">Ao enviar, seus checklists ser√£o enviados para aprova√ß√£o</p>
                            <p class="text-xs text-gray-500">Certifique-se de completar todas as tarefas obrigat√≥rias</p>
                        </div>
                        <button type="submit"
                                class="px-8 py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold text-lg rounded-xl hover:from-blue-700 hover:to-indigo-700 transform hover:scale-105 transition-all shadow-lg">
                            ‚úÖ Enviar Todos os Checklists
                        </button>
                    </div>
                </div>
            </form>
        {% endif %}
    </div>
</div>

<script>
// Auto-save no blur dos campos
document.querySelectorAll('textarea, input[type="file"]').forEach(element => {
    element.addEventListener('blur', function() {
        console.log('Auto-salvando...');
        // N√£o submete o form, apenas mostra feedback visual
    });
});

// Atualiza√ß√£o visual ao marcar checkbox
document.querySelectorAll('.task-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const taskCard = this.closest('[id^="task_"]');
        if (this.checked) {
            taskCard.classList.remove('border-gray-200');
            taskCard.classList.add('border-green-300');
        } else {
            taskCard.classList.remove('border-green-300');
            taskCard.classList.add('border-gray-200');
        }
    });
});

// Confirma√ß√£o antes de enviar
document.getElementById('todayChecklistsForm').addEventListener('submit', function(e) {
    const requiredTasks = document.querySelectorAll('input[type="checkbox"][name*="task_"]');
    let allRequired = true;
    
    requiredTasks.forEach(checkbox => {
        const taskCard = checkbox.closest('[id^="task_"]');
        const isRequired = taskCard.querySelector('h3 .text-red-500');
        
        if (isRequired && !checkbox.checked) {
            allRequired = false;
        }
    });
    
    if (!allRequired) {
        if (!confirm('‚ö†Ô∏è Algumas tarefas obrigat√≥rias n√£o foram conclu√≠das. Deseja continuar mesmo assim?')) {
            e.preventDefault();
        }
    } else {
        if (!confirm('‚úÖ Enviar todos os checklists para aprova√ß√£o?')) {
            e.preventDefault();
        }
    }
});

// Modal para visualizar imagem em tela cheia
function openImageModal(src) {
    const modal = document.createElement('div');
    modal.id = 'imageModal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
    modal.onclick = function() { closeImageModal(); };
    
    const img = document.createElement('img');
    img.src = src;
    img.className = 'max-w-full max-h-full rounded-lg shadow-2xl';
    img.onclick = function(e) { e.stopPropagation(); };
    
    modal.appendChild(img);
    document.body.appendChild(modal);
}

function closeImageModal() {
    const modal = document.getElementById('imageModal');
    if (modal) {
        modal.remove();
    }
}

// Fechar modal com ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeImageModal();
    }
});
</script>
{% endblock %}
