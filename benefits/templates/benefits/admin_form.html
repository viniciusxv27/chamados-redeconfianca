{% extends 'base.html' %}
{% load static %}

{% block title %}{% if action == 'create' %}Criar{% else %}Editar{% endif %} Benefício{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-blue-50 p-6">
    <div class="max-w-4xl mx-auto">
        
        <!-- Header -->
        <div class="mb-6">
            <a href="{% url 'benefits:admin_list' %}" 
               class="inline-flex items-center gap-2 px-4 py-2 bg-white text-gray-700 rounded-lg hover:bg-gray-100 transition-colors shadow-md">
                <i class="fas fa-arrow-left"></i>
                Voltar
            </a>
        </div>

        <!-- Form Card -->
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <div class="mb-8">
                <h1 class="text-3xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-2">
                    <i class="fas fa-{% if action == 'create' %}plus{% else %}edit{% endif %} mr-2"></i>
                    {% if action == 'create' %}Criar Novo Benefício{% else %}Editar Benefício{% endif %}
                </h1>
                <p class="text-gray-600">Preencha as informações do benefício abaixo</p>
            </div>

            <form method="post" enctype="multipart/form-data" class="space-y-6">
                {% csrf_token %}

                <!-- Title -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">
                        <i class="fas fa-heading text-purple-500 mr-1"></i>
                        Título *
                    </label>
                    <input type="text" 
                           name="title" 
                           value="{{ benefit.title|default:'' }}"
                           required
                           maxlength="200"
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                           placeholder="Ex: 50% de desconto em pizzas">
                </div>

                <!-- Description (short) -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">
                        <i class="fas fa-align-left text-purple-500 mr-1"></i>
                        Descrição Resumida *
                    </label>
                    <textarea name="description" 
                              required
                              rows="2"
                              class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                              placeholder="Descrição curta que aparece no card (até 150 caracteres)">{{ benefit.description|default:'' }}</textarea>
                    <p class="text-xs text-gray-500 mt-1">Esta descrição aparece nos cards da lista de benefícios</p>
                </div>

                <!-- Full Description with Rich Text Editor -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">
                        <i class="fas fa-file-alt text-purple-500 mr-1"></i>
                        Descrição Completa *
                    </label>
                    
                    <!-- Rich Text Editor Toolbar -->
                    <div class="border border-gray-300 rounded-lg overflow-hidden">
                        <div class="bg-gray-50 px-3 py-2 border-b border-gray-300">
                            <div class="flex items-center space-x-1">
                                <button type="button" onclick="formatText('bold')" class="p-2 hover:bg-gray-200 rounded" title="Negrito">
                                    <i class="fas fa-bold text-gray-600"></i>
                                </button>
                                <button type="button" onclick="formatText('italic')" class="p-2 hover:bg-gray-200 rounded" title="Itálico">
                                    <i class="fas fa-italic text-gray-600"></i>
                                </button>
                                <button type="button" onclick="formatText('underline')" class="p-2 hover:bg-gray-200 rounded" title="Sublinhado">
                                    <i class="fas fa-underline text-gray-600"></i>
                                </button>
                                <div class="w-px h-6 bg-gray-300 mx-2"></div>
                                <button type="button" onclick="formatText('insertUnorderedList')" class="p-2 hover:bg-gray-200 rounded" title="Lista">
                                    <i class="fas fa-list-ul text-gray-600"></i>
                                </button>
                                <button type="button" onclick="formatText('insertOrderedList')" class="p-2 hover:bg-gray-200 rounded" title="Lista Numerada">
                                    <i class="fas fa-list-ol text-gray-600"></i>
                                </button>
                                <div class="w-px h-6 bg-gray-300 mx-2"></div>
                                <button type="button" onclick="formatText('justifyLeft')" class="p-2 hover:bg-gray-200 rounded" title="Alinhar à Esquerda">
                                    <i class="fas fa-align-left text-gray-600"></i>
                                </button>
                                <button type="button" onclick="formatText('justifyCenter')" class="p-2 hover:bg-gray-200 rounded" title="Centralizar">
                                    <i class="fas fa-align-center text-gray-600"></i>
                                </button>
                                <button type="button" onclick="formatText('justifyRight')" class="p-2 hover:bg-gray-200 rounded" title="Alinhar à Direita">
                                    <i class="fas fa-align-right text-gray-600"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Editor Area -->
                        <div 
                            id="full-description-editor" 
                            class="min-h-[200px] p-4 outline-none focus:ring-0 bg-white"
                            contenteditable="true"
                            placeholder="Descrição detalhada com todas as informações do benefício, como usar, onde usar, etc."
                            style="max-height: 400px; overflow-y: auto;"
                            onkeyup="syncContent()"
                            onpaste="handlePaste(event)"
                        >{% if benefit.full_description %}{{ benefit.full_description|safe }}{% endif %}</div>
                    </div>
                    
                    <!-- Hidden input for form submission -->
                    <input type="hidden" name="full_description" id="full_description_hidden">
                    
                    <p class="text-xs text-gray-500 mt-1">
                        <i class="fas fa-info-circle mr-1"></i>
                        Use a barra de ferramentas para formatar o texto (negrito, itálico, listas, etc.)
                    </p>
                </div>

                <!-- Coupon Code -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">
                        <i class="fas fa-ticket-alt text-purple-500 mr-1"></i>
                        Código do Cupom *
                    </label>
                    <input type="text" 
                           name="coupon_code" 
                           value="{{ benefit.coupon_code|default:'' }}"
                           required
                           maxlength="100"
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all font-mono uppercase"
                           placeholder="Ex: PIZZA50OFF"
                           style="text-transform: uppercase;">
                    <p class="text-xs text-gray-500 mt-1">Este código será exibido ao usuário após resgatar o benefício</p>
                </div>

                <!-- Settings Row -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Status -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            <i class="fas fa-toggle-on text-purple-500 mr-1"></i>
                            Status
                        </label>
                        <select name="status" 
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                            <option value="active" {% if benefit.status == 'active' or not benefit %}selected{% endif %}>Ativo</option>
                            <option value="inactive" {% if benefit.status == 'inactive' %}selected{% endif %}>Inativo</option>
                            <option value="expired" {% if benefit.status == 'expired' %}selected{% endif %}>Expirado</option>
                        </select>
                    </div>

                    <!-- Featured -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            <i class="fas fa-star text-purple-500 mr-1"></i>
                            Destaque
                        </label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" 
                                   name="is_featured" 
                                   class="sr-only peer"
                                   {% if benefit.is_featured %}checked{% endif %}>
                            <div class="w-14 h-8 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-6 peer-checked:after:border-white after:content-[''] after:absolute after:top-1 after:left-1 after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-purple-600"></div>
                            <span class="ml-3 text-sm font-medium text-gray-700">Benefício em destaque aparece primeiro</span>
                        </label>
                    </div>
                </div>

                <!-- Validity Dates -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Valid From -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            <i class="fas fa-calendar-alt text-purple-500 mr-1"></i>
                            Válido de
                        </label>
                        <input type="date" 
                               name="valid_from" 
                               value="{{ benefit.valid_from|date:'Y-m-d'|default:'' }}"
                               class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                        <p class="text-xs text-gray-500 mt-1">Deixe vazio para sem data inicial</p>
                    </div>

                    <!-- Valid Until -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            <i class="fas fa-calendar-times text-purple-500 mr-1"></i>
                            Válido até
                        </label>
                        <input type="date" 
                               name="valid_until" 
                               value="{{ benefit.valid_until|date:'Y-m-d'|default:'' }}"
                               class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                        <p class="text-xs text-gray-500 mt-1">Deixe vazio para sem data limite</p>
                    </div>
                </div>

                <!-- Image (moved to bottom) -->
                <div class="pt-6 border-t border-gray-200">
                    <label class="block text-sm font-bold text-gray-700 mb-2">
                        <i class="fas fa-image text-purple-500 mr-1"></i>
                        Imagem do Benefício
                    </label>
                    
                    {% if benefit.image %}
                        <div class="mb-4 p-4 bg-gray-50 rounded-xl">
                            <p class="text-sm text-gray-600 mb-2 font-medium">Imagem atual:</p>
                            <img src="{{ benefit.image.url }}" 
                                 alt="Imagem atual"
                                 class="w-full max-w-md h-auto object-cover rounded-lg shadow-md">
                        </div>
                    {% endif %}
                    
                    <input type="file" 
                           name="image" 
                           accept="image/*"
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100 cursor-pointer">
                    <p class="text-xs text-gray-500 mt-1">Recomendado: 800x600px (JPG, PNG ou WebP)</p>
                </div>

                <!-- Action Buttons -->
                <div class="flex items-center justify-end gap-4 pt-6 border-t-2 border-gray-200">
                    <a href="{% url 'benefits:admin_list' %}" 
                       class="px-6 py-3 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 transition-colors font-semibold">
                        <i class="fas fa-times mr-2"></i>
                        Cancelar
                    </a>
                    <button type="submit" 
                            class="px-8 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-xl hover:from-purple-700 hover:to-indigo-700 transition-all transform hover:scale-105 shadow-lg font-semibold">
                        <i class="fas fa-{% if action == 'create' %}plus{% else %}save{% endif %} mr-2"></i>
                        {% if action == 'create' %}Criar Benefício{% else %}Salvar Alterações{% endif %}
                    </button>
                </div>
            </form>
        </div>
        
    </div>
</div>

<!-- Quill Editor JS -->
<script>
// Rich Text Editor Functions
function formatText(command) {
    document.execCommand(command, false, null);
    document.getElementById('full-description-editor').focus();
    syncContent();
}

function syncContent() {
    const editor = document.getElementById('full-description-editor');
    const hiddenInput = document.getElementById('full_description_hidden');
    hiddenInput.value = editor.innerHTML;
}

function handlePaste(event) {
    event.preventDefault();
    
    // Get pasted data
    const paste = (event.clipboardData || window.clipboardData).getData('text');
    
    // Insert as plain text to avoid unwanted formatting
    document.execCommand('insertText', false, paste);
    syncContent();
}

// CSS for placeholder
const style = document.createElement('style');
style.textContent = `
    #full-description-editor:empty:before {
        content: attr(placeholder);
        color: #9CA3AF;
        pointer-events: none;
        font-style: italic;
    }
    #full-description-editor:focus:before {
        display: none;
    }
`;
document.head.appendChild(style);

// Initialize - sync content on load
document.addEventListener('DOMContentLoaded', function() {
    syncContent();
    
    // Sync before form submit
    document.querySelector('form').addEventListener('submit', function(e) {
        syncContent();
        
        const editor = document.getElementById('full-description-editor');
        const content = editor.textContent.trim();
        
        if (!content) {
            document.getElementById('full_description_hidden').value = '';
        }
    });
});

// Auto uppercase coupon code
document.querySelector('input[name="coupon_code"]').addEventListener('input', function(e) {
    e.target.value = e.target.value.toUpperCase();
});
</script>
{% endblock %}
